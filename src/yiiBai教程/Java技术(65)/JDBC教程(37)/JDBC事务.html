<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">JDBC事务</h1><div style="width:100%;float:left;" class="article-content">   
 <p>如果JDBC连接处于自动提交模式，默认情况下，则每个SQL语句在完成后都会提交到数据库。</p> 
 <p>对于简单的应用程序可能没有问题，但是有三个原因需要考虑是否关闭自动提交并管理自己的事务 -</p> 
 <ul> 
  <li>提高性能</li>
  <li>保持业务流程的完整性</li>
  <li>使用分布式事务</li>
 </ul> 
 <p>事务能够控制何时更改提交并应用于数据库。 它将单个SQL语句或一组SQL语句视为一个逻辑单元，如果任何语句失败，整个事务将失败。</p> 
 <p>要启用手动事务支持，而不是使用JDBC驱动程序默认使用的自动提交模式，请调用<code>Connection</code>对象的<code>setAutoCommit()</code>方法。 如果将布尔的<code>false</code>传递给<code>setAutoCommit()</code>，则关闭自动提交。 也可以传递一个布尔值<code>true</code>来重新打开它。</p> 
 <p>例如，如果有一个名为<code>conn</code>的<code>Connection</code>对象，请将以下代码关闭自动提交 -</p> 
 <pre><code class="lang-java">conn.setAutoCommit(false);
</code></pre> 
 <h2 id="h2-u63D0u4EA4u548Cu56DEu6EDA"><a name="提交和回滚" class="reference-link"></a><span class="header-link octicon octicon-link"></span>提交和回滚</h2>
 <p>完成更改后，若要提交更改，那么可在连接对象上调用<code>commit()</code>方法，如下所示：</p> 
 <pre><code class="lang-java">conn.commit( );
</code></pre> 
 <p>否则，要使用连接名为<code>conn</code>的数据库回滚更新，请使用以下代码 -</p> 
 <pre><code class="lang-java">conn.rollback( );
</code></pre> 
 <p>以下示例说明了如何使用提交和回滚对象 -</p> 
 <pre><code class="lang-java">try{
   //Assume a valid connection object conn
   conn.setAutoCommit(false);
   Statement stmt = conn.createStatement();

   String SQL = "INSERT INTO Employees  " +
                "VALUES (106, 20, 'Rita', 'Tez')";
   stmt.executeUpdate(SQL);  
   //Submit a malformed SQL statement that breaks
   String SQL = "INSERTED IN Employees  " +
                "VALUES (107, 22, 'Sita', 'Singh')";
   stmt.executeUpdate(SQL);
   // If there is no error.
   conn.commit();
}catch(SQLException se){
   // If there is any error.
   conn.rollback();
}
</code></pre> 
 <p>在这种情况下，上述<code>INSERT</code>语句不会成功执行，因为所有操作都被回滚了。</p> 
 <p>为了更好的理解，建议学习研究“<a target="_blank" href="http://www.yiibai.com/jdbc/commit-rollback.html" title="事务提交示例代码">事务提交示例代码</a>”。</p> 
 <h2 id="h2-u4F7Fu7528u4FDDu5B58u70B9"><a name="使用保存点" class="reference-link"></a><span class="header-link octicon octicon-link"></span>使用保存点</h2>
 <p>新的JDBC 3.0新添加了<code>Savepoint</code>接口提供了额外的事务控制能力。大多数现代DBMS支持其环境中的保存点，如Oracle的PL/SQL。</p> 
 <p>设置保存点(<code>Savepoint</code>)时，可以在事务中定义逻辑回滚点。 如果通过保存点(<code>Savepoint</code>)发生错误时，则可以使用回滚方法来撤消所有更改或仅保存保存点之后所做的更改。</p> 
 <p><code>Connection</code>对象有两种新的方法可用来管理保存点 -</p> 
 <ul> 
  <li><strong>setSavepoint(String savepointName):</strong> - 定义新的保存点，它还返回一个<code>Savepoint</code>对象。</li>
  <li><strong>releaseSavepoint(Savepoint savepointName): </strong> - 删除保存点。要注意，它需要一个<code>Savepoint</code>对象作为参数。 该对象通常是由<code>setSavepoint()</code>方法生成的保存点。</li>
 </ul> 
 <p>有一个<em>rollback (String savepointName)</em>方法，它将使用事务回滚到指定的保存点。</p> 
 <p>以下示例说明了使用<code>Savepoint</code>对象 -</p>   
 <pre><code class="lang-java">try{
   //Assume a valid connection object conn
   conn.setAutoCommit(false);
   Statement stmt = conn.createStatement();

   //set a Savepoint
   Savepoint savepoint1 = conn.setSavepoint("Savepoint1");
   String SQL = "INSERT INTO Employees " +
                "VALUES (106, 24, 'Curry', 'Stephen')";
   stmt.executeUpdate(SQL);  
   //Submit a malformed SQL statement that breaks
   String SQL = "INSERTED IN Employees " +
                "VALUES (107, 32, 'Kobe', 'Bryant')";
   stmt.executeUpdate(SQL);
   // If there is no error, commit the changes.
   conn.commit();

}catch(SQLException se){
   // If there is any error.
   conn.rollback(savepoint1);
}
</code></pre> 
 <p>在这种情况下，上述<code>INSERT</code>语句都不会成功，因为所有操作都被回滚了。</p> 
 <p>为了更好的理解，建议学习研究<a target="_blank" href="http://www.yiibai.com/jdbc/jdbc-savepoints.html" title="保存点示例代码">保存点示例代码</a>。</p>
 <br>      
</div></body></html>
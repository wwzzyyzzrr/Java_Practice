<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">JDBC存储过程调用</h1><div style="width:100%;float:left;" class="article-content">   
 <p>在讨论<a target="_blank" href="http://www.yiibai.com/jdbc/jdbc-statements.html" title="JDBC Statement教程">JDBC Statement教程</a>文章时，我们已经学习了如何在JDBC中使用存储过程。 本教程文章与该部分类似，但它将讲解演示有关JDBC SQL转义语法的其他信息。</p> 
 <p>就像<code>Connection</code>对象创建<code>Statement</code>和<code>PreparedStatement</code>对象一样，它可使用同样的方式创建<code>CallableStatement</code>对象，该对象将用于执行对数据库存储过程的调用。</p> 
 <h2 id="h2--callablestatement-"><a name="创建CallableStatement对象" class="reference-link"></a><span class="header-link octicon octicon-link"></span>创建CallableStatement对象</h2>
 <p>假设需要执行以下Oracle存储过程 -</p> 
 <pre><code class="lang-sql">CREATE OR REPLACE PROCEDURE getEmpName 
   (EMP_ID IN NUMBER, EMP_FIRST OUT VARCHAR) AS
BEGIN
   SELECT first INTO EMP_FIRST
   FROM Employees
   WHERE ID = EMP_ID;
END;
</code></pre> 
 <blockquote> 
  <p><strong>注意</strong>：上面的存储过程是为Oracle编写的，但是如果使用MySQL数据库，参考以下代码为MySQL编写相同的存储过程，如下在<code>EMP</code>数据库中创建它 -</p> 
 </blockquote> 
 <pre><code class="lang-sql">DELIMITER $$

DROP PROCEDURE IF EXISTS `EMP`.`getEmpName` $$
CREATE PROCEDURE `EMP`.`getEmpName` 
   (IN EMP_ID INT, OUT EMP_FIRST VARCHAR(255))
BEGIN
   SELECT first INTO EMP_FIRST
   FROM Employees
   WHERE ID = EMP_ID;
END $$

DELIMITER ;
</code></pre> 
 <p>存在三种类型的参数：<code>IN</code>，<code>OUT</code>和<code>INOUT</code>。 <code>PreparedStatement</code>对象只使用<code>IN</code>参数。 <code>CallableStatement</code>对象可以使用上面三种类型参数。</p> 
 <p>以下是上面三种类型参数的定义 -</p> 
 <table> 
  <thead> 
   <tr> 
    <th>参数</th> 
    <th>描述</th> 
   </tr> 
  </thead> 
  <tbody> 
   <tr> 
    <td>IN</td> 
    <td>创建SQL语句时其参数值是未知的。 使用<code>setXXX()</code>方法将值绑定到<code>IN</code>参数。</td> 
   </tr> 
   <tr> 
    <td>OUT</td> 
    <td>由SQL语句返回的参数值。可以使用<code>getXXX()</code>方法从OUT参数中检索值。</td> 
   </tr> 
   <tr> 
    <td>INOUT</td> 
    <td>提供输入和输出值的参数。使用<code>setXXX()</code>方法绑定变量并使用<code>getXXX()</code>方法检索值。</td> 
   </tr> 
  </tbody> 
 </table> 
 <p>以下代码片段显示了如何使用<code>Connection.prepareCall()</code>方法根据上述存储过程来实例化一个<code>CallableStatement</code>对象 -</p> 
 <pre><code class="lang-java">CallableStatement cstmt = null;
try {
   String str = "{call getEmpName (?, ?)}";
   cstmt = conn.prepareCall (SQL);
   . . .
}
catch (SQLException e) {
   . . .
}
finally {
   . . .
}
</code></pre> 
 <p>String变量<code>str</code>表示存储过程，带有参数占位符。</p> 
 <p>使用<code>CallableStatement</code>对象与使用<code>PreparedStatement</code>对象很像。 在执行语句之前，必须将值绑定到所有参数，否则将收到一个<code>SQLException</code>异常。</p> 
 <p>如果有<code>IN</code>参数，只需遵循适用于<code>PreparedStatement</code>对象的相同规则和技术; 使用与绑定的Java数据类型相对应的<code>setXXX()</code>方法。</p> 
 <p>使用<code>OUT</code>和<code>INOUT</code>参数时，必须使用一个额外的<code>CallableStatement</code>对象方法<code>registerOutParameter()</code>。 <code>registerOutParameter()</code>方法将JDBC数据类型绑定到存储过程预期返回的数据类型。</p> 
 <p>当调用存储过程后，可以使用适当的<code>getXXX()</code>方法从<code>OUT</code>参数中检索该值。 此方法将检索到的SQL类型的值转换为Java数据类型。</p> 
 <h2 id="h2--callablestatement-"><a name="关闭CallableStatement对象" class="reference-link"></a><span class="header-link octicon octicon-link"></span>关闭CallableStatement对象</h2>
 <p>就像关闭其他Statement对象一样，由于同样的原因(节省资源)，还应该关闭<code>CallableStatement</code>对象。</p> 
 <p>简单的调用<code>close()</code>方法将执行关闭工作。 如果先关闭<code>Connection</code>对象，它也会关闭<code>CallableStatement</code>对象。 但是，应该始终显式关闭<code>CallableStatement</code>对象，以确保正确的顺序清理。</p> 
 <pre><code class="lang-java">CallableStatement cstmt = null;
try {
   String SQL = "{call getEmpName (?, ?)}";
   cstmt = conn.prepareCall (SQL);
   . . .
}
catch (SQLException e) {
   . . .
}
finally {
   cstmt.close();
}
</code></pre> 
 <p>有关更多的细节，建议学习研究“<a target="_blank" href="http://www.yiibai.com/jdbc/callablestatement-object-example.html" title="Callable实例代码">Callable实例代码</a>”</p> 
 <h2 id="h2-jdbc-sql-"><a name="JDBC SQL转义语法" class="reference-link"></a><span class="header-link octicon octicon-link"></span>JDBC SQL转义语法</h2>
 <p>通过使用标准JDBC方法和属性，转义语法使您能够灵活地使用不可用的数据库特定功能。</p> 
 <p>一般SQL转义语法格式如下 -</p>   
 <pre><code>{keyword 'parameters'}
</code></pre>
 <p>以下是以下转义序列，在执行JDBC编程时非常有用 -</p> 
 <p><strong>d, t, ts关键字</strong></p> 
 <p>它们用于帮助确定日期，时间和时间戳文字。没有哪两个DBMS表示时间和日期的方式相同。 该转义语法告诉驱动程序以目标数据库的格式呈现日期或时间。 例如 -</p> 
 <pre><code>{d 'yyyy-mm-dd'}
</code></pre>
 <p><code>yyyy</code>=年份，<code>mm</code>=月份; <code>dd</code>=日期。 使用这种语法<code>{d'2019-09-03'}</code>表示的是2019年3月9日。</p> 
 <p>这是一个简单的示例，显示如何将日期插入表中 -</p> 
 <pre><code class="lang-java">//Create a Statement object
stmt = conn.createStatement();
//Insert data ==&gt; ID, First Name, Last Name, DOB
String sql="INSERT INTO STUDENTS VALUES" +
             "(100,'Kobe','Bryant', {d '2002-12-16'})";

stmt.executeUpdate(sql);
</code></pre> 
 <p>同样，还可以使用以下两种语法：<code>t</code>或<code>ts</code> -</p> 
 <pre><code>{t 'hh:mm:ss'}
</code></pre>
 <p>这里，<code>hh</code>=小时，<code>mm</code> =分钟， <code>ss</code> =秒。 使用这种语法<code>{t '13:30:29'}</code>是<code>1:30:29 PM</code>。</p> 
 <pre><code>{ts 'yyyy-mm-dd hh:mm:ss'}
</code></pre>
 <p>这里“<code>d</code>”和“<code>t</code>”是上述两种语法的组合语法来表示时间戳。</p> 
 <p><strong>escape关键字</strong></p> 
 <p><code>escape</code>关键字标识<code>LIKE</code>子句中使用转义字符。 使用SQL通配符<code>%</code>(与<code>0</code>个或多个字符匹配)时很有用。 例如 -</p> 
 <pre><code class="lang-java">String sql = "SELECT symbol FROM MathSymbols
              WHERE symbol LIKE '\%' {escape '\'}";
stmt.execute(sql);
</code></pre> 
 <p>如果使用反斜杠字符(<code>\</code>)作为转义字符，则还必须在Java字符串文字中使用两个反斜杠字符，因为反斜杠也是Java转义字符。</p> 
 <p><strong>fn 关键字</strong></p> 
 <p>这个关键字表示DBMS中使用的标量函数。 例如，可以使用SQL函数长度来获取字符串的长度 -</p> 
 <pre><code class="lang-java">{fn length('Hello World')}
</code></pre> 
 <p>上面语句返回结果值为：<code>11</code>，也就是字符串’<code>Hello World</code>‘的长度。</p> 
 <p><strong>call 关键字</strong></p> 
 <p>此关键字用于调用存储过程。 例如，对于需要<code>IN</code>参数的存储过程，请使用以下语法 -</p> 
 <pre><code class="lang-java">{call my_procedure(?)};
</code></pre> 
 <p>对于需要<code>IN</code>参数并返回<code>OUT</code>参数的存储过程，请使用以下语法 -</p> 
 <pre><code class="lang-java">{? = call my_procedure(?)};
</code></pre> 
 <p><strong>oj关键字</strong></p> 
 <p>此关键字用于表示外部连接。 语法如下 -</p> 
 <pre><code class="lang-java">{oj outer-join}
</code></pre> 
 <p>这里，<em>outer-join = table {LEFT|RIGHT|FULL} OUTERJOIN {table | outer-join}</em> 搜索条件。 例如 - </p> 
 <pre><code class="lang-java">String sql = "SELECT Employees 
              FROM {oj ThisTable RIGHT
              OUTER JOIN ThatTable on id = '100'}";
stmt.execute(sql);
</code></pre>
 <br>      
</div></body></html>
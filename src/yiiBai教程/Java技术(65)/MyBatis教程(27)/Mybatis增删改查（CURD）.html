<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Mybatis增删改查（CURD）</h1><div style="width:100%;float:left;" class="article-content">   
 <p>前面的小节我们已经讲到用接口的方式编程。使用这种方式，需要注意的一个地方就是，在<code>User.xml</code> 配置文件中，<code>mapper namespace="com.yiibai.mybatis.inter.IUser"</code> ，命名空间对应非常重要，名称不能有错，必须与我们定义的 <code>package</code> 和 接口一致。如果不一致就会出错，这一章主要在上一讲基于接口编程的基础上完成如下操作:</p> 
 <ol> 
  <li>使用 mybatis 查询用户数据(读取用户列表)</li>
  <li>使用 mybatis 增加用户数据</li>
  <li>使用 mybatis 更新用户数据</li>
  <li>使用 mybatis 删除用户数据</li>
 </ol> 
 <p>查询数据，前面已经讲过简单的查询单个用户数据，在这里将查询出用户列表，<br>要查询出列表，也就是返回 <code>List</code>, 在我们这个例子中也就是<code>List&lt;User&gt;</code> , 要以这种方式返回数据，需要在<code>User.xml</code>里面配置返回的类型 <code>resultMap</code>, 注意不是 <code>resultType</code>, <code>而这个resultMap</code> 所对应的应该是我们自己配置。</p> 
 <p>在此示例中，我们需要使用到以下表：</p> 
 <pre><code class="lang-sql">接下我们创建一个表：user，并插入一条记录信息，其结构如下所示：

CREATE TABLE `user` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(64) NOT NULL DEFAULT '',
  `dept` varchar(254) NOT NULL DEFAULT '',
  `website` varchar(254) DEFAULT '',
  `phone` varchar(16) NOT NULL DEFAULT '',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=latin1;

-- ----------------------------
-- Records of user
-- ----------------------------
INSERT INTO `user` VALUES ('1', 'yiibai', 'Tech', 'http://www.yiibai.com', '13800009988');
</code></pre> 
 <h2 id="h2-1-"><a name="1、创建工程并配置所需环境" class="reference-link"></a><span class="header-link octicon octicon-link"></span>1、创建工程并配置所需环境</h2>
 <p>我们首先来创建一个工程：<em>mybatis-curd-03</em>，与第一节中介绍的环境配置一样，加入所需的 <code>jar</code> 包：<code>mysql-connector</code> 和 <code>mybatis3.jar</code>。配置 <code>src/config/Configure.xml</code>，其文件内容如下：</p> 
 <pre><code class="lang-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-config.dtd"&gt;
&lt;configuration&gt;
    &lt;typeAliases&gt;
        &lt;typeAlias alias="User" type="com.yiibai.mybatis.models.User" /&gt;
    &lt;/typeAliases&gt;

    &lt;environments default="development"&gt;
        &lt;environment id="development"&gt;
            &lt;transactionManager type="JDBC" /&gt;
            &lt;dataSource type="POOLED"&gt;
                &lt;property name="driver" value="com.mysql.jdbc.Driver" /&gt;
                &lt;property name="url" value="jdbc:mysql://127.0.0.1:3306/testdb" /&gt;
                &lt;property name="username" value="root" /&gt;
                &lt;property name="password" value="123456" /&gt;
            &lt;/dataSource&gt;
        &lt;/environment&gt;
    &lt;/environments&gt;

    &lt;mappers&gt;
        &lt;!-- // power by http://www.yiibai.com --&gt;
        &lt;mapper resource="com/yiibai/mybatis/models/User.xml" /&gt;
    &lt;/mappers&gt;
&lt;/configuration&gt;
</code></pre> 
 <h2 id="h2-2-java-"><a name="2、创建 Java 类和接口" class="reference-link"></a><span class="header-link octicon octicon-link"></span>2、创建 Java 类和接口</h2>
 <p>在这里需要创建一个类和一个接口：<code>User.java</code>类和<code>IUser.java</code>接口，<code>User.java</code>类位于包 <code>com.yiibai.mybatis.models</code> 下，<code>User.java</code>类代码内容如下：</p> 
 <pre><code class="lang-java">package com.yiibai.mybatis.models;

public class User {
    private int id;
    private String name;
    private String dept;
    private String phone;
    private String website;

    public String getWebsite() {
        return website;
    }
    public void setWebsite(String website) {
        this.website = website;
    }
    public int getId() {
        return id;
    }
    public void setId(int id) {
        this.id = id;
    }
    public String getName() {
        return name;
    }
    public void setName(String name) {
        this.name = name;
    }
    public String getDept() {
        return dept;
    }
    public void setDept(String dept) {
        this.dept = dept;
    }
    public String getPhone() {
        return phone;
    }
    public void setPhone(String phone) {
        this.phone = phone;
    }

}
</code></pre> 
 <p><code>IUser.java</code>接口位于包<code>com.yiibai.mybatis.dao</code> 下，<code>IUser.java</code>接口代码内容如下：</p> 
 <pre><code class="lang-java">package com.yiibai.mybatis.dao;

import java.util.List;

import org.apache.ibatis.annotations.Select;

import com.yiibai.mybatis.models.User;
/**
 * 
 * @author yiibai
 *
 */
public interface IUser {
    //@Select("select * from user where id= #{id}")
    //public User getUserByID(int id);
    public List&lt;User&gt; getUserList();

    public void insertUser(User user);

    public void updateUser(User user);

    public void deleteUser(int userId);

    public User getUser(int id);
}
</code></pre> 
 <p>这里还需要一个XML文件，与前一小节中一样，使用的是 <code>User.xml</code>，在这我们分别对应了增删改查的操作(每一个操作的 <code>ID</code> 对应于<code>IUser</code>接口的方法)，其内容如下：</p> 
 <p><em>User.xml</em></p> 
 <pre><code class="lang-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;

&lt;mapper namespace="com.yiibai.mybatis.dao.IUser"&gt;

    &lt;select id="getUser" parameterType="int"
        resultType="com.yiibai.mybatis.models.User"&gt;
        SELECT *
        FROM USER
        WHERE id = #{userId}
    &lt;/select&gt;


    &lt;insert id="insertUser" parameterType="User"&gt;
        INSERT INTO USER(name,
        dept, website,phone)
        VALUES(#{name}, #{dept}, #{website}, #{phone})
    &lt;/insert&gt;

    &lt;select id="getUserList" resultType="com.yiibai.mybatis.models.User"&gt;
        SELECT * FROM USER
    &lt;/select&gt;

    &lt;update id="updateUser" parameterType="User"&gt;
        UPDATE USER
        SET
        name=
        #{name},
        dept = #{dept},
        website = #{website},
        phone = #{phone}
        WHERE
        id =
        #{id}
    &lt;/update&gt;

    &lt;delete id="deleteUser" parameterType="int"&gt;
        DELETE FROM USER WHERE id = #{id}
    &lt;/delete&gt;

&lt;/mapper&gt;
</code></pre> 
 <p>测试程序主类：</p> 
 <pre><code class="lang-java">import java.io.Reader;
import java.text.MessageFormat;
import java.util.List;

import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;

import com.yiibai.mybatis.dao.IUser;
import com.yiibai.mybatis.models.User;

public class Main {
    private static SqlSessionFactory sqlSessionFactory;
    private static Reader reader;

    static {
        try {
            reader = Resources.getResourceAsReader("config/Configure.xml");
            sqlSessionFactory = new SqlSessionFactoryBuilder().build(reader);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public static SqlSessionFactory getSession() {
        return sqlSessionFactory;
    }

    /**
     * @param args
     */
    public static void main(String[] args) {
        // TODO Auto-generated method stub
        SqlSession session = sqlSessionFactory.openSession();
        try {
            //sqlSessionFactory.getConfiguration().addMapper(IUser.class);
            //User user = (User) session.selectOne( "com.yiibai.mybatis.models.UserMapper.getUserByID", 1);

            // 用户数据列表
            getUserList();
            // 插入数据
            // testInsert();

            // 更新用户
            //testUpdate();

            // 删除数据
            //testDelete();

        } finally {
            session.close();
        }
    }

    //
    public static void testInsert()
    {
        try
        {
            // 获取Session连接
            SqlSession session = sqlSessionFactory.openSession();
            // 获取Mapper
            IUser userMapper = session.getMapper(IUser.class);
            System.out.println("Test insert start...");
            // 执行插入
            User user = new User();
            user.setId(0);
            user.setName("Google");
            user.setDept("Tech");
            user.setWebsite("http://www.google.com");
            user.setPhone("120");
            userMapper.insertUser(user);
            // 提交事务
            session.commit();

            // 显示插入之后User信息
            System.out.println("After insert");
            getUserList();
            System.out.println("Test insert finished...");
        }
        catch (Exception e)
        {
            e.printStackTrace();
        }
    }

    // 获取用户列表
    public static void getUserList() {
        try {
            SqlSession session = sqlSessionFactory.openSession();
            IUser iuser = session.getMapper(IUser.class);
            // 显示User信息
            System.out.println("Test Get start...");
            printUsers(iuser.getUserList());
            System.out.println("Test Get finished...");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public static void testUpdate()
    {
        try
        {
            SqlSession session = sqlSessionFactory.openSession();
            IUser iuser = session.getMapper(IUser.class);
            System.out.println("Test update start...");
            printUsers(iuser.getUserList());
            // 执行更新
            User user = iuser.getUser(1);
            user.setName("New name");
            iuser.updateUser(user);
            // 提交事务
            session.commit();
            // 显示更新之后User信息
            System.out.println("After update");
            printUsers(iuser.getUserList());
            System.out.println("Test update finished...");
        }catch (Exception e)
        {
            e.printStackTrace();
        }
    }

    // 删除用户信息
    public static void testDelete()
    {
        try
        {
            SqlSession session = sqlSessionFactory.openSession();
            IUser iuser = session.getMapper(IUser.class);
            System.out.println("Test delete start...");
            // 显示删除之前User信息
            System.out.println("Before delete");
            printUsers(iuser.getUserList());
            // 执行删除
            iuser.deleteUser(2);
            // 提交事务
            session.commit();
            // 显示删除之后User信息
            System.out.println("After delete");
            printUsers(iuser.getUserList());
            System.out.println("Test delete finished...");
        }catch (Exception e)
        {
            e.printStackTrace();
        }
    }

    /**
     * 
     * 打印用户信息到控制台
     * 
     * @param users
     */
    private static void printUsers(final List&lt;User&gt; users) {
        int count = 0;

        for (User user : users) {
            System.out.println(MessageFormat.format(
                    "============= User[{0}]=================", ++count));
            System.out.println("User Id: " + user.getId());
            System.out.println("User Name: " + user.getName());
            System.out.println("User Dept: " + user.getDept());
            System.out.println("User Website: " + user.getWebsite());
        }
    }
}
</code></pre> 
 <h2 id="h2-u6D4Bu8BD5u8FD0u884C"><a name="测试运行" class="reference-link"></a><span class="header-link octicon octicon-link"></span>测试运行</h2>
 <p>执行以上程序，如果没有问题，应该能正确输出。那么这里所有增删改查都完成了，需要注意的是在增加，更改，删除的时候需要调用 <code>session.commit()</code> 来提交事务，这样才会真正对数据库进行操作提交保存，否则操作没有提交到数据中。<br>到此为止，简单的单表操作已经完成了，接下来在下一节中将会讲解多表联合查询，以及结果集的选取。 如遇到不明白的问题，请留言评论。</p> 
 <p>最后，附上项目结构图，如下：</p> 
 <p><img src="http://www.yiibai.com/uploads/images/201709/1309/287160944_75810.png" alt=""></p>
 <br>      
</div></body></html>
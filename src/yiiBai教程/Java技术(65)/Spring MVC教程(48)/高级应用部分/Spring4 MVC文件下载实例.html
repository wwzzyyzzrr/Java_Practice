<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Spring4 MVC文件下载实例</h1><div style="width:100%;float:left;" class="article-content">   
 <div> 
  <div>
    这篇文章将向您展示如何使用Spring MVC4执行文件下载，我们将看到应用程序从文件系统内部以及外部文件下载文件。 
  </div> 
 </div> 
 <p> <br> </p> 
 <p> 本教程的主要亮点： </p> 
 <p> 下载文件是相当简单的，涉及以下步骤。 </p> 
 <ul> 
  <li> 创建一个InputStream到文件用于下载。 </li> 
  <li> 查找MIME类型下载文件的内容。<br> –可以是application/pdf, text/html,application/xml,image/png等等。 </li> 
  <li> 将内容类型与上述发现的MIME类型响应（HttpServletResponse）。<br> response.setContentType(mimeType); </li> 
  <li> 针对以上找到MIME类型设置内容长度。<br> response.setContentLength(file.getLength());//length in bytes </li> 
  <li> 为响应设置内容处理标头。<br> response.setHeader(“Content-Disposition”, “attachment; filename=” + fileName);&nbsp;//随着“附件”文件将下载。可能会显示一个“另存为”基于浏览器的设置对话框。 <p> response.setHeader(“Content-Disposition”, “inline; filename=” + fileName);//通过“内联”浏览器将尝试显示内容到浏览器中（图片，PDF，文本，...）。对于其他内容类型，文件将直接下载。 </p> </li> 
  <li> 从InputStream中复制字节响应到 OutputStream。 </li> 
  <li> 一旦复制完成后，关闭输入输出流。 </li> 
 </ul> 
 <p> 完整实施例在下面讨论。 </p> 
 <hr> 
 <p> 使用到以下技术： </p> 
 <ul> 
  <li> Spring 4.2.0.RELEASE </li> 
  <li> Bootstrap v3.3.2 </li> 
  <li> Maven 3 </li> 
  <li> JDK 1.7 </li> 
  <li> Tomcat 8.0.21 </li> 
  <li> Eclipse JUNO Service Release 2 </li> 
 </ul> 
 <p> 现在让我们开始 </p> 
 <h3> 项目结构 </h3> 
 <p> <img src="/uploads/tutorial/20160116/1-16011611110Y11.png" alt=""> </p> 
 <h3> 在pom.xml中声明依赖关系 </h3> 
 <pre>&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"&gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
  &lt;groupId&gt;com.yiibai.springmvc&lt;/groupId&gt;
  &lt;artifactId&gt;Spring4MVCFileDownloadExample&lt;/artifactId&gt;
  &lt;packaging&gt;war&lt;/packaging&gt;
  &lt;version&gt;1.0.0&lt;/version&gt;
  &lt;name&gt;Spring4MVCFileDownloadExample Maven Webapp&lt;/name&gt;
 
     &lt;properties&gt;
		&lt;springframework.version&gt;4.2.0.RELEASE&lt;/springframework.version&gt;
	&lt;/properties&gt;

	&lt;dependencies&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework&lt;/groupId&gt;
			&lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt;
			&lt;version&gt;${springframework.version}&lt;/version&gt;
		&lt;/dependency&gt;

		&lt;dependency&gt;
			&lt;groupId&gt;javax.servlet&lt;/groupId&gt;
			&lt;artifactId&gt;javax.servlet-api&lt;/artifactId&gt;
			&lt;version&gt;3.1.0&lt;/version&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;javax.servlet&lt;/groupId&gt;
			&lt;artifactId&gt;jstl&lt;/artifactId&gt;
			&lt;version&gt;1.2&lt;/version&gt;
		&lt;/dependency&gt;
	&lt;/dependencies&gt;


	&lt;build&gt;
		&lt;pluginManagement&gt;
			&lt;plugins&gt;
				&lt;plugin&gt;
					&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
					&lt;artifactId&gt;maven-war-plugin&lt;/artifactId&gt;
					&lt;version&gt;2.4&lt;/version&gt;
					&lt;configuration&gt;
						&lt;warSourceDirectory&gt;src/main/webapp&lt;/warSourceDirectory&gt;
						&lt;warName&gt;Spring4MVCFileDownloadExample&lt;/warName&gt;
						&lt;failOnMissingWebXml&gt;false&lt;/failOnMissingWebXml&gt;
					&lt;/configuration&gt;
				&lt;/plugin&gt;
			&lt;/plugins&gt;
		&lt;/pluginManagement&gt;

		&lt;finalName&gt;Spring4MVCFileDownloadExample&lt;/finalName&gt;
	&lt;/build&gt;
&lt;/project&gt;
 </pre> 
 <h3> 创建控制器 </h3> 
 <pre>package com.yiibai.springmvc.controller;

import java.io.BufferedInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.URLConnection;
import java.nio.charset.Charset;

import javax.servlet.http.HttpServletResponse;

import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.util.FileCopyUtils;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

@Controller
public class FileDownloadController {
	
	private static final String INTERNAL_FILE="irregular-verbs-list.pdf";
	private static final String EXTERNAL_FILE_PATH="C:/mytemp/SpringMVCHibernateManyToManyCRUDExample.zip";
	

	@RequestMapping(value={"/","/welcome"}, method = RequestMethod.GET)
	public String getHomePage(ModelMap model) {
		return "welcome";
	}

	/*
	 * Download a file from 
	 *   - inside project, located in resources folder.
	 *   - outside project, located in File system somewhere. 
	 */
	@RequestMapping(value="/download/{type}", method = RequestMethod.GET)
	public void downloadFile(HttpServletResponse response, @PathVariable("type") String type) throws IOException {
	
		File file = null;
		
		if(type.equalsIgnoreCase("internal")){
			ClassLoader classloader = Thread.currentThread().getContextClassLoader();
			file = new File(classloader.getResource(INTERNAL_FILE).getFile());
		}else{
			file = new File(EXTERNAL_FILE_PATH);
		}
		
		if(!file.exists()){
			String errorMessage = "Sorry. The file you are looking for does not exist";
			System.out.println(errorMessage);
			OutputStream outputStream = response.getOutputStream();
			outputStream.write(errorMessage.getBytes(Charset.forName("UTF-8")));
			outputStream.close();
			return;
		}
		
		String mimeType= URLConnection.guessContentTypeFromName(file.getName());
		if(mimeType==null){
			System.out.println("mimetype is not detectable, will take default");
			mimeType = "application/octet-stream";
		}
		
		System.out.println("mimetype : "+mimeType);
		
        response.setContentType(mimeType);
        
        /* "Content-Disposition : inline" will show viewable types [like images/text/pdf/anything viewable by browser] right on browser 
            while others(zip e.g) will be directly downloaded [may provide save as popup, based on your browser setting.]*/
        response.setHeader("Content-Disposition", String.format("inline; filename=\"" + file.getName() +"\""));

        
        /* "Content-Disposition : attachment" will be directly download, may provide save as popup, based on your browser setting*/
        //response.setHeader("Content-Disposition", String.format("attachment; filename=\"%s\"", file.getName()));
        
        response.setContentLength((int)file.length());

		InputStream inputStream = new BufferedInputStream(new FileInputStream(file));

        //Copy bytes from source to destination(outputstream in this example), closes both streams.
        FileCopyUtils.copy(inputStream, response.getOutputStream());
	}

}</pre> 
 <p> 该控制器包括两个文件。一个文件是内部应用（内部资源），和其他文件位于外部的应用程序的文件系统。您的项目一定要改变外部文件的路径。仅用于演示的目的，我们已在路径一个额外的路径变量（内部/外部）。我们正在使用Spring FileCopyUtils工具类流从源复制到目的地。 </p> 
 <h3> 配置 </h3> 
 <pre>package com.yiibai.springmvc.configuration;

import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.EnableWebMvc;
import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;
import org.springframework.web.servlet.config.annotation.ViewResolverRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurerAdapter;
import org.springframework.web.servlet.view.InternalResourceViewResolver;
import org.springframework.web.servlet.view.JstlView;

@Configuration
@EnableWebMvc
@ComponentScan(basePackages = "com.yiibai.springmvc")
public class HelloWorldConfiguration extends WebMvcConfigurerAdapter{

	
	@Override
    public void configureViewResolvers(ViewResolverRegistry registry) {
        InternalResourceViewResolver viewResolver = new InternalResourceViewResolver();
        viewResolver.setViewClass(JstlView.class);
        viewResolver.setPrefix("/WEB-INF/views/");
        viewResolver.setSuffix(".jsp");
        registry.viewResolver(viewResolver);
    }
    
    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler("/static/**").addResourceLocations("/static/");
    }

}</pre> 
 <h3> 初始化 </h3>   
 <pre>package com.yiibai.springmvc.configuration;

import org.springframework.web.servlet.support.AbstractAnnotationConfigDispatcherServletInitializer;

public class HelloWorldInitializer extends AbstractAnnotationConfigDispatcherServletInitializer {
 

    @Override
    protected Class&lt;?&gt;[] getRootConfigClasses() {
        return new Class[] { HelloWorldConfiguration.class };
    }
  
    @Override
    protected Class&lt;?&gt;[] getServletConfigClasses() {
        return null;
    }
  
    @Override
    protected String[] getServletMappings() {
        return new String[] { "/" };
    }
 
 }</pre> 
 <h3> 添加视图 </h3> 
 <pre>&lt;%@ taglib prefix="form" uri="http://www.springframework.org/tags/form"%&gt;
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %&gt;
&lt;html&gt;

&lt;head&gt;
	&lt;meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"&gt;
	&lt;title&gt;Spring 4 MVC File Download Example&lt;/title&gt;
	&lt;link href="&lt;c:url value='/static/css/bootstrap.css' /&gt;"  rel="stylesheet"&gt;&lt;/link&gt;
	&lt;link href="&lt;c:url value='/static/css/app.css' /&gt;" rel="stylesheet"&gt;&lt;/link&gt;
&lt;/head&gt;
&lt;body&gt;
	&lt;div class="form-container"&gt;
		&lt;h1&gt;Welcome to FileDownloader Example&lt;/h1&gt;
		
		Click on below links to see FileDownload in action.&lt;br/&gt;&lt;br/&gt;
		
		
		&lt;a href="&lt;c:url value='/download/internal' /&gt;"&gt;Download This File (located inside project)&lt;/a&gt;  
		&lt;br/&gt;
		&lt;a href="&lt;c:url value='/download/external' /&gt;"&gt;Download This File (located outside project, on file system)&lt;/a&gt;
		
	&lt;/div&gt; 
&lt;/body&gt;
&lt;/html&gt;</pre> 
 <h3> 构建，部署和运行应用程序 </h3> 
 <p> 现在构建war（在前面的Eclipse教程）或通过Maven的命令行( mvn clean install)。部署 war 到Servlet3.0容器。或：<br> <img src="/uploads/tutorial/20160116/1-16011611001DG.png" alt=""> </p> 
 <p> 打开浏览器，浏览&nbsp;<a target="_blank" href="http://localhost:8080/Spring4MVCFileDownloadExample">http://localhost:8080/Spring4MVCFileDownloadExample</a><br> <img src="/uploads/tutorial/20160116/1-160116110T5429.png" alt=""> </p> 
 <p style="color:#404040;font-size:15px;"> <img src="file://E:/data/youdao/qq24B39E2329F08D9F4C3146A571A415EF/77a424a4319143aa8f8638b3f21cfd81/example_img2.png" alt="Spring4MVCFileDownloadExample_img2" width="933" height="546" style="height:auto;"> </p> 
 <p style="color:#404040;font-size:15px;"> 点击第二个链接。外部文件应被下载。<br> <img src="/uploads/tutorial/20160116/1-160116111514Y7.png" alt=""> </p> 
 <p style="color:#404040;font-size:15px;"> <img src="file://E:/data/youdao/qq24B39E2329F08D9F4C3146A571A415EF/e1d854e0cd064782aaf9cd852f127829/example_img3.png" alt="Spring4MVCFileDownloadExample_img3" width="934" height="545" style="height:auto;"> </p> 
 <p> 点击第一个链接。内部文件[这是一个PDF]应该显示在浏览器中，这是由于&nbsp;Content-Disposition: inline. 通过内联，如果内容可以通过浏览器显示，它会显示它在浏览器中。<br> <img src="/uploads/tutorial/20160116/1-16011611391I26.png" alt=""> </p> 
 <p style="color:#404040;font-size:15px;"> <img src="file://E:/data/youdao/qq24B39E2329F08D9F4C3146A571A415EF/24e43c49b0dc4de097a2ac582ad37b67/example_img4.png" alt="Spring4MVCFileDownloadExample_img4" width="932" height="543" style="height:auto;"> </p> 
 <p> 现在从内联更改内容处置备注。构建并部署。点击第一个链接。这个时候您应该看到 PDF文件被下载。<br> <img src="/uploads/tutorial/20160116/1-16011611261S95.png" alt=""> </p> 
 <p style="color:#404040;font-size:15px;"> <img src="file://E:/data/youdao/qq24B39E2329F08D9F4C3146A571A415EF/33967f146bc14412bd906c0bbe62bafe/example_img5.png" alt="Spring4MVCFileDownloadExample_img5" width="935" height="545" style="height:auto;"> </p> 
 <p> 就这样，完成！ </p> 
 <p> 下载代码：<a target="_blank" href="http://pan.baidu.com/s/1c1lmeL6">http://pan.baidu.com/s/1c1lmeL6</a> </p>
 <br>      
</div></body></html>
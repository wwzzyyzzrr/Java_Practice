<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Hibernate每个层次类一张表（使用注释）</h1><div style="width:100%;float:left;" class="article-content">   
 <p>在上一文章中，我们使用xml文件将继承层次映射到一个表。 在这里，我们将使用注释来执行同样的任务。需要使用<code><a target="_blank" href="https://github.com/Inheritance" title="@Inheritance" class="at-link">@Inheritance</a>(strategy = InheritanceType.SINGLE_TABLE)</code>，<code><a target="_blank" href="https://github.com/DiscriminatorColumn" title="@DiscriminatorColumn" class="at-link">@DiscriminatorColumn</a></code>和<code><a target="_blank" href="https://github.com/DiscriminatorValue" title="@DiscriminatorValue" class="at-link">@DiscriminatorValue</a></code>注释，以便根据层次结构策略映射表。</p> 
 <p>在每个层次结构一张表的情况下，只需要一个表来映射继承层次结构。 这里，在表中创建一个额外的列(也称为<code>discriminator</code>列)来标识该类。</p> 
 <p>下面来看看看继承层次结构：</p> 
 <p><img src="http://www.yiibai.com/uploads/images/201703/2603/250130338_67627.jpg" alt=""></p> 
 <p>这个层次结构中有三个类。 <code>Employee</code>是<code>Regular_Employee</code>和<code>Contract_Employee</code>类的父类。</p> 
 <p>此层次结构的表结构如下所示：</p> 
 <table> 
  <thead> 
   <tr> 
    <th>列名</th> 
    <th>数据类型</th> 
    <th>是否为空</th> 
    <th>默认值</th> 
    <th>是否主键</th> 
   </tr> 
  </thead> 
  <tbody> 
   <tr> 
    <td>id</td> 
    <td>int(10)</td> 
    <td>否</td> 
    <td>-</td> 
    <td>是</td> 
   </tr> 
   <tr> 
    <td>type</td> 
    <td>varchar(254)</td> 
    <td>否</td> 
    <td>-</td> 
    <td>-</td> 
   </tr> 
   <tr> 
    <td>name</td> 
    <td>varchar(254)</td> 
    <td>是</td> 
    <td>-</td> 
    <td>-</td> 
   </tr> 
   <tr> 
    <td>salary</td> 
    <td>float</td> 
    <td>是</td> 
    <td>-</td> 
    <td>-</td> 
   </tr> 
   <tr> 
    <td>bonus</td> 
    <td>int(10)</td> 
    <td>是</td> 
    <td>-</td> 
    <td>-</td> 
   </tr> 
   <tr> 
    <td>pay_per_hour</td> 
    <td>float</td> 
    <td>是</td> 
    <td>-</td> 
    <td>-</td> 
   </tr> 
   <tr> 
    <td>contract_duration</td> 
    <td></td> 
    <td>是</td> 
    <td>-</td> 
    <td>-</td> 
   </tr> 
  </tbody> 
 </table> 
 <h2 id="h2-u4F7Fu7528u6CE8u91CAu7684u6BCFu4E2Au5C42u6B21u7ED3u6784u4E00u5F20u8868u793Au4F8B"><a name="使用注释的每个层次结构一张表示例" class="reference-link"></a><span class="header-link octicon octicon-link"></span>使用注释的每个层次结构一张表示例</h2>
 <p>您需要按照以下步骤创建简单示例：</p> 
 <ul> 
  <li>创建持久化类</li>
  <li>创建配置文件</li>
  <li>创建类来存储提取数据</li>
 </ul> 
 <p>创建一个项目名称为：，其结构如下图所示 -<br><img src="http://www.yiibai.com/uploads/images/201703/2603/922140320_34774.png" alt=""></p> 
 <h3 id="h3-1-"><a name="1)创建持久类" class="reference-link"></a><span class="header-link octicon octicon-link"></span>1)创建持久类</h3>
 <p>您需要创建表示继承的持久化类。为上面的层次结构创建三个类：</p> 
 <p><em>文件：Employee.java</em></p> 
 <pre><code class="lang-java">package com.yiibai;

import javax.persistence.*;

@Entity  
@Table(name = "employee101")  
@Inheritance(strategy=InheritanceType.SINGLE_TABLE)  
@DiscriminatorColumn(name="type",discriminatorType=DiscriminatorType.STRING)  
@DiscriminatorValue(value="employee")  
public class Employee {
    @Id
    @GeneratedValue(strategy = GenerationType.AUTO)
    @Column(name = "id")
    private int id;

    @Column(name = "name")
    private String name;

    public int getId() {
        return id;
    }

    public void setId(int id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    // setters and getters
}
</code></pre> 
 <p><em>文件：Regular_Employee.java</em></p> 
 <pre><code class="lang-java">package com.yiibai;

/**
 * 
 * @author by maxsu
 * @copyright http://www.yiibai.com
 * @link download at: http://www.yiibai.com/siteinfo/download.html
 */
import javax.persistence.*;

@Entity  
@DiscriminatorValue("regularemployee")  
public class Regular_Employee extends Employee {

    @Column(name = "salary")
    private float salary;

    @Column(name = "bonus")
    private int bonus;

    public float getSalary() {
        return salary;
    }

    public void setSalary(float salary) {
        this.salary = salary;
    }

    public int getBonus() {
        return bonus;
    }

    public void setBonus(int bonus) {
        this.bonus = bonus;
    }

}
</code></pre> 
 <p><em>文件：Contract_Employee.java</em></p> 
 <pre><code class="lang-java">package com.yiibai;

/**
 * 
 * @author by maxsu
 * @copyright http://www.yiibai.com
 * @link download at: http://www.yiibai.com/siteinfo/download.html
 */
import javax.persistence.*;

@Entity  
@DiscriminatorValue("contractemployee")  
public class Contract_Employee extends Employee {

    @Column(name = "pay_per_hour")
    private float pay_per_hour;

    @Column(name = "contract_duration")
    private String contract_duration;

    public float getPay_per_hour() {
        return pay_per_hour;
    }

    public void setPay_per_hour(float payPerHour) {
        pay_per_hour = payPerHour;
    }

    public String getContract_duration() {
        return contract_duration;
    }

    public void setContract_duration(String contractDuration) {
        contract_duration = contractDuration;
    }
}
</code></pre> 
 <h3 id="h3-2-"><a name="2)在配置文件中添加持久化类" class="reference-link"></a><span class="header-link octicon octicon-link"></span>2)在配置文件中添加持久化类</h3>
 <p>打开<code>hibernate.cfg.xml</code>文件，并添加实体类的项，如下所示：</p> 
 <pre><code class="lang-xml">&lt;?xml version='1.0' encoding='UTF-8'?&gt;
&lt;!DOCTYPE hibernate-configuration PUBLIC
          "-//Hibernate/Hibernate Configuration DTD 3.0//EN"
          "http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"&gt;

&lt;!-- Generated by MyEclipse Hibernate Tools. --&gt;
&lt;hibernate-configuration&gt;

    &lt;session-factory&gt;
         &lt;property name="hbm2ddl.auto"&gt;update&lt;/property&gt;
        &lt;property name="connection.driver_class"&gt;com.mysql.jdbc.Driver&lt;/property&gt;
        &lt;property name="connection.url"&gt;jdbc:mysql://localhost:3306/test&lt;/property&gt;
        &lt;property name="connection.username"&gt;root&lt;/property&gt;
        &lt;property name="connection.password"&gt;123456&lt;/property&gt;
        &lt;property name="dialect"&gt;org.hibernate.dialect.MySQL5InnoDBDialect&lt;/property&gt;

        &lt;property name="show_sql"&gt;true&lt;/property&gt;
        &lt;mapping class="com.yiibai.Employee"/&gt;  
        &lt;mapping class="com.yiibai.Contract_Employee"/&gt;   
        &lt;mapping class="com.yiibai.Regular_Employee"/&gt;   
    &lt;/session-factory&gt;

&lt;/hibernate-configuration&gt;
</code></pre> 
 <p><code>hbm2ddl.auto</code>属性定义是用于在数据库中自动创建表。</p> 
 <h3 id="h3-3-"><a name="3)创建存储持久对象的类" class="reference-link"></a><span class="header-link octicon octicon-link"></span>3)创建存储持久对象的类</h3>
 <p>在这个类中，我们只是将 <code>Employee</code> 对象存储在数据库中。<br><em>文件：MainTest.java</em></p>   
 <pre><code class="lang-java">package com.yiibai;

import org.hibernate.*;
import org.hibernate.boot.MetadataSources;
import org.hibernate.boot.registry.StandardServiceRegistry;
import org.hibernate.boot.registry.StandardServiceRegistryBuilder;

/**
 * 
 * @author by maxsu
 * @copyright http://www.yiibai.com
 * @link download at: http://www.yiibai.com/siteinfo/download.html
 */

public class MainTest {
    public static void main(String[] args) {
        // 但在5.1.0版本汇总，hibernate则采用如下新方式获取：
        // 1. 配置类型安全的准服务注册类，这是当前应用的单例对象，不作修改，所以声明为final
        // 在configure("cfg/hibernate.cfg.xml")方法中，如果不指定资源路径，默认在类路径下寻找名为hibernate.cfg.xml的文件
        final StandardServiceRegistry registry = new StandardServiceRegistryBuilder()
                .configure("hibernate.cfg.xml").build();
        // 2. 根据服务注册类创建一个元数据资源集，同时构建元数据并生成应用一般唯一的的session工厂
        SessionFactory sessionFactory = new MetadataSources(registry)
                .buildMetadata().buildSessionFactory();

        /**** 上面是配置准备，下面开始我们的数据库操作 ******/
        Session session = sessionFactory.openSession();// 从会话工厂获取一个session

        // creating transaction object
        Transaction t = session.beginTransaction();

        Employee e1 = new Employee();
        e1.setName("用户名-01");

        Regular_Employee e2 = new Regular_Employee();
        e2.setName("yiibai su");
        e2.setSalary(50002);
        e2.setBonus(5);

        Contract_Employee e3 = new Contract_Employee();
        e3.setName("Mina su");
        e3.setPay_per_hour(1010);
        e3.setContract_duration("15 hours");

        session.persist(e1);
        session.persist(e2);
        session.persist(e3);

        t.commit();
        session.close();
        System.out.println("success");
    }
}
</code></pre> 
 <p>执行上面示例，输出结果如下 - </p> 
 <pre><code class="lang-shell">log4j:WARN No appenders could be found for logger (org.jboss.logging).
log4j:WARN Please initialize the log4j system properly.
log4j:WARN See http://logging.apache.org/log4j/1.2/faq.html#noconfig for more info.
Sun Mar 26 02:19:13 CST 2017 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.
Sun Mar 26 02:19:14 CST 2017 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.
Hibernate: select next_val as id_val from hibernate_sequence for update
Hibernate: update hibernate_sequence set next_val= ? where next_val=?
Hibernate: select next_val as id_val from hibernate_sequence for update
Hibernate: update hibernate_sequence set next_val= ? where next_val=?
Hibernate: select next_val as id_val from hibernate_sequence for update
Hibernate: update hibernate_sequence set next_val= ? where next_val=?
Hibernate: insert into employee101 (name, type, id) values (?, 'employee', ?)
Hibernate: insert into employee101 (name, bonus, salary, type, id) values (?, ?, ?, 'regularemployee', ?)
Hibernate: insert into employee101 (name, contract_duration, pay_per_hour, type, id) values (?, ?, ?, 'contractemployee', ?)
success
</code></pre> 
 <p>查看数据表，应该会看到相应的数据记录</p>
 <br>      
</div></body></html>
<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">集合Map映射（使用xml文件）</h1><div style="width:100%;float:left;" class="article-content">   
 <p>Hibernate允许我们将<code>Map</code>元素与RDBMS进行映射。 我们知道，<code>List</code>和<code>Map</code>是基于索引的集合。 在map的情况下，索引列作为键，元素列用作值。</p> 
 <h2 id="h2--xml-map-"><a name="使用xml文件在集合映射中映射Map的示例" class="reference-link"></a><span class="header-link octicon octicon-link"></span>使用xml文件在集合映射中映射Map的示例</h2>
 <p>现在，我们创建一个Java工程：<code>ternarystring</code>，项目的完整目录结构如下图所示 -</p> 
 <p><img src="http://www.yiibai.com/uploads/images/201703/2703/788140337_35215.png" alt=""></p> 
 <p>您需要创建以下页面来映射Map元素。</p> 
 <ul> 
  <li>Question.java</li>
  <li>question.hbm.xml</li>
  <li>hibernate.cfg.xml</li>
  <li>MainTest.java</li>
  <li>FetchTest.java</li>
 </ul> 
 <p><em>文件：Question.java</em> -</p> 
 <pre><code class="lang-java">package com.yiibai;

import java.util.Map;

public class Question {
    private int id;
    private String name, username;
    private Map&lt;String, String&gt; answers;

    public Question() {
    }

    public Question(String name, String username, Map&lt;String, String&gt; answers) {
        super();
        this.name = name;
        this.username = username;
        this.answers = answers;
    }

    public int getId() {
        return id;
    }

    public void setId(int id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public Map&lt;String, String&gt; getAnswers() {
        return answers;
    }

    public void setAnswers(Map&lt;String, String&gt; answers) {
        this.answers = answers;
    }

}
</code></pre> 
 <p><em>文件： question.hbm.xml</em> -</p> 
 <pre><code class="lang-xml">&lt;?xml version='1.0' encoding='UTF-8'?&gt;
&lt;!DOCTYPE hibernate-mapping PUBLIC
          "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
          "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd"&gt;

&lt;hibernate-mapping&gt;

    &lt;class name="com.yiibai.Question" table="question_736"&gt;
        &lt;id name="id"&gt;
            &lt;generator class="native"&gt;&lt;/generator&gt;
        &lt;/id&gt;
        &lt;property name="name"&gt;&lt;/property&gt;
        &lt;property name="username"&gt;&lt;/property&gt;

        &lt;map name="answers" table="answer736" cascade="all"&gt;
            &lt;key column="questionid"&gt;&lt;/key&gt;
            &lt;index column="answer" type="string"&gt;&lt;/index&gt;
            &lt;element column="username" type="string"&gt;&lt;/element&gt;
        &lt;/map&gt;
    &lt;/class&gt;

&lt;/hibernate-mapping&gt;
</code></pre> 
 <p><em>文件：hibernate.cfg.xml</em></p> 
 <pre><code class="lang-xml">&lt;?xml version='1.0' encoding='UTF-8'?&gt;
&lt;!DOCTYPE hibernate-configuration PUBLIC
          "-//Hibernate/Hibernate Configuration DTD 3.0//EN"
          "http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"&gt;

&lt;!-- Generated by MyEclipse Hibernate Tools. --&gt;
&lt;hibernate-configuration&gt;

    &lt;session-factory&gt;
        &lt;property name="hbm2ddl.auto"&gt;update&lt;/property&gt;

        &lt;property name="connection.driver_class"&gt;com.mysql.jdbc.Driver&lt;/property&gt;
        &lt;property name="connection.url"&gt;jdbc:mysql://localhost:3306/test&lt;/property&gt;
        &lt;property name="connection.username"&gt;root&lt;/property&gt;
        &lt;property name="connection.password"&gt;123456&lt;/property&gt;
        &lt;property name="dialect"&gt;org.hibernate.dialect.MySQL5InnoDBDialect&lt;/property&gt;
        &lt;property name="show_sql"&gt;true&lt;/property&gt;

        &lt;mapping resource="question.hbm.xml" /&gt;
    &lt;/session-factory&gt;

&lt;/hibernate-configuration&gt;
</code></pre> 
 <p><em>文件：MainTest.java</em></p> 
 <pre><code class="lang-java">package com.yiibai;

import java.util.HashMap;
import org.hibernate.*;
import org.hibernate.boot.MetadataSources;
import org.hibernate.boot.registry.StandardServiceRegistry;
import org.hibernate.boot.registry.StandardServiceRegistryBuilder;
import org.hibernate.cfg.*;

public class MainTest {
    public static void main(String[] args) {
        // 在5.1.0版本汇总，hibernate则采用如下新方式获取：
        // 1. 配置类型安全的准服务注册类，这是当前应用的单例对象，不作修改，所以声明为final
        // 在configure("cfg/hibernate.cfg.xml")方法中，如果不指定资源路径，默认在类路径下寻找名为hibernate.cfg.xml的文件
        final StandardServiceRegistry registry = new StandardServiceRegistryBuilder()
                .configure("hibernate.cfg.xml").build();
        // 2. 根据服务注册类创建一个元数据资源集，同时构建元数据并生成应用一般唯一的的session工厂
        SessionFactory sessionFactory = new MetadataSources(registry)
                .buildMetadata().buildSessionFactory();


        /**** 上面是配置准备，下面开始我们的数据库操作 ******/
        Session session = sessionFactory.openSession();// 从会话工厂获取一个session

        // creating transaction object
        Transaction t = session.beginTransaction();

        HashMap&lt;String, String&gt; map1 = new HashMap&lt;String, String&gt;();
        map1.put("java is a programming language", "John Lee ");
        map1.put("java is a platform", "Ashok Su");

        HashMap&lt;String, String&gt; map2 = new HashMap&lt;String, String&gt;();
        map2.put("servlet technology is a server side programming",
                "John Milton");
        map2.put("Servlet is an Interface", "Ashok Lee");
        map2.put("Servlet is a package", "Rahul Su");

        Question question1 = new Question("What is java?", "Alok", map1);
        Question question2 = new Question("What is servlet?", "Jai Dixit", map2);

        session.persist(question1);
        session.persist(question2);

        t.commit();
        session.close();
        System.out.println("successfully stored");
    }
}
</code></pre> 
 <p><em>文件： FetchTest.java</em> -</p> 
 <pre><code class="lang-java">package com.yiibai;

import java.util.*;
import org.hibernate.*;
import org.hibernate.cfg.*;

public class FetchTest {
    public static void main(String[] args) {
        Session session = new Configuration().configure().buildSessionFactory()
                .openSession();

        Query query = session.createQuery("from Question ");
        List&lt;Question&gt; list = query.list();

        Iterator&lt;Question&gt; iterator = list.iterator();
        while (iterator.hasNext()) {
            Question question = iterator.next();
            System.out.println("question id:" + question.getId());
            System.out.println("question name:" + question.getName());
            System.out.println("question posted by:" + question.getUsername());
            System.out.println("answers.....");
            Map&lt;String, String&gt; map = question.getAnswers();
            Set&lt;Map.Entry&lt;String, String&gt;&gt; set = map.entrySet();

            Iterator&lt;Map.Entry&lt;String, String&gt;&gt; iteratoranswer = set.iterator();
            while (iteratoranswer.hasNext()) {
                Map.Entry&lt;String, String&gt; entry = (Map.Entry&lt;String, String&gt;) iteratoranswer
                        .next();
                System.out.println("answer name:" + entry.getKey());
                System.out.println("answer posted by:" + entry.getValue());
            }
        }
        session.close();
    }
}
</code></pre> 
 <h2 id="h2-u8FD0u884Cu6D4Bu8BD5u7ED3u679C"><a name="运行测试结果" class="reference-link"></a><span class="header-link octicon octicon-link"></span>运行测试结果</h2>
 <p>首先，运行 <code>MainTest.java</code> 以插入数据，然后运行 <code>FetchTest.java</code>查询数据 -</p> 
 <ol> 
  <li><p>执行 <code>MainTest.java</code> 结果如下所示 -</p>   <pre><code class="lang-shell">log4j:WARN No appenders could be found for logger (org.jboss.logging).
log4j:WARN Please initialize the log4j system properly.
log4j:WARN See http://logging.apache.org/log4j/1.2/faq.html#noconfig for more info.
Mon Mar 27 02:31:54 CST 2017 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.
Hibernate: create table answer736 (questionid integer not null, answer varchar(255) not null, username varchar(255), primary key (questionid, answer)) engine=InnoDB
Hibernate: create table question_736 (id integer not null auto_increment, name varchar(255), username varchar(255), primary key (id)) engine=InnoDB
Hibernate: alter table answer736 add constraint FK8a0ar72dc6qqqh79ujtwm4w9o foreign key (questionid) references question_736 (id)
Hibernate: insert into question_736 (name, username) values (?, ?)
Hibernate: insert into question_736 (name, username) values (?, ?)
Hibernate: insert into answer736 (questionid, answer, username) values (?, ?, ?)
Hibernate: insert into answer736 (questionid, answer, username) values (?, ?, ?)
Hibernate: insert into answer736 (questionid, answer, username) values (?, ?, ?)
Hibernate: insert into answer736 (questionid, answer, username) values (?, ?, ?)
Hibernate: insert into answer736 (questionid, answer, username) values (?, ?, ?)
successfully stored
</code></pre> </li>
  <li><p>执行 <code>FetchTest.java</code> 结果如下所示 -</p> </li>
 </ol> 
 <pre><code class="lang-shell">log4j:WARN No appenders could be found for logger (org.jboss.logging).
log4j:WARN Please initialize the log4j system properly.
log4j:WARN See http://logging.apache.org/log4j/1.2/faq.html#noconfig for more info.
Mon Mar 27 02:34:17 CST 2017 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.
Hibernate: select question0_.id as id1_1_, question0_.name as name2_1_, question0_.username as username3_1_ from question_736 question0_
question id:1
question name:What is java?
question posted by:Alok
answers.....
Hibernate: select answers0_.questionid as question1_0_0_, answers0_.username as username3_0_0_, answers0_.answer as answer2_0_ from answer736 answers0_ where answers0_.questionid=?
answer name:java is a programming language
answer posted by:John Lee 
answer name:java is a platform
answer posted by:Ashok Su
question id:2
question name:What is servlet?
question posted by:Jai Dixit
answers.....
Hibernate: select answers0_.questionid as question1_0_0_, answers0_.username as username3_0_0_, answers0_.answer as answer2_0_ from answer736 answers0_ where answers0_.questionid=?
answer name:Servlet is a package
answer posted by:Rahul Su
answer name:servlet technology is a server side programming
answer posted by:John Milton
answer name:Servlet is an Interface
answer posted by:Ashok Lee
</code></pre>
 <br>      
</div></body></html>
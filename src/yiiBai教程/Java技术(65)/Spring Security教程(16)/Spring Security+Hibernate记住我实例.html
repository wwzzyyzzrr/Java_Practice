<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Spring Security+Hibernate记住我实例</h1><div style="width:100%;float:left;" class="article-content">   
 <div> 
  <div>
    本教程介绍了使用Spring&nbsp;Security与Hibernate实现"记住我"认证功能。 
  </div> 
 </div> 
 <div> 
  <hr> "记住我" 是持久登录认证，应用程序会记住会话用户的身份。基本上，在登录时当你使用"记住我"功能支持，应用程序会将一个cookie在登录成功后发送到浏览器。这个&nbsp;cookie 将被存储在浏览器端，并继续在一定期限(由cookie生命过期时间定义)。&nbsp;下一次，当您尝试访问该应用程序，浏览器将检测到的cookie(如果仍然有效)那么些用户将会自动登录，无需提供如用户ID/密码。 
  <div>
    Spring&nbsp;Security提供了两种&nbsp;“记住我”的实现： 
  </div> 
  <ul> 
   <li> 
    <div>
      简单基于散列标记的方法：它使用散列来保护基于cookie标记的安全性 
    </div> </li> 
   <li> 
    <div>
      持久化标记方法：它使用一个数据库或其他持久化存储机制来保存生成的标记 
    </div> </li> 
  </ul> 
  <div>
    在这篇文章中，我们将讨论关于持久化标记方法 
  </div> 
  <div>
    相对于正常登录教程文章作了一些以下的修改： 
  </div> 
  <div>
    1.持久化标记方法，数据库中添加一个名为：persistent_logins 的表，可以创建使用下面的SQL： 
  </div> 
  <pre>CREATE TABLE persistent_logins (
    username VARCHAR(64) NOT NULL,
    series VARCHAR(64) NOT NULL,
    token VARCHAR(64) NOT NULL,
    last_used TIMESTAMP NOT NULL,
    PRIMARY KEY (series)
);&nbsp;</pre> 
  <p> 此表包含用户名，“记住我”的最后一次活动时间(last_used时间戳)，Bcrypt内部实现安全令牌和一系列信息。&nbsp; </p> 
  <div>
    2.在Spring&nbsp;Security配置"记住我" 
  </div> 
  <pre>package com.yiibai.springsecurity.configuration;

import javax.sql.DataSource;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.web.authentication.rememberme.JdbcTokenRepositoryImpl;
import org.springframework.security.web.authentication.rememberme.PersistentTokenRepository;

@Configuration
@EnableWebSecurity
public class SecurityConfiguration extends WebSecurityConfigurerAdapter {

	@Autowired
	@Qualifier("customUserDetailsService")
	UserDetailsService userDetailsService;
	
	@Autowired
	DataSource dataSource;
	
	@Autowired
	public void configureGlobalSecurity(AuthenticationManagerBuilder auth) throws Exception {
		auth.userDetailsService(userDetailsService);
	}
	
	@Override
	protected void configure(HttpSecurity http) throws Exception {
	  http.authorizeRequests()
	  	.antMatchers("/", "/home").permitAll()
	  	.antMatchers("/admin/**").access("hasRole('ADMIN')")
	  	.antMatchers("/db/**").access("hasRole('ADMIN') and hasRole('DBA')")
	  	.and().formLogin().loginPage("/login")
	  	.usernameParameter("ssoId").passwordParameter("password")
	  	.and().rememberMe().rememberMeParameter("remember-me").tokenRepository(persistentTokenRepository()).tokenValiditySeconds(86400)
	  	.and().csrf()
	  	.and().exceptionHandling().accessDeniedPage("/Access_Denied");
	}
	
	@Bean
	public PersistentTokenRepository persistentTokenRepository() {
		JdbcTokenRepositoryImpl tokenRepositoryImpl = new JdbcTokenRepositoryImpl();
		tokenRepositoryImpl.setDataSource(dataSource);
		return tokenRepositoryImpl;
	}
}&nbsp;</pre> 
  <p> 请注意，我们可调用&nbsp;rememberMe()&nbsp;来配置记住我，在视图中提供一个“记住我”复选框身份验证的HTTP参数名称(我们将在视图中看到)。我们还指定要使用&nbsp;tokenRepository(令牌将被存储)，并将该令牌的时间(以秒为单位)仍然有效。要配置存储库时我们要注入了一个数据源。 </p> 
  <div>
    这是所有你需要激活"记住我"，在Spring&nbsp;Security基础的应用程序中。 
  </div> 
  <div>
    或者，可以使用
   <a target="_blank" href="http://docs.spring.io/spring-security/site/docs/4.0.1.RELEASE/reference/htmlsingle/#el-common-built-in">Spring&nbsp;Security内置表达</a>以及Spring&nbsp;security标签在您的视图根据特定的逻辑定制/显示/隐藏&nbsp;"记住我"或使用安全认证。 
  </div> 
  <div>
    注意：如果你不愿意使用JDBC，可能在应用程序是基于Hibernate，现在你可以参考
   <a target="_blank" href="http://yiibai.com/springmvc/spring-mvc-4-and-spring-security-4-integration-example/">Spring&nbsp;MVC+Spring&nbsp;Security+hibernate实例</a>，在这里我创建了一个基于Hibernate实现PersistentTokenRepository，它被命名为&nbsp;HibernateTokenRepositoryImpl。 
  </div> 
  <div>
    以上安全配置以XML配置格式为： 
  </div> 
  <pre>&lt;beans:beans xmlns="http://www.springframework.org/schema/security"
    xmlns:beans="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.1.xsd
    http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-4.0.xsd"&gt;
     
    &lt;http auto-config="true" &gt;
        &lt;intercept-url pattern="/" access="permitAll" /&gt;
        &lt;intercept-url pattern="/home" access="permitAll" /&gt;
        &lt;intercept-url pattern="/admin**" access="hasRole('ADMIN')" /&gt;
        &lt;intercept-url pattern="/dba**" access="hasRole('ADMIN') and hasRole('DBA')" /&gt;
        &lt;form-login  login-page="/login" 
                     username-parameter="ssoId" 
                     password-parameter="password" 
                     authentication-failure-url="/Access_Denied" /&gt;
        &lt;csrf/&gt;
    &lt;/http&gt;
 
    &lt;authentication-manager &gt;
        &lt;authentication-provider user-service-ref="customUserDetailsService"/&gt;
    &lt;/authentication-manager&gt;
     
    &lt;remember-me 
        remember-me-parameter="remember-me"
        remember-me-cookie="remember-me"
        token-validity-seconds="86400"
	data-source-ref="dataSource" /&gt;

    &lt;beans:bean id="customUserDetailsService" class="com.yiibai.springsecurity.service.CustomUserDetailsService" /&gt;
    
&lt;/beans:beans&gt;</pre> 
  <div>
    完整的代码示例如下所示。 
  </div> 
  <hr> 
  <h4> 
   <div>
     完整的示例 
   </div> </h4> 
  <div>
    需要使用到以下技术： 
  </div> 
  <ul> 
   <li> Spring 4.1.6.RELEASE </li> 
   <li> Spring Security 4.0.1.RELEASE </li> 
   <li> Hibernate 4.3.6.Final </li> 
   <li> MySQL Server 5.6 </li> 
   <li> Maven 3 </li> 
   <li> JDK 1.7 </li> 
   <li> Tomcat 8.0.21 </li> 
   <li> Eclipse JUNO Service Release 2 </li> 
  </ul> 
  <p> 现在就让我们开始吧！ </p> 
  <h4> 第1步: 工程目录结构 </h4> 
  <div>
    这时是最终的项目结构：
   <br> 
   <img src="/uploads/tutorial/20160823/160r3224431_1_c4.png" alt="">
   <br> 
   <img src="/uploads/tutorial/20160823/160r3224447_1_538.png" alt="">
   <br> 
  </div> 
  <h4> 
   <div>
     第2步：更新&nbsp;pom.xml&nbsp;以包括所需的相关性 
   </div> </h4> 
  <pre>&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

  &lt;groupId&gt;com.yiibai.springsecurity&lt;/groupId&gt;
  &lt;artifactId&gt;SpringSecurityRememberMeAnnotationExample&lt;/artifactId&gt;
  &lt;version&gt;1.0.0&lt;/version&gt;
  &lt;packaging&gt;war&lt;/packaging&gt;

  &lt;name&gt;SpringSecurityRememberMeAnnotationExample&lt;/name&gt;

 	&lt;properties&gt;
		&lt;springframework.version&gt;4.1.6.RELEASE&lt;/springframework.version&gt;
		&lt;springsecurity.version&gt;4.0.1.RELEASE&lt;/springsecurity.version&gt;
		&lt;hibernate.version&gt;4.3.6.Final&lt;/hibernate.version&gt;
		&lt;mysql.version&gt;5.1.31&lt;/mysql.version&gt;
	&lt;/properties&gt;

	&lt;dependencies&gt;
	
		&lt;!-- Spring --&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework&lt;/groupId&gt;
			&lt;artifactId&gt;spring-core&lt;/artifactId&gt;
			&lt;version&gt;${springframework.version}&lt;/version&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework&lt;/groupId&gt;
			&lt;artifactId&gt;spring-web&lt;/artifactId&gt;
			&lt;version&gt;${springframework.version}&lt;/version&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework&lt;/groupId&gt;
			&lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt;
			&lt;version&gt;${springframework.version}&lt;/version&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework&lt;/groupId&gt;
			&lt;artifactId&gt;spring-tx&lt;/artifactId&gt;
			&lt;version&gt;${springframework.version}&lt;/version&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework&lt;/groupId&gt;
			&lt;artifactId&gt;spring-orm&lt;/artifactId&gt;
			&lt;version&gt;${springframework.version}&lt;/version&gt;
		&lt;/dependency&gt;
		

		&lt;!-- Spring Security --&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
			&lt;artifactId&gt;spring-security-web&lt;/artifactId&gt;
			&lt;version&gt;${springsecurity.version}&lt;/version&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
			&lt;artifactId&gt;spring-security-config&lt;/artifactId&gt;
			&lt;version&gt;${springsecurity.version}&lt;/version&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
			&lt;artifactId&gt;spring-security-taglibs&lt;/artifactId&gt;
			&lt;version&gt;${springsecurity.version}&lt;/version&gt;
		&lt;/dependency&gt;

		&lt;!-- Hibernate --&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.hibernate&lt;/groupId&gt;
			&lt;artifactId&gt;hibernate-core&lt;/artifactId&gt;
			&lt;version&gt;${hibernate.version}&lt;/version&gt;
		&lt;/dependency&gt;

		&lt;!-- MySQL --&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;mysql&lt;/groupId&gt;
			&lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
			&lt;version&gt;${mysql.version}&lt;/version&gt;
		&lt;/dependency&gt;

		&lt;dependency&gt;
			&lt;groupId&gt;javax.servlet&lt;/groupId&gt;
			&lt;artifactId&gt;javax.servlet-api&lt;/artifactId&gt;
			&lt;version&gt;3.1.0&lt;/version&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;javax.servlet.jsp&lt;/groupId&gt;
			&lt;artifactId&gt;javax.servlet.jsp-api&lt;/artifactId&gt;
			&lt;version&gt;2.3.1&lt;/version&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;javax.servlet&lt;/groupId&gt;
			&lt;artifactId&gt;jstl&lt;/artifactId&gt;
			&lt;version&gt;1.2&lt;/version&gt;
		&lt;/dependency&gt;
	&lt;/dependencies&gt;

	&lt;build&gt;
		&lt;pluginManagement&gt;
			&lt;plugins&gt;
				&lt;plugin&gt;
					&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
					&lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
					&lt;version&gt;3.2&lt;/version&gt;
					&lt;configuration&gt;
						&lt;source&gt;1.7&lt;/source&gt;
						&lt;target&gt;1.7&lt;/target&gt;
					&lt;/configuration&gt;
				&lt;/plugin&gt;
				&lt;plugin&gt;
					&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
					&lt;artifactId&gt;maven-war-plugin&lt;/artifactId&gt;
					&lt;version&gt;2.4&lt;/version&gt;
					&lt;configuration&gt;
						&lt;warSourceDirectory&gt;src/main/webapp&lt;/warSourceDirectory&gt;
						&lt;warName&gt;SpringSecurityRememberMeAnnotationExample&lt;/warName&gt;
						&lt;failOnMissingWebXml&gt;false&lt;/failOnMissingWebXml&gt;
					&lt;/configuration&gt;
				&lt;/plugin&gt;
			&lt;/plugins&gt;
		&lt;/pluginManagement&gt;
		&lt;finalName&gt;SpringSecurityRememberMeAnnotationExample&lt;/finalName&gt;
	&lt;/build&gt;
&lt;/project&gt;</pre> 
  <h2> 数据库表部分 </h2> 
  <h4> 
   <div>
     第3步：创建数据库模式并填充数据 
   </div> </h4> 
  <pre>/* For Remember-Me token storage purpose */
CREATE TABLE persistent_logins (
    username VARCHAR(64) NOT NULL,
    series VARCHAR(64) NOT NULL,
    token VARCHAR(64) NOT NULL,
    last_used TIMESTAMP NOT NULL,
    PRIMARY KEY (series)
);


/*All User's gets stored in APP_USER table*/
create table APP_USER (
   id BIGINT NOT NULL AUTO_INCREMENT,
   sso_id VARCHAR(30) NOT NULL,
   password VARCHAR(100) NOT NULL,
   first_name VARCHAR(30) NOT NULL,
   last_name  VARCHAR(30) NOT NULL,
   email VARCHAR(30) NOT NULL,
   state VARCHAR(30) NOT NULL, 	
   PRIMARY KEY (id),
   UNIQUE (sso_id)
);
 
/* USER_PROFILE table contains all possible roles */  
create table USER_PROFILE(
   id BIGINT NOT NULL AUTO_INCREMENT,
   type VARCHAR(30) NOT NULL,
   PRIMARY KEY (id),
   UNIQUE (type)
);
 
/* JOIN TABLE for MANY-TO-MANY relationship*/   
CREATE TABLE APP_USER_USER_PROFILE (
    user_id BIGINT NOT NULL,
    user_profile_id BIGINT NOT NULL,
    PRIMARY KEY (user_id, user_profile_id),
    CONSTRAINT FK_APP_USER FOREIGN KEY (user_id) REFERENCES APP_USER (id),
    CONSTRAINT FK_USER_PROFILE FOREIGN KEY (user_profile_id) REFERENCES USER_PROFILE (id)
);

/* Populate USER_PROFILE Table */
INSERT INTO USER_PROFILE(type)
VALUES ('USER');

INSERT INTO USER_PROFILE(type)
VALUES ('ADMIN');

INSERT INTO USER_PROFILE(type)
VALUES ('DBA');

/* Populate one Admin User. We need only one user to demonstrate this example. You can add more as done in previous posts*/
INSERT INTO APP_USER(sso_id, password, first_name, last_name, email, state)
VALUES ('sam','abc125', 'Sam','Smith','samy@xyz.com', 'Active');

/* Populate JOIN Table */
INSERT INTO APP_USER_USER_PROFILE (user_id, user_profile_id)
  SELECT user.id, profile.id FROM app_user user, user_profile profile
  where user.sso_id='sam' and profile.type='ADMIN';</pre> 
  <h2> 安全部分 </h2> 
  <h4> 
   <div>
     第4步：添加&nbsp;Spring&nbsp;Security&nbsp;配置类 
   </div> </h4> 
  <pre>package com.yiibai.springsecurity.configuration;

import javax.sql.DataSource;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.web.authentication.rememberme.JdbcTokenRepositoryImpl;
import org.springframework.security.web.authentication.rememberme.PersistentTokenRepository;

@Configuration
@EnableWebSecurity
public class SecurityConfiguration extends WebSecurityConfigurerAdapter {

	@Autowired
	@Qualifier("customUserDetailsService")
	UserDetailsService userDetailsService;
	
	@Autowired
	DataSource dataSource;
	
	@Autowired
	public void configureGlobalSecurity(AuthenticationManagerBuilder auth) throws Exception {
		auth.userDetailsService(userDetailsService);
	}
	
	@Override
	protected void configure(HttpSecurity http) throws Exception {
	  http.authorizeRequests()
	  	.antMatchers("/", "/home").permitAll()
	  	.antMatchers("/admin/**").access("hasRole('ADMIN')")
	  	.antMatchers("/db/**").access("hasRole('ADMIN') and hasRole('DBA')")
	  	.and().formLogin().loginPage("/login")
	  	.usernameParameter("ssoId").passwordParameter("password")
	  	.and().rememberMe().rememberMeParameter("remember-me").tokenRepository(persistentTokenRepository()).tokenValiditySeconds(86400)
	  	.and().csrf()
	  	.and().exceptionHandling().accessDeniedPage("/Access_Denied");
	  	
	}
	
	@Bean
	public PersistentTokenRepository persistentTokenRepository() {
		JdbcTokenRepositoryImpl tokenRepositoryImpl = new JdbcTokenRepositoryImpl();
		tokenRepositoryImpl.setDataSource(dataSource);
		return tokenRepositoryImpl;
	}
}</pre> 
  <h4> 
   <div>
     第5步：使用war注册springSecurityFilter 
   </div> </h4> 
  <div>
    下面指定的初始化类注册&nbsp;springSecurityFilter&nbsp;与应用程序&nbsp;war&nbsp;[步骤3中创建]。 
  </div> 
  <pre>package com.yiibai.springsecurity.configuration;

import org.springframework.security.web.context.AbstractSecurityWebApplicationInitializer;

public class SecurityWebApplicationInitializer extends AbstractSecurityWebApplicationInitializer {

}</pre> 
  <p> 以上配置以XML配置格式为： </p> 
  <pre>&lt;filter&gt;
    &lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;
    &lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;/filter-class&gt;
&lt;/filter&gt;

&lt;filter-mapping&gt;
    &lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;</pre> 
  <h4> 
   <div>
     第6步：定义UserDetailsService实现 
   </div> </h4> 
  <div>
    这项服务是负责提供身份验证细节和验证管理。 
  </div> 
  <pre>package com.yiibai.springsecurity.service;

import java.util.ArrayList;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.yiibai.springsecurity.model.User;
import com.yiibai.springsecurity.model.UserProfile;

@Service("customUserDetailsService")
public class CustomUserDetailsService implements UserDetailsService{

	@Autowired
	private UserService userService;
	
	@Transactional(readOnly=true)
	public UserDetails loadUserByUsername(String ssoId)
			throws UsernameNotFoundException {
		User user = userService.findBySso(ssoId);
		System.out.println("User : "+user);
		if(user==null){
			System.out.println("User not found");
			throw new UsernameNotFoundException("Username not found");
		}
			return new org.springframework.security.core.userdetails.User(user.getSsoId(), user.getPassword(), 
				 user.getState().equals("Active"), true, true, true, getGrantedAuthorities(user));
	}

	
	private List&lt;GrantedAuthority&gt; getGrantedAuthorities(User user){
		List&lt;GrantedAuthority&gt; authorities = new ArrayList&lt;GrantedAuthority&gt;();
		
		for(UserProfile userProfile : user.getUserProfiles()){
			System.out.println("UserProfile : "+userProfile);
			authorities.add(new SimpleGrantedAuthority("ROLE_"+userProfile.getType()));
		}
		System.out.print("authorities :"+authorities);
		return authorities;
	}
	
}</pre> 
  <h2> SpringMVC部分 </h2> 
  <h4> 第7步: 添加控制器 </h4> 
  <pre>package com.yiibai.springsecurity.controller;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

@Controller
public class HelloWorldController {

	
	@RequestMapping(value = { "/", "/home" }, method = RequestMethod.GET)
	public String homePage(ModelMap model) {
		model.addAttribute("greeting", "Hi, Welcome to mysite");
		return "welcome";
	}

	@RequestMapping(value = "/admin", method = RequestMethod.GET)
	public String adminPage(ModelMap model) {
		model.addAttribute("user", getPrincipal());
		return "admin";
	}

	@RequestMapping(value = "/db", method = RequestMethod.GET)
	public String dbaPage(ModelMap model) {
		model.addAttribute("user", getPrincipal());
		return "dba";
	}

	@RequestMapping(value = "/Access_Denied", method = RequestMethod.GET)
	public String accessDeniedPage(ModelMap model) {
		model.addAttribute("user", getPrincipal());
		return "accessDenied";
	}

	@RequestMapping(value = "/login", method = RequestMethod.GET)
	public String loginPage() {
		return "login";
	}

	@RequestMapping(value="/logout", method = RequestMethod.GET)
	public String logoutPage (HttpServletRequest request, HttpServletResponse response) {
		Authentication auth = SecurityContextHolder.getContext().getAuthentication();
		if (auth != null){    
			new SecurityContextLogoutHandler().logout(request, response, auth);
		}
		return "redirect:/login?logout";
	}

	private String getPrincipal(){
		String userName = null;
		Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();

		if (principal instanceof UserDetails) {
			userName = ((UserDetails)principal).getUsername();
		} else {
			userName = principal.toString();
		}
		return userName;
	}


}</pre> 
  <h4> 第8步: 添加 SpringMVC 配置类 </h4> 
  <pre>package com.yiibai.springsecurity.configuration;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.ViewResolver;
import org.springframework.web.servlet.config.annotation.EnableWebMvc;
import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurerAdapter;
import org.springframework.web.servlet.view.InternalResourceViewResolver;
import org.springframework.web.servlet.view.JstlView;

@Configuration
@EnableWebMvc
@ComponentScan(basePackages = "com.yiibai.springsecurity")
public class HelloWorldConfiguration extends WebMvcConfigurerAdapter {
	
	@Bean(name="HelloWorld")
	public ViewResolver viewResolver() {
		InternalResourceViewResolver viewResolver = new InternalResourceViewResolver();
		viewResolver.setViewClass(JstlView.class);
		viewResolver.setPrefix("/WEB-INF/views/");
		viewResolver.setSuffix(".jsp");

		return viewResolver;
	}

    /*
     * Configure ResourceHandlers to serve static resources like CSS/ Javascript etc...
     *
     */
    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler("/static/**").addResourceLocations("/static/");
    }
}</pre> 
  <h4> 第9步: 添加初始化类 </h4> 
  <pre>package com.yiibai.springsecurity.configuration;

import org.springframework.web.servlet.support.AbstractAnnotationConfigDispatcherServletInitializer;

public class SpringMvcInitializer extends AbstractAnnotationConfigDispatcherServletInitializer {

	@Override
	protected Class&lt;?&gt;[] getRootConfigClasses() {
		return new Class[] { HelloWorldConfiguration.class };
	}
 
	@Override
	protected Class&lt;?&gt;[] getServletConfigClasses() {
		return null;
	}
 
	@Override
	protected String[] getServletMappings() {
		return new String[] { "/" };
	}

}</pre> 
  <h2> Hibernate配置部分 </h2> 
  <h4> 第10步: 创建Hibernate配置 </h4> 
  <div>
    Hibernate配置类包含数据源层，SessionFactory和事务管理的@Bean方法。数据源属性是取自&nbsp;application.properties&nbsp;文件，包含MySQL数据库详细连接信息。 
  </div> 
  <pre>package com.yiibai.springsecurity.configuration;

import java.util.Properties;

import javax.sql.DataSource;

import org.hibernate.SessionFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.PropertySource;
import org.springframework.core.env.Environment;
import org.springframework.jdbc.datasource.DriverManagerDataSource;
import org.springframework.orm.hibernate4.HibernateTransactionManager;
import org.springframework.orm.hibernate4.LocalSessionFactoryBean;
import org.springframework.transaction.annotation.EnableTransactionManagement;

@Configuration
@EnableTransactionManagement
@ComponentScan({ "com.yiibai.springsecurity.configuration" })
@PropertySource(value = { "classpath:application.properties" })
public class HibernateConfiguration {

    @Autowired
    private Environment environment;

    @Bean
    public LocalSessionFactoryBean sessionFactory() {
        LocalSessionFactoryBean sessionFactory = new LocalSessionFactoryBean();
        sessionFactory.setDataSource(dataSource());
        sessionFactory.setPackagesToScan(new String[] { "com.yiibai.springsecurity.model" });
        sessionFactory.setHibernateProperties(hibernateProperties());
        return sessionFactory;
     }
	
    @Bean
    public DataSource dataSource() {
        DriverManagerDataSource dataSource = new DriverManagerDataSource();
        dataSource.setDriverClassName(environment.getRequiredProperty("jdbc.driverClassName"));
        dataSource.setUrl(environment.getRequiredProperty("jdbc.url"));
        dataSource.setUsername(environment.getRequiredProperty("jdbc.username"));
        dataSource.setPassword(environment.getRequiredProperty("jdbc.password"));
        return dataSource;
    }
    
    private Properties hibernateProperties() {
        Properties properties = new Properties();
        properties.put("hibernate.dialect", environment.getRequiredProperty("hibernate.dialect"));
        properties.put("hibernate.show_sql", environment.getRequiredProperty("hibernate.show_sql"));
        properties.put("hibernate.format_sql", environment.getRequiredProperty("hibernate.format_sql"));
        return properties;        
    }
    
    @Bean
    @Autowired
    public HibernateTransactionManager transactionManager(SessionFactory s) {
       HibernateTransactionManager txManager = new HibernateTransactionManager();
       txManager.setSessionFactory(s);
       return txManager;
    }
}</pre> 
  <p> application.properties </p> 
  <pre>jdbc.driverClassName = com.mysql.jdbc.Driver
jdbc.url = jdbc:mysql://localhost:3306/yiibai
jdbc.username = myuser
jdbc.password = mypassword
hibernate.dialect = org.hibernate.dialect.MySQLDialect
hibernate.show_sql = true
hibernate.format_sql = true</pre> 
  <h2> DAO, Model &amp; Service服务 </h2> 
  <h4> 第11步: 创建模型类 </h4> 
  <div>
    用户可以有多个角色[DBA，ADMIN，USER]。而角色可以被分配给一个以上的用户。因此，有一个用户和用户配置[角色]之间存在多对多的关系。我们保持这种关系单向[用户到用户配置]，因为我们只是在查找对于给用户的角色。我们将使用使用连接表来实现多一对多关联。 
  </div>   
  <pre>package com.yiibai.springsecurity.model;

import java.util.HashSet;
import java.util.Set;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.FetchType;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.JoinColumn;
import javax.persistence.JoinTable;
import javax.persistence.ManyToMany;
import javax.persistence.Table;

@Entity
@Table(name="APP_USER")
public class User {

	@Id @GeneratedValue(strategy=GenerationType.IDENTITY)
	private int id;

	@Column(name="SSO_ID", unique=true, nullable=false)
	private String ssoId;
	
	@Column(name="PASSWORD", nullable=false)
	private String password;
		
	@Column(name="FIRST_NAME", nullable=false)
	private String firstName;

	@Column(name="LAST_NAME", nullable=false)
	private String lastName;

	@Column(name="EMAIL", nullable=false)
	private String email;

	@Column(name="STATE", nullable=false)
	private String state=State.ACTIVE.getState();

	@ManyToMany(fetch = FetchType.EAGER)
	@JoinTable(name = "APP_USER_USER_PROFILE", 
             joinColumns = { @JoinColumn(name = "USER_ID") }, 
             inverseJoinColumns = { @JoinColumn(name = "USER_PROFILE_ID") })
	private Set&lt;UserProfile&gt; userProfiles = new HashSet&lt;UserProfile&gt;();

	public int getId() {
		return id;
	}

	public void setId(int id) {
		this.id = id;
	}

	public String getSsoId() {
		return ssoId;
	}

	public void setSsoId(String ssoId) {
		this.ssoId = ssoId;
	}

	public String getPassword() {
		return password;
	}

	public void setPassword(String password) {
		this.password = password;
	}

	public String getFirstName() {
		return firstName;
	}

	public void setFirstName(String firstName) {
		this.firstName = firstName;
	}

	public String getLastName() {
		return lastName;
	}

	public void setLastName(String lastName) {
		this.lastName = lastName;
	}

	public String getEmail() {
		return email;
	}

	public void setEmail(String email) {
		this.email = email;
	}

	public String getState() {
		return state;
	}

	public void setState(String state) {
		this.state = state;
	}

	public Set&lt;UserProfile&gt; getUserProfiles() {
		return userProfiles;
	}

	public void setUserProfiles(Set&lt;UserProfile&gt; userProfiles) {
		this.userProfiles = userProfiles;
	}

	@Override
	public int hashCode() {
		final int prime = 31;
		int result = 1;
		result = prime * result + id;
		result = prime * result + ((ssoId == null) ? 0 : ssoId.hashCode());
		return result;
	}

	@Override
	public boolean equals(Object obj) {
		if (this == obj)
			return true;
		if (obj == null)
			return false;
		if (!(obj instanceof User))
			return false;
		User other = (User) obj;
		if (id != other.id)
			return false;
		if (ssoId == null) {
			if (other.ssoId != null)
				return false;
		} else if (!ssoId.equals(other.ssoId))
			return false;
		return true;
	}

	@Override
	public String toString() {
		return "User [id=" + id + ", ssoId=" + ssoId + ", password=" + password
				+ ", firstName=" + firstName + ", lastName=" + lastName
				+ ", email=" + email + ", state=" + state + ", userProfiles=" + userProfiles +"]";
	}

	
}</pre> 
  <pre>package com.yiibai.springsecurity.model;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;

@Entity
@Table(name="USER_PROFILE")
public class UserProfile {

	@Id @GeneratedValue(strategy=GenerationType.IDENTITY)
	private int id;	

	@Column(name="TYPE", length=15, unique=true, nullable=false)
	private String type = UserProfileType.USER.getUserProfileType();
	
	public int getId() {
		return id;
	}

	public void setId(int id) {
		this.id = id;
	}

	public String getType() {
		return type;
	}

	public void setType(String type) {
		this.type = type;
	}


	@Override
	public int hashCode() {
		final int prime = 31;
		int result = 1;
		result = prime * result + id;
		result = prime * result + ((type == null) ? 0 : type.hashCode());
		return result;
	}

	@Override
	public boolean equals(Object obj) {
		if (this == obj)
			return true;
		if (obj == null)
			return false;
		if (!(obj instanceof UserProfile))
			return false;
		UserProfile other = (UserProfile) obj;
		if (id != other.id)
			return false;
		if (type == null) {
			if (other.type != null)
				return false;
		} else if (!type.equals(other.type))
			return false;
		return true;
	}

	@Override
	public String toString() {
		return "UserProfile [id=" + id + ",  type=" + type	+ "]";
	}
	

}</pre> 
  <pre>package com.yiibai.springsecurity.model;

public enum UserProfileType {
	USER("USER"),
	DBA("DBA"),
	ADMIN("ADMIN");
	
	String userProfileType;
	
	private UserProfileType(String userProfileType){
		this.userProfileType = userProfileType;
	}
	
	public String getUserProfileType(){
		return userProfileType;
	}
	
}</pre> 
  <pre>package com.yiibai.springsecurity.model;

public enum State {

	ACTIVE("Active"),
	INACTIVE("Inactive"),
	DELETED("Deleted"),
	LOCKED("Locked");
	
	private String state;
	
	private State(final String state){
		this.state = state;
	}
	
	public String getState(){
		return this.state;
	}

	@Override
	public String toString(){
		return this.state;
	}


	public String getName(){
		return this.name();
	}


}</pre> 
  <h4> 第12步: 创建 Dao 层 </h4> 
  <pre>package com.yiibai.springsecurity.dao;

import java.io.Serializable;

import java.lang.reflect.ParameterizedType;

import org.hibernate.Criteria;
import org.hibernate.Session;
import org.hibernate.SessionFactory;
import org.springframework.beans.factory.annotation.Autowired;

public abstract class AbstractDao&lt;PK extends Serializable, T&gt; {
	
	private final Class&lt;T&gt; persistentClass;
	
	@SuppressWarnings("unchecked")
	public AbstractDao(){
		this.persistentClass =(Class&lt;T&gt;) ((ParameterizedType) this.getClass().getGenericSuperclass()).getActualTypeArguments()[1];
	}
	
	@Autowired
	private SessionFactory sessionFactory;

	protected Session getSession(){
		return sessionFactory.getCurrentSession();
	}

	@SuppressWarnings("unchecked")
	public T getByKey(PK key) {
		return (T) getSession().get(persistentClass, key);
	}

	public void persist(T entity) {
		getSession().persist(entity);
	}

	public void delete(T entity) {
		getSession().delete(entity);
	}
	
	protected Criteria createEntityCriteria(){
		return getSession().createCriteria(persistentClass);
	}

}</pre> 
  <pre>package com.yiibai.springsecurity.dao;

import com.yiibai.springsecurity.model.User;

public interface UserDao {

	User findById(int id);
	
	User findBySSO(String sso);
	
}</pre> 
  <pre>package com.yiibai.springsecurity.dao;

import org.hibernate.Criteria;
import org.hibernate.criterion.Restrictions;
import org.springframework.stereotype.Repository;

import com.yiibai.springsecurity.model.User;

@Repository("userDao")
public class UserDaoImpl extends AbstractDao&lt;Integer, User&gt; implements UserDao {

	public User findById(int id) {
		return getByKey(id);
	}

	public User findBySSO(String sso) {
		Criteria crit = createEntityCriteria();
		crit.add(Restrictions.eq("ssoId", sso));
		return (User) crit.uniqueResult();
	}

	
}</pre> 
  <h4> 第13步: 创建Service层 </h4> 
  <pre>package com.yiibai.springsecurity.service;

import com.yiibai.springsecurity.model.User;

public interface UserService {

	User findById(int id);
	
	User findBySso(String sso);
	
}</pre> 
  <pre>package com.yiibai.springsecurity.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.yiibai.springsecurity.dao.UserDao;
import com.yiibai.springsecurity.model.User;

@Service("userService")
@Transactional
public class UserServiceImpl implements UserService{

	@Autowired
	private UserDao dao;

	public User findById(int id) {
		return dao.findById(id);
	}

	public User findBySso(String sso) {
		return dao.findBySSO(sso);
	}

}</pre> 
  <h2> 视图部分 </h2> 
  <h4> 
   <div>
     第14步：添加视图 
   </div> </h4> 
  <p> login.jsp </p> 
  <pre>&lt;%@ page language="java" contentType="text/html; charset=ISO-8859-1" pageEncoding="ISO-8859-1"%&gt;
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%&gt;
&lt;html&gt;
	&lt;head&gt;
		&lt;meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"&gt;
		&lt;title&gt;HelloWorld Login page&lt;/title&gt;
		&lt;link href="&lt;c:url value='/static/css/bootstrap.css' /&gt;"  rel="stylesheet"&gt;&lt;/link&gt;
		&lt;link href="&lt;c:url value='/static/css/app.css' /&gt;" rel="stylesheet"&gt;&lt;/link&gt;
		&lt;link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.css" /&gt;
	&lt;/head&gt;

	&lt;body&gt;
		&lt;div id="mainWrapper"&gt;
			&lt;div class="login-container"&gt;
				&lt;div class="login-card"&gt;
					&lt;div class="login-form"&gt;
						&lt;c:url var="loginUrl" value="/login" /&gt;
						&lt;form action="${loginUrl}" method="post" class="form-horizontal"&gt;
							&lt;c:if test="${param.error != null}"&gt;
								&lt;div class="alert alert-danger"&gt;
									&lt;p&gt;Invalid username and password.&lt;/p&gt;
								&lt;/div&gt;
							&lt;/c:if&gt;
							&lt;c:if test="${param.logout != null}"&gt;
								&lt;div class="alert alert-success"&gt;
									&lt;p&gt;You have been logged out successfully.&lt;/p&gt;
								&lt;/div&gt;
							&lt;/c:if&gt;
							&lt;div class="input-group input-sm"&gt;
								&lt;label class="input-group-addon" for="username"&gt;&lt;i class="fa fa-user"&gt;&lt;/i&gt;&lt;/label&gt;
								&lt;input type="text" class="form-control" id="username" name="ssoId" placeholder="Enter Username" required&gt;
							&lt;/div&gt;
							&lt;div class="input-group input-sm"&gt;
								&lt;label class="input-group-addon" for="password"&gt;&lt;i class="fa fa-lock"&gt;&lt;/i&gt;&lt;/label&gt; 
								&lt;input type="password" class="form-control" id="password" name="password" placeholder="Enter Password" required&gt;
							&lt;/div&gt;
                            &lt;div class="input-group input-sm"&gt;
                              &lt;div class="checkbox"&gt;
                                &lt;label&gt;&lt;input type="checkbox" id="rememberme" name="remember-me"&gt; Remember Me&lt;/label&gt;  
                              &lt;/div&gt;
							&lt;/div&gt;
							&lt;input type="hidden" name="${_csrf.parameterName}"
								value="${_csrf.token}" /&gt;
								
							&lt;div class="form-actions"&gt;
								&lt;input type="submit"
									class="btn btn-block btn-primary btn-default" value="Log in"&gt;
							&lt;/div&gt;
						&lt;/form&gt;
					&lt;/div&gt;
				&lt;/div&gt;
			&lt;/div&gt;
		&lt;/div&gt;

	&lt;/body&gt;
&lt;/html&gt;</pre> 
  <p> 正如你所看到的，CSRF参数需要在JSP中的EL表达式访问，所以还需要通过添将以下的代码添加JSP的顶部来强行执行EL表达式解析编译： </p> 
  <pre>&lt;%@ page isELIgnored="false"%&gt;</pre> 
  <p> admin.jsp </p> 
  <pre>&lt;%@ page language="java" contentType="text/html; charset=ISO-8859-1" pageEncoding="ISO-8859-1"%&gt;
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%&gt;
&lt;%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%&gt;

&lt;html&gt;
&lt;head&gt;
	&lt;meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"&gt;
	&lt;title&gt;Admin page&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
	Dear &lt;strong&gt;${user}&lt;/strong&gt;, Welcome to Admin Page.
	
	&lt;sec:authorize access="isFullyAuthenticated()"&gt;
		&lt;label&gt;&lt;a href="#"&gt;Create New User&lt;/a&gt; | &lt;a href="#"&gt;View existing Users&lt;/a&gt;&lt;/label&gt;
	&lt;/sec:authorize&gt;
	&lt;sec:authorize access="isRememberMe()"&gt;
		&lt;label&gt;&lt;a href="#"&gt;View existing Users&lt;/a&gt;&lt;/label&gt;
	&lt;/sec:authorize&gt;
 
	&lt;a href="&lt;c:url value="/logout" /&gt;"&gt;Logout&lt;/a&gt;
&lt;/body&gt;
&lt;/html&gt;</pre> 
  <div>
    以下提到的视图在这个帖子中不需要，只是在这里提及，作为一个完整的补充。 
  </div> 
  <p> welcome.jsp </p> 
  <pre>&lt;%@ page language="java" contentType="text/html; charset=ISO-8859-1" pageEncoding="ISO-8859-1"%&gt;
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%&gt;
&lt;html&gt;
&lt;head&gt;
	&lt;meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"&gt;
	&lt;title&gt;Welcome page&lt;/title&gt;
	&lt;link href="&lt;c:url value='/static/css/bootstrap.css' /&gt;" rel="stylesheet"&gt;&lt;/link&gt;
	&lt;link href="&lt;c:url value='/static/css/app.css' /&gt;" rel="stylesheet"&gt;&lt;/link&gt;
&lt;/head&gt;
&lt;body&gt;
	&lt;div class="success"&gt;
		Greeting : ${greeting}
		This is a welcome page.
	&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</pre> 
  <p> dba.jsp </p> 
  <pre>&lt;%@ page language="java" contentType="text/html; charset=ISO-8859-1"  pageEncoding="ISO-8859-1"%&gt;
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"&gt;
&lt;title&gt;DBA page&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
	Dear &lt;strong&gt;${user}&lt;/strong&gt;, Welcome to DBA Page.
	&lt;a href="&lt;c:url value="/logout" /&gt;"&gt;Logout&lt;/a&gt;
&lt;/body&gt;
&lt;/html&gt;</pre> 
  <p> accessDenied.jsp </p> 
  <pre>&lt;%@ page language="java" contentType="text/html; charset=ISO-8859-1" pageEncoding="ISO-8859-1"%&gt;
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%&gt;
&lt;html&gt;
&lt;head&gt;
	&lt;meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"&gt;
	&lt;title&gt;AccessDenied page&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
	Dear &lt;strong&gt;${user}&lt;/strong&gt;, You are not authorized to access this page
	&lt;a href="&lt;c:url value="/logout" /&gt;"&gt;Logout&lt;/a&gt;
&lt;/body&gt;
&lt;/html&gt;</pre> 
  <h4> </h4> 
  <h4> 
   <div>
     第16步 - 构建和部署应用程序 
   </div> </h4> 
  <p> 现在构造&nbsp;war(通过&nbsp;eclipse/m2eclipse)或通过Maven的命令行(mvn&nbsp;clean&nbsp;install)。部署WAR文件到Servlet3.0容器。由于这里我使用的是在&nbsp;eclipse&nbsp;中配置&nbsp;Tomcat，可以直接发布到&nbsp;Tomcat&nbsp;服务容器中。如果不知道怎么使用，可以参考：<a target="_blank" href="http://www.yiibai.com/maven/create-a-maven-web-project-with-eclipse.html">http://www.yiibai.com/maven/create-a-maven-web-project-with-eclipse.html</a> </p> 
  <div> 
   <strong>运行应用程序</strong> 
  </div> 
  <p> 打开浏览器并访问 -&nbsp;&nbsp;http://localhost:8080/SpringSecurityRememberMeAnnotation/admin </p> 
  <div>
    系统将提示您登录，如下图中所示 -&nbsp;
   <br> 
   <img src="/uploads/tutorial/20160823/160r3224533_1_a9.png" alt="">
   <br> 
  </div> 
  <div>
    使用"记住我"&nbsp;验证登录(使用用户：kenny/123456)，您将获得管理员视图，如下所示&nbsp;-&nbsp;
   <br> 
   <img src="/uploads/tutorial/20160823/160r3224550_1_a6.png" alt="">
   <br> 
  </div> 
  <div>
    验证查看 Cookies。打开谷歌浏览器设置/显示高级设置/内容设置/所有Cookie和网站数据显示本地主机。你会发现有两个&nbsp;cookies&nbsp;，一个用于当前会话[JSESSIONID]，一个用于"记住我"的身份验证。 
  </div> 
  <p> <img src="/uploads/tutorial/20160823/160r3224606_1_531.png" alt=""> </p> 
  <p> 点击"记住我"(remember-me)，查看cookie详细信息。你可以看到 cookie 的有效期是一天(如在安全配置设置)。 </p> 
  <div>
    现在查看 persistent_logins 表中数据。应该有当前用户的 Cookies 记录信息。
   <br> 
   <img src="/uploads/tutorial/20160823/160r3224647_1_h7.png" alt="">
   <br> 
  </div> 
  <p> 现在退出登录，如下图中所示 &nbsp;-&nbsp; </p> 
  <p> <img src="/uploads/tutorial/20160823/160r3224f0_1_e0.png" alt=""> </p> 
  <p> 现在再试尝试打开：http://localhost:8080/SpringSecurityRememberMeAnnotation/admin，应该直接登录，而不再需要使用输入用户名和密码登录。<br> <img src="/uploads/tutorial/20160823/160r3224g8_1_191.png" alt=""> </p> 
  <div>
    还可以看到&nbsp;“Create&nbsp;New&nbsp;User”&nbsp;选项不可用，这是因为一个是仅当用户(使用登录名/密码，例如)有权限的认证才能使用此功能，现在从Chrome中删除&nbsp;"记住我"&nbsp;的cookie(如前所示)，并再次尝试访问：
   <a target="_blank" href="http://localhost:8080/SpringSecurityRememberMeAnnotation/admin">http://localhost:8080/SpringSecurityRememberMeAnnotation/admin</a>，程序应该提示您登录。 
  </div> 
  <div>
    就这么多，
   <a target="_blank" href="http://yiibai.com/spring-security/spring-security-4-method-security-using-preauthorize-postauthorize-secured-el/">下一篇文章</a>我们将来学习使用&nbsp;Spring&nbsp;Security&nbsp;的&nbsp;@PreAuthorize，@PostAuthorize，@Secured和Spring&nbsp;EL表达式的方法级的安全控制。 
  </div> 
  <h4> 下载源代码 </h4> 
  <p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<a target="_blank" href="http://share.weiyun.com/6726def9217bbd3c4f1d6b6dd0cdbc16">11-SpringSecurityRememberMeAnnotation.zip</a> </p> 
  <h4> 参考 </h4> 
  <ul> 
   <li> 
    <div> 
     <a target="_blank" href="http://jaspan.com/improved_persistent_login_cookie_best_practice">改善永久登录cookie的最佳实践</a> 
    </div> </li> 
   <li> <a target="_blank" href="http://projects.spring.io/spring-security/">Spring Security 4 项目主页</a> </li> 
   <li> <a target="_blank" href="http://docs.spring.io/spring-security/site/docs/4.0.1.RELEASE/reference/htmlsingle/">Spring Security 4 参考手册</a> </li> 
  </ul> 
 </div>
 <br>      
</div></body></html>
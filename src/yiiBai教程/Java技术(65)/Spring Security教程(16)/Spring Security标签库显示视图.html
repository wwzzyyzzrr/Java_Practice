<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Spring Security标签库显示视图</h1><div style="width:100%;float:left;" class="article-content">   
 <div>
   本教程介绍了如何保护视图层，基于已登录用户的角色，使用Spring&nbsp;Security标签来显示/隐藏&nbsp;Spring&nbsp;MVC&nbsp;Web应用程序的JSP/视图。 
 </div> 
 <div> 
  <div>
    完整的工程结构如下所示 -&nbsp;
   <br> 
   <img src="/uploads/tutorial/20160820/160r0112t6_1_307.png" alt="">
   <br> 
  </div> 
  <hr> 
  <div>
    首先，为了使用Spring&nbsp;Security标签，我们需要在pom.xml中包括&nbsp;spring-security-taglibs&nbsp;标记库的依赖库，如下图所示：
   <br> 
   <pre class="prettyprint lang-xml">&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
			&lt;artifactId&gt;spring-security-taglibs&lt;/artifactId&gt;
			&lt;version&gt;4.0.1.RELEASE&lt;/version&gt;
		&lt;/dependency&gt;</pre> 
  </div> 
  <div>
    然后在下一步在&nbsp;视图/JSP&nbsp;包括这些标签库。如下代码所示 - 
  </div> 
  <pre>&lt;%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%&gt;</pre> 
  <p> 最后，我们就可以使用<a target="_blank" href="http://docs.spring.io/spring-security/site/docs/4.0.1.RELEASE/reference/htmlsingle/#el-common-built-in">Spring&nbsp;Security</a><a target="_blank" href="http://docs.spring.io/spring-security/site/docs/4.0.1.RELEASE/reference/htmlsingle/#el-common-built-in">表达式</a>类似 hasRole，hasAnyRole&nbsp;等。在视图中，如下图所示： </p> 
  <pre>&lt;%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%&gt;
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%&gt;
&lt;%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%&gt;
&lt;html&gt;
&lt;head&gt;
	&lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8"&gt;
	&lt;title&gt;Welcome page&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
	Dear &lt;strong&gt;${user}&lt;/strong&gt;, Welcome to Home Page.
	&lt;a href="&lt;c:url value="/logout" /&gt;"&gt;Logout&lt;/a&gt;

	&lt;br/&gt;
	&lt;br/&gt;
	&lt;div&gt;
		&lt;label&gt;View all information| This part is visible to Everyone&lt;/label&gt;
	&lt;/div&gt;

	&lt;br/&gt;
	&lt;div&gt;
		&lt;sec:authorize access="hasRole('ADMIN')"&gt;
			&lt;label&gt;&lt;a href="#"&gt;Edit this page&lt;/a&gt; | This part is visible only to ADMIN&lt;/label&gt;
		&lt;/sec:authorize&gt;
	&lt;/div&gt;

	&lt;br/&gt;
	&lt;div&gt;
		&lt;sec:authorize access="hasRole('ADMIN') and hasRole('DBA')"&gt;
			&lt;label&gt;&lt;a href="#"&gt;Start backup&lt;/a&gt; | This part is visible only to one who is both ADMIN &amp; DBA&lt;/label&gt;
		&lt;/sec:authorize&gt;
	&lt;/div&gt;
&lt;/html&gt;</pre> 
  <div>
    这里就是需要基于角色这个有选择地显示/隐藏视图片段，使用Spring&nbsp;Security表达式在视图中。 
  </div> 
  <div>
    以下是用于这个例子的&nbsp;Security&nbsp;配置： 
  </div> 
  <pre>package com.yiibai.springsecurity.configuration;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;

@Configuration
@EnableWebSecurity
public class SecurityConfiguration extends WebSecurityConfigurerAdapter {

	
	@Autowired
	public void configureGlobalSecurity(AuthenticationManagerBuilder auth) throws Exception {
		auth.inMemoryAuthentication().withUser("yiibai").password("123456").roles("USER");
		auth.inMemoryAuthentication().withUser("admin").password("123456").roles("ADMIN");
		auth.inMemoryAuthentication().withUser("dba").password("123456").roles("ADMIN","DBA");
	}
	
	@Override
	protected void configure(HttpSecurity http) throws Exception {
	  
	  http.authorizeRequests()
	  	.antMatchers("/", "/home").access("hasRole('USER') or hasRole('ADMIN') or hasRole('DBA')")
	  	.and().formLogin().loginPage("/login")
	  	.usernameParameter("ssoId").passwordParameter("password")
	  	.and().exceptionHandling().accessDeniedPage("/Access_Denied");
	}
}</pre> 
  <div>
    上面的安全配置基于XML配置格式如下所示： 
  </div> 
  <pre>&lt;beans:beans xmlns="http://www.springframework.org/schema/security"
    xmlns:beans="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.1.xsd
    http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-4.0.xsd"&gt;
     
    &lt;http auto-config="true" &gt;
        &lt;intercept-url pattern="/"     access="hasRole('USER') or hasRole('ADMIN') or hasRole('DBA')" /&gt;
        &lt;intercept-url pattern="/home" access="hasRole('USER') or hasRole('ADMIN') or hasRole('DBA')" /&gt;
        &lt;form-login  login-page="/login" 
                     username-parameter="ssoId" 
                     password-parameter="password" 
                     authentication-failure-url="/Access_Denied" /&gt;
    &lt;/http&gt;
 
    &lt;authentication-manager &gt;
        &lt;authentication-provider&gt;
            &lt;user-service&gt;
                &lt;user name="yiibai"  password="123456"  authorities="ROLE_USER" /&gt;
                &lt;user name="admin" password="123456" authorities="ROLE_ADMIN" /&gt;
                &lt;user name="dba"   password="123456" authorities="ROLE_ADMIN,ROLE_DBA" /&gt;
            &lt;/user-service&gt;
        &lt;/authentication-provider&gt;
    &lt;/authentication-manager&gt;
     
    
&lt;/beans:beans&gt;</pre> 
  <p> 下面是控制器的完整代码，如下所示 - </p> 
  <pre>package com.yiibai.springsecurity.controller;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

@Controller
public class HelloWorldController {

	
	@RequestMapping(value = { "/", "/home" }, method = RequestMethod.GET)
	public String homePage(ModelMap model) {
		model.addAttribute("user", getPrincipal());
		return "welcome";
	}

	@RequestMapping(value = "/Access_Denied", method = RequestMethod.GET)
	public String accessDeniedPage(ModelMap model) {
		model.addAttribute("user", getPrincipal());
		return "accessDenied";
	}

	@RequestMapping(value = "/login", method = RequestMethod.GET)
	public String loginPage() {
		return "login";
	}

	@RequestMapping(value="/logout", method = RequestMethod.GET)
	public String logoutPage (HttpServletRequest request, HttpServletResponse response) {
		Authentication auth = SecurityContextHolder.getContext().getAuthentication();
		if (auth != null){    
			new SecurityContextLogoutHandler().logout(request, response, auth);
		}
		return "redirect:/login?logout";
	}

	private String getPrincipal(){
		String userName = null;
		Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();

		if (principal instanceof UserDetails) {
			userName = ((UserDetails)principal).getUsername();
		} else {
			userName = principal.toString();
		}
		return userName;
	}

}</pre> 
  <div>
    应用程序的其余部分代码和这个系列的其他教程文章是相同的。 
  </div> 
  <h4> 部署和运行 </h4> 
  <div>
    如需要自己动手实践，可在文章底部提供的下载链接并点击下载本示例代码，这个项目的完整代码。它是在Servlet&nbsp;3.0的容器(Tomcat7/8，本文章使用&nbsp;Tomcat7)上构建和部署运行的。 
  </div> 
  <div>
    打开您的浏览器，在地址栏中输入网址：
   <a target="_blank" href="http://localhost:8080/SpringSecurityTaglibs">http://localhost:8080/SpringSecurityTaglibs</a>，默认的页面将显示(提示登录页面)如下&nbsp;-&nbsp;
   <br> 
   <img src="/uploads/tutorial/20160820/160r0113125_1_3p.png" alt="">
   <br> 
  </div> 
 </div> 
 <div> 
  <div>
    提供用户登录凭据(用户名及密码)，首先我们使用&nbsp;yiibai&nbsp;这个用户名登录如下所示 -
   <br> 
   <img src="/uploads/tutorial/20160820/160r0113146_1_318.png" alt="">
   <br> 
  </div> 
  <div>
    登录成功后可以看到，有限的信息显示页面上，如下图中所示 -&nbsp;
   <br> 
   <img src="/uploads/tutorial/20160820/160r0113203_1_c2.png" alt="">
   <br> 
  </div> 
  <div>
    现在点击注销，并使用管理员角色登录，所下图中所示 -&nbsp;
   <br> 
   <img src="/uploads/tutorial/20160820/160r0113218_1_120.png" alt="">
   <br> 
  </div> 
  <div>
    提交登录成功后，你会看到使用ADMIN角色的操作访问，如下图中所示&nbsp;-&nbsp;
   <br> 
   <img src="/uploads/tutorial/20160820/160r0113232_1_g0.png" alt="">
   <br> 
  </div> 
  <div>
    现在注销登录，然后使用&nbsp;DBA&nbsp;角色登录，如下图中所示&nbsp;-&nbsp;
   <br> 
   <img src="/uploads/tutorial/20160820/160r0113247_1_106.png" alt="">
   <br> 
  </div> 
  <div>
    提交登录成功后，你会看到与DBA角色相关的操作访问。
   <br> 
   <img src="/uploads/tutorial/20160820/160r0113259_1_j6.png" alt="">
   <br> 
  </div> 
  <div>
    全部就这样(包教不包会)。下一篇教程文章将我们学习如何使用基于角色登录。这意味着可根据自己分配的角色，在登录成功后用户将重定向到不同的URL。
   <br> 
   <img src="/uploads/tutorial/20160820/160r0113322_1_603.png" alt="">
   <br> 
  </div> 
  <h4> 下载代码 </h4> 
  <div> 
   <a target="_blank" href="http://share.weiyun.com/57b3ad20120c7c4ea2886872d07b562a">06-SpringSecurityTaglibs.zip&nbsp;</a>
   <br> 
  </div> 
  <h4> 参考 </h4> 
  <ul> 
   <li> <a target="_blank" href="http://docs.spring.io/spring-security/site/docs/4.0.1.RELEASE/reference/htmlsingle/#el-common-built-in">Spring Security表达式</a> </li> 
   <li> <a target="_blank" href="http://projects.spring.io/spring-security/">Spring Security 4 项目页面</a> </li> 
   <li> <a target="_blank" href="http://docs.spring.io/spring-security/site/docs/4.0.1.RELEASE/reference/htmlsingle/">Spring Security 4 参考手册</a> </li> 
  </ul> 
 </div>
 <br>      
</div></body></html>
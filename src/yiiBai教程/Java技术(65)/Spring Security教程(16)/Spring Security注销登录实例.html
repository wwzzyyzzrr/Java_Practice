<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Spring Security注销登录实例</h1><div style="width:100%;float:left;" class="article-content">   
 <div style="font-family:微软雅黑;font-size:14px;background-color:#FFFFFF;"> 
  <div> 
   <div>
     这篇教程文章将向您展示如何以编程方式注销 Spring&nbsp;Security 用户。使用浏览器的后退按钮也能很好显示。要整个工程完成代码编写并运行后，主页面如下图所示 -
    <br> 
    <img src="http://www.yiibai.com/uploads/tutorial/20160820/160r0111i2_1_f6.png" alt="">
    <br> 
   </div> 
  </div> 
 </div> 
 <div> 
  <hr> 首先我们先来看看工程结构，这里使用的是注释方式来实现的。如下图中所示 -&nbsp; 
 </div> 
 <div> 
  <img src="/uploads/tutorial/20160820/160r0111p6_1_294.png" alt="">
  <br> 
 </div> 
 <div>
   一般情况下，在你的视图中应该提供一个简单的注销链接来注销用户，类似如下所示：&nbsp; 
  <pre>&lt;%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%&gt;
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%&gt;
&lt;html&gt;
&lt;head&gt;
	&lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8"&gt;
	&lt;title&gt;Admin page&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
	Dear &lt;strong&gt;${user}&lt;/strong&gt;, Welcome to Admin Page.
	&lt;a href="&lt;c:url value="/logout" /&gt;"&gt;Logout&lt;/a&gt;
&lt;/body&gt;
&lt;/html&gt;&nbsp;</pre> 
  <p> 没有什么特别的东西。现在，我们只需要在映射控制器到&nbsp;&nbsp;/logout&nbsp;注销链接。创建一个新的方法如下所示：&nbsp; </p> 
  <pre>	@RequestMapping(value="/logout", method = RequestMethod.GET)
	public String logoutPage (HttpServletRequest request, HttpServletResponse response) {
		Authentication auth = SecurityContextHolder.getContext().getAuthentication();
		if (auth != null){    
			new SecurityContextLogoutHandler().logout(request, response, auth);
		}
		return "redirect:/login?logout";//You can redirect wherever you want, but generally it's a good practice to show login screen again.
	}
&nbsp;</pre> 
  <p> 在这里，首先我们确定，如果用户在认证之后使用&nbsp;SecurityContextHolder.getContext().getAuthentication()&nbsp;。如果是这样，那么我们调用&nbsp;SecurityContextLogoutHandler().logout(request, response, auth)&nbsp;注销用户。&nbsp; </p> 
  <div>
    注销调用执行以下操作： 
  </div> 
  <ul> 
   <li> 
    <div>
      HTTP的会话失效，那么解除绑定到它的任何对象； 
    </div> </li> 
   <li> 
    <div>
      将删除 SecurityContext 的身份验证，以防止并发请求的问题； 
    </div> </li> 
   <li> 
    <div>
      显式地清除当前线程上下文值； 
    </div> </li> 
  </ul> 
  <div>
    就这样，不需要在应用程序中的任何其他地方处理注销。请注意，你甚至不需要做任何特殊的Spring配置(XML或基于注释)，信息如下图所示： 
  </div> 
  <pre>package com.yiibai.springsecurity.configuration;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;

@Configuration
@EnableWebSecurity
public class SecurityConfiguration extends WebSecurityConfigurerAdapter {

	
	@Autowired
	public void configureGlobalSecurity(AuthenticationManagerBuilder auth) throws Exception {
		auth.inMemoryAuthentication().withUser("yiibai").password("123456").roles("USER");
		auth.inMemoryAuthentication().withUser("admin").password("123456").roles("ADMIN");
		auth.inMemoryAuthentication().withUser("dba").password("123456").roles("ADMIN","DBA");
	}
	
	@Override
	protected void configure(HttpSecurity http) throws Exception {
	  
	  http.authorizeRequests()
	  	.antMatchers("/", "/home").permitAll()
	  	.antMatchers("/admin/**").access("hasRole('ADMIN')")
	  	.antMatchers("/db/**").access("hasRole('ADMIN') and hasRole('DBA')")
	  	.and().formLogin().loginPage("/login")
	  	.usernameParameter("ssoId").passwordParameter("password")
	  	.and().exceptionHandling().accessDeniedPage("/Access_Denied");
	}
}</pre> 
  <div>
    如在上面提到的，没有特殊配置来处理注销。 
  </div> 
  <div>
    以上如果使用 XML&nbsp;来配置&nbsp;Security&nbsp;，那么格式如下： 
  </div> 
  <pre>&lt;beans:beans xmlns="http://www.springframework.org/schema/security"
    xmlns:beans="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.1.xsd
    http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-4.0.xsd"&gt;
     
    &lt;http auto-config="true" &gt;
        &lt;intercept-url pattern="/" access="hasRole('USER')" /&gt;
        &lt;intercept-url pattern="/home" access="hasRole('USER')" /&gt;
        &lt;intercept-url pattern="/admin**" access="hasRole('ADMIN')" /&gt;
        &lt;intercept-url pattern="/dba**" access="hasRole('ADMIN') and hasRole('DBA')" /&gt;
        &lt;form-login  login-page="/login" 
                     username-parameter="ssoId" 
                     password-parameter="password" 
                     authentication-failure-url="/Access_Denied" /&gt;
    &lt;/http&gt;
 
    &lt;authentication-manager &gt;
        &lt;authentication-provider&gt;
            &lt;user-service&gt;
                &lt;user name="yiibai"  password="123456"  authorities="ROLE_USER" /&gt;
                &lt;user name="admin" password="123456" authorities="ROLE_ADMIN" /&gt;
                &lt;user name="dba"   password="123456" authorities="ROLE_ADMIN,ROLE_DBA" /&gt;
            &lt;/user-service&gt;
        &lt;/authentication-provider&gt;
    &lt;/authentication-manager&gt;
    
&lt;/beans:beans&gt;</pre> 
  <div>
    在本系列教程中的应用程序代码，在之后的文章都是基于这个教程的。所以如果打算往后学习其它教程，请务必清楚理解此文章代码和逻辑，以及相关配置或原理。 
  </div> 
  <h4> 发布并运行 </h4> 
  <div>
    如需要自己动手实践，可在文章底部提供的下载链接并点击下载本示例代码，这个项目的完整代码。它是在Servlet&nbsp;3.0的容器(Tomcat7/8，本文章使用&nbsp;Tomcat7)上构建和部署运行的。 
  </div> 
  <div>
    打开您的浏览器，在地址栏中输入网址：
   <a target="_blank" href="http://localhost:8080/SpringSecurityCustomLogout/">http://localhost:8080/SpringSecurityCustomLogout/</a>&nbsp;，默认的页面将显示如下&nbsp;-&nbsp;
   <br> 
   <img src="/uploads/tutorial/20160820/160r0111t2_1_323.png" alt="">
   <br> 
  </div> 
  <div>
    现在访问&nbsp;
   <a target="_blank" href="http://localhost:8080/SpringSecurityCustomLogout/admin">http://localhost:8080/SpringSecurityCustomLogout/admin</a>，系统将提示您登录，如下图中所示 -&nbsp;
   <br> 
   <img src="/uploads/tutorial/20160820/160r0111u9_1_117.png" alt="">
   <br> 
  </div> 
  <div>
    提供用户名和密码(admin/123456)并点击提交，就会看到管理页面。如下图中所示 -
   <br> 
   <img src="/uploads/tutorial/20160820/160r0111917_1_c9.png" alt="">
   <br> 
  </div> 
  <div>
    点击注销，将会自动跳转到登录页。如下图中所示 -&nbsp;
   <br> 
   <img src="/uploads/tutorial/20160820/160r0111932_1_2s.png" alt="">
   <br> 
  </div> 
  <div>
    点击浏览器后退按钮，将会留在登录屏幕。如下所示 -
   <br> 
   <img src="/uploads/tutorial/20160820/160r0111948_1_i9.png" alt="">
   <br> 
  </div> 
  <p> 而已。下一篇文章将学习如何显示基于已登录用户的角色，使用Spring Security&nbsp;&nbsp;标签显示 JSP/视图等等。 </p> 
  <h4> 下载源代码 </h4> 
 </div> 
 <div> 
  <div> 
   <a target="_blank" href="http://share.weiyun.com/af7bf0c3fb2bd6f0d43785dc66c609a6">05-SpringSecurityCustomLogout.zip</a> 
  </div> 
 </div>
 <br>      
</div></body></html>
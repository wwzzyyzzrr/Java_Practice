<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Spring Security自定义表单登录实例</h1><div style="width:100%;float:left;" class="article-content">   
 <div>
   默认情况下，如果没有指定登录表单，Spring&nbsp;Security会自动创建一个默认的登录表单。请参阅 -&nbsp;
  <a target="_blank" href="http://www.yiibai.com/spring-security/spring-security-hello-world-example.html">Spring&nbsp;Security&nbsp;Hello&nbsp;World实例</a>。 
 </div> 
 <div>
   在本教程中，我们将向您展示如何创建Spring&nbsp;Security(例如XML)定制登录表单。注意：由于在这一系列教程中使用的是Maven来创建工程，如果不了解 Mave 如何使用的，可以参考：
  <a target="_blank" href="http://www.yiibai.com/maven/create-a-maven-web-project-with-eclipse.html">http://www.yiibai.com/maven/create-a-maven-web-project-with-eclipse.html</a> 
 </div> 
 <div> 
  <div>
    需要使用到的技术： 
  </div> 
  <blockquote> 
   <ol> 
    <li> Spring 3.2.8.RELEASE </li> 
    <li> Spring Security 3.2.3.RELEASE </li> 
    <li> Eclipse 4.2 </li> 
    <li> JDK 1.6 </li> 
    <li> Maven 3 </li> 
   </ol> 
  </blockquote> 
  <div>
    注意
   <br> 
   <div>
     在这个例子中，之前&nbsp;
    <a target="_blank" href="http://www.yiibai.com/spring-security/spring-security-hello-world-example.html">Spring&nbsp;Security&nbsp;hello&nbsp;world实例</a>将重新使用，现在我们增强它以支持自定义登录表单。 
   </div> 
  </div> 
 </div> 
 <div> 
  <h2> 1. 目录结构 </h2> 
  <div>
    我们来看看本教程的最终目录结构，如下图所示：
   <br> 
   <img src="/uploads/tutorial/20160818/160qr13938_1_329.png" alt="">
   <br> 
  </div> 
  <h2> 2. Spring Security配置 </h2> 
  <div>
    在Spring&nbsp;XML文件自定义登录表单。请参见下面的解释： 
  </div> 
  <ol> 
   <li> login-page=”/login” – 用于显示自定义登录表单的页面 </li> 
   <li> authentication-failure-url=”/login?error” –&nbsp;如果验证失败，则将转向URL：/login?error </li> 
   <li> logout-success-url=”/login?logout” –如果登录成功，则将转向URL：/logout </li> 
   <li> username-parameter=”username” –&nbsp;请求包含“username”的名字。在HTML中，这是在输入文本的名称。 </li> 
   <li> &lt;csrf/&gt; –&nbsp;启用跨站请求伪造(CSRF)保护，请参阅此<a target="_blank" href="http://spring.io/blog/2013/08/21/spring-security-3-2-0-rc1-highlights-csrf-protection/">链接</a>。在XML中，默认情况下CSRF保护被禁用。 </li> 
  </ol> 
  <div>
    通常情况下，我们并不像登录或注销处理认证，要让Spring处理它，我们只需要在处理成功或失败的页面中显示。 
  </div> 
  <div>
    spring-security.xml 
  </div> 
  <pre>&lt;beans:beans xmlns="http://www.springframework.org/schema/security"
	xmlns:beans="http://www.springframework.org/schema/beans" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
	http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
	http://www.springframework.org/schema/security
	http://www.springframework.org/schema/security/spring-security-3.2.xsd"&gt;

	&lt;http auto-config="true"&gt;
		&lt;intercept-url pattern="/admin**" access="ROLE_USER" /&gt;
		&lt;form-login 
		    login-page="/login" 
		    default-target-url="/welcome" 
			authentication-failure-url="/login?error" 
			username-parameter="username"
			password-parameter="password" /&gt;
		&lt;logout logout-success-url="/login?logout" /&gt;
		&lt;!-- enable csrf protection --&gt;
		&lt;csrf/&gt;
	&lt;/http&gt;

	&lt;authentication-manager&gt;
		&lt;authentication-provider&gt;
		  &lt;user-service&gt;
			&lt;user name="yiibai" password="123456" authorities="ROLE_USER" /&gt;
		  &lt;/user-service&gt;
		&lt;/authentication-provider&gt;
	&lt;/authentication-manager&gt;

&lt;/beans:beans&gt;</pre> 
  <div>
    在上面显示成功的配置中，/admin&nbsp;及其子文件夹都被密码保护。 
  </div> 
  <div> 
   <div>
     跨站请求伪造(CSRF)保护 
   </div> 
   <div>
     如果启用了CSRF，那么在登录或注销页面中必须包括_csrf.token。请参阅下面&nbsp;login.jsp和admin.jsp(注销表单)。否则登录和注销功能将失败。 
   </div> 
  </div> 
  <div> 
   <div>
     密码明文？ 
   </div> 
   <div>
     在过去，您应该大部分时候都在使用哈希算法SHA来加密密码，本教程教学习如何使用&nbsp;Spring&nbsp;Security&nbsp;中的密码哈希例子。 
   </div> 
  </div> 
  <h2> 3. 定义登录表单 </h2> 
  <div>
    自定义登录表单，以匹配上面(步骤3)Spring&nbsp;Security 的登录成功显示。它应该是很容易就能理解的。 
  </div> 
  <div>
    login.jsp 
  </div> 
  <pre>&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Login Page&lt;/title&gt;
&lt;style&gt;
.error {
	padding: 15px;
	margin-bottom: 20px;
	border: 1px solid transparent;
	border-radius: 4px;
	color: #a94442;
	background-color: #f2dede;
	border-color: #ebccd1;
}

.msg {
	padding: 15px;
	margin-bottom: 20px;
	border: 1px solid transparent;
	border-radius: 4px;
	color: #31708f;
	background-color: #d9edf7;
	border-color: #bce8f1;
}

#login-box {
	width: 300px;
	padding: 20px;
	margin: 100px auto;
	background: #fff;
	-webkit-border-radius: 2px;
	-moz-border-radius: 2px;
	border: 1px solid #000;
}
&lt;/style&gt;
&lt;/head&gt;
&lt;body onload='document.loginForm.username.focus();'&gt;

	&lt;h1&gt;Spring Security Custom Login Form (XML)&lt;/h1&gt;

	&lt;div id="login-box"&gt;

		&lt;h2&gt;Login with Username and Password&lt;/h2&gt;

		&lt;c:if test="${not empty error}"&gt;
			&lt;div class="error"&gt;${error}&lt;/div&gt;
		&lt;/c:if&gt;
		&lt;c:if test="${not empty msg}"&gt;
			&lt;div class="msg"&gt;${msg}&lt;/div&gt;
		&lt;/c:if&gt;

		&lt;form name='loginForm'
		  action="&lt;c:url value='j_spring_security_check' /&gt;" method='POST'&gt;

		  &lt;table&gt;
			&lt;tr&gt;
				&lt;td&gt;User:&lt;/td&gt;
				&lt;td&gt;&lt;input type='text' name='username' value=''&gt;&lt;/td&gt;
			&lt;/tr&gt;
			&lt;tr&gt;
				&lt;td&gt;Password:&lt;/td&gt;
				&lt;td&gt;&lt;input type='password' name='password' /&gt;&lt;/td&gt;
			&lt;/tr&gt;
			&lt;tr&gt;
				&lt;td colspan='2'&gt;&lt;input name="submit" type="submit"
					value="submit" /&gt;&lt;/td&gt;
			&lt;/tr&gt;
		  &lt;/table&gt;

		  &lt;input type="hidden" name="${_csrf.parameterName}"
			value="${_csrf.token}" /&gt;

		&lt;/form&gt;
	&lt;/div&gt;

&lt;/body&gt;
&lt;/html&gt;</pre> 
  <div>
    而另外两个JSP页面，admin.jsp中的密码已经被 Spring 安全保护。 
  </div> 
  <div>
    hello.jsp 
  </div> 
  <pre>&lt;%@page session="false"%&gt;
&lt;html&gt;
&lt;body&gt;
	&lt;h1&gt;Title : ${title}&lt;/h1&gt;	
	&lt;h1&gt;Message : ${message}&lt;/h1&gt;	
&lt;/body&gt;
&lt;/html&gt;</pre> 
  <div>
    admin.jsp + logout 
  </div> 
  <pre>&lt;%@taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%&gt;
&lt;%@page session="true"%&gt;
&lt;html&gt;
&lt;body&gt;
	&lt;h1&gt;Title : ${title}&lt;/h1&gt;
	&lt;h1&gt;Message : ${message}&lt;/h1&gt;

	&lt;c:url value="/j_spring_security_logout" var="logoutUrl" /&gt;

	&lt;!-- csrt for log out--&gt;
	&lt;form action="${logoutUrl}" method="post" id="logoutForm"&gt;
	  &lt;input type="hidden" 
		name="${_csrf.parameterName}"
		value="${_csrf.token}" /&gt;
	&lt;/form&gt;
	
	&lt;script&gt;
		function formSubmit() {
			document.getElementById("logoutForm").submit();
		}
	&lt;/script&gt;

	&lt;c:if test="${pageContext.request.userPrincipal.name != null}"&gt;
		&lt;h2&gt;
			Welcome : ${pageContext.request.userPrincipal.name} | &lt;a
				href="javascript:formSubmit()"&gt; Logout&lt;/a&gt;
		&lt;/h2&gt;
	&lt;/c:if&gt;

&lt;/body&gt;
&lt;/html&gt;</pre> 
  <h2> 4. Spring MVC控制器 </h2> 
  <p> 一个简单的控制器，如下代码所示 -&nbsp; </p> 
  <div>
    HelloController.java 
  </div>   
  <pre>package com.yiibai.web.controller;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.ModelAndView;

@Controller
public class HelloController {

	@RequestMapping(value = { "/", "/welcome**" }, method = RequestMethod.GET)
	public ModelAndView welcomePage() {

		ModelAndView model = new ModelAndView();
		model.addObject("title", "Spring Security Custom Login Form");
		model.addObject("message", "This is welcome page!");
		model.setViewName("hello");
		return model;

	}

	@RequestMapping(value = "/admin**", method = RequestMethod.GET)
	public ModelAndView adminPage() {

		ModelAndView model = new ModelAndView();
		model.addObject("title", "Spring Security Custom Login Form");
		model.addObject("message", "This is protected page!");
		model.setViewName("admin");

		return model;

	}

	//Spring Security see this :
	@RequestMapping(value = "/login", method = RequestMethod.GET)
	public ModelAndView login(
		@RequestParam(value = "error", required = false) String error,
		@RequestParam(value = "logout", required = false) String logout) {

		ModelAndView model = new ModelAndView();
		if (error != null) {
			model.addObject("error", "Invalid username and password!");
		}

		if (logout != null) {
			model.addObject("msg", "You've been logged out successfully.");
		}
		model.setViewName("login");

		return model;

	}

}</pre> 
  <h2> 5. 示例 </h2> 
  <p> 5.1. 欢迎页面 –&nbsp;<a target="_blank" href="http://localhost:8080/spsecurity-custom-login-form-xml/welcome">http://localhost:8080/spsecurity-custom-login-form-xml/welcome</a>&nbsp;，结果如下图中所示 -&nbsp;<br> <img src="/uploads/tutorial/20160818/160qr14030_1_d4.png" alt=""> </p> 
  <p> 5.2&nbsp;尝试访问：<a target="_blank" href="http://localhost:8080/spsecurity-custom-login-form-xml/admin">http://localhost:8080/spsecurity-custom-login-form-xml/admin</a>&nbsp;页面，Spring&nbsp;Security将截取请求并重定向到&nbsp;/login&nbsp;，并显示您的自定义登录表单。<br> <img src="/uploads/tutorial/20160818/160qr14046_1_620.png" alt=""> </p> 
  <p> 5.3.&nbsp;如果用户名和密码不正确，将显示错误信息，并且Spring将重定向到网址：&nbsp;<a target="_blank" href="http://localhost:8080/spsecurity-custom-login-form-xml/login?error">http://localhost:8080/spsecurity-custom-login-form-xml/login?error</a>.<span id="__kindeditor_bookmark_end_9__"></span><br> <img src="/uploads/tutorial/20160818/160qr14114_1_b7.png" alt=""> </p> 
  <p> 5.4.&nbsp;如果用户名和密码都正确，Spring将重定向到原请求的URL并显示该网页信息。<br> <img src="/uploads/tutorial/20160818/160qr14131_1_c1.png" alt=""> </p> 
  <p> 5.5.&nbsp;尝试注销，它会重定向到&nbsp;&nbsp;&nbsp;<a target="_blank" href="http://localhost:8080/spsecurity-custom-login-form-xml/login?logout">http://localhost:8080/spsecurity-custom-login-form-xml/login?logout</a><span id="__kindeditor_bookmark_end_33__"></span>&nbsp;页面。<br> <img src="/uploads/tutorial/20160818/160qr14158_1_148.png" alt=""> </p> 
  <h2> 
   <div>
     下载源代码 
   </div> </h2> 
  <div>
    下载本实例中的代码 –&nbsp;
   <a target="_blank" href="http://share.weiyun.com/9167f6102d18694c781f39c5b17cd662">spring-security-custom-login-form-xml.zip</a> 
  </div> 
 </div> 
 <div> 
  <br> 
 </div>
 <br>      
</div></body></html>
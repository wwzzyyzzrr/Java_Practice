<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Spring Security自定义表单登录注释示例</h1><div style="width:100%;float:left;" class="article-content">   
 <div> 
  <div>
    在本教程中，我们将以前的&nbsp;
   <span style="line-height:1.5;"><a target="_blank" href="http://www.yiibai.com/spring-security/spring-security-form-login-example.html">Spring&nbsp;Security定制登录表单(XML)项目</a></span>&nbsp;转换为一个纯粹基于注解的项目。注意：由于在这一系列教程中使用的是Maven来创建工程，如果不了解 Mave 如何使用的，可以参考：
   <span style="line-height:1.5;"><a target="_blank" href="http://www.yiibai.com/maven/create-a-maven-web-project-with-eclipse.html">http://www.yiibai.com/maven/create-a-maven-web-project-with-eclipse.html</a></span> 
  </div> 
 </div> 
 <div> 
  <p> 需要用到的技术： </p> 
  <blockquote> 
   <ol> 
    <li> Spring 3.2.8.RELEASE </li> 
    <li> Spring Security 3.2.3.RELEASE </li> 
    <li> Eclipse 4.2 </li> 
    <li> JDK 1.6 </li> 
    <li> Maven 3 </li> 
    <li> Tomcat 7 (Servlet 3.x) </li> 
   </ol> 
  </blockquote> 
  <div>
    注意
   <br> 在这个例子中，上一个
   <a target="_blank" href="http://www.yiibai.com/spring-security/spring-security-hello-world-annotation-example.html">Spring Security hello world声明示例</a>&nbsp;将被重用，增强这个以支持自定义登录表单。 
  </div> 
 </div> 
 <div> 
  <h2> 2. 工程目录结构 </h2> 
  <div>
    我们来看看本教程的最终目录结构。如下所示 -&nbsp;
   <br> 
   <img src="/uploads/tutorial/20160818/160qr15342_1_317.png" alt="">
   <br> 
  </div> 
  <div style="text-align:center;"> 
   <img src="file://E:/data/youdao/qq24B39E2329F08D9F4C3146A571A415EF/cfaca81daa86471685c8ccedd7e5fc89/clipboard.png"> 
  </div> 
  <h2> 3. Spring Security配置 </h2> 
  <p> Spring Security通过注解配置，如下图所示： </p> 
  <div>
    SecurityConfig.java 
  </div> 
  <pre>package com.yiibai.config;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;

@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {

	@Autowired
	public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
		auth.inMemoryAuthentication()
                   .withUser("yiibai").password("123456").roles("USER");
	}

	//.csrf() is optional, enabled by default, if using WebSecurityConfigurerAdapter constructor
	@Override
	protected void configure(HttpSecurity http) throws Exception {

	    http.authorizeRequests()
		.antMatchers("/admin/**").access("hasRole('ROLE_USER')")
		.and()
		    .formLogin().loginPage("/login").failureUrl("/login?error")
		    .usernameParameter("username").passwordParameter("password")		
		.and()
		    .logout().logoutSuccessUrl("/login?logout")
		.and()
		    .csrf(); 		
	}
}</pre> 
  <div>
    Spring&nbsp;Security的XML文件相当于以下配置： 
  </div> 
  <pre>&lt;http auto-config="true"&gt;
	  &lt;intercept-url pattern="/admin**" access="ROLE_USER" /&gt;
	  &lt;form-login 
		login-page="/login" 
	        default-target-url="/welcome" 
		authentication-failure-url="/login?error" 
		username-parameter="username"
		password-parameter="password" /&gt;
	  &lt;logout logout-success-url="/login?logout" /&gt;
	  &lt;!-- enable csrf protection --&gt;
	  &lt;csrf/&gt;
	&lt;/http&gt;

	&lt;authentication-manager&gt;
	  &lt;authentication-provider&gt;
	    &lt;user-service&gt;
		&lt;user name="yiibai" password="123456" authorities="ROLE_USER" /&gt;
	    &lt;/user-service&gt;
	  &lt;/authentication-provider&gt;
	&lt;/authentication-manager&gt;</pre> 
  <h2> 4. 自定义登录表单 </h2> 
  <p> 4.1&nbsp;这个页面用于显示自定义登录表单。如果CSRF保护被启用，记得要在登录和注销表单中添加${_csrf.token}。 </p> 
  <div>
    login.jsp 
  </div> 
  <pre>&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Login Page&lt;/title&gt;
&lt;style&gt;
.error {
	padding: 15px;
	margin-bottom: 20px;
	border: 1px solid transparent;
	border-radius: 4px;
	color: #a94442;
	background-color: #f2dede;
	border-color: #ebccd1;
}

.msg {
	padding: 15px;
	margin-bottom: 20px;
	border: 1px solid transparent;
	border-radius: 4px;
	color: #31708f;
	background-color: #d9edf7;
	border-color: #bce8f1;
}

#login-box {
	width: 300px;
	padding: 20px;
	margin: 100px auto;
	background: #fff;
	-webkit-border-radius: 2px;
	-moz-border-radius: 2px;
	border: 1px solid #000;
}
&lt;/style&gt;
&lt;/head&gt;
&lt;body onload='document.loginForm.username.focus();'&gt;

	&lt;h1&gt;Spring Security Custom Login Form (Annotation)&lt;/h1&gt;

	&lt;div id="login-box"&gt;

		&lt;h2&gt;Login with Username and Password&lt;/h2&gt;

		&lt;c:if test="${not empty error}"&gt;
			&lt;div class="error"&gt;${error}&lt;/div&gt;
		&lt;/c:if&gt;
		&lt;c:if test="${not empty msg}"&gt;
			&lt;div class="msg"&gt;${msg}&lt;/div&gt;
		&lt;/c:if&gt;

		&lt;form name='loginForm'
		    action="&lt;c:url value='j_spring_security_check' /&gt;" method='POST'&gt;

		    &lt;table&gt;
			&lt;tr&gt;
				&lt;td&gt;User:&lt;/td&gt;
				&lt;td&gt;&lt;input type='text' name='user' value=''&gt;&lt;/td&gt;
			&lt;/tr&gt;
			&lt;tr&gt;
				&lt;td&gt;Password:&lt;/td&gt;
				&lt;td&gt;&lt;input type='password' name='pass' /&gt;&lt;/td&gt;
			&lt;/tr&gt;
			&lt;tr&gt;
			        &lt;td colspan='2'&gt;
                                &lt;input name="submit" type="submit" value="submit" /&gt;
                                &lt;/td&gt;
			&lt;/tr&gt;
		   &lt;/table&gt;

		   &lt;input type="hidden" 
                     name="${_csrf.parameterName}" value="${_csrf.token}" /&gt;
		&lt;/form&gt;
	&lt;/div&gt;

&lt;/body&gt;
&lt;/html&gt;</pre> 
  <p> 4.2 这个页面用来显示欢迎信息，这是一个默认页面。 </p> 
  <div>
    hello.jsp 
  </div> 
  <pre>&lt;%@page session="false"%&gt;
&lt;html&gt;
&lt;body&gt;
	&lt;h1&gt;Title : ${title}&lt;/h1&gt;	
	&lt;h1&gt;Message : ${message}&lt;/h1&gt;	
&lt;/body&gt;
&lt;/html&gt;</pre> 
  <p> 4.3&nbsp;这页面有密码保护，只有经过验证的用户才允许访问。 </p> 
  <div>
    admin.jsp + logout 
  </div> 
  <pre>&lt;%@taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%&gt;
&lt;%@page session="true"%&gt;
&lt;html&gt;
&lt;body&gt;
	&lt;h1&gt;Title : ${title}&lt;/h1&gt;
	&lt;h1&gt;Message : ${message}&lt;/h1&gt;

	&lt;c:url value="/j_spring_security_logout" var="logoutUrl" /&gt;

		&lt;!-- csrt support --&gt;
	&lt;form action="${logoutUrl}" method="post" id="logoutForm"&gt;
		&lt;input type="hidden" 
			name="${_csrf.parameterName}"
			value="${_csrf.token}" /&gt;
	&lt;/form&gt;
	
	&lt;script&gt;
		function formSubmit() {
			document.getElementById("logoutForm").submit();
		}
	&lt;/script&gt;

	&lt;c:if test="${pageContext.request.userPrincipal.name != null}"&gt;
		&lt;h2&gt;
			Welcome : ${pageContext.request.userPrincipal.name} | &lt;a
				href="javascript:formSubmit()"&gt; Logout&lt;/a&gt;
		&lt;/h2&gt;
	&lt;/c:if&gt;

&lt;/body&gt;
&lt;/html&gt;</pre> 
  <h2> 5. Spring MVC控制器 </h2> 
  <p> 一个简单的控制器，如下所示： </p> 
  <div>
    HelloController.java 
  </div> 
  <pre>package com.yiibai.web.controller;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.ModelAndView;

@Controller
public class HelloController {

	@RequestMapping(value = { "/", "/welcome**" }, method = RequestMethod.GET)
	public ModelAndView welcomePage() {

		ModelAndView model = new ModelAndView();
		model.addObject("title", "Spring Security Custom Login Form");
		model.addObject("message", "This is welcome page!");
		model.setViewName("hello");
		return model;

	}

	@RequestMapping(value = "/admin**", method = RequestMethod.GET)
	public ModelAndView adminPage() {

		ModelAndView model = new ModelAndView();
		model.addObject("title", "Spring Security Custom Login Form");
		model.addObject("message", "This is protected page!");
		model.setViewName("admin");

		return model;

	}

	//Spring Security see this :
	@RequestMapping(value = "/login", method = RequestMethod.GET)
	public ModelAndView login(
		@RequestParam(value = "error", required = false) String error,
		@RequestParam(value = "logout", required = false) String logout) {

		ModelAndView model = new ModelAndView();
		if (error != null) {
			model.addObject("error", "Invalid username and password!");
		}

		if (logout != null) {
			model.addObject("msg", "You've been logged out successfully.");
		}
		model.setViewName("login");

		return model;

	}

}</pre> 
  <h2> 6. 初始化类 </h2> 
  <div>
    下面是初始化类，使这个项目是纯粹基于注解。 
  </div> 
  <p> 6.1&nbsp;初始化类启用Spring&nbsp;Security配置。 </p> 
  <div>
    SpringSecurityInitializer.java 
  </div>   
  <pre>package com.yiibai.config.core;

import org.springframework.security.web.context.AbstractSecurityWebApplicationInitializer;
public class SpringSecurityInitializer extends AbstractSecurityWebApplicationInitializer {

}</pre> 
  <p> 6.2&nbsp;初始化类启用Spring&nbsp;MVC。 </p> 
  <div>
    SpringMvcInitializer.java 
  </div> 
  <pre>package com.yiibai.config.core;

import org.springframework.web.servlet.support.AbstractAnnotationConfigDispatcherServletInitializer;
import com.yiibai.config.AppConfig;

public class SpringMvcInitializer 
	extends AbstractAnnotationConfigDispatcherServletInitializer {

	@Override
	protected Class&lt;?&gt;[] getRootConfigClasses() {
		return new Class[] { AppConfig.class };
	}

	@Override
	protected Class&lt;?&gt;[] getServletConfigClasses() {
		return null;
	}

	@Override
	protected String[] getServletMappings() {
		return new String[] { "/" };
	}
	
}</pre> 
  <div>
    AppConfig.java 
  </div> 
  <pre>package com.yiibai.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Import;
import org.springframework.web.servlet.config.annotation.EnableWebMvc;
import org.springframework.web.servlet.view.InternalResourceViewResolver;
import org.springframework.web.servlet.view.JstlView;

@EnableWebMvc
@Configuration
@ComponentScan({ "com.yiibai.web.*" })
@Import({ SecurityConfig.class })
public class AppConfig {

	@Bean
	public InternalResourceViewResolver viewResolver() {
		InternalResourceViewResolver viewResolver
                           = new InternalResourceViewResolver();
		viewResolver.setViewClass(JstlView.class);
		viewResolver.setPrefix("/WEB-INF/pages/");
		viewResolver.setSuffix(".jsp");
		return viewResolver;
	}
	
}</pre> 
  <h2> 7. 示例 </h2> 
  <p> 7.1. 打开欢迎页面 –&nbsp;<a target="_blank" href="http://localhost:8080/spsecurity-custom-login-form-annotation/welcome">http://localhost:8080/spsecurity-custom-login-form-annotation/welcome</a>&nbsp;<br> <img src="/uploads/tutorial/20160818/160qr15409_1_392.png" alt=""> </p> 
  <div style="text-align:center;"> 
   <img src="file://E:/data/youdao/qq24B39E2329F08D9F4C3146A571A415EF/f562f9432bb140b79c849e22217cd5ba/clipboard.png"> 
  </div> 
  <p> 7.2&nbsp;尝试访问&nbsp;<a target="_blank" href="http://localhost:8080/spsecurity-custom-login-form-annotation/">http://localhost:8080/spsecurity-custom-login-form-annotation/</a>admin 页面，它将会显示自定义登录表单。如下图中所示：<br> <img src="/uploads/tutorial/20160818/160qr15425_1_317.png" alt=""> </p> 
  <div style="text-align:center;"> 
   <img src="file://E:/data/youdao/qq24B39E2329F08D9F4C3146A571A415EF/27ffbca408be4d4c952f61d2d586fbc3/clipboard.png"> 
  </div> 
  <p> 7.3.&nbsp;如果用户名和密码不正确，将显示页面：&nbsp;<a target="_blank" href="http://localhost:8080/spsecurity-custom-login-form-annotation/login?error">http://localhost:8080/spsecurity-custom-login-form-annotation/login?error</a><br> <img src="/uploads/tutorial/20160818/160qr15508_1_v8.png" alt=""><br> <span id="__kindeditor_bookmark_end_9__"></span> </p> 
  <div style="text-align:center;"> 
   <img src="file://E:/data/youdao/qq24B39E2329F08D9F4C3146A571A415EF/5673ccf9d746412fab20f2d64c957626/clipboard.png"> 
  </div> 
  <p> 7.4.&nbsp;如果用户名和密码都正确，Spring将请求重定向到原来请求的URL并显示该网页内容。<br> <img src="/uploads/tutorial/20160818/160qr15524_1_252.png" alt=""> </p> 
  <div style="text-align:center;"> 
   <img src="file://E:/data/youdao/qq24B39E2329F08D9F4C3146A571A415EF/0d6c8fdcee9b4948ae2c0aeb8b184bec/clipboard.png"> 
  </div> 
  <p> 7.5.&nbsp;尝试注销，它会重定向到&nbsp;&nbsp;<a target="_blank" href="http://localhost:8080/spsecurity-custom-login-form-annotation/login?logout">http://localhost:8080/spsecurity-custom-login-form-annotation/login?logout</a><span id="__kindeditor_bookmark_end_22__"></span>&nbsp;页面，如下所示：<br> <img src="/uploads/tutorial/20160818/160qr15539_1_393.png" alt=""> </p> 
  <div style="text-align:center;"> 
   <img src="file://E:/data/youdao/qq24B39E2329F08D9F4C3146A571A415EF/47099b4ee5ec4dd191eb2cb633e527ea/clipboard.png"> 
  </div> 
  <h2> 下载源代码 </h2> 
  <div>
    下载代码 –&nbsp;
   <a target="_blank" href="http://share.weiyun.com/014c2a4474d7f52f511eed16908dc001">spsecurity-custom-login-form-annotation.zip</a>&nbsp;(19 KB) 
  </div> 
  <h2> 参考 </h2> 
  <ol> 
   <li> <a target="_blank" href="http://www.yiibai.com/spring-security/spring-security-hello-world-annotation-example.html">Spring Security Hello World注释实例</a> </li> 
   <li> <a target="_blank" href="http://docs.spring.io/spring-security/site/docs/3.2.0.RELEASE/guides/form.html">创建一个自定义登录表单</a> </li> 
   <li> <a target="_blank" href="http://spring.io/blog/2013/08/21/spring-security-3-2-0-rc1-highlights-csrf-protection/">Spring Security 3.2.0.RC1 Highlights: CSRF Protection</a> </li> 
   <li> <a target="_blank" href="http://en.wikipedia.org/wiki/Cross-site_request_forgery">Wikipedia : Cross-site request forgery</a> </li> 
  </ol> 
 </div>
 <br>      
</div></body></html>
<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Java NIO通道FileLock</h1><div style="width:100%;float:left;" class="article-content">   
 <p><code>FileLock</code>锁定或尝试锁定文件的给定部分。它属于<code>java.nio.channels</code>包，该功能在JDK 1.4以上版本可用。</p> 
 <p><code>FileLock</code>用于在共享模式或非共享模式下锁定文件。它有两个重要的方法如下：</p> 
 <ul> 
  <li><code>FileLock.lock(long position, long size, boolean shared)</code></li>
  <li><code>FileLock.tryLock(long position, long size, boolean shared)</code></li>
 </ul> 
 <p>上述方法使用参数作为初始位置，文件大小锁定和一个参数来决定是否共享锁定。</p> 
 <p><strong>创建文件锁</strong></p> 
 <p>当使用<code>FileChannel</code>或<code>AsynchronousFileChannel</code>的<code>lock()</code>或<code>tryLock()</code>方法之一获取文件锁时，将创建文件锁定对象。</p> 
 <p><strong>基本FileLock示例</strong></p> 
 <p>下面来看看使用专用锁定的通道在文件中写入(附加)的程序(<em>FileLockExample.java</em>)：</p> 
 <pre><code class="lang-java">package com.yiibai;

import java.io.IOException;
import java.nio.channels.FileChannel;
import java.nio.channels.FileLock;
import java.nio.ByteBuffer;
import java.nio.file.Paths;
import java.nio.file.Path;
import java.nio.file.StandardOpenOption;

public class FileLockExample {
    public static void main (String [] args)  
            throws IOException {  
        String input = "* end of the file.";  
        System.out.println("Input string to the test file is: " + input);  
        ByteBuffer buf = ByteBuffer.wrap(input.getBytes());  
        String fp = "testout-file.txt";  
        Path pt = Paths.get(fp);  
        FileChannel fc = FileChannel.open(pt, StandardOpenOption.WRITE,  
StandardOpenOption.APPEND);  
        System.out.println("File channel is open for write and Acquiring lock...");  
        fc.position(fc.size() - 1); // position of a cursor at the end of file       
        FileLock lock = fc.lock();   
        System.out.println("The Lock is shared: " + lock.isShared());  
        fc.write(buf);  
        fc.close(); // Releases the Lock  
        System.out.println("Content Writing is complete. Therefore close the channel and release the lock.");  
        PrintFile.print(fp);  
    }
}
</code></pre> 
 <p><strong>PrintFile.java</strong>文件的内容如下 - </p>   
 <pre><code class="lang-java">package com.yiibai;

import java.io.IOException;
import java.io.FileReader;
import java.io.BufferedReader;

public class PrintFile {
    public static void print(String path) throws IOException {
        FileReader filereader = new FileReader(path);
        BufferedReader bufferedreader = new BufferedReader(filereader);
        String tr = bufferedreader.readLine();
        System.out.println("The Content of testout-file.txt file is: ");
        while (tr != null) {
            System.out.println("    " + tr);
            tr = bufferedreader.readLine();
        }
        filereader.close();
        bufferedreader.close();
    }
}
</code></pre> 
 <p>注意：在运行代码之前，需要创建一个名称为<code>“testout-file.txt”</code>的文本文件，文本文件的内容如下：</p> 
 <pre><code class="lang-txt">Welcome to yiibai.com

This is the example of FileLock in Java NIO channel.
</code></pre> 
 <p>执行上面示例代码，得到以下结果 - </p> 
 <pre><code class="lang-shell">Input string to the test file is: * end of the file.
File channel is open for write and Acquiring lock...
The Lock is shared: false
Content Writing is complete. Therefore close the channel and release the lock.
The Content of testout-file.txt file is: 
    Welcome to yiibai.com

    This is the example of FileLock in Java NIO channel.* end of the file.
</code></pre>
 <br>      
</div></body></html>
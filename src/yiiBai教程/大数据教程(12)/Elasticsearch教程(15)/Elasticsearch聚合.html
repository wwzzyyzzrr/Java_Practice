<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Elasticsearch聚合</h1><div style="width:100%;float:left;" class="article-content">   
 <p>框架集合由搜索查询选择的所有数据。框架中包含许多构建块，有助于构建复杂的数据描述或摘要。聚合的基本结构如下所示 -</p> 
 <pre><code class="lang-json">"aggregations" : {
   "&lt;aggregation_name&gt;" : {
      "&lt;aggregation_type&gt;" : {
         &lt;aggregation_body&gt;
      }

      [,"meta" : { [&lt;meta_data_body&gt;] } ]?
      [,"aggregations" : { [&lt;sub_aggregation&gt;]+ } ]?
   }
}
</code></pre> 
 <p>有以下不同类型的聚合，每个都有自己的目的 -</p> 
 <h3 id="h3-u6307u6807u805Au5408"><a name="指标聚合" class="reference-link"></a><span class="header-link octicon octicon-link"></span>指标聚合</h3>
 <p>这些聚合有助于从聚合文档的字段值计算矩阵，并且某些值可以从脚本生成。<br>数字矩阵或者是平均聚合的单值，或者是像<code>stats</code>一样的多值。</p> 
 <h3 id="h3-u5E73u5747u805Au5408"><a name="平均聚合" class="reference-link"></a><span class="header-link octicon octicon-link"></span>平均聚合</h3>
 <p>此聚合用于获取聚合文档中存在的任何数字字段的平均值。 例如，</p> 
 <pre><code>POST http://localhost:9200/schools/_search
</code></pre>
 <p><strong>请求正文</strong></p> 
 <pre><code class="lang-json">{
   "aggs":{
      "avg_fees":{"avg":{"field":"fees"}}
   }
}
</code></pre> 
 <p><strong>响应</strong></p> 
 <pre><code class="lang-json">{
   "took":44, "timed_out":false, "_shards":{"total":5, "successful":5, "failed":0},
   "hits":{
      "total":3, "max_score":1.0, "hits":[
         {
            "_index":"schools", "_type":"school", "_id":"2", "_score":1.0,
            "_source":{
               "name":"Saint Paul School", "description":"ICSE Affiliation",
               "street":"Dawarka", "city":"Delhi", "state":"Delhi", 
               "zip":"110075", "location":[28.5733056, 77.0122136], "fees":5000, 
               "tags":["Good Faculty", "Great Sports"], "rating":"4.5"
            }
         },

         {
            "_index":"schools", "_type":"school", "_id":"1", "_score":1.0,
            "_source":{
               "name":"Central School", "description":"CBSE Affiliation",
               "street":"Nagan", "city":"paprola", "state":"HP", "zip":"176115",
               "location":[31.8955385, 76.8380405], "fees":2200, 
               "tags":["Senior Secondary", "beautiful campus"], "rating":"3.3"
            }
         },

         {
            "_index":"schools", "_type":"school", "_id":"3", "_score":1.0,
            "_source":{
               "name":"Crescent School", "description":"State Board Affiliation",
               "street":"Tonk Road", "city":"Jaipur", "state":"RJ", 
               "zip":"176114", "location":[26.8535922, 75.7923988], "fees":2500, 
               "tags":["Well equipped labs"], "rating":"4.5"
            }
         }
      ]
   }, "aggregations":{"avg_fees":{"value":3233.3333333333335}}
}
</code></pre> 
 <p>如果该值不存在于一个或多个聚合文档中，则默认情况下将忽略该值。您可以在聚合中添加缺少的字段，将缺少值视为默认值。</p> 
 <pre><code class="lang-json">{
   "aggs":{
      "avg_fees":{
         "avg":{
            "field":"fees"
            "missing":0
         }
      }
   }
}
</code></pre> 
 <h3 id="h3-u57FAu6570u805Au5408"><a name="基数聚合" class="reference-link"></a><span class="header-link octicon octicon-link"></span>基数聚合</h3>
 <p>此聚合给出特定字段的不同值的计数。 例如，</p> 
 <pre><code>POST http://localhost:9200/schools*/_search
</code></pre>
 <p><strong>请求正文</strong></p> 
 <pre><code>{
   "aggs":{
      "distinct_name_count":{"cardinality":{"field":"name"}}
   }
}
</code></pre>
 <p><strong>响应</strong></p> 
 <pre><code>………………………………………………
{
   "name":"Government School", "description":"State Board Afiliation",
   "street":"Hinjewadi", "city":"Pune", "state":"MH", "zip":"411057",
   "location":[18.599752, 73.6821995], "fees":500, "tags":["Great Sports"], 
   "rating":"4"
},

{
   "_index":"schools_gov", "_type": "school", "_id":"1", "_score":1.0,
   "_source":{
      "name":"Model School", "description":"CBSE Affiliation", "street":"silk city",
      "city":"Hyderabad", "state":"AP", "zip":"500030", 
      "location":[17.3903703, 78.4752129], "fees":700, 
      "tags":["Senior Secondary", "beautiful campus"], "rating":"3"
   }
}, "aggregations":{"disticnt_name_count":{"value":3}}
………………………………………………
</code></pre>
 <blockquote> 
  <p>注 - 基数的值为<code>3</code>，因为名称 - Government, School 和 Model中有三个不同的值。</p> 
 </blockquote> 
 <h3 id="h3-u6269u5C55u7EDFu8BA1u805Au5408"><a name="扩展统计聚合" class="reference-link"></a><span class="header-link octicon octicon-link"></span>扩展统计聚合</h3>
 <p>此聚合生成聚合文档中特定数字字段的所有统计信息。 例如，</p> 
 <pre><code>POST http://localhost:9200/schools/school/_search
</code></pre>
 <p><strong>请求正文</strong></p> 
 <pre><code class="lang-json">{
   "aggs" : {
      "fees_stats" : { "extended_stats" : { "field" : "fees" } }
   }
}
</code></pre> 
 <p><strong>响应</strong></p> 
 <pre><code class="lang-json">{
   "aggregations":{
      "fees_stats":{
         "count":3, "min":2200.0, "max":5000.0, 
         "avg":3233.3333333333335, "sum":9700.0,
         "sum_of_squares":3.609E7, "variance":1575555.555555556, 
         "std_deviation":1255.2113589175156,

         "std_deviation_bounds":{
            "upper":5743.756051168364, "lower":722.9106154983024
         }
      }
   }
}
</code></pre> 
 <h3 id="h3-u6700u5927u805Au5408"><a name="最大聚合" class="reference-link"></a><span class="header-link octicon octicon-link"></span>最大聚合</h3>
 <p>此聚合查找聚合文档中特定数字字段的最大值。 例如，</p>   
 <pre><code>POST http://localhost:9200/schools*/_search
</code></pre>
 <p><strong>请求正文</strong></p> 
 <pre><code class="lang-json">{
   "aggs" : {
      "max_fees" : { "max" : { "field" : "fees" } }
   }
}
</code></pre> 
 <p><strong>响应</strong></p> 
 <pre><code class="lang-json">{
   aggregations":{"max_fees":{"value":5000.0}}
}
</code></pre> 
 <h3 id="h3-u6700u5C0Fu805Au5408"><a name="最小聚合" class="reference-link"></a><span class="header-link octicon octicon-link"></span>最小聚合</h3>
 <p>此聚合查找聚合文档中特定数字字段的最小值。 例如，</p> 
 <pre><code>POST http://localhost:9200/schools*/_search
</code></pre>
 <p><strong>请求正文</strong></p> 
 <pre><code class="lang-json">{
   "aggs" : {
      "min_fees" : { "min" : { "field" : "fees" } }
   }
}
</code></pre> 
 <p><strong>响应</strong></p> 
 <pre><code class="lang-json">"aggregations":{"min_fees":{"value":500.0}}
</code></pre> 
 <h3 id="h3-u603Bu548Cu805Au5408"><a name="总和聚合" class="reference-link"></a><span class="header-link octicon octicon-link"></span>总和聚合</h3>
 <p>此聚合计算聚合文档中特定数字字段的总和。 例如，</p> 
 <pre><code>POST http://localhost:9200/schools*/_search
</code></pre>
 <p><strong>请求正文</strong></p> 
 <pre><code class="lang-json">{
   "aggs" : {
      "total_fees" : { "sum" : { "field" : "fees" } }
   }
}
</code></pre> 
 <p><strong>响应</strong></p> 
 <pre><code class="lang-json">"aggregations":{"total_fees":{"value":10900.0}}
</code></pre> 
 <p>在特殊情况下使用的一些其他度量聚合，例如地理边界聚集和用于地理位置的地理中心聚集。</p> 
 <h3 id="h3-u6876u805Au5408"><a name="桶聚合" class="reference-link"></a><span class="header-link octicon octicon-link"></span>桶聚合</h3>
 <p>这些聚合包含用于具有标准的不同类型的桶聚合，该标准确定文档是否属于某一个桶。桶聚合已经在下面描述 -</p> 
 <p><strong>子聚集</strong></p> 
 <p>此存储桶聚合会生成映射到父存储桶的文档集合。类型参数用于定义父索引。 例如，我们有一个品牌及其不同的模型，然后模型类型将有以下<code>_parent</code>字段 -</p> 
 <pre><code class="lang-json">{
   "model" : {
      "_parent" : {
         "type" : "brand"
      }
   }
}
</code></pre> 
 <p>还有许多其他特殊的桶聚合，这在许多其他情况下是有用的，它们分别是 -</p> 
 <ul> 
  <li>日期直方图汇总/聚合</li>
  <li>日期范围汇总/聚合</li>
  <li>过滤聚合</li>
  <li>过滤器聚合</li>
  <li>地理距离聚合</li>
  <li>GeoHash网格聚合</li>
  <li>全局汇总</li>
  <li>直方图聚合</li>
  <li>IPv4范围聚合</li>
  <li>失踪聚合</li>
  <li>嵌套聚合</li>
  <li>范围聚合</li>
  <li>反向嵌套聚合</li>
  <li>采样器聚合</li>
  <li>重要条款聚合</li>
  <li>术语聚合</li>
 </ul> 
 <h3 id="h3-u805Au5408u5143u6570u636E"><a name="聚合元数据" class="reference-link"></a><span class="header-link octicon octicon-link"></span>聚合元数据</h3>
 <p>可以通过使用元标记在请求时添加关于聚合的一些数据，并可以获得响应。 例如，</p> 
 <pre><code>POST http://localhost:9200/school*/report/_search
</code></pre>
 <p><strong>请求正文</strong></p> 
 <pre><code class="lang-json">{
   "aggs" : {
      "min_fees" : { "avg" : { "field" : "fees" } ,
         "meta" :{
            "dsc" :"Lowest Fees"
         }
      }
   }
}
</code></pre> 
 <p><strong>响应</strong></p> 
 <pre><code class="lang-json">{
   "aggregations":{"min_fees":{"meta":{"dsc":"Lowest Fees"}, "value":2180.0}}
}
</code></pre>
 <br>      
</div></body></html>
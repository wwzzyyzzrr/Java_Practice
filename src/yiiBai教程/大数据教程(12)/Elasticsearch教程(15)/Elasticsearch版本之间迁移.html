<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Elasticsearch版本之间迁移</h1><div style="width:100%;float:left;" class="article-content">   
 <p>在任何系统或软件中，当我们升级到较新版本时，需要按照几个步骤来维护应用程序设置，配置，数据和其他事情。 这些步骤是使应用程序在新系统中保持稳定或保持数据的完整性(防止数据损坏)所必需的。</p> 
 <p>以下是升级Elasticsearch的步骤 -</p> 
 <ul> 
  <li>从 <a target="_blank" href="http://www.elastic.co/">http://www.elastic.co/</a> 阅读了解如何更改文档。</li>
  <li>在非生产环境(如UAT，E2E，SIT或DEV环境)中测试升级版本。</li>
  <li>如果没有数据备份，则无法回滚到上一个Elasticsearch版本。 建议在升级到更高版本之前进行数据备份。</li>
  <li>可以使用完全群集重新启动或滚动升级进行升级。 滚动升级适用于新版本(适用于2.x和更高版本)。当您使用滚动升级方法进行迁移时，不要中断服务。</li>
 </ul> 
 <table> 
  <thead> 
   <tr> 
    <th>旧版</th> 
    <th>新版</th> 
    <th>升级方法</th> 
   </tr> 
  </thead> 
  <tbody> 
   <tr> 
    <td>0.90.x</td> 
    <td>2.x</td> 
    <td>完全群集重新启动</td> 
   </tr> 
   <tr> 
    <td>1.x</td> 
    <td>2.x</td> 
    <td>完全群集重新启动</td> 
   </tr> 
   <tr> 
    <td>2.x</td> 
    <td>2.y</td> 
    <td>滚动升级(y&gt; x)</td> 
   </tr> 
  </tbody> 
 </table> 
 <ul> 
  <li>在迁移前进行数据备份，并按照说明执行备份过程。 快照和恢复模块可用于进行备份。此模块可用于创建索引或完整集群的快照，并可存储在远程存储库中。</li>
 </ul> 
 <h2 id="h2-u5FEBu7167u548Cu8FD8u539Fu6A21u5757"><a name="快照和还原模块" class="reference-link"></a><span class="header-link octicon octicon-link"></span>快照和还原模块</h2>
 <p>在开始备份过程之前，需要在Elasticsearch中注册快照存储库。</p> 
 <pre><code>PUT /_snapshot/backup1
{
   "type": "fs", "settings": {
      ... repository settings ...
   }
}
</code></pre>
 <blockquote> 
  <p>注意 - 上面的文本是对<code>http://localhost:9200/_snapshot/backup1</code>的HTTP PUT请求(可以是远程服务器的IP地址，而不是<code>localhost</code>)。其余的文本是请求正文。可以使用fiddler2和Windows中的其他网络工具。</p> 
 </blockquote> 
 <p>我们使用共享文件系统(类型：fs)进行备份; 它需要在每个主节点和数据节点中注册。只需要添加具有备份存储库路径的<code>path.repo</code>变量作为值。</p> 
 <p>添加存储库路径后，需要重新启动节点，然后可以通过执行以下命令来执行注册 -</p> 
 <pre><code class="lang-json">PUT http://localhost:9200/_snapshot/backup1
{
   "type": "fs", "settings": {
      "location": "/mount/backups/backup1", "compress": true
   }
}
</code></pre> 
 <h2 id="h2-u5B8Cu5168u7FA4u96C6u91CDu65B0u542Fu52A8"><a name="完全群集重新启动" class="reference-link"></a><span class="header-link octicon octicon-link"></span>完全群集重新启动</h2>
 <p>此升级过程包括以下步骤 -</p> 
 <p><strong>第1步</strong> - 禁用碎片分配程序，并关闭节点。</p> 
 <pre><code class="lang-json">PUT http://localhost:9200/_cluster/settings
{
   "persistent": {
      "cluster.routing.allocation.enable": "none"
   }
}
</code></pre> 
 <p>在升级<code>0.90.x</code>到<code>1.x</code>的情况下使用以下请求 -</p> 
 <pre><code class="lang-json">PUT http://localhost:9200/_cluster/settings
{
   "persistent": {
      "cluster.routing.allocation.disable_allocation": false,
      "cluster.routing.allocation.enable": "none"
   }
}
</code></pre> 
 <p><strong>第2步</strong> - 对Elasticsearch进行同步刷新 -</p> 
 <pre><code class="lang-json">POST http://localhost:9200/_flush/synced
</code></pre> 
 <p><strong>第3步</strong> - 在所有节点上，终止所有 <code>elastic</code> 服务。<br><strong>第4步</strong> - 在每个节点上执行以下操作 -</p> 
 <ul> 
  <li>在Debian或Red Hat节点中 - 可以使用rmp或dpkg通过安装新软件包来升级节点。 不要覆盖配置文件。</li>
  <li>在Windows(zip文件)或UNIX(tar文件) - 提取新版本，而不覆盖<code>config</code>目录。 您可以从旧安装复制文件或可以更改<code>path.conf</code>或<code>path.data</code>。</li>
 </ul> 
 <p><strong>第5步</strong> - 从群集中的主节点(<code>node.master</code>设置为<code>true</code>，<code>node.data</code>设置为<code>false</code>的节点)开始重新启动节点。等待一段时间以建立群集。可以通过监视日志或使用以下请求进行检查 -</p>   
 <pre><code>GET _cat/health or http://localhost:9200/_cat/health
GET _cat/nodes or http://localhost:9200/_cat/health
</code></pre>
 <p><strong>第6步</strong> - 使用<code>GET _cat/health</code>请求监视集群的形成进度，并等待黄色响应，响应将是这样 -</p> 
 <pre><code class="lang-shell">1451295971 17:46:11 elasticsearch yellow 1 1 5 5 0 0 5 0 - 50.0%
</code></pre> 
 <p><strong>第6步</strong> - 启用分片分配过程，这是在<strong>第1步</strong>中禁用的，使用以下请求 -</p> 
 <pre><code class="lang-shell">PUT http://localhost:9200/_cluster/settings
{
   "persistent": {
      "cluster.routing.allocation.enable": "all"
   }
}
</code></pre> 
 <p>在将<code>0.90.x</code>升级到<code>1.x</code>的情况下，请使用以下请求 -</p> 
 <pre><code class="lang-shell">PUT http://localhost:9200/_cluster/settings
{
   "persistent": {
      "cluster.routing.allocation.disable_allocation": true,
      "cluster.routing.allocation.enable": "all"
   }
}
</code></pre> 
 <h2 id="h2-u6EDAu52A8u5347u7EA7"><a name="滚动升级" class="reference-link"></a><span class="header-link octicon octicon-link"></span>滚动升级</h2>
 <p>它与完全群集重新启动相同，但<strong>第3步</strong>除外。在此，停止一个节点并进行升级。升级后，重新启动节点并对所有节点重复这些步骤。 启用分片分配过程后，可以通过以下请求监视：</p> 
 <pre><code class="lang-shell">GET http://localhost:9200/_cat/recovery
</code></pre>
 <br>      
</div></body></html>
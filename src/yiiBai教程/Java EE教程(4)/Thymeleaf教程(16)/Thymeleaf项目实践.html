<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Thymeleaf项目实践</h1><div style="width:100%;float:left;" class="article-content">   
 <p>为了更好地解释Thymeleaf处理模板所涉及的概念，本教程将使用一个演示应用程序，您可以下载本项目的应用程序。本项目是基于:<a target="_blank" href="https://github.com/thymeleaf/thymeleafexamples-gtvg" title="Thymeleaf虚拟杂货店">Thymeleaf虚拟杂货店</a> 的汉化修改。</p> 
 <p>这个应用程序是一个虚拟的虚拟杂货店的网站，并提供许多场景展示Thymeleaf的许多功能。</p> 
 <p>首先，我们需要为应用程序提供一组简单的模型实体:销售给客户的产品有订单信息记录。 也将管理对这些产品的注释:<br><img src="http://www.yiibai.com/uploads/images/201802/2502/798150257_93856.png" alt=""></p> 
 <p>应用程序还将有一个非常简单的服务层，由<code>Service</code>对象组成，其中包含以下方法:</p> 
 <pre><code class="lang-java">/*
 * =============================================================================
 * 
 *   Copyright (c) 2011-2016, The THYMELEAF team (http://www.thymeleaf.org)
 * 
 *   Licensed under the Apache License, Version 2.0 (the "License");
 *   you may not use this file except in compliance with the License.
 *   You may obtain a copy of the License at
 * 
 *       http://www.apache.org/licenses/LICENSE-2.0
 * 
 *   Unless required by applicable law or agreed to in writing, software
 *   distributed under the License is distributed on an "AS IS" BASIS,
 *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *   See the License for the specific language governing permissions and
 *   limitations under the License.
 * 
 * =============================================================================
 */
package com.yiibai.business.services;

import java.util.List;

import com.yiibai.business.entities.Product;
import com.yiibai.business.entities.repositories.ProductRepository;

public class ProductService {

    public ProductService() {
        super();
    }

    public List&lt;Product&gt; findAll() {
        return ProductRepository.getInstance().findAll();
    }

    public Product findById(final Integer id) {
        return ProductRepository.getInstance().findById(id);
    }
}
</code></pre> 
 <p>在Web层，应用程序将有一个过滤器，根据请求URL将执行委托给启用Thymeleaf的命令:</p> 
 <pre><code class="lang-java">/*
 * =============================================================================
 * 
 *   Copyright (c) 2011-2016, The THYMELEAF team (http://www.thymeleaf.org)
 * 
 *   Licensed under the Apache License, Version 2.0 (the "License");
 *   you may not use this file except in compliance with the License.
 *   You may obtain a copy of the License at
 * 
 *       http://www.apache.org/licenses/LICENSE-2.0
 * 
 *   Unless required by applicable law or agreed to in writing, software
 *   distributed under the License is distributed on an "AS IS" BASIS,
 *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *   See the License for the specific language governing permissions and
 *   limitations under the License.
 * 
 * =============================================================================
 */
package com.yiibai.web.filter;

import java.io.IOException;

import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.thymeleaf.ITemplateEngine;
import com.yiibai.business.entities.User;
import com.yiibai.web.application.GTVGApplication;
import com.yiibai.web.controller.IGTVGController;


public class GTVGFilter implements Filter {

    private ServletContext servletContext;
    private GTVGApplication application;

    public GTVGFilter() {
        super();
    }

    private static void addUserToSession(final HttpServletRequest request) {
        // Simulate a real user session by adding a user object
        request.getSession(true).setAttribute("user", new User("John", "Apricot", "Antarctica", null));
    }

    public void init(final FilterConfig filterConfig) throws ServletException {
        this.servletContext = filterConfig.getServletContext();
        this.application = new GTVGApplication(this.servletContext);
    }

    public void doFilter(final ServletRequest request, final ServletResponse response,
            final FilterChain chain) throws IOException, ServletException {
        addUserToSession((HttpServletRequest)request);
        if (!process((HttpServletRequest)request, (HttpServletResponse)response)) {
            chain.doFilter(request, response);
        }
    }

    public void destroy() {
        // nothing to do
    }

    private boolean process(HttpServletRequest request, HttpServletResponse response)
            throws ServletException {
        try {

            // This prevents triggering engine executions for resource URLs
            if (request.getRequestURI().startsWith("/css") ||
                    request.getRequestURI().startsWith("/images") ||
                    request.getRequestURI().startsWith("/favicon")) {
                return false;
            }
            /*
             * Query controller/URL mapping and obtain the controller
             * that will process the request. If no controller is available,
             * return false and let other filters/servlets process the request.
             */
            IGTVGController controller = this.application.resolveControllerForRequest(request);
            if (controller == null) {
                return false;
            }

            /*
             * Obtain the TemplateEngine instance.
             */
            ITemplateEngine templateEngine = this.application.getTemplateEngine();

            /*
             * Write the response headers
             */
            response.setContentType("text/html;charset=UTF-8");
            response.setHeader("Pragma", "no-cache");
            response.setHeader("Cache-Control", "no-cache");
            response.setDateHeader("Expires", 0);

            /*
             * Execute the controller and process view template,
             * writing the results to the response writer. 
             */
            controller.process(
                    request, response, this.servletContext, templateEngine);

            return true;

        } catch (Exception e) {
            try {
                response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);
            } catch (final IOException ignored) {
                // Just ignore this
            }
            throw new ServletException(e);
        }
    }

}
</code></pre> 
 <p>下面是<code>IGTVGController</code>接口的代码:</p> 
 <pre><code class="lang-java">/*
 * =============================================================================
 * 
 *   Copyright (c) 2011-2016, The THYMELEAF team (http://www.thymeleaf.org)
 * 
 *   Licensed under the Apache License, Version 2.0 (the "License");
 *   you may not use this file except in compliance with the License.
 *   You may obtain a copy of the License at
 * 
 *       http://www.apache.org/licenses/LICENSE-2.0
 * 
 *   Unless required by applicable law or agreed to in writing, software
 *   distributed under the License is distributed on an "AS IS" BASIS,
 *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *   See the License for the specific language governing permissions and
 *   limitations under the License.
 * 
 * =============================================================================
 */
package com.yiibai.web.controller;

import javax.servlet.ServletContext;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.thymeleaf.ITemplateEngine;

public interface IGTVGController {

    public void process(
            HttpServletRequest request, HttpServletResponse response,
            ServletContext servletContext, ITemplateEngine templateEngine)
            throws Exception;

}
</code></pre> 
 <p>我们现在要做的就是创建<code>IGTVGController</code>接口的实现，从服务中检索数据并使用<code>ITemplateEngine</code>对象处理模板。</p> 
 <p>最后，它会看起来得到类似下面的页面:<br><img src="http://www.yiibai.com/uploads/images/201802/2502/869160213_33581.png" alt=""></p> 
 <p>但首先来看看这个模板引擎是如何初始化的。</p> 
 <h2 id="h2-u521Bu5EFAu548Cu914Du7F6Eu6A21u677Fu5F15u64CE"><a name="创建和配置模板引擎" class="reference-link"></a><span class="header-link octicon octicon-link"></span>创建和配置模板引擎</h2>
 <p>过滤器中的<code>process(…)</code>方法包含这一行:</p>   
 <pre><code class="lang-java">ITemplateEngine templateEngine = this.application.getTemplateEngine();
</code></pre> 
 <p><code>GTVGApplication</code>类负责创建和配置Thymeleaf应用程序中最重要的对象之一:TemplateEngine实例(实现<code>ITemplateEngine</code>接口)。<br><code>org.thymeleaf.TemplateEngine</code>对象是这样初始化的:</p> 
 <pre><code class="lang-java">public class GTVGApplication {


    ...
    private final TemplateEngine templateEngine;
    ...


    public GTVGApplication(final ServletContext servletContext) {

        super();

        ServletContextTemplateResolver templateResolver = 
                new ServletContextTemplateResolver(servletContext);

        // HTML is the default mode, but we set it anyway for better understanding of code
        templateResolver.setTemplateMode(TemplateMode.HTML);
        // This will convert "home" to "/WEB-INF/templates/home.html"
        templateResolver.setPrefix("/WEB-INF/templates/");
        templateResolver.setSuffix(".html");
        // Template cache TTL=1h. If not set, entries would be cached until expelled by LRU
        templateResolver.setCacheTTLMs(Long.valueOf(3600000L));

        // Cache is set to true by default. Set to false if you want templates to
        // be automatically updated when modified.
        templateResolver.setCacheable(true);

        this.templateEngine = new TemplateEngine();
        this.templateEngine.setTemplateResolver(templateResolver);

        ...

    }

}
</code></pre> 
 <p>配置<code>TemplateEngine</code>对象的方法有很多种，但现在这几行代码将足以教会需要的步骤。</p> 
 <p><strong>模板解析器</strong></p> 
 <p>从模板解析器开始:</p> 
 <pre><code class="lang-java">ServletContextTemplateResolver templateResolver = 
        new ServletContextTemplateResolver(servletContext);
</code></pre> 
 <p>模板解析器是实现来自Thymeleaf API(名为<code>org.thymeleaf.templateresolver.ITemplateResolver</code>)的接口的对象:</p> 
 <pre><code class="lang-java">public interface ITemplateResolver {

    ...

    /*
     * Templates are resolved by their name (or content) and also (optionally) their 
     * owner template in case we are trying to resolve a fragment for another template.
     * Will return null if template cannot be handled by this template resolver.
     */
    public TemplateResolution resolveTemplate(
            final IEngineConfiguration configuration,
            final String ownerTemplate, final String template,
            final Map&lt;String, Object&gt; templateResolutionAttributes);
}
</code></pre> 
 <p>这些对象负责确定模板将如何被访问，并且在这个GTVG应用程序中，org.thymeleaf.templateresolver.ServletContextTemplateResolver意味着我们要从Servlet上下文中检索我们的模板文件作为资源:一个应用程序范围的javax .servlet.ServletContext对象，它存在于每个Java Web应用程序中，并解析来自Web应用程序根目录的资源。</p> 
 <p>但这并不是我们说的模板解析器，因为可以在其上设置一些配置参数。 首先，模板模式:</p> 
 <pre><code class="lang-java">templateResolver.setTemplateMode(TemplateMode.HTML);
</code></pre> 
 <p>HTML是<code>ServletContextTemplateResolver</code>的默认模板模式，但最好还是建立它，以便可以清楚知道代码执行了什么。</p> 
 <pre><code class="lang-java">templateResolver.setPrefix("/WEB-INF/templates/");
templateResolver.setSuffix(".html");
</code></pre> 
 <p>前缀和后缀修改了将传递给引擎以获取要使用的真实资源名称的模板名称。</p> 
 <p>使用此配置，模板名称<code>“product/list”</code>将对应于:</p> 
 <pre><code class="lang-java">servletContext.getResourceAsStream("/WEB-INF/templates/product/list.html")
</code></pre> 
 <p>可选地，解析模板可以存储在缓存中的时间量是通过cacheTTLMs属性在模板解析器中配置:</p> 
 <pre><code class="lang-java">templateResolver.setCacheTTLMs(3600000L);
</code></pre> 
 <p>如果达到最大高速缓存大小并且它是当前高速缓存的最旧条目，则在达到TTL之前，模板仍可从高速缓存中排除。</p> 
 <h2 id="h2--strong-strong-"><a name="<strong>模板引擎</strong>" class="reference-link"></a><span class="header-link octicon octicon-link"></span><strong>模板引擎</strong></h2>
 <p>模板引擎对象是<code>org.thymeleaf.ITemplateEngine</code>接口的实现。 其中一个实现由Thymeleaf核心提供:<code>org.thymeleaf.TemplateEngine</code>，在这里创建一个实例:</p> 
 <pre><code class="lang-java">templateEngine = new TemplateEngine();
templateEngine.setTemplateResolver(templateResolver);
</code></pre> 
 <p>很简单，不是吗？ 需要的只是创建一个实例并为其设置模板解析器。</p> 
 <p>模板解析器是<code>TemplateEngine</code>需要的唯一必需的参数，不过稍后还会介绍其他许多参数(消息解析器，缓存大小等)。</p> 
 <p>我们的模板引擎已准备就绪，就可以使用Thymeleaf开始创建页面了。有关项目的代码，可以从: <a target="_blank" href="https://pan.baidu.com/s/1nwBa9Gd">https://pan.baidu.com/s/1nwBa9Gd</a> 下载。</p>
 <br>      
</div></body></html>
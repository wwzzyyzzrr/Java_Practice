<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Spring编写服务器</h1><div style="width:100%;float:left;" class="article-content">   
 <p>在本章中，我们将了解如何使用Spring WS创建Web应用程序服务器。请参考以下步骤:</p> 
 <p><strong>第1步:</strong> 按照Spring WS入门程序章节的介绍，创建一个名称为：<code>countryService</code> 的项目，并在这个项目中创建一个名为<code>com.yiibai</code>的包。</p> 
 <p><strong>第2步:</strong> 按照以下步骤中的说明创建:<em>countries.xsd</em>，以及域类:<code>CountryRepository</code>和<code>CountryEndPoint</code>。</p> 
 <p><strong>第3步:</strong> 更新<code>/WEB-INF</code>子文件夹下<code>spring-ws-servlet.xml</code>。</p> 
 <p><strong>第4步:</strong> 最后一步是为所有源文件和配置文件创建内容，并按照下面的说明导出应用程序。</p> 
 <p>文件:<em>countries.xsd</em> - </p> 
 <pre><code class="lang-xml">&lt;xs:schema xmlns:xs = "http://www.w3.org/2001/XMLSchema" 
   xmlns:tns = "http://www.yiibai/schemas"
   targetNamespace = "http://www.yiibai/schemas" 
   elementFormDefault = "qualified"&gt;

   &lt;xs:element name = "getCountryRequest"&gt;
      &lt;xs:complexType&gt;
         &lt;xs:sequence&gt;
            &lt;xs:element name = "name" type = "xs:string"/&gt;
         &lt;/xs:sequence&gt;
      &lt;/xs:complexType&gt;
   &lt;/xs:element&gt;

   &lt;xs:element name = "getCountryResponse"&gt;
      &lt;xs:complexType&gt;
         &lt;xs:sequence&gt;
            &lt;xs:element name = "country" type = "tns:country"/&gt;
         &lt;/xs:sequence&gt;
      &lt;/xs:complexType&gt;
   &lt;/xs:element&gt;

   &lt;xs:complexType name = "country"&gt;
      &lt;xs:sequence&gt;
         &lt;xs:element name = "name" type = "xs:string"/&gt;
         &lt;xs:element name = "population" type = "xs:int"/&gt;
         &lt;xs:element name = "capital" type = "xs:string"/&gt;
         &lt;xs:element name = "currency" type = "tns:currency"/&gt;
      &lt;/xs:sequence&gt;
   &lt;/xs:complexType&gt;

   &lt;xs:simpleType name = "currency"&gt;
      &lt;xs:restriction base = "xs:string"&gt;
         &lt;xs:enumeration value = "RMB"/&gt;
     &lt;xs:enumeration value = "GBP"/&gt;
         &lt;xs:enumeration value = "USD"/&gt;
         &lt;xs:enumeration value = "INR"/&gt;
      &lt;/xs:restriction&gt;
   &lt;/xs:simpleType&gt;
&lt;/xs:schema&gt;
</code></pre> 
 <h2 id="h2-u521Bu5EFAu9879u76EE"><a name="创建项目" class="reference-link"></a><span class="header-link octicon octicon-link"></span>创建项目</h2>
 <p>打开Eclise创建一个Maven项目，项目名称为: <em>countryService</em> ，完整的项目目录结构如下 - </p> 
 <p><img src="http://www.yiibai.com/uploads/images/201805/2905/383150502_50350.png" alt=""></p> 
 <p>更新文件:<em>pom.xml</em> 中的代码 - </p> 
 <pre><code class="lang-xml">&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;groupId&gt;com.yiibai&lt;/groupId&gt;
    &lt;artifactId&gt;countryService&lt;/artifactId&gt;
    &lt;packaging&gt;war&lt;/packaging&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;name&gt;countryService Maven Webapp&lt;/name&gt;
    &lt;url&gt;http://maven.apache.org&lt;/url&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;junit&lt;/groupId&gt;
            &lt;artifactId&gt;junit&lt;/artifactId&gt;
            &lt;version&gt;3.8.1&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.ws&lt;/groupId&gt;
            &lt;artifactId&gt;spring-ws-core&lt;/artifactId&gt;
            &lt;version&gt;2.4.0.RELEASE&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;jdom&lt;/groupId&gt;
            &lt;artifactId&gt;jdom&lt;/artifactId&gt;
            &lt;version&gt;1.0&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;jaxen&lt;/groupId&gt;
            &lt;artifactId&gt;jaxen&lt;/artifactId&gt;
            &lt;version&gt;1.1&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;wsdl4j&lt;/groupId&gt;
            &lt;artifactId&gt;wsdl4j&lt;/artifactId&gt;
            &lt;version&gt;1.6.2&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
    &lt;build&gt;
        &lt;finalName&gt;countryService&lt;/finalName&gt;
        &lt;defaultGoal&gt;compile&lt;/defaultGoal&gt;
    &lt;/build&gt;
&lt;/project&gt;
</code></pre> 
 <h2 id="h2-u521Bu5EFAu57DFu7C7B"><a name="创建域类" class="reference-link"></a><span class="header-link octicon octicon-link"></span>创建域类</h2>
 <p>将文件<em>countries.xsd</em> 复制到 <em>D:\eclipse-workspace\countryService\countryService\src\main\resources</em> ， 打开命令控制台，进入到 <em>D:\eclipse-workspace\countryService\countryService\src\main\resources</em> 目录并执行以下<code>xjc</code> 命令，以使用<code>countries.xsd</code>生成域类。</p> 
 <pre><code class="lang-shell">xjc -p com.yiibai countries.xsd
</code></pre> 
 <p>Maven将开始处理，并将在 <code>com.yiibai</code> 包中创建域类。</p> 
 <pre><code class="lang-shell">D:\eclipse-workspace\countryService\countryService\src\main\resources&gt;
xjc -p com.yiibai countries.xsd
正在解析模式...
正在编译模式...
com\yiibai\Country.java
com\yiibai\Currency.java
com\yiibai\GetCountryRequest.java
com\yiibai\GetCountryResponse.java
com\yiibai\ObjectFactory.java
com\yiibai\package-info.java

D:\eclipse-workspace\countryService\countryService\src\main\resources&gt;
</code></pre> 
 <p>在<em>D:\eclipse-workspace\countryService\countryService\src\main</em>文件夹中创建一个文件夹:<code>java</code>。 复制上面生成的所有类到<em>D:\eclipse-workspace\countryService\countryService\src\main\java</em>目录中。 并且再创建两个类:<code>CountryRepository</code>和<code>CountryEndPoint</code>分别代表国家数据库和国家/地区服务器。</p> 
 <p><em>CountryRepository.java </em> - 类代码如下所示 - </p> 
 <pre><code class="lang-java">package com.yiibai;

import java.util.ArrayList;
import java.util.List;
import org.springframework.beans.propertyeditors.CurrencyEditor;
import org.springframework.stereotype.Component;
import org.springframework.util.Assert;

@Component
public class CountryRepository {
    private static final List&lt;Country&gt; countries = new ArrayList&lt;Country&gt;();

    public CountryRepository() {
        initData();
    }

    public void initData() {
        Country us = new Country();
        us.setName("United States");
        us.setCapital("Washington");
        us.setCurrency(Currency.USD);
        us.setPopulation(46704314);

        countries.add(us);

        Country china = new Country();
        china.setName("China");
        china.setCapital("Beijing");
        china.setCurrency(Currency.RMB);
        china.setPopulation(138186860);

        countries.add(china);

        Country uk = new Country();
        uk.setName("United Kingdom");
        uk.setCapital("London");
        uk.setCurrency(Currency.GBP);
        uk.setPopulation(63705000);

        countries.add(uk);
    }

    public Country findCountry(String name) {
        Assert.notNull(name);
        Country result = null;

        for (Country country : countries) {
            if (name.trim().equals(country.getName())) {
                result = country;
            }
        }
        return result;
    }
}
</code></pre> 
 <p>文件:<em>CountryEndPoint.java</em> 的代码如下 - </p>   
 <pre><code class="lang-java">package com.yiibai;

import org.jdom.JDOMException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.ws.server.endpoint.annotation.Endpoint;
import org.springframework.ws.server.endpoint.annotation.PayloadRoot;
import org.springframework.ws.server.endpoint.annotation.RequestPayload;
import org.springframework.ws.server.endpoint.annotation.ResponsePayload;

import com.yiibai.Country;
import com.yiibai.CountryRepository;
import com.yiibai.GetCountryRequest;
import com.yiibai.GetCountryResponse;

@Endpoint
public class CountryEndPoint {
   private static final String NAMESPACE_URI = "http://www.yiibai/schemas";
   private CountryRepository countryRepository;

   @Autowired
   public CountryEndPoint(CountryRepository countryRepository) throws JDOMException {
      this.countryRepository = countryRepository;
   }
   @PayloadRoot(namespace = NAMESPACE_URI, localPart = "getCountryRequest")
   @ResponsePayload
   public GetCountryResponse getCountry(@RequestPayload GetCountryRequest request) 
      throws JDOMException {

      Country country = countryRepository.findCountry(request.getName());
      GetCountryResponse response = new GetCountryResponse();
      response.setCountry(country);
      return response;
   }
}
</code></pre> 
 <p>文件:<em>/WEB-INF/spring-ws-servlet.xml</em> 中的代码如下所示 - </p> 
 <pre><code class="lang-xml">&lt;beans xmlns = "http://www.springframework.org/schema/beans"
   xmlns:xsi = "http://www.w3.org/2001/XMLSchema-instance"
   xmlns:context = "http://www.springframework.org/schema/context"
   xmlns:sws = "http://www.springframework.org/schema/web-services"
   xsi:schemaLocation = "http://www.springframework.org/schema/beans

   http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
   http://www.springframework.org/schema/web-services
   http://www.springframework.org/schema/web-services/web-services-2.0.xsd
   http://www.springframework.org/schema/context 
   http://www.springframework.org/schema/context/spring-context-3.0.xsd"&gt;

   &lt;context:component-scan base-package = "com.yiibai"/&gt;
   &lt;sws:annotation-driven/&gt;

   &lt;sws:dynamic-wsdl id="countries"
      portTypeName = "CountriesPort"
      locationUri = "/countryService/"
      targetNamespace = "http://www.yiibai.com/definitions"&gt;
      &lt;sws:xsd location = "/WEB-INF/countries.xsd"/&gt;
   &lt;/sws:dynamic-wsdl&gt;
&lt;/beans&gt;
</code></pre> 
 <p>文件:<em>/WEB-INF/web.xml</em> 中的代码如下所示 -</p> 
 <pre><code class="lang-xml">&lt;web-app xmlns = "http://java.sun.com/xml/ns/j2ee"
   xmlns:xsi = "http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation = "http://java.sun.com/xml/ns/j2ee
   http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd"
   version = "2.4"&gt;

   &lt;display-name&gt;Yiibai Country Service&lt;/display-name&gt;

   &lt;servlet&gt;
      &lt;servlet-name&gt;spring-ws&lt;/servlet-name&gt;
      &lt;servlet-class&gt;org.springframework.ws.transport.http.MessageDispatcherServlet
      &lt;/servlet-class&gt;
      &lt;init-param&gt;
         &lt;param-name&gt;transformWsdlLocations&lt;/param-name&gt;
         &lt;param-value&gt;true&lt;/param-value&gt;
      &lt;/init-param&gt;
   &lt;/servlet&gt;

   &lt;servlet-mapping&gt;
      &lt;servlet-name&gt;spring-ws&lt;/servlet-name&gt;
      &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
   &lt;/servlet-mapping&gt;
&lt;/web-app&gt;
</code></pre> 
 <h2 id="h2-u8FD0u884Cu8BE5u9879u76EE"><a name="运行该项目" class="reference-link"></a><span class="header-link octicon octicon-link"></span>运行该项目</h2>
 <p>创建源文件和配置文件后，构建完成后，发布到Tomcat的服务器中。启动Tomcat服务器完成后，使用标准浏览器进行POST请求 - <code>http://localhost:8080/countryService /</code>，并通过使用任何SOAP客户端发出以下请求。</p> 
 <pre><code class="lang-xml">&lt;x:Envelope xmlns:x = "http://schemas.xmlsoap.org/soap/envelope/" 
   xmlns:tns = "http://www.yiibai/schemas"&gt;
   &lt;x:Header/&gt;
   &lt;x:Body&gt;
      &lt;tns:getCountryRequest&gt;
         &lt;tns:name&gt;United States&lt;/tns:name&gt;
      &lt;/tns:getCountryRequest&gt;
   &lt;/x:Body&gt;
&lt;/x:Envelope&gt;
</code></pre> 
 <p>应该会看到类似以下的结果 - </p> 
 <pre><code class="lang-xml">&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV = "http://schemas.xmlsoap.org/soap/envelope/"&gt;
   &lt;SOAP-ENV:Header/&gt;
   &lt;SOAP-ENV:Body&gt;
      &lt;ns2:getCountryResponse xmlns:ns2 = "http://www.yiibai/schemas"&gt;
         &lt;ns2:country&gt;
            &lt;ns2:name&gt;United States&lt;/ns2:name&gt;
            &lt;ns2:population&gt;46704314&lt;/ns2:population&gt;
            &lt;ns2:capital&gt;Washington&lt;/ns2:capital&gt;
            &lt;ns2:currency&gt;USD&lt;/ns2:currency&gt;
         &lt;/ns2:country&gt;
      &lt;/ns2:getCountryResponse&gt;
   &lt;/SOAP-ENV:Body&gt;
&lt;/SOAP-ENV:Envelope&gt;
</code></pre>
 <br>      
</div></body></html>
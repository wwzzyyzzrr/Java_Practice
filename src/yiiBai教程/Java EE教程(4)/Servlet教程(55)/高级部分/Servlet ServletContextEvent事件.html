<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Servlet ServletContextEvent事件</h1><div style="width:100%;float:left;" class="article-content">   
 <p>当Web应用程序部署在服务器上时，会通知<code>ServletContextEvent</code>事件。</p> 
 <p>如果要在部署Web应用程序时执行某些操作，例如创建数据库连接，创建项目的所有表等，则需要实现<code>ServletContextListener</code>接口并提供其方法的实现。</p> 
 <p><strong>ServletContextEvent类的构造方法</strong></p> 
 <p>在<code>ServletContextEvent</code>类中只定义了一个构造函数。Web容器在<code>ServletContext</code>实例之后创建<code>ServletContextEvent</code>的实例。</p> 
 <ul> 
  <li><code>ServletContextEvent(ServletContext e)</code></li>
 </ul> 
 <p><strong>ServletContextEvent类的方法</strong></p> 
 <p><code>ServletContextEvent</code>类中只定义了一个方法：</p> 
 <ul> 
  <li><code>public ServletContext getServletContext()</code> - 返回<code>ServletContext</code>的实例。</li>
 </ul> 
 <p><strong>ServletContextListener接口的方法</strong></p> 
 <p>在<code>ServletContextListener</code>接口中声明了两种方法，这些方法必须由<code>servlet</code>程序员实现，以执行一些操作，如创建数据库连接等。</p> 
 <ul> 
  <li><code>public void contextInitialized(ServletContextEvent e)</code>: 当应用程序部署在服务器上时被调用。</li>
  <li><code>public void contextDestroyed(ServletContextEvent e)</code>: 当应用程序从服务器取消部署时被调用。</li>
 </ul> 
 <h2 id="h2-servletcontextevent-servletcontextlistener-"><a name="ServletContextEvent和ServletContextListener的示例" class="reference-link"></a><span class="header-link octicon octicon-link"></span>ServletContextEvent和ServletContextListener的示例</h2>
 <p>在这个例子中，从<code>employees</code>表中检索数据。为了实现这个服务，我们在监听器类中创建了连接数据库对象，并在servlet中使用了连接对象。</p> 
 <p>首先，在MySQL中创建一个名称为：<em>testdb</em> 的数据库，创建以下表及以数据记录 - </p> 
 <pre><code class="lang-sql">DROP TABLE IF EXISTS `employees`;
CREATE TABLE `employees` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(64) NOT NULL DEFAULT '',
  `age` int(3) unsigned NOT NULL DEFAULT '0',
  `address` varchar(254) DEFAULT NULL,
  `salary` float(8,2) unsigned DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;

-- ----------------------------
-- Records of employees
-- ----------------------------
INSERT INTO `employees` VALUES ('1', '李小春', '23', '海口市人民大道1800号', '8900.00');
INSERT INTO `employees` VALUES ('2', '张辉', '28', '广州天河区珠村市场', '15800.00');
INSERT INTO `employees` VALUES ('3', '林贤弟', '25', '广州白云区龙塘村120号', '18990.00');
</code></pre> 
 <p>打开Eclipse，创建一个动态Web项目：<em>ServletContextEvent</em>，其完整的目录结构如下 - </p> 
 <p><img src="http://www.yiibai.com/uploads/images/201710/1210/698091045_43795.png" alt=""></p> 
 <p>以下是项目中的几个主要的文件代码。</p> 
 <p>文件：<em>index.html</em> - </p> 
 <pre><code class="lang-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta charset="UTF-8"&gt;
&lt;title&gt;ServletContextListener实例&lt;/title&gt;
&lt;/head&gt;
&lt;body style="text-algin: center;"&gt;
    &lt;a href="getdata"&gt;点击读取employees表中的数据&lt;/a&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre> 
 <p>文件：<em>MyListener.java</em> - </p> 
 <pre><code>package com.yiibai;

import java.sql.Connection;
import java.sql.DriverManager;

import javax.servlet.ServletContext;
import javax.servlet.ServletContextEvent;
import javax.servlet.ServletContextListener;
import javax.servlet.annotation.WebListener;

/**
 * Application Lifecycle Listener implementation class MyListener
 *
 */
@WebListener
public class MyListener implements ServletContextListener {

    public void contextInitialized(ServletContextEvent event) {

        String jdbcDriver = "com.mysql.jdbc.Driver";
        String dbURL = "jdbc:mysql://localhost/testdb";

        // Database credentials
        String dbUser = "root";
        final String passwd = "123456";
        try {
            Class.forName(jdbcDriver);
            Connection con = DriverManager.getConnection(dbURL, dbUser, passwd);
            // storing connection object as an attribute in ServletContext
            ServletContext ctx = event.getServletContext();
            ctx.setAttribute("mycon", con);

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public void contextDestroyed(ServletContextEvent arg0) {
        System.out.println("Servlet has contextDestroyed...");
    }

}
</code></pre>
 <p>文件：<em>FetchData.java</em> - </p> 
 <pre><code class="lang-java">package com.yiibai;

import java.io.IOException;
import java.io.PrintWriter;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;

import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

/**
 * Servlet implementation class FetchData
 */
public class FetchData extends HttpServlet {
    private static final long serialVersionUID = 1L;

    /**
     * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse
     *      response)
     */
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        // TODO Auto-generated method stub
        response.setCharacterEncoding("UTF-8");
        response.setContentType("text/html;charset=UTF-8");
        PrintWriter out = response.getWriter();

        try {
            // Retrieving connection object from ServletContext object
            ServletContext ctx = getServletContext();
            Connection con = (Connection) ctx.getAttribute("mycon");
            if(con==null) {
                System.out.println("获取数据库连接异常~！");
            }
            // retieving data from emp32 table
            String sql = "SELECT * FROM employees";
            PreparedStatement ps = con.prepareStatement(sql, ResultSet.TYPE_SCROLL_SENSITIVE,
                    ResultSet.CONCUR_UPDATABLE);

            ResultSet rs = ps.executeQuery();
            while (rs.next()) {
                out.print("&lt;br&gt;" + rs.getString(1) + " " + rs.getString(2));
            }
            con.close();
        } catch (Exception e) {
            e.printStackTrace();
        }

        out.close();
    }
}
</code></pre> 
 <p>文件：<em>web.xml</em> - </p>   
 <pre><code class="lang-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns="http://xmlns.jcp.org/xml/ns/javaee"
    xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"
    id="WebApp_ID" version="3.1"&gt;
    &lt;display-name&gt;ServletContextEvent&lt;/display-name&gt;
    &lt;welcome-file-list&gt;
        &lt;welcome-file&gt;index.html&lt;/welcome-file&gt;
        &lt;welcome-file&gt;index.jsp&lt;/welcome-file&gt;
    &lt;/welcome-file-list&gt;
    &lt;listener&gt;
        &lt;listener-class&gt;com.yiibai.MyListener&lt;/listener-class&gt;
    &lt;/listener&gt;
    &lt;servlet&gt;
        &lt;servlet-name&gt;FetchDataServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;com.yiibai.FetchData&lt;/servlet-class&gt;
    &lt;/servlet&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;FetchDataServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/getdata&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
&lt;/web-app&gt;
</code></pre> 
 <p>在编写上面代码后，部署此Web应用程序(在项目名称上点击右键-&gt;”Run On Server…”)，打开浏览器访问URL： <a target="_blank" href="http://localhost:8080/ServletContextEvent/">http://localhost:8080/ServletContextEvent/</a> ，如果没有错误，应该会看到以下结果 -</p> 
 <p><img src="http://www.yiibai.com/uploads/images/201710/1210/867091048_68116.png" alt=""></p> 
 <p>点击上面链接后，从数据库表中读取到的数据如下所示 - </p> 
 <p><img src="http://www.yiibai.com/uploads/images/201710/1210/283091049_20884.png" alt=""></p> 
 <h2 id="h2-servletcontextlistener-"><a name="ServletContextListener创建项目表的示例" class="reference-link"></a><span class="header-link octicon octicon-link"></span>ServletContextListener创建项目表的示例</h2>
 <p>在这个例子中，我们创建一个项目所使用的表。因此不需要在数据库中手动创建所有表。</p> 
 <p>修改上面<em>MyListener.java</em>中的示例代码：</p> 
 <pre><code class="lang-java">package com.yiibai;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;

import javax.servlet.ServletContext;
import javax.servlet.ServletContextEvent;
import javax.servlet.ServletContextListener;
import javax.servlet.annotation.WebListener;

/**
 * Application Lifecycle Listener implementation class MyListener
 *
 */
@WebListener
public class MyListener implements ServletContextListener {

    public void contextInitialized(ServletContextEvent event) {

        String jdbcDriver = "com.mysql.jdbc.Driver";
        String dbURL = "jdbc:mysql://localhost/testdb";

        // Database credentials
        String dbUser = "root";
        final String passwd = "123456";
        try {
            Class.forName(jdbcDriver);
            Connection con = DriverManager.getConnection(dbURL, dbUser, passwd);
            String query="CREATE TABLE `employees` (" + 
                    "  `id` int(10) unsigned NOT NULL AUTO_INCREMENT," + 
                    "  `name` varchar(64) NOT NULL DEFAULT ''," + 
                    "  `age` int(3) unsigned NOT NULL DEFAULT '0'," + 
                    "  `address` varchar(254) DEFAULT NULL," + 
                    "  `salary` float(8,2) unsigned DEFAULT NULL," + 
                    "  PRIMARY KEY (`id`)" + 
                    ") ENGINE=MyISAM AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;";  
            PreparedStatement ps=con.prepareStatement(query);  
            ps.executeUpdate();  

            System.out.println(query);  

            // storing connection object as an attribute in ServletContext
            ServletContext ctx = event.getServletContext();
            ctx.setAttribute("mycon", con);

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public void contextDestroyed(ServletContextEvent arg0) {
        System.out.println("Servlet has contextDestroyed...");
    }

}
</code></pre> 
 <p><strong>ServletContextListener的其他示例</strong></p> 
 <ul> 
  <li><a target="_blank" href="http://www.yiibai.com/servlet/improving-servlet-performance-to-fetch-records.html" title="高性能ServletContextListener的示例">高性能ServletContextListener的示例</a></li>
 </ul>
 <br>      
</div></body></html>
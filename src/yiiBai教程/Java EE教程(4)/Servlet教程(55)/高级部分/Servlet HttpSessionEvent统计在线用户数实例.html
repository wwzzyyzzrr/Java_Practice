<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Servlet HttpSessionEvent统计在线用户数实例</h1><div style="width:100%;float:left;" class="article-content">   
 <p>会话对象更改时通知<code>HttpSessionEvent</code>，此事件的相应侦听器接口是<code>HttpSessionListener</code>。</p> 
 <p>我们可以在这个事件上执行一些操作，例如：计数统计当前登录的用户，记录登录时间，注销时间等用户详细信息。</p> 
 <p><strong>HttpSessionListener接口的方法</strong></p> 
 <p>在<code>HttpSessionListener</code>接口中声明了两种方法，这些方法必须由servlet程序员来实现，以执行某些操作。</p> 
 <ul> 
  <li><code>public void sessionCreated(HttpSessionEvent e)</code>：在创建会话对象时被调用。</li>
  <li><code>public void sessionDestroyed(ServletContextEvent e)</code>：当会话无效时被调用。</li>
 </ul> 
 <h2 id="h2-httpsessionevent-httpsessionlistener-"><a name="HttpSessionEvent和HttpSessionListener统计当前登录用户数的示例" class="reference-link"></a><span class="header-link octicon octicon-link"></span>HttpSessionEvent和HttpSessionListener统计当前登录用户数的示例</h2>
 <p>在这个例子中，实现对当前登录的用户进行统计。主要创建了以下几个代码文件：</p> 
 <ul> 
  <li><em>index.html</em>：从用户处获取输入。</li>
  <li><em>MyListener.java</em>：一个侦听器类，用于计算当前登录的用户数量，并将此信息作为属性存储在<code>ServletContext</code>对象中。</li>
  <li><em>First.java</em>：一个创建会话并打印登录用户数量的Servlet类。</li>
  <li><em>Logout.java</em>：一个使会话无效的Servlet类。</li>
 </ul> 
 <p>打开Eclipse，创建一个动态Web项目：<em>HttpSessionEvent</em>，其完整的目录结构如下所示 -</p> 
 <p>以下是这个项目中的几个主要的代码文件。</p> 
 <p>文件：<em>index.html</em> -</p> 
 <pre><code class="lang-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta charset="UTF-8"&gt;
&lt;title&gt;统计在线用户数量&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div style="font-align: center;"&gt;
        &lt;form action="first" method="post"&gt;
            用户名:&lt;input type="text" name="username" value="admin"&gt;密码:&lt;input
                type="password" name="password"&gt;&lt;input
                type="submit" value="登录" /&gt;
        &lt;/form&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre> 
 <p>监听器文件：<em>CountUserListener.java</em> -</p> 
 <pre><code class="lang-java">package com.yiibai;

import javax.servlet.ServletContext;
import javax.servlet.http.HttpSessionEvent;
import javax.servlet.http.HttpSessionListener;

public class CountUserListener implements HttpSessionListener {
    ServletContext ctx = null;
    static int total = 0, current = 0;

    public void sessionCreated(HttpSessionEvent e) {
        total++;
        current++;

        ctx = e.getSession().getServletContext();
        ctx.setAttribute("totalusers", total);
        ctx.setAttribute("currentusers", current);

    }

    public void sessionDestroyed(HttpSessionEvent e) {
        current--;
        ctx.setAttribute("currentusers", current);
    }

}
</code></pre> 
 <p>文件：<em>First.java</em> -</p> 
 <pre><code class="lang-java">package com.yiibai;

import java.io.IOException;
import java.io.PrintWriter;

import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

public class FirstServlet extends HttpServlet {
    // 显示用户数
    public void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {

        response.setCharacterEncoding("UTF-8");
        response.setContentType("text/html;charset=UTF-8");
        request.setCharacterEncoding("UTF-8");
        PrintWriter out = response.getWriter();

        // retrieving data from ServletContext object
        ServletContext ctx = getServletContext();
        int t = (Integer) ctx.getAttribute("totalusers");
        int c = (Integer) ctx.getAttribute("currentusers");
        out.print("&lt;br&gt;用户总数： " + t);
        out.print("&lt;br&gt;当前用户数： " + c);
        out.print("&lt;br&gt;&lt;a href='logout'&gt;注销&lt;/a&gt;");
        out.close();
    }

    // 执行用户登录
    public void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {

        response.setCharacterEncoding("UTF-8");
        response.setContentType("text/html;charset=UTF-8");
        request.setCharacterEncoding("UTF-8");
        PrintWriter out = response.getWriter();

        String n = request.getParameter("username");
        String password = request.getParameter("password");
        // 假设输入密码为：123456时，此用户登录成功
        if (password == null) {
            password = "";
        }
        if (password.equals("123456")) {
            out.print("您好, " + n);
            HttpSession session = request.getSession();
            session.setAttribute("uname", n);
        } else {
            out.print("登陆失败 ~");
        }
        // retrieving data from ServletContext object
        ServletContext ctx = getServletContext();
        int t = (Integer) ctx.getAttribute("totalusers");
        int c = (Integer) ctx.getAttribute("currentusers");
        out.print("&lt;br&gt;用户总数： " + t);
        out.print("&lt;br&gt;当前用户数： " + c);
        out.print("&lt;br&gt;&lt;a href='logout'&gt;注销&lt;/a&gt;");
        out.close();
    }

}
</code></pre> 
 <p>文件：<em>LogoutServlet.java</em> -</p>   
 <pre><code class="lang-java">package com.yiibai;

import java.io.IOException;
import java.io.PrintWriter;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

public class LogoutServlet extends HttpServlet {
    public void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {

        response.setContentType("text/html");
        PrintWriter out = response.getWriter();

        HttpSession session = request.getSession(false);
        session.invalidate();// invalidating session

        out.print("You are successfully logged out");

        out.close();
    }

}
</code></pre> 
 <p>文件：<em>web.xml</em> -</p> 
 <pre><code class="lang-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns="http://xmlns.jcp.org/xml/ns/javaee"
    xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"
    id="WebApp_ID" version="3.1"&gt;
    &lt;display-name&gt;HttpSessionEvent&lt;/display-name&gt;
    &lt;welcome-file-list&gt;
        &lt;welcome-file&gt;index.html&lt;/welcome-file&gt;
        &lt;welcome-file&gt;index.jsp&lt;/welcome-file&gt;
    &lt;/welcome-file-list&gt;
        &lt;listener&gt;
        &lt;listener-class&gt;com.yiibai.CountUserListener&lt;/listener-class&gt;
    &lt;/listener&gt;

    &lt;servlet&gt;
        &lt;servlet-name&gt;FirstServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;com.yiibai.FirstServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;FirstServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/first&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;    
    &lt;servlet&gt;
        &lt;servlet-name&gt;LogoutServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;com.yiibai.LogoutServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;LogoutServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/logout&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
&lt;/web-app&gt;
</code></pre> 
 <p>在编写上面代码后，部署此Web应用程序(在项目名称上点击右键-&gt;”Run On Server…”)，打开浏览器访问URL： <a target="_blank" href="http://localhost:8080/HttpSessionEvent/">http://localhost:8080/HttpSessionEvent/</a> ，如果没有错误，应该会看到以下结果 -</p> 
 <p><img src="http://www.yiibai.com/uploads/images/201710/1310/207141028_58146.png" alt=""></p> 
 <p>打开另一个浏览器访问URL： <a target="_blank" href="http://localhost:8080/HttpSessionEvent/">http://localhost:8080/HttpSessionEvent/</a> ，登录应用，然后注销，再次访问： <a target="_blank" href="http://localhost:8080/HttpSessionEvent/first">http://localhost:8080/HttpSessionEvent/first</a> ，应该看到以下结果 - </p> 
 <p><img src="http://www.yiibai.com/uploads/images/201710/1310/526141030_13158.png" alt=""></p>
 <br>      
</div></body></html>
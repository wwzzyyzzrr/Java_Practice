<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Servlet上传文件</h1><div style="width:100%;float:left;" class="article-content">   
 <p>在这里，我们将学习如何使用Servlet处理文件上传到服务器。要将文件上传到服务器，<em>html</em>文件中表单的方法必须指定为：<code>post</code>，并且<code>enctype</code>必须是<code>multipart/form-data</code>。 例如：</p> 
 <pre><code class="lang-html">&lt;form action="go" method="post" enctype="multipart/form-data"&gt;
</code></pre> 
 <blockquote> 
  <p>注意： <code>method</code>和<code>enctype</code>指定的值不正确，文件将无法正常上传和接收。</p> 
 </blockquote> 
 <h2 id="h2--servlet-"><a name="在servlet中将文件上传到服务器的示例" class="reference-link"></a><span class="header-link octicon octicon-link"></span>在servlet中将文件上传到服务器的示例</h2>
 <p>要将文件上传到服务器，有多种方法可以完成这个工作。但是，将使用由<code>oreilly</code>提供的<code>MultipartRequest</code>类。对于使用此类，必须有<code>cos.jar</code>文件。如果下载这个例子的项目代码，我们已经在项目目录<code>WEB-INF/lib</code>附带了<code>cos.jar</code>文件。</p> 
 <p>打开Eclipse，创建一个动态Web项目：<em>UploadFileHandle</em>，其完整的目录结构如下所示 -</p> 
 <p><img src="http://www.yiibai.com/uploads/images/201710/1510/922111036_10570.png" alt=""></p> 
 <p>以下是这个项目中的几个主要的代码文件。</p> 
 <p><strong>文件：index.html</strong></p> 
 <pre><code class="lang-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta charset="UTF-8"&gt;
&lt;title&gt;文件上传示例&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div style="margin: auto; text-align: center"&gt;
        &lt;form action="upload" method="post" enctype="multipart/form-data"&gt;
            选择文件:&lt;input type="file" name="fname" /&gt;&lt;input type="submit"
                value="上传" /&gt;
        &lt;/form&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre> 
 <p><strong>文件：UploadServlet.java</strong></p> 
 <pre><code class="lang-java">package com.yiibai;

import java.io.*;
import java.util.Enumeration;

import javax.servlet.ServletException;
import javax.servlet.http.*;
import com.oreilly.servlet.MultipartRequest;

public class UploadServlet extends HttpServlet {

    public void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        response.setCharacterEncoding("UTF-8");
        response.setContentType("text/html;charset=UTF-8");
        request.setCharacterEncoding("UTF-8");
        PrintWriter out = response.getWriter();
        // String dir = System.getProperty("user.dir")+"/uploads";
        String dir = request.getSession().getServletContext().getRealPath("");
        System.out.println("Save to path: " + dir);
        MultipartRequest mr = new MultipartRequest(request, dir);
        // 传回所有文件输入类型的名称
        Enumeration files = mr.getFileNames();
        String fileName = "";
        String filePath = "";
        while (files.hasMoreElements()) {
            fileName = (String) files.nextElement();
            System.out.println("FileName = " + fileName);
            // 用此方法得到上传文件的真正的文件名，这里的fileName指文件输入类型的名称
            filePath = mr.getFilesystemName(fileName);
            System.out.println("FilePath = " + filePath);
            // 此方法得到一个文件对象，代表储存在服务器上的fileName文件
            File f = mr.getFile(fileName);
            if (null == f) {
                throw new ServletException("file is not exist");
            }
        }
        out.print("successfully uploaded");
        out.close();
    }
}
</code></pre> 
 <blockquote> 
  <p>注意：<br>在<code>MultipartRequest</code>类构造函数中传递了两个参数，第一个是<code>HttpServletRequest</code>对象，第二个是<code>String</code>对象(指定存储目录位置)。在这里假设在当前项目文件下存储上传的文件。</p> 
 </blockquote> 
 <p><strong>文件：web.xml</strong></p> 
 <p>此配置文件提供有关servlet的信息。</p> 
 <pre><code class="lang-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns="http://xmlns.jcp.org/xml/ns/javaee"
    xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"
    id="WebApp_ID" version="3.1"&gt;
    &lt;display-name&gt;UploadFileHandle&lt;/display-name&gt;
    &lt;welcome-file-list&gt;
        &lt;welcome-file&gt;index.html&lt;/welcome-file&gt;
        &lt;welcome-file&gt;index.jsp&lt;/welcome-file&gt;
    &lt;/welcome-file-list&gt;
    &lt;servlet&gt;
        &lt;servlet-name&gt;UploadServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;com.yiibai.UploadServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;UploadServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/upload&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
&lt;/web-app&gt;
</code></pre> 
 <p>在编写上面代码后，部署此Web应用程序(在项目名称上点击右键-&gt;”Run On Server…”)，打开浏览器访问URL： <a target="_blank" href="http://localhost:8080/UploadHandle/">http://localhost:8080/UploadHandle/</a> ，如果没有错误，应该会看到以下结果 -</p> 
 <p><img src="http://www.yiibai.com/uploads/images/201710/1510/343111028_97823.png" alt=""></p> 
 <p>在选择好要上传文件后，提交上传，打开项目部署的目录，将会看到文件已经上传成功 - </p> 
 <p><img src="http://www.yiibai.com/uploads/images/201710/1510/580111027_29648.png" alt=""></p> 
 <p>同时在终端上也输出以下有关文件的信息：</p> 
 <pre><code class="lang-shell">Save to path: F:\worksp\servlet\.metadata\.plugins\org.eclipse.wst.server.core\tmp0\wtpwebapps\UploadFileHandle\
FileName = fname
FilePath = 0171015223409.png
</code></pre> 
 <h2 id="h2-u4E0Au4F20u6587u4EF6u5904u7406u65B9u6CD5u4E8C"><a name="上传文件处理方法二" class="reference-link"></a><span class="header-link octicon octicon-link"></span>上传文件处理方法二</h2>
 <p>以下是<code>UploadServlet</code>的源代码，可以一次处理多个文件上传。在进行之前，请确保以下内容准备完成 - </p> 
 <ul> 
  <li>以下示例使用上传组件：<code>FileUpload</code>，因此请确保类路径中有最新版本的<code>commons-fileupload.x.x.jar</code>文件。可以从 <a target="_blank" href="http://commons.apache.org/fileupload/">http://commons.apache.org/fileupload/</a> 下载。</li>
  <li><code>FileUpload</code>上传组件取决于<em>Commons IO</em>，因此请确保类路径中有最新版本的<code>commons-io-x.x.jar</code>文件，可以从 <a target="_blank" href="http://commons.apache.org/io/">http://commons.apache.org/io/</a> 下载。</li>
  <li>在测试以下示例之前，应该上传的文件的大小设置为小于<code>maxFileSize</code>，否则将不会上传文件。</li>
 </ul> 
 <p>确保提前创建目录<code>C:\temp</code>和<code>webapps\data</code>，如何实现请参考以下代码 - </p>   
 <pre><code class="lang-java">// Import required java libraries
import java.io.*;
import java.util.*;

import javax.servlet.ServletConfig;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.commons.fileupload.FileItem;
import org.apache.commons.fileupload.FileUploadException;
import org.apache.commons.fileupload.disk.DiskFileItemFactory;
import org.apache.commons.fileupload.servlet.ServletFileUpload;
import org.apache.commons.io.output.*;

public class UploadServlet extends HttpServlet {

   private boolean isMultipart;
   private String filePath;
   private int maxFileSize = 50 * 1024;
   private int maxMemSize = 4 * 1024;
   private File file ;

   public void init( ){
      // Get the file location where it would be stored.
      filePath = getServletContext().getInitParameter("file-upload"); 
   }

   public void doPost(HttpServletRequest request, HttpServletResponse response)
      throws ServletException, java.io.IOException {

      // Check that we have a file upload request
      isMultipart = ServletFileUpload.isMultipartContent(request);
      response.setContentType("text/html");
      java.io.PrintWriter out = response.getWriter( );

      if( !isMultipart ) {
         out.println("&lt;html&gt;");
         out.println("&lt;head&gt;");
         out.println("&lt;title&gt;Servlet upload&lt;/title&gt;");  
         out.println("&lt;/head&gt;");
         out.println("&lt;body&gt;");
         out.println("&lt;p&gt;No file uploaded&lt;/p&gt;"); 
         out.println("&lt;/body&gt;");
         out.println("&lt;/html&gt;");
         return;
      }

      DiskFileItemFactory factory = new DiskFileItemFactory();

      // maximum size that will be stored in memory
      factory.setSizeThreshold(maxMemSize);

      // Location to save data that is larger than maxMemSize.
      factory.setRepository(new File("c:\\temp"));

      // Create a new file upload handler
      ServletFileUpload upload = new ServletFileUpload(factory);

      // maximum file size to be uploaded.
      upload.setSizeMax( maxFileSize );

      try { 
         // Parse the request to get file items.
         List fileItems = upload.parseRequest(request);

         // Process the uploaded file items
         Iterator i = fileItems.iterator();

         out.println("&lt;html&gt;");
         out.println("&lt;head&gt;");
         out.println("&lt;title&gt;Servlet upload&lt;/title&gt;");  
         out.println("&lt;/head&gt;");
         out.println("&lt;body&gt;");

         while ( i.hasNext () ) {
            FileItem fi = (FileItem)i.next();
            if ( !fi.isFormField () ) {
               // Get the uploaded file parameters
               String fieldName = fi.getFieldName();
               String fileName = fi.getName();
               String contentType = fi.getContentType();
               boolean isInMemory = fi.isInMemory();
               long sizeInBytes = fi.getSize();

               // Write the file
               if( fileName.lastIndexOf("\\") &gt;= 0 ) {
                  file = new File( filePath + fileName.substring( fileName.lastIndexOf("\\"))) ;
               } else {
                  file = new File( filePath + fileName.substring(fileName.lastIndexOf("\\")+1)) ;
               }
               fi.write( file ) ;
               out.println("Uploaded Filename: " + fileName + "&lt;br&gt;");
            }
         }
         out.println("&lt;/body&gt;");
         out.println("&lt;/html&gt;");
         } catch(Exception ex) {
            System.out.println(ex);
         }
      }

      public void doGet(HttpServletRequest request, HttpServletResponse response)
         throws ServletException, java.io.IOException {

         throw new ServletException("GET method used with " +
            getClass( ).getName( )+": POST method required.");
      }
   }
}
</code></pre>
 <br>      
</div></body></html>
<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Kotlin JavaScript模块</h1><div style="width:100%;float:left;" class="article-content">   
 <p>Kotlin 允许你将 Kotlin 项目编译为热门模块系统的 JavaScript 模块。以下是<br>可用选项的列表：</p> 
 <ol> 
  <li>无模块(Plain)。不为任何模块系统编译。像往常一样，你可以在全局作用域中以其名称访问模块。<br>默认使用此选项。</li>
  <li><a target="_blank" href="http://github.com/amdjs/amdjs-api/wiki/AMD">异步模块定义(AMD，Asynchronous Module Definition)</a>，它尤其为<br>require.js 库所使用。</li>
  <li><a target="_blank" href="http://wiki.commonjs.org/wiki/Modules/1.1">CommonJS</a> 约定，广泛用于 node.js/npm<br>(<code>require</code> 函数和 <code>module.exports</code> 对象)</li>
  <li>统一模块定义(UMD，Unified Module Definitions)，它与 <em>AMD</em> 和 <em>CommonJS</em> 兼容，<br>并且当在运行时 <em>AMD</em> 和 <em>CommonJS</em> 都不可用时，作为“plain”使用。</li>
 </ol> 
 <h2 id="h2-u9009u62E9u76EEu6807u6A21u5757u7CFBu7EDF"><a name="选择目标模块系统" class="reference-link"></a><span class="header-link octicon octicon-link"></span>选择目标模块系统</h2>
 <p>选择目标模块系统的方式取决于你的构建环境：</p> 
 <h3 id="h3--intellij-idea-"><a name="在 IntelliJ IDEA 中" class="reference-link"></a><span class="header-link octicon octicon-link"></span>在 IntelliJ IDEA 中</h3>
 <p>设置每个模块：<br>打开“File → Project Structure…”，在“Modules”中找到你的模块并选择其下的“Kotlin”facet。在<br>“Module kind”字段中选择合适的模块系统。</p> 
 <p>为整个项目设置：<br>打开“File → Settings”，选择“Build, Execution, Deployment”→“Compiler”→“Kotlin compiler”。 在<br>“Module kind”字段中选择合适的模块系统。</p> 
 <h3 id="h3--maven-"><a name="在 Maven 中" class="reference-link"></a><span class="header-link octicon octicon-link"></span>在 Maven 中</h3>
 <p>要选择通过 Maven 编译时的模块系统，你应该设置 <code>moduleKind</code> 配置属性，即你的<br><code>pom.xml</code> 应该看起来像这样：</p> 
 <pre><code class="lang-xml">&lt;plugin&gt;
    &lt;artifactId&gt;kotlin-maven-plugin&lt;/artifactId&gt;
    &lt;groupId&gt;org.jetbrains.kotlin&lt;/groupId&gt;
    &lt;version&gt;${kotlin.version}&lt;/version&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;id&gt;compile&lt;/id&gt;
            &lt;goals&gt;
                &lt;goal&gt;js&lt;/goal&gt;
            &lt;/goals&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
    &lt;!-- 插入这些行 --&gt;
    &lt;configuration&gt;
        &lt;moduleKind&gt;commonjs&lt;/moduleKind&gt;
    &lt;/configuration&gt;
    &lt;!-- 插入文本结束 --&gt;
&lt;/plugin&gt;
</code></pre> 
 <p>可用值包括：<code>plain</code>、 <code>amd</code>、 <code>commonjs</code>、 <code>umd</code>。</p> 
 <h3 id="h3--gradle-"><a name="在 Gradle 中" class="reference-link"></a><span class="header-link octicon octicon-link"></span>在 Gradle 中</h3>
 <p>要选择通过 Gradle 编译时的模块系统，你应该设置 <code>moduleKind</code> 属性，即</p> 
 <pre><code class="lang-groovy">compileKotlin2Js.kotlinOptions.moduleKind = "commonjs"
</code></pre> 
 <p>可用的值类似于 Maven。</p> 
 <h2 id="h2--code-jsmodule-code-"><a name="<code>@JsModule</code> 注解" class="reference-link"></a><span class="header-link octicon octicon-link"></span><code><a target="_blank" href="https://github.com/JsModule" title="@JsModule" class="at-link">@JsModule</a></code> 注解</h2>
 <p>要告诉 Kotlin 一个 <code>external</code> 类、 包、 函数或者属性是一个 JavaScript 模块，你可以使用 <code><a target="_blank" href="https://github.com/JsModule" title="@JsModule" class="at-link">@JsModule</a></code><br>注解。考虑你有以下 CommonJS 模块叫“hello”：</p> 
 <pre><code class="lang-javascript">module.exports.sayHello = function(name) { alert("Hello, " + name); }
</code></pre> 
 <p>你应该在 Kotlin 中这样声明：</p> 
 <pre><code class="lang-kotlin">@JsModule("hello")
external fun sayHello(name: String)
</code></pre> 
 <h3 id="h3--code-jsmodule-code-"><a name="将 <code>@JsModule</code> 应用到包" class="reference-link"></a><span class="header-link octicon octicon-link"></span>将 <code><a target="_blank" href="https://github.com/JsModule" title="@JsModule" class="at-link">@JsModule</a></code> 应用到包</h3>
 <p>一些 JavaScript 库导出包(命名空间)而不是函数和类。<br>从 JavaScript 角度讲 它是一个具有一些成员的对象，这些成员<em>是</em>类、函数和属性。<br>将这些包作为 Kotlin 对象导入通常看起来不自然。<br>编译器允许使用以下助记符将导入的 JavaScript 包映射到 Kotlin 包：</p> 
 <pre><code class="lang-kotlin">@file:JsModule("extModule")
package ext.jspackage.name

external fun foo()

external class C
</code></pre> 
 <p>其中相应的 JavaScript 模块的声明如下：</p> 
 <pre><code class="lang-javascript">module.exports = {
    foo:  { /* 此处一些代码 */ },
    C:  { /* 此处一些代码 */ }
}
</code></pre> 
 <p>重要提示：标有 <code><a target="_blank" href="https://github.com/file" title="@file" class="at-link">@file</a>:JsModule</code> 注解的文件无法声明非外部成员。<br>下面的示例会产生编译期错误：</p>   
 <pre><code class="lang-kotlin">@file:JsModule("extModule")
package ext.jspackage.name

external fun foo()

fun bar() = "!" + foo() + "!" // 此处报错
</code></pre> 
 <h3 id="h3-u5BFCu5165u66F4u6DF1u7684u5305u5C42u6B21u7ED3u6784"><a name="导入更深的包层次结构" class="reference-link"></a><span class="header-link octicon octicon-link"></span>导入更深的包层次结构</h3>
 <p>在前文示例中，JavaScript 模块导出单个包。<br>但是，一些 JavaScript 库会从模块中导出多个包。<br>Kotlin 也支持这种场景，尽管你必须为每个导入的包声明一个新的 <code>.kt</code> 文件。</p> 
 <p>例如，让我们的示例更复杂一些：</p> 
 <pre><code class="lang-javascript">module.exports = {
    mylib: {
        pkg1: {
            foo: function() { /* 此处一些代码 */ },
            bar: function() { /* 此处一些代码 */ }
        },
        pkg2: {
            baz: function() { /* 此处一些代码 */ }
        }
    }
}
</code></pre> 
 <p>要在 Kotlin 中导入该模块，你必须编写两个 Kotlin 源文件：</p> 
 <pre><code class="lang-kotlin">@file:JsModule("extModule")
@file:JsQualifier("mylib.pkg1")
package extlib.pkg1

external fun foo()

external fun bar()
</code></pre> 
 <p>以及</p> 
 <pre><code class="lang-kotlin">@file:JsModule("extModule")
@file:JsQualifier("mylib.pkg2")
package extlib.pkg2

external fun baz()
</code></pre> 
 <h3 id="h3--code-jsnonmodule-code-"><a name="<code>@JsNonModule</code> 注解" class="reference-link"></a><span class="header-link octicon octicon-link"></span><code><a target="_blank" href="https://github.com/JsNonModule" title="@JsNonModule" class="at-link">@JsNonModule</a></code> 注解</h3>
 <p>当一个声明具有 <code><a target="_blank" href="https://github.com/JsModule" title="@JsModule" class="at-link">@JsModule</a></code>、当你并不把它编译到一个 JavaScript 模块时，你不能在 Kotlin 代码中使用它。<br>通常，开发人员将他们的库既作为 JavaScript 模块也作为可下载的<code>.js</code> 文件分发，你可以将这些文件复制到<br>项目的静态资源，并通过 <code>&lt;script&gt;</code> 元素包含。 要告诉 Kotlin，可以<br>在非模块环境中使用一个 <code><a target="_blank" href="https://github.com/JsModule" title="@JsModule" class="at-link">@JsModule</a></code> 声明，你应该放置 <code><a target="_blank" href="https://github.com/JsNonModule" title="@JsNonModule" class="at-link">@JsNonModule</a></code> 声明。例如，<br>给定 JavaScript 代码：</p> 
 <pre><code class="lang-javascript">function topLevelSayHello(name) { alert("Hello, " + name); }
if (module &amp;&amp; module.exports) {
    module.exports = topLevelSayHello;
}
</code></pre> 
 <p>可以这样描述：</p> 
 <pre><code class="lang-kotlin">@JsModule("hello")
@JsNonModule
@JsName("topLevelSayHello")
external fun sayHello(name: String)
</code></pre> 
 <h3 id="h3-u5907u6CE8"><a name="备注" class="reference-link"></a><span class="header-link octicon octicon-link"></span>备注</h3>
 <p>Kotlin 以 <code>kotlin.js</code> 标准库作为单个文件分发，该文件本身被编译为 UMD 模块，因此<br>你可以使用上述任何模块系统。也可以在 NPM 上使用 <a target="_blank" href="http://www.npmjs.com/package/kotlin"><code>kotlin</code> 包</a></p>
 <br>      
</div></body></html>
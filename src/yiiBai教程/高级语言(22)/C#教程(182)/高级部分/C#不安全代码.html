<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">C#不安全代码</h1><div style="width:100%;float:left;" class="article-content">   
 <p> C# 允许在代码块的函数中使用指针变量来标记不安全的修饰符。不安全代码或非托管代码是使用指针变量的代码块。</p> 
 <h2 id="h2-u6307u9488"><a name="指针" class="reference-link"></a><span class="header-link octicon octicon-link"></span>指针</h2>
 <p>指针是一个变量，其值是另一个变量的地址，即存储器位置的直接地址。 类似于任何变量或常量，要使用指针必须先声明指针，然后才能使用它来存储任何变量地址。</p> 
 <p>指针声明的一般形式是：</p> 
 <pre><code class="lang-csharp">type *var-name;
</code></pre> 
 <p>以下是有效的指针声明：</p> 
 <pre><code class="lang-csharp">int    *ip;    /* pointer to an integer */
double *dp;    /* pointer to a double */
float  *fp;    /* pointer to a float */
char   *ch     /* pointer to a character */
</code></pre> 
 <p>以下示例说明如何在 C# 中使用指针，使用不安全的修饰符：</p> 
 <pre><code class="lang-csharp">using System;
namespace UnsafeCodeApplication
{
   class Program
   {
      static unsafe void Main(string[] args)
      {
         int var = 20;
         int* p = &amp;var;
         Console.WriteLine("Data is: {0} ",  var);
         Console.WriteLine("Address is: {0}",  (int)p);
         Console.ReadKey();
      }
   }
}
</code></pre> 
 <p>当上述代码通过编译并执行后，会产生以下结果：</p> 
 <pre><code class="lang-csharp">Data is: 20
Address is: 890153869
</code></pre> 
 <p>不必将整个方法声明为不安全，也可将代码的一部分声明为不安全。下一节中的示例显示了这一点。</p> 
 <h2 id="h2-u4F7Fu7528u6307u9488u68C0u7D22u6570u636Eu503C"><a name="使用指针检索数据值" class="reference-link"></a><span class="header-link octicon octicon-link"></span>使用指针检索数据值</h2>
 <p>可以使用<code>ToString()</code>方法检索由指针变量引用的位置处存储的数据。以下示例演示如下：</p> 
 <pre><code class="lang-csharp">using System;
namespace UnsafeCodeApplication
{
   class Program
   {
      public static void Main()
      {
         unsafe
         {
            int var = 20;
            int* p = &amp;var;
            Console.WriteLine("Data is: {0} " , var);
            Console.WriteLine("Data is: {0} " , p-&gt;ToString());
            Console.WriteLine("Address is: {0} " , (int)p);
         }

         Console.ReadKey();
      }
   }
}
</code></pre> 
 <p>当编译和执行上述代码时，会产生以下结果：</p> 
 <pre><code class="lang-shell">Data is: 20
Data is: 20
Address is: 97122341
</code></pre> 
 <h2 id="h2-u5C06u6307u9488u4F5Cu4E3Au53C2u6570u4F20u9012u7ED9u65B9u6CD5"><a name="将指针作为参数传递给方法" class="reference-link"></a><span class="header-link octicon octicon-link"></span>将指针作为参数传递给方法</h2>
 <p>可以将指针变量传递给方法作为参数。以下示例说明了这一点：</p> 
 <pre><code class="lang-csharp">using System;
namespace UnsafeCodeApplication
{
   class TestPointer
   {
      public unsafe void swap(int* p, int *q)
      {
         int temp = *p;
         *p = *q;
         *q = temp;
      }

      public unsafe static void Main()
      {
         TestPointer p = new TestPointer();
         int var1 = 10;
         int var2 = 20;
         int* x = &amp;var1;
         int* y = &amp;var2;

         Console.WriteLine("Before Swap: var1:{0}, var2: {1}", var1, var2);
         p.swap(x, y);

         Console.WriteLine("After Swap: var1:{0}, var2: {1}", var1, var2);
         Console.ReadKey();
      }
   }
}
</code></pre> 
 <p>当上述代码被编译并执行时，它产生以下结果：</p> 
 <pre><code class="lang-csharp">Before Swap: var1: 10, var2: 20
After Swap: var1: 20, var2: 10
</code></pre> 
 <h2 id="h2-u4F7Fu7528u6307u9488u8BBFu95EEu6570u7EC4u5143u7D20"><a name="使用指针访问数组元素" class="reference-link"></a><span class="header-link octicon octicon-link"></span>使用指针访问数组元素</h2>
 <p>在 C# 中，一个数组名称和一个与数组数据类型相同的数据类型的指针是不一样的变量类型。 例如，<code>int * p</code>和<code>int [] p</code>是两个不一样的类型。我们可以增加指针变量<code>p</code>，因为它在内存中不是固定的，而数组的地址是固定在内存中，所以不能增加。</p> 
 <p>因此，如果您需要使用指针变量来访问数组数据，如传统上在C语言或C++(请查阅：<a target="_blank" href="http://www.yiibai.com/cprogramming/c_pointers.html" title="C指针">C指针</a>)中所做的那样，则需要使用<code>fixed</code>关键字修复指针。</p> 
 <p>以下示例演示如下：</p>   
 <pre><code class="lang-csharp">using System;
namespace UnsafeCodeApplication
{
   class TestPointer
   {
      public unsafe static void Main()
      {
         int[]  list = {10, 100, 200};
         fixed(int *ptr = list)

         /* let us have array address in pointer */
         for ( int i = 0; i &lt; 3; i++)
         {
            Console.WriteLine("Address of list[{0}]={1}",i,(int)(ptr + i));
            Console.WriteLine("Value of list[{0}]={1}", i, *(ptr + i));
         }

         Console.ReadKey();
      }
   }
}
</code></pre> 
 <p>当编译和执行上述代码时，会产生以下结果：</p> 
 <pre><code class="lang-shell">Address of list[0] = 31627168
Value of list[0] = 10
Address of list[1] = 31627172
Value of list[1] = 100
Address of list[2] = 31627176
Value of list[2] = 200
</code></pre> 
 <h2 id="h2-u7F16u8BD1u4E0Du5B89u5168u7684u4EE3u7801"><a name="编译不安全的代码" class="reference-link"></a><span class="header-link octicon octicon-link"></span>编译不安全的代码</h2>
 <p>要编译不安全的代码，必须使用命令行编译器指定<code>/unsafe</code>命令行开关。</p> 
 <p>例如，要编译一个名称为<code>prog1.cs</code>的源代码中包含不安全代码，请从命令行中输入命令：</p> 
 <pre><code class="lang-shell">csc /unsafe prog1.cs
</code></pre> 
 <p>如果您使用的是<em>Visual Studio IDE</em>，则需要在项目属性中启用不安全的代码。</p> 
 <p>参考以下步骤：</p> 
 <ul> 
  <li>通过双击解决方案资源管理器中的属性节点打开项目属性(<em>project properties</em>)。</li>
  <li>单击构建(<em>Build</em>)选项卡。</li>
  <li>选择“允许不安全代码(<em>Allow unsafe code</em>)”选项。</li>
 </ul>
 <br>      
</div></body></html>
<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Laravel中间件</h1><div style="width:100%;float:left;" class="article-content">   
 <div> 
  <div>
    正如其名称提示，中间件作为请求和响应之间的中间人。它是一种过滤机制类型。例如，Laravel包括一个中间件用来验证应用程序的用户认证与否。如果用户通过验证，它将被重定向到主页，否则将被重定向到登录页面。 
  </div> 
 </div> 
 <div> 
  <div>
    中间件可以通过执行以下命令来创建&nbsp;- 
  </div> 
  <pre>php artisan make:middleware &lt;middleware-name&gt;&nbsp;</pre> 
  <p style="text-align:justify;"> 使用你的中间件名称替换&lt;middleware-name&gt;。创建可以看到中间件在&nbsp;app/Http/Middleware&nbsp;目录。 </p> 
  <h3> 示例 </h3> 
  <div>
    第1步&nbsp;-&nbsp;现在，让我们创建&nbsp;AgeMiddleware&nbsp;中间件。我们需要执行下面的命令- 
  </div> 
  <pre>php artisan make:middleware AgeMiddleware</pre> 
  <div>
    第2步&nbsp;-&nbsp;命令成功执行后，会收到以下输出&nbsp;-
   <br> 
   <img src="/uploads/tutorial/20160507/1-16050H02332P7.jpg" alt="">
   <br> 
  </div> 
  <p style="text-align:justify;"> 第3步&nbsp;−&nbsp;AgeMiddlware&nbsp;会在&nbsp;app/Http/Middleware 文件中创建。新创建的文件将自动创建下面代码： </p> 
  <pre>&lt;?php
namespace App\Http\Middleware;
use Closure;

class AgeMiddleware {
   public function handle($request, Closure $next) {
      return $next($request);
   }
}</pre> 
  <h2> 
   <div>
     注册中间件 
   </div> </h2> 
  <div>
    我们需要在使用前注册每一个中间件。在Laravel有两种类型的中间件。 
  </div> 
  <ul> 
   <li> 
    <div>
      全局中间件 
    </div> </li> 
   <li> 
    <div>
      路由中间件 
    </div> </li> 
  </ul> 
  <p style="text-align:justify;"> 全局中间件将在应用程序的每个HTTP请求运行，而路由中间件将被分配到一个特定的路由。中间件可在&nbsp;app/Http/Kernel.php&nbsp;注册.&nbsp;<br> 该文件包含两个属性：&nbsp;$middleware&nbsp;和&nbsp;$routeMiddleware。$middleware&nbsp;属性用于注册全局中间件，$routeMiddleware属性用于注册路由指定中间件。 </p> 
  <div>
    要注册全局中间件，列出的类在&nbsp;$middleware&nbsp;属性的结尾。 
  </div> 
  <pre>protected $middleware = [
   \Illuminate\Foundation\Http\Middleware\CheckForMaintenanceMode::class,
   \App\Http\Middleware\EncryptCookies::class,
   \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class,
   \Illuminate\Session\Middleware\StartSession::class,
   \Illuminate\View\Middleware\ShareErrorsFromSession::class,
   \App\Http\Middleware\VerifyCsrfToken::class,
];</pre> 
  <div>
    要注册路由特定中间件，添加键和值到$routeMiddleware&nbsp;属性。 
  </div> 
  <pre>protected $routeMiddleware = [
   'auth' =&gt; \App\Http\Middleware\Authenticate::class,
   'auth.basic' =&gt; \Illuminate\Auth\Middleware\AuthenticateWithBasicAuth::class,
   'guest' =&gt; \App\Http\Middleware\RedirectIfAuthenticated::class,
];</pre> 
  <h3> 示例 </h3> 
  <p> 我们已经在前面的例子中已创建&nbsp;AgeMiddleware&nbsp;中间件。&nbsp;现在，我们可以在具体的路由中间件属性登记。注册代码如下所示。 </p> 
  <div>
    以下是应用程序代码&nbsp;
   <strong>app/Http/Kernel.php</strong> 
  </div> 
  <pre>&lt;?php
namespace App\Http;
use Illuminate\Foundation\Http\Kernel as HttpKernel;

class Kernel extends HttpKernel {
   protected $middleware = [
      \Illuminate\Foundation\Http\Middleware\CheckForMaintenanceMode::class,
      \App\Http\Middleware\EncryptCookies::class,
      \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class,
      \Illuminate\Session\Middleware\StartSession::class,
      \Illuminate\View\Middleware\ShareErrorsFromSession::class,
      \App\Http\Middleware\VerifyCsrfToken::class,
   ];
  
   protected $routeMiddleware = [
      'auth' =&gt; \App\Http\Middleware\Authenticate::class,
      'auth.basic' =&gt; \Illuminate\Auth\Middleware\AuthenticateWithBasicAuth::class,
      'guest' =&gt; \App\Http\Middleware\RedirectIfAuthenticated::class,
      'Age' =&gt; \App\Http\Middlware\AgeMiddleware::class,
   ];
}</pre> 
  <h2> 
   <div>
     中间件参数 
   </div> </h2> 
  <p> 我们也可以传递中间件参数。例如，如果您的应用程序有不同角色，如用户，管理员，超级管理员等，并且要验证基于角色的动作，这可以通过参数传递中间件来实现。我们创建的中间件包含以下功能，我们可以通过&nbsp;$next&nbsp;参数之后，自定义参数。 </p> 
  <pre>public function handle($request, Closure $next) {
   return $next($request);
}</pre> 
  <h3> 示例 </h3> 
  <div>
    第1步&nbsp;-&nbsp;通过执行以下命令创建角色中间件&nbsp;- 
  </div> 
  <pre>php artisan make:middleware RoleMiddleware</pre> 
  <div>
    第2步&nbsp;-&nbsp;成功执行后，会收到以下输出
   <br> 
   <img src="/uploads/tutorial/20160507/1-16050H02434F3.png" alt="">
   <br> 
  </div> 
  <p> 第3步&nbsp;&nbsp;−&nbsp;添加以下代码到新创建的角色中间件的处理方法 -&nbsp;app/Http/Middleware/RoleMiddleware.php. </p> 
  <pre>&lt;?php
namespace App\Http\Middleware;
use Closure;

class RoleMiddleware {
   public function handle($request, Closure $next, $role) {
      echo "Role: ".$role;
      return $next($request);
   }
}</pre> 
  <p> 第4步&nbsp;&nbsp;−&nbsp;在 app\Http\Kernel.php&nbsp;文件中注册角色中间件。&nbsp;加入灰色突出的线条的是在该文件中注册 RoleMiddleware&nbsp;中间件。<br> <img src="/uploads/tutorial/20160507/1-16050H02H9507.jpg" alt=""> </p> 
  <div>
    第5步&nbsp;-&nbsp;执行以下命令来创建测试控制器&nbsp;- 
  </div> 
  <pre>php artisan make:controller TestController</pre> 
  <div>
    第6步&nbsp;-&nbsp;成功执行后，您会收到以下输出&nbsp;-
   <br> 
   <img src="/uploads/tutorial/20160507/1-16050H02KGU.png" alt="">
   <br> 
  </div> 
  <div>
    第7步&nbsp;-&nbsp;将以下代码复制到&nbsp;app/Http/TestController.php 文件。 
  </div> 
  <p> app/Http/TestController.php </p>   
  <pre>&lt;?php
namespace App\Http\Controllers;
use Illuminate\Http\Request;
use App\Http\Requests;
use App\Http\Controllers\Controller;

class TestController extends Controller {
   public function index(){
      echo "&lt;br&gt;Test Controller.";
   }
}</pre> 
  <div>
    第8步&nbsp;-&nbsp;添加下面一行代码到&nbsp;app/Http/routes.php&nbsp;文件。 
  </div> 
  <p> app/Http/routes.php </p> 
  <pre>Route::get('role',[
   'middleware' =&gt; 'Role:editor',
   'uses' =&gt; 'TestController@index',
]);</pre> 
  <div>
    第9步&nbsp;-&nbsp;访问以下网址来测试带参数中间件 
  </div> 
  <p> <a target="_blank" href="http://localhost:8000/role">http://localhost:8000/role</a> </p> 
  <div>
    第10步&nbsp;-&nbsp;输出显示如下图中所示。
   <br> 
   <img src="/uploads/tutorial/20160507/1-16050H02Q9217.png" alt="">
   <br> 
  </div> 
  <h2> 
   <div>
     可终止的中间件 
   </div> </h2> 
  <p> 响应已经发送给浏览器后可终止中间件执行一些任务。这可以通过使用创建中间件“终止”方法的中间件来实现。可终止中间件会注册全局中间件。该终止方法将接受两个参数：$request&nbsp;和&nbsp;$response。终止方法可以被创建，如在下面显示的代码。 </p> 
  <h3> 示例 </h3> 
  <div>
    第1步-&nbsp;通过执行以下命令创建&nbsp;TerminateMiddleware&nbsp;中间件。 
  </div> 
  <pre>php artisan make:middleware TerminateMiddleware</pre> 
  <div>
    第2步&nbsp;-&nbsp;这将产生以下输出&nbsp;-
   <br> 
   <img src="/uploads/tutorial/20160507/1-16050H02SMQ.png" alt="">
   <br> 
  </div> 
  <p> 第3步&nbsp;-&nbsp;复制下面的代码到新创建文件 -&nbsp;TerminateMiddleware 在&nbsp;<strong><em>app/Http/Middleware/TerminateMiddleware.php</em></strong> 文件中如下： </p> 
  <pre>&lt;?php
namespace App\Http\Middleware;
use Closure;

class TerminateMiddleware {
   public function handle($request, Closure $next) {
      echo "Executing statements of handle method of TerminateMiddleware.";
      return $next($request);
   }
   
   public function terminate($request, $response){
      echo "&lt;br&gt;Executing statements of terminate method of TerminateMiddleware.";
   }
}</pre> 
  <p> 第4步&nbsp;&nbsp;− 注册&nbsp;TerminateMiddleware&nbsp;到&nbsp;<strong>app\Http\Kernel.php</strong><strong>&nbsp;</strong>文件中.<br> <img src="/uploads/tutorial/20160507/1-16050H02Z43N.jpg" alt=""> </p> 
  <p> 加了灰色突出的线条的是该文件中注册的&nbsp;TerminateMiddleware&nbsp;中间件。 </p> 
  <div>
    第5步&nbsp;-&nbsp;执行以下命令来创建一个控制器。 
  </div> 
  <pre>php artisan make:controller ABCController</pre> 
  <div>
    第6步&nbsp;-&nbsp;URL成功执行后，会收到以下输出&nbsp;-
   <br> 
   <img src="/uploads/tutorial/20160507/1-16050H02923929.png" alt="">
   <br> 
  </div> 
  <div>
    第7步&nbsp;-&nbsp;将以下代码复制到&nbsp;
   <strong>app/Http/ABCController.php&nbsp;</strong>文件。 
  </div> 
  <p> <strong><em>app/Http/ABCController.php</em></strong> </p> 
  <pre>&lt;?php
namespace App\Http\Controllers;
use Illuminate\Http\Request;
use App\Http\Requests;
use App\Http\Controllers\Controller;

class ABCController extends Controller {
   public function index(){
      echo "&lt;br&gt;ABC Controller.";
   }
}</pre> 
  <div>
    第8步&nbsp;-&nbsp;添加下面的一行代码到&nbsp;
   <strong>app/Http/routes.php&nbsp;</strong>文件。 
  </div> 
  <p> <em><strong>app/Http/routes.php</strong></em> </p> 
  <pre>Route::get('terminate',[
   'middleware' =&gt; 'terminate',
   'uses' =&gt; 'ABCController@index',
]);</pre> 
  <div>
    第9步&nbsp;-&nbsp;访问以下网址测试可终止中间件。 
  </div> 
  <p> http://localhost:8000/terminate </p> 
  <div>
    第10步&nbsp;-&nbsp;如下面的图片输出的结果。
   <br> 
   <img src="/uploads/tutorial/20160507/1-16050H0294D17.png" alt="">
   <br> 
  </div> 
 </div>
 <br>      
</div></body></html>
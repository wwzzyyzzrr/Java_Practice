<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Yii错误处理</h1><div style="width:100%;float:left;" class="article-content">   
 <div>
   Yii中包括一个内置的错误处理程序。Yii错误处理程序将执行以下操作&nbsp;- 
 </div> 
 <div> 
  <ul> 
   <li> 
    <div>
      转换所有非致命PHP错误到可捕获异常 
    </div> </li> 
   <li> 
    <div>
      显示带有详细的调用堆栈的所有错误和异常 
    </div> </li> 
   <li> 
    <div>
      支持不同的错误格式 
    </div> </li> 
   <li> 
    <div>
      支持使用一个控制器动作来显示错误 
    </div> </li> 
  </ul> 
  <div>
    要禁用错误处理，应该在入口脚本中定义&nbsp;YII_ENABLE_ERROR_HANDLER&nbsp;常量为&nbsp;false&nbsp;。 
  </div> 
  <div>
    错误处理程序被注册为一个应用程序组件。 
  </div> 
  <div>
    步骤1&nbsp;-&nbsp;可以通过以下方式对其进行配置，代码如下所示： 
  </div> 
  <pre>return [
   'components' =&gt; [
      'errorHandler' =&gt; [
         'maxSourceLines' =&gt; 10,
      ],
   ],
];</pre> 
  <div>
    上述配置设置以便显示源代码的数量为&nbsp;10&nbsp;行&nbsp;。错误处理程序将所有非致命PHP错误到可捕获异常。 
  </div> 
  <div>
    第2步&nbsp;-&nbsp;添加&nbsp;actionShowError()&nbsp;方法到&nbsp;SiteController。 
  </div> 
  <pre>public function actionShowError() {
   try {
      5/0;
   } catch (ErrorException $e) {
      Yii::warning("Ooops...division by zero.");
   }
   // execution continues...
}</pre> 
  <div style="background-color:inherit;">
    第3步&nbsp;-&nbsp;打开URL&nbsp;
   <a target="_blank" href="http://localhost:8080/index.php?r=site/show-error">http://localhost:8080/index.php?r=site/show-error</a>&nbsp;会看到一个警告消息。 
  </div> 
  <img src="/uploads/tutorial/20160606/1-1606062024492Q.png" alt="">
  <br> 
  <div>
    如果想显示给用户说明他的请求是无效的，可以抛出&nbsp;yii\web\NotFoundHttpException&nbsp;。 
  </div> 
  <div>
    步骤4&nbsp;-&nbsp;修改&nbsp;actionShowError()函数(在 SiteController 中)。 
  </div> 
  <pre>public function actionShowError() {
   throw new NotFoundHttpException("Something unexpected happened");
}</pre> 
  <div>
    第5步&nbsp;-&nbsp;访问以下URL&nbsp;=&gt;&nbsp;
   <a target="_blank" href="http://localhost:8080/index.php?r=site/show-error">http://localhost:8080/index.php?r=site/show-error</a>&nbsp;会看到下面的HTTP错误。
   <br> 
   <img src="/uploads/tutorial/20160606/1-160606202509163.png" alt="">
   <br> 
  </div> 
  <div>
    当&nbsp;YII_DEBUG&nbsp;常量设置为&nbsp;true&nbsp;，错误处理程序将显示详细的调用堆栈的错误。 
  </div> 
  <div>
    当常量常量设置为&nbsp;false&nbsp;，则仅显示该错误消息。默认情况下，错误处理程序使用这些视图显示错误&nbsp; 
  </div> 
  <ul> 
   <li> <p style="text-align:justify;"> @yii/views/errorHandler/exception.php&nbsp;−&nbsp;当调用堆栈信息显示错误时视图文件应该会被使用。 </p> </li> 
   <li> <p style="text-align:justify;"> @yii/views/errorHandler/error.php&nbsp;−&nbsp;当在不调用堆栈信息显示错误时视图文件被使用。 </p> </li> 
  </ul> 
  <div>
    也可以使用指定错误处理的动作，以自定义显示错误。 
  </div> 
  <div>
    第6步&nbsp;-&nbsp;在&nbsp;config/web.php&nbsp;文件修改&nbsp;ErrorHandler&nbsp;应用程序组件。 
  </div> 
  <pre>&lt;?php
   $params = require(__DIR__ . '/params.php');
   $config = [
      'id' =&gt; 'basic',
      'basePath' =&gt; dirname(__DIR__),
      'bootstrap' =&gt; ['log'],
      'components' =&gt; [
         'request' =&gt; [
            // !!! insert a secret key in the following (if it is empty) - this
               //is required by cookie validation
            'cookieValidationKey' =&gt; 'ymoaYrebZHa8gURuolioHGlK8fLXCKjO',
         ],
         'cache' =&gt; [
            'class' =&gt; 'yii\caching\FileCache',
         ],
         'user' =&gt; [
            'identityClass' =&gt; 'app\models\User',
            'enableAutoLogin' =&gt; true,
         ], <b>'errorHandler' =&gt; [
            'errorAction' =&gt; 'site/error',
         ],</b> //other components...
            'db' =&gt; require(__DIR__ . '/db.php'),
      ],
      'modules' =&gt; [
         'hello' =&gt; [
            'class' =&gt; 'app\modules\hello\Hello',
         ],
      ],
      'params' =&gt; $params,
   ];
   if (YII_ENV_DEV) {
      // configuration adjustments for 'dev' environment
      $config['bootstrap'][] = 'debug';
      $config['modules']['debug'] = [
         'class' =&gt; 'yii\debug\Module',
      ];
      $config['bootstrap'][] = 'gii';
      $config['modules']['gii'] = [
         'class' =&gt; 'yii\gii\Module',
      ];
   }
   return $config;
?&gt;</pre> 
  <div>
    上述结构定义了不调用堆栈来显示错误，site/error&nbsp;动作将被执行。 
  </div> 
  <div>
    第7步&nbsp;-&nbsp;修改&nbsp;SiteController&nbsp;中的&nbsp;actions()&nbsp;方法。 
  </div>   
  <pre>public function actions() {
   return [
      'error' =&gt; [
         'class' =&gt; 'yii\web\ErrorAction',
      ],
   ];
}</pre> 
  <div>
    上面的代码定义：当错误发生时，错误(error.php)视图将被渲染。 
  </div> 
  <div>
    第8步&nbsp;-&nbsp;在&nbsp;views/site&nbsp;目录下创建一个&nbsp;error.php&nbsp;文件。 
  </div> 
  <pre>&lt;?php
   /* @var $this yii\web\View */
   /* @var $name string */
   /* @var $message string */
   /* @var $exception Exception */
   use yii\helpers\Html;
   $this-&gt;title = $name;
?&gt;

&lt;div class = "site-error"&gt;
   &lt;h2&gt;customized error&lt;/h2&gt;
   &lt;h1&gt;&lt;?= Html::encode($this-&gt;title) ?&gt;&lt;/h1&gt;
   
   &lt;div class = "alert alert-danger"&gt;
      &lt;?= nl2br(Html::encode($message)) ?&gt;
   &lt;/div&gt;
   
   &lt;p&gt;
      The above error occurred while the Web server was processing your request.
   &lt;/p&gt;
   
   &lt;p&gt;
      这是一个自定义的错误显示页面。
   &lt;/p&gt;
&lt;/div&gt;</pre> 
  <div>
    第9步&nbsp;-&nbsp;打开&nbsp;
   <a target="_blank" href="http://localhost:8080/index.php?r=site/show-error">http://localhost:8080/index.php?r=site/show-error</a>&nbsp;，将看到自定义的错误视图。
   <br> 
   <img src="/uploads/tutorial/20160606/1-160606202545518.png" alt="Yii错误处理">
   <br> 
  </div> 
 </div>
 <br>      
</div></body></html>
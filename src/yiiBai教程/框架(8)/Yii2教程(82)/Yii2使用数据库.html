<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Yii2使用数据库</h1><div style="width:100%;float:left;" class="article-content">   
 <h1 style="color: rgb(0, 0, 0); font-family: Simsun;"> 使用数据库</h1> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 本章节将介绍如何如何创建一个从数据表&nbsp;<code>country</code>&nbsp;中获取国家数据并显示出来的页面。为了实现这个目标，你将会配置一个数据库连接，创建一个活动记录类，并且创建一个操作及一个视图。</p> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 贯穿整个章节，你将会学到：</p> 
 <ul style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 
  <li> 配置一个数据库连接</li> 
  <li> 定义一个活动记录类</li> 
  <li> 使用活动记录从数据库中查询数据</li> 
  <li> 以分页方式在视图中显示数据</li> 
 </ul> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 请注意，为了掌握本章你应该具备最基本的数据库知识和使用经验。尤其是应该知道如何创建数据库，如何通过数据库终端执行 SQL 语句。</p> 
 <h2 style="color: rgb(0, 0, 0); font-family: Simsun;"> 准备数据库</h2> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 首先创建一个名为&nbsp;<code>yii2basic</code>&nbsp;的数据库，应用将从这个数据库中获取数据。你可以创建 SQLite，MySQL，PostregSQL，MSSQL 或 Oracle 数据库，Yii 内置多种数据库支持。简单起见后面的内容将以 MySQL 为例做演示。</p> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 然后在数据库中创建一个名为&nbsp;<code>country</code>&nbsp;的表并插入简单的数据。可以执行下面的语句：</p> 
 <pre>
<code class="lang-sql">CREATE TABLE `country` (
  `code` CHAR(2) NOT NULL PRIMARY KEY,
  `name` CHAR(52) NOT NULL,
  `population` INT(11) NOT NULL DEFAULT '0'
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

INSERT INTO `Country` VALUES ('AU','Australia',18886000);
INSERT INTO `Country` VALUES ('BR','Brazil',170115000);
INSERT INTO `Country` VALUES ('CA','Canada',1147000);
INSERT INTO `Country` VALUES ('CN','China',1277558000);
INSERT INTO `Country` VALUES ('DE','Germany',82164700);
INSERT INTO `Country` VALUES ('FR','France',59225700);
INSERT INTO `Country` VALUES ('GB','United Kingdom',59623400);
INSERT INTO `Country` VALUES ('IN','India',1013662000);
INSERT INTO `Country` VALUES ('RU','Russia',146934000);
INSERT INTO `Country` VALUES ('US','United States',278357000);</code></pre> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 于是便有了一个名为&nbsp;<code>yii2basic</code>&nbsp;的数据库，在这个数据库中有一个包含三个字段的数据表&nbsp;<code>country</code>，表中有十行数据。</p> 
 <h2 style="color: rgb(0, 0, 0); font-family: Simsun;"> 配置数据库连接</h2> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 开始之前，请确保你已经安装了 PHP&nbsp;PDO&nbsp;扩展和你所使用的数据库的 PDO 驱动(例如 MySQL 的&nbsp;<code>pdo_mysql</code>)。对于使用关系型数据库来讲，这是基本要求。</p> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 驱动和扩展安装可用后，打开&nbsp;<code>config/db.php</code>&nbsp;修改里面的配置参数对应你的数据库配置。该文件默认包含这些内容：</p> 
 <pre>
<code class="lang-php">&lt;?php

return [
    'class' =&gt; 'yiidbConnection',
    'dsn' =&gt; 'mysql:host=localhost;dbname=yii2basic',
    'username' =&gt; 'root',
    'password' =&gt; '',
    'charset' =&gt; 'utf8',
];</code></pre> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> <code>config/db/php</code>&nbsp;是一个典型的基于文件的配置工具。这个文件配置了数据库连接 [[yiidbConnection]] 的创建和初始化参数，应用的 SQL 查询正是基于这个数据库。</p> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 上面配置的数据库连接可以在应用中通过&nbsp;<code>Yii::$app-&gt;db</code>&nbsp;访问。</p> 
 <blockquote style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 
  <p> 补充：<code>config/db.php</code>&nbsp;将被包含在应用配置文件&nbsp;<code>config/web.php</code>&nbsp;中，后者指定了整个应用如何初始化。请参考配置章节了解更多信息。</p> 
 </blockquote> 
 <h2 style="color: rgb(0, 0, 0); font-family: Simsun;"> 创建活动记录</h2> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 创建一个继承自活动记录类的类&nbsp;<code>Country</code>，把它放在&nbsp;<code>models/Country.php</code>，去表示和获取&nbsp;<code>country</code>&nbsp;表的数据。</p> 
 <pre>
<code class="lang-php">&lt;?php

namespace appmodels;

use yiidbActiveRecord;

class Country extends ActiveRecord
{
}</code></pre> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 这个&nbsp;<code>Country</code>&nbsp;类继承自 [[yiidbActiveRecord]]。你不用在里面写任何代码。只需要像现在这样，Yii 就能根据类名去猜测对应的数据表名。</p> 
 <blockquote style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 
  <p> 补充：如果类名和数据表名不能直接对应，可以重写 [[yiidbActiveRecord::tableName()|tableName()]] 方法去显式指定相关表名。</p> 
 </blockquote> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 使用&nbsp;<code>Country</code>&nbsp;类可以很容易地操作&nbsp;<code>country</code>&nbsp;表数据，就像这段代码：</p> 
 <pre>
<code class="lang-php">use appmodelsCountry;

// 获取 country 表的所有行并以 name 排序
$countries = Country::find()-&gt;orderBy('name')-&gt;all();

// 获取主键为 “US” 的行
$country = Country::findOne('US');

// 输出 “United States”
echo $country-&gt;name;

// 修改 name 为 “U.S.A.” 并在数据库中保存更改
$country-&gt;name = 'U.S.A.';
$country-&gt;save();</code></pre> 
 <blockquote style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 
  <p> 补充：活动记录是面向对象、功能强大的访问和操作数据库数据的方式。你可以在活动记录章节了解更多信息。除此之外你还可以使用另一种更原生的称做数据访问对象的方法操作数据库数据。</p> 
 </blockquote> 
 <h2 style="color: rgb(0, 0, 0); font-family: Simsun;"> 创建操作</h2> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 为了向最终用户显示国家数据，你需要创建一个操作。相比之前小节掌握的在&nbsp;<code>site</code>&nbsp;控制器中创建操作，在这里为所有和国家有关的数据新建一个控制器更加合理。新控制器名为<code>CountryController</code>，并在其中创建一个&nbsp;<code>index</code>&nbsp;操作，如下：</p> 
 <pre>
<code class="lang-php">&lt;?php

namespace appcontrollers;

use yiiwebController;
use yiidataPagination;
use appmodelsCountry;

class CountryController extends Controller
{
    public function actionIndex()
    {
        $query = Country::find();

        $pagination = new Pagination([
            'defaultPageSize' =&gt; 5,
            'totalCount' =&gt; $query-&gt;count(),
        ]);

        $countries = $query-&gt;orderBy('name')
            -&gt;offset($pagination-&gt;offset)
            -&gt;limit($pagination-&gt;limit)
            -&gt;all();

        return $this-&gt;render('index', [
            'countries' =&gt; $countries,
            'pagination' =&gt; $pagination,
        ]);
    }
}</code></pre> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 把上面的代码保存在&nbsp;<code>controllers/CountryController.php</code>。</p> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> <code>index</code>&nbsp;操作调用了活动记录&nbsp;<code>Country::find()</code>&nbsp;方法，去生成查询语句并从&nbsp;<code>country</code>&nbsp;表中取回所有数据。为了限定每个请求所返回的国家数量，查询在 [[yiidataPagination]] 对象的帮助下进行分页。&nbsp;<code>Pagination</code>&nbsp;对象的使命主要有两点：</p> 
 <ul style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 
  <li> 为 SQL 查询语句设置&nbsp;<code>offset</code>&nbsp;和&nbsp;<code>limit</code>&nbsp;从句，确保每个请求只需返回一页数据(本例中每页是 5 行)。</li> 
  <li> 在视图中显示一个由页码列表组成的分页器，这点将在后面的段落中解释。</li> 
 </ul> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 在代码末尾，<code>index</code>&nbsp;操作渲染一个名为&nbsp;<code>index</code>&nbsp;的视图，并传递国家数据和分页信息进去。</p> 
 <h2 style="color: rgb(0, 0, 0); font-family: Simsun;"> 创建视图</h2> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 在&nbsp;<code>views</code>&nbsp;目录下先创建一个名为&nbsp;<code>country</code>&nbsp;的子目录。这个目录存储所有由&nbsp;<code>country</code>&nbsp;控制器渲染的视图。在&nbsp;<code>views/country</code>&nbsp;目录下创建一个名为&nbsp;<code>index.php</code>&nbsp;的视图文件，内容如下：</p>   
 <pre>
<code class="lang-php">&lt;?php
use yiihelpersHtml;
use yiiwidgetsLinkPager;
?&gt;
&lt;h1&gt;Countries&lt;/h1&gt;
&lt;ul&gt;
&lt;?php foreach ($countries as $country): ?&gt;
    &lt;li&gt;
        &lt;?= Html::encode("{$country-&gt;name} ({$country-&gt;code})") ?&gt;:
        &lt;?= $country-&gt;population ?&gt;
    &lt;/li&gt;
&lt;?php endforeach; ?&gt;
&lt;/ul&gt;

&lt;?= LinkPager::widget(['pagination' =&gt; $pagination]) ?&gt;</code></pre> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 这个视图包含两部分用以显示国家数据。第一部分遍历国家数据并以无序 HTML 列表渲染出来。第二部分使用 [[yiiwidgetsLinkPager]] 去渲染从操作中传来的分页信息。小部件<code>LinkPager</code>&nbsp;显示一个分页按钮的列表。点击任何一个按钮都会跳转到对应的分页。</p> 
 <h2 style="color: rgb(0, 0, 0); font-family: Simsun;"> 尝试下</h2> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 浏览器访问下面的 URL 看看能否工作：</p> 
 <div style="float:left;margin-bottom: 10px;">  
 </div>
 <div style="float:left;margin-bottom: 10px;">  
 </div>
 <pre>
<code>http://hostname/index.php?r=country/index</code></pre> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> <img alt="国家列表" src="file:///D:/360Downloads/images/start-country-list.png"></p> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 首先你会看到显示着五个国家的列表页面。在国家下面，你还会看到一个包含四个按钮的分页器。如果你点击按钮 “2”，将会跳转到显示另外五个国家的页面，也就是第二页记录。如果观察仔细点你还会看到浏览器的 URL 变成了：</p> 
 <pre>
<code>http://hostname/index.php?r=country/index&amp;page=2</code></pre> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 在这个场景里，[[yiidataPagination|Pagination]] 提供了为数据结果集分页的所有功能：</p> 
 <ul style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 
  <li> 首先 [[yiidataPagination|Pagination]] 把 SELECT 的子查询&nbsp;<code>LIMIT 5 OFFSET 0</code>&nbsp;数据表示成第一页。因此开头的五条数据会被取出并显示。</li> 
  <li> 然后小部件 [[yiiwidgetsLinkPager|LinkPager]] 使用 [[yiidataPagination::createUrl()|Pagination::createUrl()]] 方法生成的 URL 去渲染翻页按钮。URL 中包含必要的参数&nbsp;<code>page</code>&nbsp;才能查询不同的页面编号。</li> 
  <li> 如果你点击按钮 “2”，将会发起一个路由为&nbsp;<code>country/index</code>&nbsp;的新请求。[[yiidataPagination|Pagination]] 接收到 URL 中的&nbsp;<code>page</code>&nbsp;参数把当前的页码设为 2。新的数据库请求将会以&nbsp;<code>LIMIT 5 OFFSET 5</code>&nbsp;查询并显示。</li> 
 </ul> 
 <h2 style="color: rgb(0, 0, 0); font-family: Simsun;"> 总结</h2> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 本章节中你学到了如何使用数据库。你还学到了如何取出并使用 [[yiidataPagination]] 和 [[yiiwidgetsLinkPager]] 显示数据。</p> 
 <p style="color: rgb(0, 0, 0); font-family: Simsun; font-size: medium;"> 下一章中你会学到如何使用 Yii 中强大的代码生成器&nbsp;Gii，去帮助你实现一些常用的功能需求，例如增查改删(CRUD)数据表中的数据。事实上你之前所写的代码全部都可以由 Gii 自动生成。</p> 
 <br>      
</div></body></html>
<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Yii模型</h1><div style="width:100%;float:left;" class="article-content">   
 <div>
   模型代表业务逻辑和规则的对象。要创建一个模型，应该扩展&nbsp;yii\base\Model类或它的子类。 
 </div> 
 <div> 
  <h2> 属性 </h2> 
  <p style="text-align:justify;"> 属性代表业务数据。它们可以像数组元素或对象的属性那样来访问。一个模型的每个属性都是公开访问的属性。要指定模型拥有什么属性，应该重写yii\base\Model::attributes()&nbsp;方法。 </p> 
  <div>
    我们看一下基本应用程序模板中的&nbsp;ContactForm&nbsp;模型。 
  </div> 
  <pre>&lt;?php
   namespace app\models;
   use Yii;
   use yii\base\Model;
   /**
   * ContactForm is the model behind the contact form.
   */
   class ContactForm extends Model {
      public $name;
      public $email;
      public $subject;
      public $body;
      public $verifyCode;
      /**
      * @return array the validation rules.
      */
      public function rules() {
         return [
            // name, email, subject and body are required
            [['name', 'email', 'subject', 'body'], 'required'],
            // email has to be a valid email address
            ['email', 'email'],
            // verifyCode needs to be entered correctly
            ['verifyCode', 'captcha'],
         ];
      }
      /**
      * @return array customized attribute labels
      */
      public function attributeLabels() {
         return [
            'verifyCode' =&gt; 'Verification Code',
         ];
      }
      /**
      * Sends an email to the specified email address using the information 
         collected by this model.
      * @param  string  $email the target email address
      * @return boolean whether the model passes validation
      */
      public function contact($email) {
         if ($this-&gt;validate()) {
            Yii::$app-&gt;mailer-&gt;compose()
               -&gt;setTo($email)
               -&gt;setFrom([$this-&gt;email =&gt; $this-&gt;name])
               -&gt;setSubject($this-&gt;subject)
               -&gt;setTextBody($this-&gt;body)
               -&gt;send();
            return true;
         }
         return false;
      }
   }
?&gt;</pre> 
  <div>
    第1步&nbsp;-&nbsp;在 SiteController中创建一个&nbsp;actionShowContactModel&nbsp;函数并使用下面的代码。 
  </div> 
  <pre>public function actionShowContactModel() { 
   $mContactForm = new \app\models\ContactForm(); 
   $mContactForm-&gt;name = "contactForm"; 
   $mContactForm-&gt;email = "user@gmail.com"; 
   $mContactForm-&gt;subject = "标题"; 
   $mContactForm-&gt;body = "内容主体"; 
   var_dump($mContactForm); 
}</pre> 
  <div>
    在上面的代码中，我们定义&nbsp;ContactForm&nbsp;表单模型，设置属性，并在屏幕上显示模型。 
  </div> 
  <div>
    第2步&nbsp;-&nbsp;现在，如果在Web浏览器的地址栏中输入URL：
   <a target="_blank" href="http://localhost:8080/index.php?r=site/show-contact-model">http://localhost:8080/index.php?r=site/show-contact-model</a>&nbsp;，应该会看到以下内容。
   <br> 
   <img src="/uploads/tutorial/20160518/1-16051R231264F.png" width="655" height="312" title="Yii模型" alt="Yii模型">
   <br> 
  </div> 
  <p> 如模型是从&nbsp;yii\base\Model&nbsp;扩展，那么它的所有成员变量应该为公共且是非静态的属性。在&nbsp;ContactForm&nbsp;模型五个属性&nbsp;-&nbsp;name,&nbsp;email,&nbsp;subject,&nbsp;body,&nbsp;verifyCode，也可以再添加一些新的。 </p> 
  <h2> 属性标签 </h2> 
  <p> 在应用中我们经常需要使用属性相关联来显示标签。默认情况下，属性标签由 yii\base\Model::generateAttributeLabel()&nbsp;方法自动生成。要手动声明属性标签，可以覆盖yii\base\Model::attributeLabels()&nbsp;方法。 </p> 
  <div>
    第1步&nbsp;-&nbsp;如果在浏览器中打开URL：&nbsp;
   <a target="_blank" href="http://localhost:8080/index.php?r=site/contact">http://localhost:8080/index.php?r=site/contact</a>，将看到以下页面。
   <br> 
   <img src="/uploads/tutorial/20160518/1-16051R231414H.png" alt="">
   <br> 
  </div> 
  <div>
    注意，标签的名称与属性的名称相同。 
  </div> 
  <div>
    步骤2&nbsp;-&nbsp;现在，中以下列方式修改在&nbsp;ContactForm&nbsp;模型中的&nbsp;attributeLabels() 函数。 
  </div> 
  <pre>public function attributeLabels() {
   return [
      'name' =&gt; '名字',
      'email' =&gt; '邮箱地址',
      'subject' =&gt; '标题',
      'body' =&gt; '内容',
      'verifyCode' =&gt; '验证码',
   ];
}</pre> 
  <div>
    第3步&nbsp;-&nbsp;如果再次打开URL：
   <a target="_blank" href="http://localhost:8080/index.php?r=site/contact">http://localhost:8080/index.php?r=site/contact</a>，你会发现，标签已经改变如下面图片所示。
   <br> 
   <img src="/uploads/tutorial/20160518/1-16051R23202423.png" alt="">
   <br> 
  </div> 
  <h2> 模型使用在不同的场景 </h2> 
  <p> 可以使用模型在不同的场景。&nbsp;例如，当一个访问用户要发送一份联系表单，我们需要所有的模型属性。&nbsp;当用户已经登录，我们并不需要他的名字，因为我们可以很容易地从数据库把它读取出来。 </p> 
  <p> 要声明场景，应该覆盖&nbsp;scenarios()&nbsp;函数。它返回一个数组，其键是场景名称而其值是&nbsp;Active&nbsp;属性。Active属性是用来来验证的。它们也可以被大量分配。 </p> 
  <div>
    第1步&nbsp;-&nbsp;以下方式修改&nbsp;ContactForm&nbsp;模型。 
  </div> 
  <pre>&lt;?php
   namespace app\models;
   use Yii;
   use yii\base\Model;
   /**
   * ContactForm is the model behind the contact form.
   */
   class ContactForm extends Model {
      public $name;
      public $email;
      public $subject;
      public $body;
      public $verifyCode;
      const SCENARIO_EMAIL_FROM_GUEST = 'EMAIL_FROM_GUEST';
      const SCENARIO_EMAIL_FROM_USER = 'EMAIL_FROM_USER';
      public function scenarios() {
         return [
            self::SCENARIO_EMAIL_FROM_GUEST =&gt; ['name', 'email', 'subject', 
               'body', 'verifyCode'],
            self::SCENARIO_EMAIL_FROM_USER =&gt; ['email' ,'subject', 'body', 
               'verifyCode'],
         ];
      }
      /**
      * @return array the validation rules.
      */
      public function rules() {
         return [
            // name, email, subject and body are required
            [['name', 'email', 'subject', 'body'], 'required'],
            // email has to be a valid email address
            ['email', 'email'],
            // verifyCode needs to be entered correctly
            ['verifyCode', 'captcha'],
         ];
      }
      /**
      * @return array customized attribute labels
      */
      public function attributeLabels() {
         return [
            'name' =&gt; '名字',
            'email' =&gt; '电子邮箱',
            'subject' =&gt; '标题',
            'body' =&gt; '内容',
            'verifyCode' =&gt; '验证码',
         ];
      }
      /**
      * Sends an email to the specified email address using the information 
         collected by this model.
      * @param  string  $email the target email address
      * @return boolean whether the model passes validation
      */
      public function contact($email) {
         if ($this -&gt; validate()) {
            Yii::$app-&gt;mailer-&gt;compose()
               -&gt;setTo($email)
               -&gt;setFrom([$this-&gt;email =&gt; $this-&gt;name]) 
               -&gt;setSubject($this-&gt;subject) 
               -&gt;setTextBody($this-&gt;body)
               -&gt;send();
            return true;
         }
         return false;
      }
   }
?&gt;&nbsp;</pre> 
  <p> 我们增加了两个场景。一个用于访问游客用户，另一个用于身份验证的用户。当用户通过验证后，再不需要他填入名字。 </p> 
  <div>
    第2步-&nbsp;现在，修改 SiteController 的&nbsp;actionContact&nbsp;功能。 
  </div>   
  <pre>public function actionContact() {
   $model = new ContactForm();
   $model-&gt;scenario = ContactForm::SCENARIO_EMAIL_FROM_GUEST;
   if ($model-&gt;load(Yii::$app-&gt;request-&gt;post()) &amp;&amp; $model-&gt;
      contact(Yii::$app-&gt;params ['adminEmail'])) {
         Yii::$app-&gt;session-&gt;setFlash('contactFormSubmitted');  
         return $this-&gt;refresh();
   }
   return $this-&gt;render('contact', [
      'model' =&gt; $model,
   ]);
}&nbsp;</pre> 
  <p> 第3步&nbsp;-&nbsp;在浏览器访问URL&nbsp;=&gt;&nbsp;<a target="_blank" href="http://localhost:8080/index.php?r=site/contact">http://localhost:8080/index.php?r=site/contact</a>&nbsp;。你应该已经注意到，当前所有模型的属性都是必须的。<br> <img src="/uploads/tutorial/20160518/1-16051R23231500.png" alt=""> </p> 
  <div>
    第4步&nbsp;-&nbsp;如果你在模式的&nbsp;actionContact&nbsp;动作中更改了场景。如下面给出的代码，你会发现&nbsp;name&nbsp;属性不再是必需的。 
  </div> 
  <pre>$model-&gt;scenario = ContactForm::SCENARIO_EMAIL_FROM_USER;</pre> 
  <img src="/uploads/tutorial/20160518/1-16051R23301K7.png" alt="">
  <br> 
  <h2> 大量的分配 </h2> 
  <div>
    大规模的分配是通过一个单一的代码行创建多个输入模型属性的一种便捷方式。 
  </div> 
  <div>
    如下的代码行&nbsp;- 
  </div> 
  <pre>$mContactForm = new \app\models\ContactForm; 
$mContactForm-&gt;attributes = \Yii::$app-&gt;request-&gt;post('ContactForm');</pre> 
  <div>
    上面给出的代码行相当于- 
  </div> 
  <pre>$mContactForm = new \app\models\ContactForm; 
$postData = \Yii::$app-&gt;request-&gt;post('ContactForm', []); 
$mContactForm-&gt;name = isset($postData['name']) ? $postData['name'] : null; 
$mContactForm-&gt;email = isset($postData['email']) ? $postData['email'] : null; 
$mContactForm-&gt;subject = isset($postData['subject']) ? $postData['subject'] : null; 
$mContactForm-&gt;body = isset($postData['body']) ? $postData['body'] : null;&nbsp;</pre> 
  <p> 前者干净多了。注意，大量分配仅适用于安全属性。它们只是在&nbsp;scenario()&nbsp;函数中列出当前场景属性。 </p> 
  <h2> 数据导出 </h2> 
  <p> 模型往往需要以不同的格式导出。要转模型转换为数组，则修改&nbsp;SiteController&nbsp;的&nbsp;actionShowContactModel()&nbsp;函数- </p> 
  <pre>public function actionShowContactModel() {
   $mContactForm = new \app\models\ContactForm();
   $mContactForm-&gt;name = "用户名称";
   $mContactForm-&gt;email = "user@gmail.com";
   $mContactForm-&gt;subject = "标题";
   $mContactForm-&gt;body = "内容";
   var_dump($mContactForm-&gt;attributes);
} </pre> 
  <div>
    在浏览器地址栏中输入URL：
   <a target="_blank" href="http://localhost:8080/index.php?r=site/show-contact-model">http://localhost:8080/index.php?r=site/show-contact-model</a>，你会看到如下结果 -
   <br> 
   <img src="http://www.yiibai.com/uploads/tutorial/20160518/1-16051R23326307.png" alt="">
   <br> 
  </div> 
  <div>
    要将模型转换成JSON格式，修改actionShowContactModel()函数如以下方式- 
  </div> 
  <pre>public function actionShowContactModel() {
   $mContactForm = new \app\models\ContactForm();
   $mContactForm-&gt;name = "username";
   $mContactForm-&gt;email = "user@gmail.com";
   $mContactForm-&gt;subject = "subject";
   $mContactForm-&gt;body = "body-content";
   return \yii\helpers\Json::encode($mContactForm);
}</pre> 
  <div>
    浏览器输出&nbsp;-
   <br> 
   <img src="/uploads/tutorial/20160518/1-16051R2335Bc.png" alt="">
   <br> 
  </div> 
  <h2> 要点 </h2> 
  <div>
    模型通常是一个精心设计比控制器快得多的应用。模型应该- 
  </div> 
  <ul> 
   <li> 包含业务逻辑 </li> 
   <li> 包含验证规则 </li> 
   <li> 包含属性 </li> 
   <li> 不嵌入HTML </li> 
   <li> 不能直接访问请求 </li> 
   <li> 
    <div>
      不要有太多的场景 
    </div> </li> 
  </ul> 
 </div>
 <br>      
</div></body></html>
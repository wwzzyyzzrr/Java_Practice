<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Yii依赖注入</h1><div style="width:100%;float:left;" class="article-content">   
 <div> 
  <div>
    DI(依赖注入)容器是一个知道如何实例化和配置对象的对象。&nbsp;Yii提供对它&nbsp;yii\di\Container&nbsp;类来提供&nbsp;DI&nbsp;容器。 
  </div> 
 </div> 
 <div> 
  <div>
    它支持以下几种注入方式&nbsp;- 
  </div> 
  <ul> 
   <li> 
    <div>
      Setter方法和属性注入 
    </div> </li> 
   <li> 
    <div>
      PHP可调用注入 
    </div> </li> 
   <li> 
    <div>
      构造函数注入 
    </div> </li> 
   <li> 
    <div>
      控制器动作注入 
    </div> </li> 
  </ul> 
  <div>
    依赖注入(DI)容器支持构造器使用类型提示的帮助来注入&nbsp;- 
  </div> 
  <pre>class Object1 {
   public function __construct(Object2 $object2) {

   }
}
$object1 = $container-&gt;get('Object1');
// which is equivalent to the following:
$object2 = new Object2;
$object1 = new Object1($object2);</pre> 
  <div style="background-color:inherit;">
    属性和 setter 注入需要通过配置支持&nbsp;- 
  </div> 
  <pre>&lt;?php
   use yii\base\Object;
   class MyObject extends Object {
      public $var1;
      private $_var2;
      public function getVar2() {
         return $this-&gt;_var2;
      }
      public function setVar2(MyObject2 $var2) {
         $this-&gt;_var2 = $var2;
      }
   }
   $container-&gt;get('MyObject', [], [
      'var1' =&gt; $container-&gt;get('MyOtherObject'),
      'var2' =&gt; $container-&gt;get('MyObject2'),
   ]);
?&gt;</pre> 
  <div style="background-color:inherit;">
    在调用PHP注入的案例中，容器将使用注册的 PHP 回调构建类的新实例&nbsp;- 
  </div> 
  <pre>$container-&gt;set('Object1', function () {
   $object1 = new Object1(new Object2);
   return $object1;
});
$object1 = $container-&gt;get('Object1');</pre> 
  <div style="background-color:inherit;">
    控制器操作注入是一种依赖注入(DI)类型，在这里依赖声明使用类型提示。这是有助于保持&nbsp;MVC&nbsp;控制器的超轻量级&nbsp;- 
  </div> 
  <pre>public function actionSendToAdmin(EmailValidator $validator, $email) {
   if ($validator-&gt;validate($email)) {
      // sending email
   }
}</pre> 
  <div style="background-color:inherit;">
    可以使用&nbsp;yii\db\Container::set()&nbsp;方法来注册依赖&nbsp;- 
  </div> 
  <pre>&lt;?php
   $container = new \yii\di\Container;
   // register a class name as is. This can be skipped.
   $container-&gt;set('yii\db\Connection');
   // register an alias name. You can use $container-&gt;get('MyObject')
   // to create an instance of Connection
   $container-&gt;set('MyObject', 'yii\db\Connection');
   // register an interface
   // When a class depends on the interface, the corresponding class
   // will be instantiated as the dependent object
   $container-&gt;set('yii\mail\MailInterface', 'yii\swiftmailer\Mailer');
   // register an alias name with class configuration
   // In this case, a "class" element is required to specify the class
   $container-&gt;set('db', [
      'class' =&gt; 'yii\db\Connection',
      'dsn' =&gt; 'mysql:host=127.0.0.1;dbname = helloworld',
      'username' =&gt; 'vladimir',
      'password' =&gt; '12345',
      'charset' =&gt; 'utf8',
   ]);
   // register a class with configuration. The configuration
   // will be applied when the class is instantiated by get()
   $container-&gt;set('yii\db\Connection', [
      'dsn' =&gt; 'mysql:host=127.0.0.1;dbname = mystudy',
      'username' =&gt; 'root',
      'password' =&gt; '',
      'charset' =&gt; 'utf8',
   ]);
   // register a PHP callable
   // The callable will be executed each time when $container-&gt;get('db') is called
   $container-&gt;set('db', function ($container, $params, $config) {
      return new \yii\db\Connection($config);
   });
   // register a component instance
   // $container-&gt;get('pageCache') will return the same instance each time when it 
      //is called
   $container-&gt;set('pageCache', new FileCache);
?&gt;</pre> 
  <h2 style="background-color:inherit;color:#121214;font-family:Verdana, Geneva, Tahoma,  Helvetica, font-size:1.7em;font-weight:normal;"> 
   <div style="background-color:inherit;">
     使用依赖注入(DI) 
   </div> </h2> 
  <div style="background-color:inherit;">
    第1步&nbsp;-&nbsp;在&nbsp;components&nbsp;文件夹中创建一个&nbsp;MyInterface.php&nbsp;的文件，并使用下面的代码。 
  </div>   
  <pre>&lt;?php
   namespace app\components;
   interface MyInterface {
      public function test();
   }
?&gt;</pre> 
  <div style="background-color:inherit;">
    第2步&nbsp;-&nbsp;在&nbsp;components&nbsp;文件夹中创建两个文件。 
  </div> 
  <p style="font-family:Verdana, Geneva, Tahoma,  Helvetica, text-align:justify;font-size:15px !important;background-color:inherit;"> <b>First.php</b>&nbsp;− </p> 
  <pre>&lt;?php
   namespace app\components;
   use app\components\MyInterface;
   class First implements MyInterface {
      public function test() {
         echo "First class &lt;br&gt;";
      }
   }
?&gt;</pre> 
  <p style="font-family:Verdana, Geneva, Tahoma,  Helvetica, text-align:justify;font-size:15px !important;background-color:inherit;"> <b>Second.php</b>&nbsp;− </p> 
  <pre>&lt;?php
   namespace app\components;
   use app\components\MyInterface;
      class Second implements MyInterface {
      public function test() {
         echo "Second class &lt;br&gt;";
      }
   }
?&gt;</pre> 
  <div style="background-color:inherit;">
    第3步&nbsp;-&nbsp;现在，添加一个&nbsp;actionTestInterface&nbsp;到控制器&nbsp;SiteController。 
  </div> 
  <pre>public function actionTestInterface() {
   $container = new \yii\di\Container();
   $container-&gt;set
      ("\app\components\MyInterface","\app\components\First");
   $obj = $container-&gt;get("\app\components\MyInterface");
   $obj-&gt;test(); // print "First class"
   $container-&gt;set
      ("\app\components\MyInterface","\app\components\Second");
   $obj = $container-&gt;get("\app\components\MyInterface");
   $obj-&gt;test(); // print "Second class"
}</pre> 
  <div>
    第4步&nbsp;-&nbsp;在浏览器打开URL地址：
   <a target="_blank" href="http://localhost:8080/index.php?r=site/test-interface">http://localhost:8080/index.php?r=site/test-interface</a>&nbsp;，会看到输出如下图所示。 
  </div> 
 </div> 
 <div> 
  <img src="/uploads/tutorial/20160604/1-160604144F9631.png" alt="Yii依赖注入" title="Yii依赖注入">
  <br> 
  <p> 这种方法很方便，因为我们可以在一个地方设置类，而且其他代码将自动使用新类。 </p> 
 </div>
 <br>      
</div></body></html>
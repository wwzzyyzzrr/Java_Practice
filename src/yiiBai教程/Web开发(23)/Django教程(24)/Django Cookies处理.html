<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Django Cookies处理</h1><div style="width:100%;float:left;" class="article-content">   
 <div> 
  <div>
    有时候，可能要按您的Web应用程序的要求存储访问者一些数据在每个站点。始终牢记，那cookies被保存在客户端，并根据您的客户端浏览器的安全级别，设置cookie&nbsp;存活的时间，有时候可能不需要。 
  </div> 
 </div> 
 <div> 
  <p style="text-align:justify;"> 为了说明在Django如何cookie处理，让我们创建一个使用之前创建的登录功能的系统。&nbsp;系统将让你登录为时间x分钟，在此时间之后，应用程序将会自动注销你的登陆信息。 </p> 
  <div>
    对于这一点，需要设置两个cookie：last_connection和username。 
  </div> 
  <p style="text-align:justify;"> 首先，让我们改变登录视图以存储用户名和last_connection&nbsp;cookies&nbsp;− </p> 
  <pre>from django.template import RequestContext

def login(request):
   username = "not logged in"
   
   if request.method == "POST":
      #Get the posted form
      MyLoginForm = LoginForm(request.POST)
   
   if MyLoginForm.is_valid():
      username = MyLoginForm.cleaned_data['username']
   else:
      MyLoginForm = LoginForm()
   
   response = render_to_response(request, 'loggedin.html', {"username" : username}, 
      context_instance = RequestContext(request))
   
   response.set_cookie('last_connection', datetime.datetime.now())
   response.set_cookie('username', datetime.datetime.now())
	
   return response&nbsp;</pre> 
  <p style="text-align:justify;"> 正如在上面这个视图，设置cookie是调用setcookie方法完成的，而不是请求响应的，&nbsp;还要注意所有Cookie的值是作为字符串返回的。 </p> 
  <p style="text-align:justify;"> 让我们为登录表单创建一个FormView，我们将不会显示的表单，如果Cookie设置并且在10秒内&nbsp;− </p> 
  <pre>def formView(request):
   if 'username' in request.COOKIES and 'last_connection' in request.COOKIES:
      username = request.COOKIES['username']
      
      last_connection = request.COOKIES['last_connection']
      last_connection_time = datetime.datetime.strptime(last_connection[:-7], 
         "%Y-%m-%d %H:%M:%S")
      
      if (datetime.datetime.now() - last_connection_time).seconds &lt; 10:
         return render(request, 'loggedin.html', {"username" : username})
      else:
         return render(request, 'login.html', {})
			
   else:
      return render(request, 'login.html', {})&nbsp;</pre> 
  <p style="text-align:justify;"> 可以在&nbsp;formView&nbsp;视图上访问您设置Cookie，通过请求COOKIES类属性(字典)完成。 </p> 
  <p style="text-align:justify;"> 现在修改url.py文件更改URL，配对新的视图&nbsp;− </p>   
  <pre>from django.conf.urls import patterns, url
from django.views.generic import TemplateView

urlpatterns = patterns('myapp.views',
   url(r'^connection/','formView', name = 'loginform'),
   url(r'^login/', 'login', name = 'login'))</pre> 
  <div>
    当访问&nbsp;/myapp/connection，您将进入以下页面-
   <br> 
   <img src="/uploads/tutorial/20160130/1-160130223H04U.jpg" alt="">
   <br> 
  </div> 
  <div>
    提交后会重定向到以下界面&nbsp;-
   <br> 
   <img src="/uploads/tutorial/20160130/1-160130223J2416.jpg" alt="">
   <br> 
  </div> 
  <p style="text-align:justify;"> 现在，如果你在10秒内访问&nbsp;/myapp/connection&nbsp;一遍，&nbsp;会得到直接重定向到第二个屏幕。如果你再次访问&nbsp;/myapp/connection&nbsp;超出这个范围，将会得到的登录表单(屏幕1)。 </p> 
  <div> 
   <span style="background-color:inherit;font-family:微软雅黑;font-size:14px;line-height:1.5;"><br> </span> 
  </div> 
 </div>
 <br>      
</div></body></html>
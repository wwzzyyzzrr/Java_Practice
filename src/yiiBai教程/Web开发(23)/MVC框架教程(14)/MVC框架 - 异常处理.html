<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">MVC框架 - 异常处理</h1><div style="width:100%;float:left;" class="article-content">   
 <p> 在ASP.NET中，错误处理是通过使用标准的尝试捕捉方法或使用应用程序事件。ASP.NET MVC附带内置支持,被称为异常过滤器功能异常处理。在这里我们要学习两种方法：一个是定义HandleError过滤器，另一个是重写onException方法。</p> 
 <h2> 覆盖onException方法</h2> 
 <p> 使用这种方式在当要处理整个操作方法所有的异常在控制器级别。</p> 
 <p> 要理解这种方式，创建一个MVC应用程序(包括跟随在前面章节中的步骤)。现在添加一个新的控制器类，并添加以下代码将覆盖onException方法，并明确在行动方法抛出一个错误：</p> 
 <img alt="mvc_exception_handling" src="/uploads/allimg/150603/104G44460-0.jpg"> 
 <p> 现在，让我们创建一个通用的视图名为Error，显示给用户在任何异常的应用程序发生时。在Views文件夹内，创建一个名为Shared的新文件夹，并添加一个新的名为Error的视图。</p> 
 <img alt="mvc_error_handling" src="/uploads/allimg/150603/104G42461-1.jpg"> 
 <p> 拷贝下面下面的代码到新建文件： Error.cshtml:</p> 
 <img alt="mvc_exception_common_view" src="/uploads/allimg/150603/104G46008-2.jpg"> 
 <p> 如果现在尝试运行应用程序，它会给出结果如下。当任何异常发生在控制器内的操作方法时，上面的代码会渲染错误在视图中。</p> 
 <img alt="mvc_common_exception_handling" src="/uploads/allimg/150603/104G41064-3.jpg"> 
 <p> 这种方法的优点是，在同一个控制器中的多个动作可以共享这个错误处理逻辑。 但是，缺点是不能跨越多个控制器使用相同的错误处理逻辑。</p> 
 <h2> HandleError属性</h2> 
 <p> HandleError的属性是学习过滤器过滤操作之一，在操作过滤器的篇章。HandleErrorAttribute是IExceptionFilter是的默认实现。该过滤器处理所有的控制器动作，过滤器和视图引发的例外。</p> 
 <p> 要使用此功能，首先打开web.config文件的customErrors部分。打开web.config把System.Web下面的代码，并将其值设置为ON。</p> 
 <pre class="prettyprint prettyprinted" style="box-sizing: border-box; Menlo, Monaco, Consolas, 'Courier New', monospace; border-radius: 0px; width: 501.328125px; line-height: 16px; font-size: 12px; overflow: auto; color: rgb(49, 49, 49);">
<span class="pln" style="box-sizing: border-box;">    </span><span class="tag" style="box-sizing: border-box; color: rgb(0, 0, 136);">&lt;customErrors</span><span class="pln" style="box-sizing: border-box;"> </span><span class="atn" style="box-sizing: border-box; color: rgb(127, 0, 85);">mode</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">=</span><span class="atv" style="box-sizing: border-box; color: rgb(0, 136, 0);">"On"</span><span class="tag" style="box-sizing: border-box; color: rgb(0, 0, 136);">/&gt;</span></pre> 
 <p> 我们已经有了下查看Shared文件夹中创建的错误视图。这一次，这个视图文件的代码更改为强类型，键入使用HandleErrorInfo模型（这是System.Web.MVC下存在）：</p> 
 <pre class="prettyprint prettyprinted" style="box-sizing: border-box; Menlo, Monaco, Consolas, 'Courier New', monospace; border-radius: 0px; width: 501.328125px; line-height: 16px; font-size: 12px; overflow: auto; color: rgb(49, 49, 49);">
<span class="lit" style="box-sizing: border-box; color: rgb(0, 102, 102);">@model</span><span class="pln" style="box-sizing: border-box;"> </span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">System</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">.</span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">Web</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">.</span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">Mvc</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">.</span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">HandleErrorInfo</span><span class="pln" style="box-sizing: border-box;">
</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">@{</span><span class="pln" style="box-sizing: border-box;">
</span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">Layout</span><span class="pln" style="box-sizing: border-box;"> </span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">=</span><span class="pln" style="box-sizing: border-box;"> </span><span class="kwd" style="box-sizing: border-box; color: rgb(0, 0, 136);">null</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">;</span><span class="pln" style="box-sizing: border-box;">
</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">}</span><span class="pln" style="box-sizing: border-box;">
 
</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">&lt;!</span><span class="pln" style="box-sizing: border-box;">DOCTYPE html</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">&gt;</span><span class="pln" style="box-sizing: border-box;">
</span><span class="str" style="box-sizing: border-box; color: rgb(0, 136, 0);">&lt;html&gt;</span><span class="pln" style="box-sizing: border-box;">
</span><span class="str" style="box-sizing: border-box; color: rgb(0, 136, 0);">&lt;head&gt;</span><span class="pln" style="box-sizing: border-box;">
   </span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">&lt;</span><span class="pln" style="box-sizing: border-box;">meta name</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">=</span><span class="str" style="box-sizing: border-box; color: rgb(0, 136, 0);">"viewport"</span><span class="pln" style="box-sizing: border-box;"> content</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">=</span><span class="str" style="box-sizing: border-box; color: rgb(0, 136, 0);">"width=device-width"</span><span class="pln" style="box-sizing: border-box;"> </span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">/&gt;</span><span class="pln" style="box-sizing: border-box;">
   </span><span class="str" style="box-sizing: border-box; color: rgb(0, 136, 0);">&lt;title&gt;</span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">Error</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">&lt;/</span><span class="pln" style="box-sizing: border-box;">title</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">&gt;</span><span class="pln" style="box-sizing: border-box;">
</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">&lt;/</span><span class="pln" style="box-sizing: border-box;">head</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">&gt;</span><span class="pln" style="box-sizing: border-box;">
</span><span class="str" style="box-sizing: border-box; color: rgb(0, 136, 0);">&lt;body&gt;</span><span class="pln" style="box-sizing: border-box;">
</span><span class="str" style="box-sizing: border-box; color: rgb(0, 136, 0);">&lt;h2&gt;</span><span class="pln" style="box-sizing: border-box;">
    </span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">Sorry</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">,</span><span class="pln" style="box-sizing: border-box;"> an error occurred </span><span class="kwd" style="box-sizing: border-box; color: rgb(0, 0, 136);">while</span><span class="pln" style="box-sizing: border-box;"> processing your request</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">.</span><span class="pln" style="box-sizing: border-box;">

</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">&lt;/</span><span class="pln" style="box-sizing: border-box;">h2</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">&gt;</span><span class="pln" style="box-sizing: border-box;">
    </span><span class="str" style="box-sizing: border-box; color: rgb(0, 136, 0);">&lt;h2&gt;</span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">Exception</span><span class="pln" style="box-sizing: border-box;"> details</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">&lt;/</span><span class="pln" style="box-sizing: border-box;">h2</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">&gt;</span><span class="pln" style="box-sizing: border-box;">
</span><span class="str" style="box-sizing: border-box; color: rgb(0, 136, 0);">&lt;p&gt;</span><span class="pln" style="box-sizing: border-box;">
    </span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">Controller</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">:</span><span class="pln" style="box-sizing: border-box;"> </span><span class="lit" style="box-sizing: border-box; color: rgb(0, 102, 102);">@Model</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">.</span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">ControllerName</span><span class="pln" style="box-sizing: border-box;"> </span><span class="str" style="box-sizing: border-box; color: rgb(0, 136, 0);">&lt;br&gt;</span><span class="pln" style="box-sizing: border-box;">
    </span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">Action</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">:</span><span class="pln" style="box-sizing: border-box;"> </span><span class="lit" style="box-sizing: border-box; color: rgb(0, 102, 102);">@Model</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">.</span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">ActionName</span><span class="pln" style="box-sizing: border-box;">
    </span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">Exception</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">:</span><span class="pln" style="box-sizing: border-box;"> </span><span class="lit" style="box-sizing: border-box; color: rgb(0, 102, 102);">@Model</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">.</span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">Exception</span><span class="pln" style="box-sizing: border-box;">
</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">&lt;/</span><span class="pln" style="box-sizing: border-box;">p</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">&gt;</span><span class="pln" style="box-sizing: border-box;">
  
</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">&lt;/</span><span class="pln" style="box-sizing: border-box;">body</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">&gt;</span><span class="pln" style="box-sizing: border-box;">
</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">&lt;/</span><span class="pln" style="box-sizing: border-box;">html</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">&gt;</span></pre> 
 <p> 现在，将下面的代码在控制器文件，其中规定在控制器文件[HandleError]属性。</p>   
 <pre class="prettyprint prettyprinted" style="box-sizing: border-box; Menlo, Monaco, Consolas, 'Courier New', monospace; border-radius: 0px; width: 501.328125px; line-height: 16px; font-size: 12px; overflow: auto; color: rgb(49, 49, 49);">
<span class="kwd" style="box-sizing: border-box; color: rgb(0, 0, 136);">using</span><span class="pln" style="box-sizing: border-box;"> </span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">System</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">;</span><span class="pln" style="box-sizing: border-box;">
</span><span class="kwd" style="box-sizing: border-box; color: rgb(0, 0, 136);">using</span><span class="pln" style="box-sizing: border-box;"> </span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">System</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">.</span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">Data</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">.</span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">Common</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">;</span><span class="pln" style="box-sizing: border-box;">
</span><span class="kwd" style="box-sizing: border-box; color: rgb(0, 0, 136);">using</span><span class="pln" style="box-sizing: border-box;"> </span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">System</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">.</span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">Web</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">.</span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">Mvc</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">;</span><span class="pln" style="box-sizing: border-box;">

</span><span class="kwd" style="box-sizing: border-box; color: rgb(0, 0, 136);">namespace</span><span class="pln" style="box-sizing: border-box;"> </span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">ExceptionHandlingMVC</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">.</span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">Controllers</span><span class="pln" style="box-sizing: border-box;">
</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">{</span><span class="pln" style="box-sizing: border-box;">
    </span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">[</span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">HandleError</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">]</span><span class="pln" style="box-sizing: border-box;">
    </span><span class="kwd" style="box-sizing: border-box; color: rgb(0, 0, 136);">public</span><span class="pln" style="box-sizing: border-box;"> </span><span class="kwd" style="box-sizing: border-box; color: rgb(0, 0, 136);">class</span><span class="pln" style="box-sizing: border-box;"> </span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">ExceptionHandlingController</span><span class="pln" style="box-sizing: border-box;"> </span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">:</span><span class="pln" style="box-sizing: border-box;"> </span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">Controller</span><span class="pln" style="box-sizing: border-box;">
    </span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">{</span><span class="pln" style="box-sizing: border-box;">
        </span><span class="kwd" style="box-sizing: border-box; color: rgb(0, 0, 136);">public</span><span class="pln" style="box-sizing: border-box;"> </span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">ActionResult</span><span class="pln" style="box-sizing: border-box;"> </span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">TestMethod</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">()</span><span class="pln" style="box-sizing: border-box;">
        </span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">{</span><span class="pln" style="box-sizing: border-box;">
            </span><span class="kwd" style="box-sizing: border-box; color: rgb(0, 0, 136);">throw</span><span class="pln" style="box-sizing: border-box;"> </span><span class="kwd" style="box-sizing: border-box; color: rgb(0, 0, 136);">new</span><span class="pln" style="box-sizing: border-box;"> </span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">Exception</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">(</span><span class="str" style="box-sizing: border-box; color: rgb(0, 136, 0);">"Test Exception"</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">);</span><span class="pln" style="box-sizing: border-box;">
            </span><span class="kwd" style="box-sizing: border-box; color: rgb(0, 0, 136);">return</span><span class="pln" style="box-sizing: border-box;"> </span><span class="typ" style="box-sizing: border-box; color: rgb(127, 0, 85);">View</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">();</span><span class="pln" style="box-sizing: border-box;">
        </span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">}</span><span class="pln" style="box-sizing: border-box;">
    </span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">}</span><span class="pln" style="box-sizing: border-box;">
</span><span class="pun" style="box-sizing: border-box; color: rgb(102, 102, 0);">}</span><span class="pln" style="box-sizing: border-box;">
</span></pre> 
 <p> 如果尝试现在运行的应用程序，会得到类似如下的错误：</p> 
 <img alt="mvc_exception" src="/uploads/allimg/150603/104G4OM-4.jpg"> 
 <p> 正如所看到的，这一次的错误包含了控制器和动作细节相关的更多信息。以这种方式，HandleError可用于在任何级别和跨控制器处理这样的错误。</p> 
 <br>      
</div></body></html>
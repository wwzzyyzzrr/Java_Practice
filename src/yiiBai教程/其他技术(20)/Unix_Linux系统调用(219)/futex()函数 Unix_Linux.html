<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">futex()函数 Unix/Linux</h1><div style="width:100%;float:left;" class="article-content">   
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> futex - 快速用户空间锁定系统调用</p> 
 <h1 class="manpages" style="font-weight: normal; font-size: 18px; line-height: 1.5; font-family: Calibri; margin-bottom: 0px; color: rgb(0, 0, 0);"> 内容简介</h1> 
 <div style="float:left;margin-bottom: 10px;">  
 </div>
 <div style="float:left;margin-bottom: 10px;">  
 </div>
 <table cellpadding="5" cellspacing="5" class="src" style="font-family: verdana, helvetica, arial, sans-serif;  border-color: rgb(170, 170, 170); width: 552px; background-color: rgb(241, 241, 241); border-collapse: collapse; padding-left: 5px; vertical-align: top; color: rgb(0, 0, 0);"> 
  <tbody> 
   <tr> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse;  border-color: rgb(170, 170, 170);"> <p style="text-align: justify;"> <b>#include &lt;linux/futex.h&gt;</b></p> <p style="text-align: justify;"> <b>#include &lt;sys/time.h&gt;</b></p> <p style="text-align: justify;"> <b>int futex(int *</b><i>uaddr</i><b>, int </b><i>op</i><b>, int </b><i>val</i>, const struct timespec * timeout , <b> int *</b><i>uaddr2</i><b>, int </b><i>val3</i><b>);</b></p> </td> 
   </tr> 
  </tbody> 
 </table> 
 <h1 class="manpages" style="font-weight: normal; font-size: 18px; line-height: 1.5; font-family: Calibri; margin-bottom: 0px; color: rgb(0, 0, 0);"> 描述</h1> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> The&nbsp;<b>futex</b>() system call provides a method for a program to wait for a value at a given address to change, and a method to wake up anyone waiting on a particular address (while the addresses for the same memory in separate processes may not be equal, the kernel maps them internally so the same memory mapped in different locations will correspond for&nbsp;<b>futex</b>() calls). It is typically used to implement the contended case of a lock in shared memory, as described in&nbsp;<b>futex</b>(7).</p> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> When a&nbsp;<b>futex</b>(7) operation did not finish uncontended in userspace, a call needs to be made to the kernel to arbitrate. Arbitration can either mean putting the calling process to sleep or, conversely, waking a waiting process.</p> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> Callers of this function are expected to adhere to the semantics as set out in&nbsp;<b>futex</b>(7). As these semantics involve writing non-portable assembly instructions, this in turn probably means that most users will in fact be library authors and not general application developers.</p> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> The&nbsp;<i>uaddr</i>&nbsp;argument needs to yiibai to an aligned integer which stores the counter. The operation to execute is passed via the&nbsp;<i>op</i>&nbsp;parameter, along with a value&nbsp;<i>val</i>.</p> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> Five operations are currently defined:</p> 
 <table border="1" cellpadding="5" cellspacing="0" class="src" style="font-family: verdana, helvetica, arial, sans-serif; border: 1px solid rgb(170, 170, 170); width: 552px; background-color: rgb(241, 241, 241); border-collapse: collapse; padding-left: 5px; vertical-align: top; color: rgb(0, 0, 0);"> 
  <tbody> 
   <tr> 
    <th style="background-color: rgb(205, 205, 205); border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" width="25%"> 标签</th> 
    <th style="background-color: rgb(205, 205, 205); border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> 描述</th> 
   </tr> 
   <tr valign="top"> 
    <td colspan="2" style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>FUTEX_WAIT</b></td> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" width="6%"> &nbsp;</td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> This operation atomically verifies that the futex address<i>uaddr</i>&nbsp;still contains the value&nbsp;<i>val</i>, and sleeps awaiting FUTEX_WAKE on this futex address. If the&nbsp;<i>timeout</i>&nbsp;argument is non-NULL, its contents describe the maximum duration of the wait, which is infinite otherwise. The arguments&nbsp;<i>uaddr2</i>and&nbsp;<i>val3</i>&nbsp;are ignored. <p style="text-align: justify;"> For&nbsp;<b>futex</b>(7), this call is executed if decrementing the count gave a negative value (indicating contention), and will sleep until another process releases the futex and executes the FUTEX_WAKE operation.</p> </td> 
   </tr> 
   <tr> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>FUTEX_WAKE</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> This operation wakes at most&nbsp;<i>val</i>&nbsp;processes waiting on this futex address (ie. inside FUTEX_WAIT). The arguments<i>timeout</i>,&nbsp;<i>uaddr2</i>&nbsp;and&nbsp;<i>val3</i>&nbsp;are ignored. <p style="text-align: justify;"> For&nbsp;<b>futex</b>(7), this is executed if incrementing the count showed that there were waiters, once the futex value has been set to 1 (indicating that it is available).</p> </td> 
   </tr> 
   <tr> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>FUTEX_FD</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> To support asynchronous wakeups, this operation associates a file descriptor with a futex. If another process executes a FUTEX_WAKE, the process will receive the signal number that was passed in&nbsp;<i>val</i>. The calling process must close the returned file descriptor after use. The arguments<i>timeout</i>,&nbsp;<i>uaddr2</i>&nbsp;and&nbsp;<i>val3</i>&nbsp;are ignored. <p style="text-align: justify;"> To prevent race conditions, the caller should test if the futex has been upped after FUTEX_FD returns.</p> </td> 
   </tr> 
   <tr> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>FUTEX_REQUEUE</b>(since Linux 2.5.70)</td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> This operation was introduced in order to avoid a "thundering herd" effect when FUTEX_WAKE is used and all processes woken up need to acquire another futex. This call wakes up&nbsp;<i>val</i>&nbsp;processes, and requeues all other waiters on the futex at address&nbsp;<i>uaddr2</i>. The arguments&nbsp;<i>timeout</i>&nbsp;and<i>val3</i>&nbsp;are ignored.</td> 
   </tr> 
   <tr> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>FUTEX_CMP_REQUEUE</b>(since Linux 2.6.7)</td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> There was a race in the intended use of FUTEX_REQUEUE, so FUTEX_CMP_REQUEUE was introduced. This is similar to FUTEX_REQUEUE, but first checks whether the location<i>uaddr</i>&nbsp;still contains the value&nbsp;<i>val3</i>. If not, an error EAGAIN is returned. The argument&nbsp;<i>timeout</i>&nbsp;is ignored.</td> 
   </tr> 
  </tbody> 
 </table> 
 <h1 class="manpages" style="font-weight: normal; font-size: 18px; line-height: 1.5; font-family: Calibri; margin-bottom: 0px; color: rgb(0, 0, 0);"> 返回值</h1> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> Depending on which operation was executed, the returned value can have differing meanings.</p> 
 <table border="1" cellpadding="5" cellspacing="0" class="src" style="font-family: verdana, helvetica, arial, sans-serif; border: 1px solid rgb(170, 170, 170); width: 552px; background-color: rgb(241, 241, 241); border-collapse: collapse; padding-left: 5px; vertical-align: top; color: rgb(0, 0, 0);"> 
  <tbody> 
   <tr> 
    <th style="background-color: rgb(205, 205, 205); border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" width="25%"> 标签</th> 
    <th style="background-color: rgb(205, 205, 205); border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> 描述</th> 
   </tr> 
   <tr> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>FUTEX_WAIT</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> Returns 0 if the process was woken by a FUTEX_WAKE call. In case of timeout, ETIMEDOUT is returned. If the futex was not equal to the expected value, the operation returns EWOULDBLOCK. Signals (or other spurious wakeups) cause FUTEX_WAIT to return EINTR.</td> 
   </tr> 
   <tr> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>FUTEX_WAKE</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> Returns the number of processes woken up.</td> 
   </tr> 
   <tr> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>FUTEX_FD</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> Returns the new file descriptor associated with the futex.</td> 
   </tr> 
   <tr> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>FUTEX_REQUEUE</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> Returns the number of processes woken up.</td> 
   </tr> 
   <tr> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>FUTEX_CMP_REQUEUE</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> Returns the number of processes woken up.</td> 
   </tr> 
  </tbody> 
 </table>   
 <h1 class="manpages" style="font-weight: normal; font-size: 18px; line-height: 1.5; font-family: Calibri; margin-bottom: 0px; color: rgb(0, 0, 0);"> 错误</h1> 
 <table border="1" cellpadding="5" cellspacing="0" class="src" style="font-family: verdana, helvetica, arial, sans-serif; border: 1px solid rgb(170, 170, 170); width: 552px; background-color: rgb(241, 241, 241); border-collapse: collapse; padding-left: 5px; vertical-align: top; color: rgb(0, 0, 0);"> 
  <tbody> 
   <tr> 
    <th style="background-color: rgb(205, 205, 205); border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" width="25%"> 错误代码</th> 
    <th style="background-color: rgb(205, 205, 205); border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> 描述</th> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>EACCES</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" valign="bottom"> No read access to futex memory.</td> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>EAGAIN</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" valign="bottom"> FUTEX_CMP_REQUEUE found an unexpected futex value. (This probably indicates a race; use the safe FUTEX_WAKE now.)</td> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>EFAULT</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" valign="bottom"> Error in getting&nbsp;<i>timeout</i>&nbsp;information from userspace.</td> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>EINVAL</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" valign="bottom"> An operation was not defined or error in page alignment.</td> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>ENFILE</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" valign="bottom"> The system limit on the total number of open files has been reached.</td> 
   </tr> 
  </tbody> 
 </table> 
 <h1 class="manpages" style="font-weight: normal; font-size: 18px; line-height: 1.5; font-family: Calibri; margin-bottom: 0px; color: rgb(0, 0, 0);"> 注意</h1> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> To reiterate, bare futexes are not intended as an easy to use abstraction for end-users. Implementors are expected to be assembly literate and to have read the sources of the futex userspace library referenced below.</p> 
 <h1 class="manpages" style="font-weight: normal; font-size: 18px; line-height: 1.5; font-family: Calibri; margin-bottom: 0px; color: rgb(0, 0, 0);"> 版本</h1> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> Initial futex support was merged in Linux 2.5.7 but with different semantics from what was described above. A 4-parameter system call with the semantics given here was introduced in Linux 2.5.40. In Linux 2.5.70 one parameter was added. In Linux 2.6.7 a sixth parameter was added — messy, especially on the s390 architecture.</p> 
 <h1 class="manpages" style="font-weight: normal; font-size: 18px; line-height: 1.5; font-family: Calibri; margin-bottom: 0px; color: rgb(0, 0, 0);"> 遵循于</h1> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> This system call is Minux specific.</p> 
 <br>      
</div></body></html>
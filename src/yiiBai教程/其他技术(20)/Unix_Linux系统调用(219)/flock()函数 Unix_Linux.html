<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">flock()函数 Unix/Linux</h1><div style="width:100%;float:left;" class="article-content">   
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> flock - 应用或删除上一个打开的文件的咨询锁</p> 
 <h1 class="manpages" style="font-weight: normal; font-size: 18px; line-height: 1.5; font-family: Calibri; margin-bottom: 0px; color: rgb(0, 0, 0);"> 内容简介</h1> 
 <pre style="font-family: 'Courier New', monospace; font-size: 12px; margin-bottom: 0px;">
<b>#include &lt;sys/file.h&gt;</b> 
<b>int flock(int </b><i>fd</i><b>, int </b><i>operation</i><b>);</b></pre> 
 <h1 class="manpages" style="font-weight: normal; font-size: 18px; line-height: 1.5; font-family: Calibri; margin-bottom: 0px; color: rgb(0, 0, 0);"> 描述</h1> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> 应用或删除由 fd 所指定的打开文件的咨询锁。参数操作是执行下列操作之一：</p> 
 <table border="1" cellpadding="5" cellspacing="0" class="src" style="font-family: verdana, helvetica, arial, sans-serif; border: 1px solid rgb(170, 170, 170); width: 552px; background-color: rgb(241, 241, 241); border-collapse: collapse; padding-left: 5px; vertical-align: top; color: rgb(0, 0, 0);"> 
  <tbody> 
   <tr> 
    <th style="background-color: rgb(205, 205, 205); border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" width="25%"> 标签</th> 
    <th style="background-color: rgb(205, 205, 205); border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> 描述</th> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>LOCK_SH</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" valign="bottom"> Place a shared lock. More than one process may hold a shared lock for a given file at a given time.</td> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>LOCK_EX</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" valign="bottom"> Place an exclusive lock. Only one process may hold an exclusive lock for a given file at a given time.</td> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>LOCK_UN</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" valign="bottom"> Remove an existing lock held by this process. <p style="text-align: justify;"> &nbsp;</p> </td> 
   </tr> 
  </tbody> 
 </table> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> A call to&nbsp;<b>flock</b>() may block if an incompatible lock is held by another process. To make a non-blocking request, include&nbsp;<b>LOCK_NB</b>&nbsp;(by&nbsp;<i>OR</i>ing) with any of the above operations.</p> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> A single file may not simultaneously have both shared and exclusive locks.</p> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> Locks created by&nbsp;<b>flock</b>() are associated with an open file table entry. This means that duplicate file descriptors (created by, for example,&nbsp;<b>fork</b>(2) or&nbsp;<b>dup</b>(2)) refer to the same lock, and this lock may be modified or released using any of these descriptors. Furthermore, the lock is released either by an explicit&nbsp;<b>LOCK_UN</b>&nbsp;operation on any of these duplicate descriptors, or when all such descriptors have been closed.</p> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> If a process uses&nbsp;<b>open</b>(2) (or similar) to obtain more than one descriptor for the same file, these descriptors are treated independently by&nbsp;<b>flock</b>(). An attempt to lock the file using one of these file descriptors may be denied by a lock that the calling process has already placed via another descriptor.</p> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> A process may only hold one type of lock (shared or exclusive) on a file. Subsequent<b>flock</b>() calls on an already locked file will convert an existing lock to the new lock mode.</p> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> Locks created by&nbsp;<b>flock</b>() are preserved across an&nbsp;<b>execve</b>(2).</p> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> A shared or exclusive lock can be placed on a file regardless of the mode in which the file was opened.</p> 
 <h1 class="manpages" style="font-weight: normal; font-size: 18px; line-height: 1.5; font-family: Calibri; margin-bottom: 0px; color: rgb(0, 0, 0);"> 返回值</h1> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> On success, zero is returned. On error, -1 is returned, and&nbsp;<i>errno</i>&nbsp;is set appropriately.</p> 
 <h1 class="manpages" style="font-weight: normal; font-size: 18px; line-height: 1.5; font-family: Calibri; margin-bottom: 0px; color: rgb(0, 0, 0);"> 错误</h1> 
 <table border="1" cellpadding="5" cellspacing="0" class="src" style="font-family: verdana, helvetica, arial, sans-serif; border: 1px solid rgb(170, 170, 170); width: 552px; background-color: rgb(241, 241, 241); border-collapse: collapse; padding-left: 5px; vertical-align: top; color: rgb(0, 0, 0);"> 
  <tbody> 
   <tr> 
    <th style="background-color: rgb(205, 205, 205); border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" width="25%"> Error Code</th> 
    <th style="background-color: rgb(205, 205, 205); border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> 描述</th> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>EBADF</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" valign="bottom"> <i>fd</i>&nbsp;is not a not an open file descriptor.</td> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>EINTR</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" valign="bottom"> While waiting to acquire a lock, the call was interrupted by delivery of a signal caught by a handler.</td> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>EINVAL</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" valign="bottom"> <i>operation</i>&nbsp;is invalid.</td> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>ENOLCK</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" valign="bottom"> The kernel ran out of memory for allocating lock records.</td> 
   </tr> 
   <tr> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>EWOULDBLOCK</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> The file is locked and the&nbsp;<b>LOCK_NB</b>&nbsp;flag was selected.</td> 
   </tr> 
  </tbody> 
 </table>   
 <h1 class="manpages" style="font-weight: normal; font-size: 18px; line-height: 1.5; font-family: Calibri; margin-bottom: 0px; color: rgb(0, 0, 0);"> 遵循于</h1> 
 <span style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">4.4BSD (the&nbsp;</span>
 <b style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">flock</b>
 <span style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">(2) call first appeared in 4.2BSD). A version of&nbsp;</span>
 <b style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">flock</b>
 <span style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">(2), possibly implemented in terms of&nbsp;</span>
 <b style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">fcntl</b>
 <span style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">(2), appears on most Unices.</span> 
 <h1 class="manpages" style="font-weight: normal; font-size: 18px; line-height: 1.5; font-family: Calibri; margin-bottom: 0px; color: rgb(0, 0, 0);"> 注意</h1> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> <b>flock</b>(2) does not lock files over NFS. Use&nbsp;<b>fcntl</b>(2) instead: that does work over NFS, given a sufficiently recent version of Linux and a server which supports locking.</p> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> Since kernel 2.0,&nbsp;<b>flock</b>(2) is implemented as a system call in its own right rather than being emulated in the GNU C library as a call to&nbsp;<b>fcntl</b>(2). This yields true BSD semantics: there is no interaction between the types of lock placed by&nbsp;<b>flock</b>(2) and&nbsp;<b>fcntl</b>(2), and<b>flock</b>(2) does not detect deadlock.</p> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> <b>flock</b>(2) places advisory locks only; given suitable permissions on a file, a process is free to ignore the use of&nbsp;<b>flock</b>(2) and perform I/O on the file.</p> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> <b>flock</b>(2) and&nbsp;<b>fcntl</b>(2) locks have different semantics with respect to forked processes and&nbsp;<b>dup</b>(2). On systems that implement&nbsp;<b>flock</b>() using&nbsp;<b>fcntl</b>(), the semantics of&nbsp;<b>flock</b>() will be different from those described in this manual page.</p> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> Converting a lock (shared to exclusive, or vice versa) is not guaranteed to be atomic: the existing lock is first removed, and then a new lock is established. Between these two steps, a pending lock request by another process may be granted, with the result that the conversion either blocks, or fails if&nbsp;<b>LOCK_NB</b>&nbsp;was specified. (This is the original BSD behaviour, and occurs on many other implementations.)</p> 
 <h1 class="manpages" style="font-weight: normal; font-size: 18px; line-height: 1.5; font-family: Calibri; margin-bottom: 0px; color: rgb(0, 0, 0);"> 另请参阅</h1> 
 <ul style="font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> 
  <li> <p style="text-align: justify;"> <a target="_blank" href="http://www.yiibai.com/unix_system_calls/close.html" style="color: rgb(144, 11, 9); background-color: transparent;">close (2)</a></p> </li> 
  <li> <p style="text-align: justify;"> <a target="_blank" href="http://www.yiibai.com/unix_system_calls/dup.html" style="color: rgb(144, 11, 9); background-color: transparent;">dup (2)</a></p> </li> 
  <li> <p style="text-align: justify;"> <a target="_blank" href="http://www.yiibai.com/unix_system_calls/execve.html" style="color: rgb(144, 11, 9); background-color: transparent;">execve (2)</a></p> </li> 
  <li> <p style="text-align: justify;"> <a target="_blank" href="http://www.yiibai.com/unix_system_calls/fcntl.html" style="color: rgb(144, 11, 9); background-color: transparent;">fcntl (2)</a></p> </li> 
  <li> <p style="text-align: justify;"> <a target="_blank" href="http://www.yiibai.com/unix_system_calls/fork.html" style="color: rgb(144, 11, 9); background-color: transparent;">fork (2)</a></p> </li> 
  <li> <p style="text-align: justify;"> <a target="_blank" href="http://www.yiibai.com/unix_system_calls/open.html" style="color: rgb(144, 11, 9); background-color: transparent;">open (2)</a></p> </li> 
 </ul> 
 <br>      
</div></body></html>
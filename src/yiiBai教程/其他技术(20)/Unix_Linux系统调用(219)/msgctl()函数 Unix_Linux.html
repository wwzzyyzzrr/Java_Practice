<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">msgctl()函数 Unix/Linux</h1><div style="width:100%;float:left;" class="article-content">   
 <span style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">msgctl -&nbsp;</span>消息控制操作 
 <h1 class="manpages" style="font-weight: normal; font-size: 18px; line-height: 1.5; font-family: Calibri; margin-bottom: 0px; color: rgb(0, 0, 0);"> 内容简介</h1> 
 <pre style="font-family: 'Courier New', monospace; font-size: 12px; margin-bottom: 0px;">
<b>#include &lt;sys/types.h&gt;</b> 
<b>#include &lt;sys/ipc.h&gt;</b> 
<b>#include &lt;sys/msg.h&gt;</b> 
</pre> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> <b>int msgctl(int&nbsp;</b><i>msqid</i><b>,</b>&nbsp;<b>int&nbsp;</b><i>cmd</i><b>,</b>&nbsp;<b>struct msqid_ds *</b><i>buf</i><b>);</b></p> 
 <h1 class="manpages" style="font-weight: normal; font-size: 18px; line-height: 1.5; font-family: Calibri; margin-bottom: 0px; color: rgb(0, 0, 0);"> 描述</h1> 
 <pre style="font-family: 'Courier New', monospace; font-size: 12px; margin-bottom: 0px;">
struct msqid_ds {
    struct ipc_perm msg_perm;     /* Ownership and permissions
    time_t         msg_stime;    /* Time of last msgsnd() */
    time_t         msg_rtime;    /* Time of last msgrcv() */
    time_t         msg_ctime;    /* Time of last change */
    unsigned long  __msg_cbytes; /* Current number of bytes in
                                    queue (non-standard) */
    msgqnum_t      msg_qnum;     /* Current number of messages
                                    in queue */
    msglen_t       msg_qbytes;   /* Maximum number of bytes
                                    allowed in queue */
    pid_t          msg_lspid;    /* PID of last msgsnd() */
    pid_t          msg_lrpid;    /* PID of last msgrcv() */
};
</pre> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> The&nbsp;<i>ipc_perm</i>&nbsp;structure is defined in &lt;sys/ipc.h&gt; as follows (the highlighted fields are settable using&nbsp;<b>IPC_SET</b>):</p> 
 <pre style="font-family: 'Courier New', monospace; font-size: 12px; margin-bottom: 0px;">
struct ipc_perm {
    key_t key;            /* Key supplied to msgget() */
    uid_t <b>uid</b>;            /* Effective UID of owner */
    gid_t <b>gid</b>;            /* Effective GID of owner */
    uid_t cuid;           /* Effective UID of creator */
    gid_t cgid;           /* Effective GID of creator */
    unsigned short <b>mode</b>;  /* Permissions */
    unsigned short seq;   /* Sequence number */
};

</pre> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> Valid values for&nbsp;<i>cmd</i>&nbsp;are:</p> 
 <table border="1" cellpadding="5" cellspacing="0" class="src" style="font-family: verdana, helvetica, arial, sans-serif; border: 1px solid rgb(170, 170, 170); width: 552px; background-color: rgb(241, 241, 241); border-collapse: collapse; padding-left: 5px; vertical-align: top; color: rgb(0, 0, 0);"> 
  <tbody> 
   <tr> 
    <th style="background-color: rgb(205, 205, 205); border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" width="25%"> 标签</th> 
    <th style="background-color: rgb(205, 205, 205); border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> 描述</th> 
   </tr> 
   <tr valign="top"> 
    <td colspan="2" style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>IPC_STAT</b></td> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" width="6%"> &nbsp;</td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> Copy information from the kernel data structure associated with<i>msqid</i>&nbsp;into the&nbsp;<i>msqid_ds</i>&nbsp;structure pointed to by&nbsp;<i>buf</i>. The caller must have read permission on the message queue.</td> 
   </tr> 
   <tr valign="top"> 
    <td colspan="2" style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>IPC_SET</b></td> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" width="6%"> &nbsp;</td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> Write the values of some members of the&nbsp;<i>msqid_ds</i>&nbsp;structure pointed to by&nbsp;<i>buf</i>&nbsp;to the kernel data structure associated with this message queue, updating also its&nbsp;<i>msg_ctime</i>&nbsp;member. The following members of the structure are updated:&nbsp;<i>msg_qbytes</i>,<i>msg_perm.uid</i>,&nbsp;<i>msg_perm.gid</i>, and (the least significant 9 bits of)<i>msg_perm.mode</i>. The effective UID of the calling process must match the owner (<i>msg_perm.uid</i>) or creator (<i>msg_perm.cuid</i>) of the message queue, or the caller must be privileged. Appropriate privilege (Linux: the&nbsp;<b>CAP_IPC_RESOURCE</b>capability) is required to raise the&nbsp;<i>msg_qbytes</i>&nbsp;value beyond the system parameter&nbsp;<b>MSGMNB</b>.</td> 
   </tr> 
   <tr valign="top"> 
    <td colspan="2" style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>IPC_RMID</b></td> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" width="6%"> &nbsp;</td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> Immediately remove the message queue, awakening all waiting reader and writer processes (with an error return and&nbsp;<i>errno</i>&nbsp;set to&nbsp;<b>EIDRM</b>). The calling process must have appropriate privileges or its effective user ID must be either that of the creator or owner of the message queue.</td> 
   </tr> 
   <tr valign="top"> 
    <td colspan="2" style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>IPC_INFO</b>&nbsp;(Linux specific)</td> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" width="6%"> &nbsp;</td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> Returns information about system-wide message queue limits and parameters in the structure pointed to by&nbsp;<i>buf</i>. This structure is of type&nbsp;<i>msginfo</i>&nbsp;(thus, a cast is required), defined in<i>&lt;sys/msg.h&gt;</i>&nbsp;if the _GNU_SOURCE feature test macro is defined: 
     <table cellpadding="5" cellspacing="5" class="src" style=" border-color: rgb(170, 170, 170); width: 401px; border-collapse: collapse; padding-left: 5px; vertical-align: top;"> 
      <tbody> 
       <tr> 
        <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse;  border-color: rgb(170, 170, 170);"> <pre style="font-family: 'Courier New', monospace; font-size: 12px; margin-bottom: 0px;">
</pre> <p style="text-align: justify;"> struct msginfo { int msgpool; /* Size in bytes of buffer pool used to hold message data; unused */ int msgmap; /* Max. # of entries in message map; unused */ int msgmax; /* Max. # of bytes that can be written in a single message */ int msgmnb; /* Max. # of bytes that can be written to queue; used to initialize msg_qbytes during queue creation (msgget()) */ int msgmni; /* Max. # of message queues */ int msgssz; /* Message segment size; unused */ int msgtql; /* Max. # of messages on all queues in system; unused */ unsigned short int msgseg; /* Max. # of segments; unused */ };</p> <p style="text-align: justify;"> &nbsp;</p> </td> 
       </tr> 
      </tbody> 
     </table> The&nbsp;<i>msgmni</i>,&nbsp;<i>msgmax</i>, and&nbsp;<i>msgmnb</i>&nbsp;settings can be changed via<i>/proc</i>&nbsp;files of the same name; see&nbsp;<b>proc</b>(5) for details.</td> 
   </tr> 
   <tr valign="top"> 
    <td colspan="2" style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>MSG_INFO</b>&nbsp;(Linux specific)</td> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" width="6%"> &nbsp;</td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> Returns a&nbsp;<i>msginfo</i>&nbsp;structure containing the same information as for&nbsp;<b>IPC_INFO</b>, except that the following fields are returned with information about system resources consumed by message queues: the&nbsp;<i>msgpool</i>&nbsp;field returns the number of message queues that currently exist on the system; the&nbsp;<i>msgmap</i>&nbsp;field returns the total number of messages in all queues on the system; and the&nbsp;<i>msgtql</i>&nbsp;field returns the total number of bytes in all messages in all queues on the system.</td> 
   </tr> 
   <tr valign="top"> 
    <td colspan="2" style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>MSG_STAT</b>&nbsp;(Linux specific)</td> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" width="6%"> &nbsp;</td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> Returns a&nbsp;<i>msqid_ds</i>&nbsp;structure as for&nbsp;<b>IPC_STAT</b>. However, the<i>msqid</i>&nbsp;argument is not a queue identifier, but instead an index into the kernel’s internal array that maintains information about all message queues on the system.</td> 
   </tr> 
  </tbody> 
 </table> 
 <h1 class="manpages" style="font-weight: normal; font-size: 18px; line-height: 1.5; font-family: Calibri; margin-bottom: 0px; color: rgb(0, 0, 0);"> 返回值</h1> 
 <span style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">On success,&nbsp;</span>
 <b style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">IPC_STAT</b>
 <span style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">,&nbsp;</span>
 <b style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">IPC_SET</b>
 <span style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">, and&nbsp;</span>
 <b style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">IPC_RMID</b>
 <span style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">&nbsp;return 0. A successful&nbsp;</span>
 <b style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">IPC_INFO</b>
 <span style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">&nbsp;or</span>
 <b style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">MSG_INFO</b>
 <span style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">&nbsp;operation returns the index of the highest used entry in the kernel’s internal array recording information about all message queues. (This information can be used with repeated&nbsp;</span>
 <b style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">MSG_STAT</b>
 <span style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">&nbsp;operations to obtain information about all queues on the system.) A successful&nbsp;</span>
 <b style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">MSG_STAT</b>
 <span style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">&nbsp;operation returns the identifier of the queue whose index was given in&nbsp;</span>
 <i style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">msqid</i>
 <span style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">.</span> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> On error, -1 is returned with&nbsp;<i>errno</i>&nbsp;indicating the error.</p> 
 <h1 class="manpages" style="font-weight: normal; font-size: 18px; line-height: 1.5; font-family: Calibri; margin-bottom: 0px; color: rgb(0, 0, 0);"> 错误</h1> 
 <span style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">On failure,&nbsp;</span>
 <i style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">errno</i>
 <span style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">&nbsp;is set to one of the following:</span> 
 <table border="1" cellpadding="5" cellspacing="0" class="src" style="font-family: verdana, helvetica, arial, sans-serif; border: 1px solid rgb(170, 170, 170); width: 552px; background-color: rgb(241, 241, 241); border-collapse: collapse; padding-left: 5px; vertical-align: top; color: rgb(0, 0, 0);"> 
  <tbody> 
   <tr> 
    <th style="background-color: rgb(205, 205, 205); border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" width="25%"> 标签</th> 
    <th style="background-color: rgb(205, 205, 205); border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> 描述</th> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>EACCES</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" valign="bottom"> The argument&nbsp;<i>cmd</i>&nbsp;is equal to&nbsp;<b>IPC_STAT</b>&nbsp;or&nbsp;<b>MSG_STAT</b>, but the calling process does not have read permission on the message queue&nbsp;<i>msqid</i>, and does not have the&nbsp;<b>CAP_IPC_OWNER</b>capability.</td> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>EFAULT</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" valign="bottom"> The argument&nbsp;<i>cmd</i>&nbsp;has the value&nbsp;<b>IPC_SET</b>&nbsp;or&nbsp;<b>IPC_STAT</b>, but the address pointed to by&nbsp;<i>buf</i>&nbsp;isn’t accessible.</td> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>EIDRM</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" valign="bottom"> The message queue was removed.</td> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>EINVAL</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" valign="bottom"> Invalid value for&nbsp;<i>cmd</i>&nbsp;or&nbsp;<i>msqid</i>. Or: for a&nbsp;<b>MSG_STAT</b>&nbsp;operation, the index value specified in&nbsp;<i>msqid</i>&nbsp;referred to an array slot that is currently unused.</td> 
   </tr> 
   <tr valign="top"> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);"> <b>EPERM</b></td> 
    <td style="vertical-align: top; margin-bottom: 0px; border-collapse: collapse; border: 1px solid rgb(170, 170, 170);" valign="bottom"> The argument&nbsp;<i>cmd</i>&nbsp;has the value&nbsp;<b>IPC_SET</b>&nbsp;or&nbsp;<b>IPC_RMID</b>, but the effective user ID of the calling process is not the creator (as found in&nbsp;<i>msg_perm.cuid</i>) or the owner (as found in<i>msg_perm.uid</i>) of the message queue, and the process is not privileged (Linux: it does not have the&nbsp;<b>CAP_SYS_ADMIN</b>capability).</td> 
   </tr> 
  </tbody> 
 </table> 
 <h1 class="manpages" style="font-weight: normal; font-size: 18px; line-height: 1.5; font-family: Calibri; margin-bottom: 0px; color: rgb(0, 0, 0);"> 注意</h1> 
 <span style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">The&nbsp;</span>
 <b style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">IPC_INFO</b>
 <span style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">,&nbsp;</span>
 <b style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">MSG_STAT</b>
 <span style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">&nbsp;and&nbsp;</span>
 <b style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">MSG_INFO</b>
 <span style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">&nbsp;operations are used by the&nbsp;</span>
 <b style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">ipcs</b>
 <span style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">(8) program to provide information on allocated resources. In the future these may modified or moved to a /proc file system interface.</span> 
 <p style="text-align: justify; font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> Various fields in the&nbsp;<i>struct msqid_ds</i>&nbsp;were shorts under Linux 2.2 and have become longs under Linux 2.4. To take advantage of this, a recompilation under glibc-2.1.91 or later should suffice. (The kernel distinguishes old and new calls by an IPC_64 flag in<i>cmd</i>.)</p> 
 <h1 class="manpages" style="font-weight: normal; font-size: 18px; line-height: 1.5; font-family: Calibri; margin-bottom: 0px; color: rgb(0, 0, 0);"> 遵循于</h1> 
 <span style="color: rgb(0, 0, 0); font-family: verdana, helvetica, arial, sans-serif;">SVr4, POSIX.1-2001.</span> 
 <h1 class="manpages" style="font-weight: normal; font-size: 18px; line-height: 1.5; font-family: Calibri; margin-bottom: 0px; color: rgb(0, 0, 0);"> 另请参阅</h1> 
 <ul style="font-family: verdana, helvetica, arial, sans-serif; color: rgb(0, 0, 0);"> 
  <li> <p style="text-align: justify;"> <a target="_blank" href="http://www.yiibai.com/unix_system_calls/msgget.html" style="color: rgb(144, 11, 9); background-color: transparent;">msgget (2)</a></p> </li> 
  <li> <p style="text-align: justify;"> <a target="_blank" href="http://www.yiibai.com/unix_system_calls/msgrcv.html" style="color: rgb(144, 11, 9); background-color: transparent;">msgrcv (2)</a></p> </li> 
  <li> <p style="text-align: justify;"> <a target="_blank" href="http://www.yiibai.com/unix_system_calls/msgsnd.html" style="color: rgb(144, 11, 9); background-color: transparent;">msgsnd (2)</a></p> 
   <div>
     &nbsp;
   </div> </li> 
 </ul> 
 <br>      
</div></body></html>
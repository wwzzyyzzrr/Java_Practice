<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">子进程监视</h1><div style="width:100%;float:left;" class="article-content">   
 <p>每当使用fork创建一个程序的子进程，就会发生以下情况 -</p> 
 <ul> 
  <li>当前进程现在成为父进程</li>
  <li>新的进程成为子进程</li>
 </ul> 
 <p>如果父进程早于子进程完成其任务，然后退出，会发生什么情况？ 现在谁将是子进程的父进程？ 子进程的父进程是初始进程，它是启动所有任务的第一个进程。</p> 
 <p>要监视子进程执行状态，要检查子进程是正在运行还是停止，或检查执行状态等，使用<code>wait()</code>系统调用及其变体。</p> 
 <p>让我们考虑一个示例程序，其中父进程不等待子进程，这会导致子进程成为新父进程(初始进程)。</p> 
 <p><strong>文件</strong>: <em>parentprocess_nowait.c</em> - </p> 
 <pre><code class="lang-cpp">#include&lt;stdio.h&gt;

int main() {
   int pid;
   pid = fork();

   // Child process
   if (pid == 0) {
      system("ps -ef");
      sleep(10);
      system("ps -ef");
   } else {
      sleep(3);
   }
   return 0;
}
</code></pre> 
 <p>编译和执行结果 - </p> 
 <pre><code class="lang-shell">UID         PID   PPID  C STIME TTY          TIME CMD
root          1      0  0 Jan20 ?        00:00:00 /bin/sh /usr/bin/mysqld_safe
mysql       101      1  0 Jan20 ?        00:04:41 /usr/libexec/mysqld --basedir=/usr --datadir=/var/lib/mysql --plugin-dir=/usr/lib64/mysql/plugin --user=mysql --log-error=/var/log/mariadb/mariadb.log --pid-file=/run/mariadb/mariadb.pid --socket=/var/lib/mysql/mysql.sock
3108506    5445      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
4688328    5446      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   21894      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   21895      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   27309      0  0 Jan22 ?        00:00:00 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   27311      0  0 Jan22 ?        00:00:00 [/sbin/klogd -c ] &lt;defunct&gt;
8295652   32407      0  0 Jan20 ?        00:00:39 /sbin/klogd -c 1 -x -x
4688328   49830      0  0 Jan20 ?        00:00:18 /sbin/klogd -c 1 -x -x
3108506   50854      0  0 Jan20 ?        00:00:18 /sbin/klogd -c 1 -x -x
4688328   64936      0  0 Jan22 ?        00:00:59 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   64937      0  0 Jan22 ?        00:00:59 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   67563      0  0 Jan22 ?        00:00:59 [/sbin/klogd -c ] &lt;defunct&gt;
5942779   68128      0  0 Jan22 ?        00:00:07 /sbin/klogd -c 1 -x -x
3108506   68238      0  0 Jan22 ?        00:00:59 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   68999      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   69212      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   74090      0  0 Jan22 ?        00:00:00 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   74091      0  0 Jan22 ?        00:00:00 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   74298      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   74299      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
6327201   74901      0  0 Jan20 ?        00:00:38 /sbin/klogd -c 1 -x -x
6327201   77274      0  0 Jan20 ?        00:00:27 /sbin/klogd -c 1 -x -x
7528790   78621      0  0 Jan20 ?        00:00:33 /sbin/klogd -c 1 -x -x
7528790   80536      0  0 Jan20 ?        00:01:09 [/sbin/klogd -c ] &lt;defunct&gt;
6327201   80542      0  0 Jan20 ?        00:01:09 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   82050      0  0 Jan22 ?        00:01:59 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   82051      0  0 Jan22 ?        00:01:59 [/sbin/klogd -c ] &lt;defunct&gt;
7528790   84116      0  0 Jan20 ?        00:00:27 /sbin/klogd -c 1 -x -x
7528790   84136      0 19 Jan20 ?        21:13:38 /sbin/klogd -c 1 -x -x
7528790   84140      0  0 Jan20 ?        00:00:28 /sbin/klogd -c 1 -x -x
3108506   84395      0  0 Jan22 ?        00:00:29 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   84396      0  0 Jan22 ?        00:00:29 [/sbin/klogd -c ] &lt;defunct&gt;
5942779   84397      0  0 Jan22 ?        00:00:29 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   84928      0  0 Jan22 ?        00:00:29 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   84929      0  0 Jan22 ?        00:00:29 [/sbin/klogd -c ] &lt;defunct&gt;
5942779   84930      0  0 Jan22 ?        00:00:30 [/sbin/klogd -c ] &lt;defunct&gt;
7528790   84970      0  0 Jan20 ?        00:00:34 /sbin/klogd -c 1 -x -x
3108506   85787      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   85789      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
5942779   86368      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
5942779   86402      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
5942779   87027      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
7528790   87629      0  0 Jan20 ?        00:00:39 /sbin/klogd -c 1 -x -x
7528790   87719      0  0 Jan20 ?        00:00:27 /sbin/klogd -c 1 -x -x
4688328   88138      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   88140      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
5942779   89353      0 99 Jan22 ?        2-07:35:14 /sbin/klogd -c 1 -x -x
5942779   91836      0  0 Jan22 ?        00:00:00 [/sbin/klogd -c ] &lt;defunct&gt;
4688328  125358      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
3108506  125359      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
4688328  127456      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
3108506  127457      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
8023807  163891      0  0 05:41 ?        00:00:00 main
8023807  164130      0  0 05:41 ?        00:00:00 sh -c cd /home/cg/root/8023807; timeout 10s main
8023807  164136 164130  0 05:41 ?        00:00:00 timeout 10s main
8023807  164137 164136  0 05:41 ?        00:00:00 main
8023807  164138 164137  0 05:41 ?        00:00:00 main
8023807  164139 164138  0 05:41 ?        00:00:00 ps -ef
UID         PID   PPID  C STIME TTY          TIME CMD
root          1      0  0 Jan20 ?        00:00:00 /bin/sh /usr/bin/mysqld_safe
mysql       101      1  0 Jan20 ?        00:04:41 /usr/libexec/mysqld --basedir=/usr --datadir=/var/lib/mysql --plugin-dir=/usr/lib64/mysql/plugin --user=mysql --log-error=/var/log/mariadb/mariadb.log --pid-file=/run/mariadb/mariadb.pid --socket=/var/lib/mysql/mysql.sock
3108506    5445      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
4688328    5446      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   21894      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   21895      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   27309      0  0 Jan22 ?        00:00:00 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   27311      0  0 Jan22 ?        00:00:00 [/sbin/klogd -c ] &lt;defunct&gt;
8295652   32407      0  0 Jan20 ?        00:00:39 /sbin/klogd -c 1 -x -x
4688328   49830      0  0 Jan20 ?        00:00:18 /sbin/klogd -c 1 -x -x
3108506   50854      0  0 Jan20 ?        00:00:18 /sbin/klogd -c 1 -x -x
4688328   64936      0  0 Jan22 ?        00:00:59 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   64937      0  0 Jan22 ?        00:00:59 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   67563      0  0 Jan22 ?        00:00:59 [/sbin/klogd -c ] &lt;defunct&gt;
5942779   68128      0  0 Jan22 ?        00:00:07 /sbin/klogd -c 1 -x -x
3108506   68238      0  0 Jan22 ?        00:00:59 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   68999      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   69212      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   74090      0  0 Jan22 ?        00:00:00 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   74091      0  0 Jan22 ?        00:00:00 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   74298      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   74299      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
6327201   74901      0  0 Jan20 ?        00:00:38 /sbin/klogd -c 1 -x -x
6327201   77274      0  0 Jan20 ?        00:00:27 /sbin/klogd -c 1 -x -x
7528790   78621      0  0 Jan20 ?        00:00:33 /sbin/klogd -c 1 -x -x
7528790   80536      0  0 Jan20 ?        00:01:09 [/sbin/klogd -c ] &lt;defunct&gt;
6327201   80542      0  0 Jan20 ?        00:01:09 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   82050      0  0 Jan22 ?        00:01:59 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   82051      0  0 Jan22 ?        00:01:59 [/sbin/klogd -c ] &lt;defunct&gt;
7528790   84116      0  0 Jan20 ?        00:00:27 /sbin/klogd -c 1 -x -x
7528790   84136      0 19 Jan20 ?        21:13:48 /sbin/klogd -c 1 -x -x
7528790   84140      0  0 Jan20 ?        00:00:28 /sbin/klogd -c 1 -x -x
3108506   84395      0  0 Jan22 ?        00:00:29 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   84396      0  0 Jan22 ?        00:00:29 [/sbin/klogd -c ] &lt;defunct&gt;
5942779   84397      0  0 Jan22 ?        00:00:29 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   84928      0  0 Jan22 ?        00:00:29 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   84929      0  0 Jan22 ?        00:00:29 [/sbin/klogd -c ] &lt;defunct&gt;
5942779   84930      0  0 Jan22 ?        00:00:30 [/sbin/klogd -c ] &lt;defunct&gt;
7528790   84970      0  0 Jan20 ?        00:00:34 /sbin/klogd -c 1 -x -x
3108506   85787      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   85789      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
5942779   86368      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
5942779   86402      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
5942779   87027      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
7528790   87629      0  0 Jan20 ?        00:00:39 /sbin/klogd -c 1 -x -x
7528790   87719      0  0 Jan20 ?        00:00:27 /sbin/klogd -c 1 -x -x
4688328   88138      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   88140      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
5942779   89353      0 99 Jan22 ?        2-07:35:24 /sbin/klogd -c 1 -x -x
5942779   91836      0  0 Jan22 ?        00:00:00 [/sbin/klogd -c ] &lt;defunct&gt;
4688328  125358      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
3108506  125359      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
4688328  127456      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
3108506  127457      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
8023807  164138      0  0 05:41 ?        00:00:00 main
8023807  164897 164138  0 05:41 ?        00:00:00 ps -ef
</code></pre> 
 <p><strong>注</strong> - 观察父进程PID为<code>94</code>，子进程PID为<code>95</code>。父进程退出后，子进程的PPID从<code>94</code>变为<code>1</code>(初始进程)。</p> 
 <p>以下是监视子进程的系统调用的另一个方式 -</p> 
 <ul> 
  <li><em>wait()</em></li>
  <li><em>waitpid()</em></li>
  <li><em>waitid()</em></li>
 </ul> 
 <p><em>wait()</em>系统调用将等待其中一个子进程终止，并将其终止状态返回到缓冲区，如下所述。</p> 
 <pre><code class="lang-cpp">#include &lt;sys/types.h&gt;
#include &lt;sys/wait.h&gt;

pid_t wait(int *status);
</code></pre> 
 <p>此调用返回已成功终止的子进程的ID，失败时返回<code>-1</code>。 <code>wait()</code>系统调用暂停当前进程的执行并无限期地等待，直到其中一个子进程终止。 来自子进程的终止状态处于不可用状态。</p> 
 <p>让我们修改以前的程序，以便父进程现在等待子进程。</p> 
 <p><strong>文件:</strong> - <em>parentprocess_waits.c</em> - </p> 
 <pre><code class="lang-cpp">#include&lt;stdio.h&gt;

int main() {
   int pid;
   int status;
   pid = fork();

   // Child process
   if (pid == 0) {
      system("ps -ef");
      sleep(10);
      system("ps -ef");
      return 3; //exit status is 3 from child process
   } else {
      sleep(3);
      wait(&amp;status);
      printf("In parent process: exit status from child is decimal %d, hexa %0x\n", status, status);
   }
   return 0;
}
</code></pre> 
 <p>编译和执行,结果如下 - </p> 
 <pre><code class="lang-cpp">UID         PID   PPID  C STIME TTY          TIME CMD
root          1      0  0 Jan20 ?        00:00:00 /bin/sh /usr/bin/mysqld_safe
mysql       101      1  0 Jan20 ?        00:04:42 /usr/libexec/mysqld --basedir=/usr --datadir=/var/lib/mysql --plugin-dir=/usr/lib64/mysql/plugin --user=mysql --log-error=/var/log/mariadb/mariadb.log --pid-file=/run/mariadb/mariadb.pid --socket=/var/lib/mysql/mysql.sock
3108506    5445      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
4688328    5446      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   21894      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   21895      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   27309      0  0 Jan22 ?        00:00:00 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   27311      0  0 Jan22 ?        00:00:00 [/sbin/klogd -c ] &lt;defunct&gt;
8295652   32407      0  0 Jan20 ?        00:00:39 /sbin/klogd -c 1 -x -x
4688328   49830      0  0 Jan20 ?        00:00:18 /sbin/klogd -c 1 -x -x
3108506   50854      0  0 Jan20 ?        00:00:18 /sbin/klogd -c 1 -x -x
4688328   64936      0  0 Jan22 ?        00:00:59 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   64937      0  0 Jan22 ?        00:00:59 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   67563      0  0 Jan22 ?        00:00:59 [/sbin/klogd -c ] &lt;defunct&gt;
5942779   68128      0  0 Jan22 ?        00:00:07 /sbin/klogd -c 1 -x -x
3108506   68238      0  0 Jan22 ?        00:00:59 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   68999      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   69212      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   74090      0  0 Jan22 ?        00:00:00 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   74091      0  0 Jan22 ?        00:00:00 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   74298      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   74299      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
6327201   74901      0  0 Jan20 ?        00:00:38 /sbin/klogd -c 1 -x -x
6327201   77274      0  0 Jan20 ?        00:00:27 /sbin/klogd -c 1 -x -x
7528790   78621      0  0 Jan20 ?        00:00:33 /sbin/klogd -c 1 -x -x
7528790   80536      0  0 Jan20 ?        00:01:09 [/sbin/klogd -c ] &lt;defunct&gt;
6327201   80542      0  0 Jan20 ?        00:01:09 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   82050      0  0 Jan22 ?        00:01:59 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   82051      0  0 Jan22 ?        00:01:59 [/sbin/klogd -c ] &lt;defunct&gt;
7528790   84116      0  0 Jan20 ?        00:00:27 /sbin/klogd -c 1 -x -x
7528790   84136      0 19 Jan20 ?        21:19:39 /sbin/klogd -c 1 -x -x
7528790   84140      0  0 Jan20 ?        00:00:28 /sbin/klogd -c 1 -x -x
3108506   84395      0  0 Jan22 ?        00:00:29 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   84396      0  0 Jan22 ?        00:00:29 [/sbin/klogd -c ] &lt;defunct&gt;
5942779   84397      0  0 Jan22 ?        00:00:29 [/sbin/klogd -c ] &lt;defunct&gt;
3108506   84928      0  0 Jan22 ?        00:00:29 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   84929      0  0 Jan22 ?        00:00:29 [/sbin/klogd -c ] &lt;defunct&gt;
5942779   84930      0  0 Jan22 ?        00:00:30 [/sbin/klogd -c ] &lt;defunct&gt;
7528790   84970      0  0 Jan20 ?        00:00:34 /sbin/klogd -c 1 -x -x
3108506   85787      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   85789      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
5942779   86368      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
5942779   86402      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
5942779   87027      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
7528790   87629      0  0 Jan20 ?        00:00:39 /sbin/klogd -c 1 -x -x
7528790   87719      0  0 Jan20 ?        00:00:27 /sbin/klogd -c 1 -x -x
4688328   88138      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
4688328   88140      0  0 Jan22 ?        00:00:14 [/sbin/klogd -c ] &lt;defunct&gt;
5942779   89353      0 99 Jan22 ?        2-07:41:15 /sbin/klogd -c 1 -x -x
5942779   91836      0  0 Jan22 ?        00:00:00 [/sbin/klogd -c ] &lt;defunct&gt;
4688328  125358      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
3108506  125359      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
4688328  127456      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
3108506  127457      0  0 Jan22 ?        00:01:19 [/sbin/klogd -c ] &lt;defunct&gt;
8023807  191762      0  0 05:47 ?        00:00:00 sh -c cd /home/cg/root/8023807; timeout 10s main
8023807  191768 191762  0 05:47 ?        00:00:00 timeout 10s main
8023807  191769 191768  0 05:47 ?        00:00:00 main
8023807  191770 191769  0 05:47 ?        00:00:00 main
8023807  192193      0  0 05:47 ?        00:00:00 sh -c cd /home/cg/root/8023807; timeout 10s main
8023807  192199 192193  0 05:47 ?        00:00:00 timeout 10s main
8023807  192200 192199  0 05:47 ?        00:00:00 main
8023807  192201 192200  0 05:47 ?        00:00:00 main
8023807  192202 192201  0 05:47 ?        00:00:00 ps -ef
</code></pre> 
 <p><strong>注意</strong> - 即使子进程返回<code>3</code>的退出状态，为什么父进程看到的是<code>768</code>。状态存储在高位字节中，因此它以十六进制格式存储为0X0300，十进制为768。 正常终止如下</p> 
 <table> 
  <thead> 
   <tr> 
    <th>高阶字节(8到15位)</th> 
    <th>低位字节(位0至7)</th> 
   </tr> 
  </thead> 
  <tbody> 
   <tr> 
    <td>退出状态(0到255)</td> 
    <td>0</td> 
   </tr> 
  </tbody> 
 </table> 
 <p><code>wait()</code>系统调用有限制，例如它只能等到下一个子进程退出。 如果需要等待一个特定的子进程，那么使用<code>wait()</code>是不可能的，但是可以使用<code>waitpid()</code>系统调用。</p> 
 <p>如下所述，<code>waitpid()</code>系统调用将等待指定的子进程终止，并将其终止状态返回到缓冲区中。</p>   
 <pre><code class="lang-cpp">#include &lt;sys/types.h&gt;
#include &lt;sys/wait.h&gt;

pid_t waitpid(pid_t pid, int *status, int options);
</code></pre> 
 <p>上面的调用返回成功的终止子进程的ID，失败时返回<code>-1</code>。<code>waitpid()</code>系统调用暂停当前进程的执行并无限期地等待，直到指定的子项(按照pid值)终止。 状态中可以显示子进程的终止状态。</p> 
 <p><code>pid</code>的值可以是以下任一值 -</p> 
 <ul> 
  <li><strong>小于-1</strong> - 等待进程组标识等于pid绝对值的子进程。</li>
  <li><strong>-1</strong> - 等待任何子进程，等于<code>wait()</code>系统调用的进程。</li>
  <li><strong>0</strong> - 等待进程组ID等于调用进程的子进程。</li>
  <li><strong>大于0</strong> - 等待任何进程ID等于pid值的子进程。</li>
 </ul> 
 <p>默认情况下，<code>waitpid()</code>系统调用只会等待已终止的子节点，但是可以使用<code>options</code>参数修改此默认行为。</p> 
 <p>现在让我们以一个程序为例，等待一个具有进程ID的特定进程。</p> 
 <p><strong>文件:</strong> <em>waitpid_test.c</em> - </p> 
 <pre><code class="lang-cpp">#include&lt;stdio.h&gt;
#include&lt;unistd.h&gt;
#include&lt;sys/types.h&gt;
#include&lt;sys/wait.h&gt;

int main() {
   int pid;
   int pids[3];
   int status;
   int numprocesses = 0;
   int total_processes = 3;
   while (numprocesses &lt; total_processes) {
      pid = fork();

      // Child process
      if (pid == 0) {
         printf("In child process: process id is %d\n", getpid());
         sleep(5);
         return 4;
      } else {
         pids[numprocesses] = pid;
         numprocesses++;
         printf("In parent process: created process number: %d\n", pid);
      }
   }

   // Waiting for 3rd child process
   waitpid(pids[total_processes - 1], &amp;status, 0);
   if (WIFEXITED(status) != 0) {
      printf("process %d exited normally\n", pids[total_processes - 1]);
      printf("exit status from child is %d\n", WEXITSTATUS(status));
   } else {
      printf("process %d not exited normally\n", pids[total_processes - 1]);
   }
   return 0;
}
</code></pre> 
 <p>编译和执行后，输出如下 - </p> 
 <pre><code class="lang-shell">In child process: process id is 32528
In parent process: created process number: 32528
In child process: process id is 32529
In parent process: created process number: 32528
In parent process: created process number: 32529
In child process: process id is 32530
In parent process: created process number: 32528
In parent process: created process number: 32529
In parent process: created process number: 32530
process 32530 exited normally
exit status from child is 4
</code></pre> 
 <p>现在，查看<code>waitid()</code>系统调用。 这个系统调用等待子进程改变状态。</p> 
 <pre><code class="lang-cpp">#include &lt;sys/wait.h&gt;

int waitpid(idtype_t idtype, id_t id, siginfo_t *infop, int options);
</code></pre> 
 <p>上面的系统调用等待子进程改变状态，这个调用暂停当前/调用进程，直到它的任何子进程改变它的状态。 “infop”的说法是记录子进程的当前状态。 如果进程已经改变了状态，这个调用立即返回。</p> 
 <p><code>idtype</code>的值可以是以下之一 -</p> 
 <ul> 
  <li><code>P_PID</code> - 等待进程ID，等于id的子进程。</li>
  <li><code>P_PGID</code> - 等待任何子进程，其进程组ID等于ID。</li>
  <li><code>P_ALL</code> - 等待任何子进程，id被忽略。</li>
  <li><code>options</code>参数是指定哪些状态改变，这可以通过下面提到的标志按位或运算来形成 - 
   <ul> 
    <li><code>WCONTINUED</code> - 返回任何已停止且已被继续的孩子的状态。</li>
    <li><code>WEXITED</code> - 等待进程退出。</li>
    <li><code>WNOHANG</code> - 立即返回。</li>
    <li><code>WSTOPPED</code> - 等待接收到信号并返回状态的任何停止的孩子的过程。</li>
   </ul> </li>
 </ul> 
 <p>这个调用返回<code>0</code>，如果它由于其中一个子进程的状态改变而返回，并且使用了<code>WNOHANG</code>。 它返回<code>-1</code>，以防错误并设置适当的错误编号。</p> 
 <p><strong>文件</strong>:<em>waitid_test.c</em></p> 
 <pre><code class="lang-cpp">#include&lt;stdio.h&gt;
#include&lt;unistd.h&gt;
#include&lt;sys/types.h&gt;
#include&lt;sys/wait.h&gt;

int main() {
   int pid;
   int pids[3];
   int status;
   int numprocesses = 0;
   int total_processes = 3;
   siginfo_t siginfo;
   while (numprocesses &lt; total_processes) {
      pid = fork();

      // Child process
      if (pid == 0) {
         printf("In child process: process id is %d\n", getpid());
         sleep(5);
         return 2;
      } else {
         pids[numprocesses] = pid;
         numprocesses++;
         printf("In parent process: created process number: %d\n", pid);
      }
   }

   // Waiting for 3rd child process
   status = waitid(P_PID, pids[total_processes - 1], &amp;siginfo, WEXITED);
   if (status == -1) {
      perror("waitid error");
      return 1;
   }
   printf("Info received from waitid is: ");
   printf("PID of child: %d, real user id of child: %d\n", siginfo.si_pid, siginfo.si_uid);
   return 0;
}
</code></pre> 
 <p>上述程序执行完成后，结果如下 - </p> 
 <pre><code class="lang-shell">In child process: process id is 35390
In parent process: created process number: 35390
In child process: process id is 35391
In parent process: created process number: 35390
In parent process: created process number: 35391
In child process: process id is 35392
In parent process: created process number: 35390
In parent process: created process number: 35391
In parent process: created process number: 35392
Info received from waitid is: PID of child: 35392, real user id of child: 4581875
</code></pre>
 <br>      
</div></body></html>
<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">SQL注入</h1><div style="width:100%;float:left;" class="article-content">   
 <p> 如果需要通过网页需要用户输入的数据并将其插入到一个SQL数据库，可能会留下敞开称为SQL注入安全问题。</p> 
 <p> 这一课将教你如何防止这种情况的发生，并帮助您保护服务器端脚本，如Perl脚本中使用的SQL语句。</p> 
 <p> 注入通常当要求一个用户输入，就如他们的名字，但他们给你不是一个名字，会在不知不觉中对数据库运行SQL语句时发生问题。</p> 
 <p> 千万不要信任用户提供的数据，处理这些数据只是验证后;作为一项规则，通过模式匹配进行。</p> 
 <p> 在下面的例子中，该名称被限制为字母数字字符加下划线并以8至20个字符之间的长度(根据需要修改这些规则)。</p> 
 <pre class="prettyprint prettyprinted" style="border-radius: 0px; font-size: 12px; overflow: auto;">
<span class="kwd" style="margin: 0px; padding: 0px; color: rgb(0, 0, 136);">if</span><span class="pln" style="margin: 0px; padding: 0px;"> </span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">(</span><span class="pln" style="margin: 0px; padding: 0px;">preg_match</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">(</span><span class="str" style="margin: 0px; padding: 0px; color: rgb(0, 136, 0);">"/^w{8,20}$/"</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">,</span><span class="pln" style="margin: 0px; padding: 0px;"> $_GET</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">[</span><span class="str" style="margin: 0px; padding: 0px; color: rgb(0, 136, 0);">'username'</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">],</span><span class="pln" style="margin: 0px; padding: 0px;"> $matches</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">))</span><span class="pln" style="margin: 0px; padding: 0px;">
</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">{</span><span class="pln" style="margin: 0px; padding: 0px;">
   $result </span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">=</span><span class="pln" style="margin: 0px; padding: 0px;"> mysql_query</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">(</span><span class="str" style="margin: 0px; padding: 0px; color: rgb(0, 136, 0);">"SELECT * FROM CUSTOMERS 
                          WHERE name=$matches[0]"</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">);</span><span class="pln" style="margin: 0px; padding: 0px;">
</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">}</span><span class="pln" style="margin: 0px; padding: 0px;">
</span><span class="kwd" style="margin: 0px; padding: 0px; color: rgb(0, 0, 136);">else</span><span class="pln" style="margin: 0px; padding: 0px;"> 
</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">{</span><span class="pln" style="margin: 0px; padding: 0px;">
   echo </span><span class="str" style="margin: 0px; padding: 0px; color: rgb(0, 136, 0);">"user name not accepted"</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">;</span><span class="pln" style="margin: 0px; padding: 0px;">
</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">}</span></pre> 
 <p> 为了说明问题，考虑这个片段：</p> 
 <pre class="prettyprint prettyprinted" style="border-radius: 0px; font-size: 12px; overflow: auto;">
<span class="com" style="margin: 0px; padding: 0px; color: rgb(136, 0, 0);">// supposed input</span><span class="pln" style="margin: 0px; padding: 0px;">
$name </span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">=</span><span class="pln" style="margin: 0px; padding: 0px;"> </span><span class="str" style="margin: 0px; padding: 0px; color: rgb(0, 136, 0);">"Qadir'; DELETE FROM CUSTOMERS;"</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">;</span><span class="pln" style="margin: 0px; padding: 0px;">
mysql_query</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">(</span><span class="str" style="margin: 0px; padding: 0px; color: rgb(0, 136, 0);">"SELECT * FROM CUSTOMSRS WHERE name='{$name}'"</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">);</span></pre> 
 <p> 函数调用应该检索来自CUSTOMERS表，其中name列相匹配用户指定名称的记录。在正常情况下，$name应该只包含字母数字字符和或许空格，如字符串ilia。 但在这里，通过附加一个全新的查询$name，调用数据库变成灾难：注入DELETE查询删除所有记录的客户。</p> 
 <p> 幸运的是，如果你使用MySQL，在mysql_query()函数不允许查询堆叠或一个函数调用执行多个SQL查询。 如果您尝试堆叠查询，调用失败。</p> 
 <p> 然而，其他PHP数据库扩展，如SQLite和PostgreSQL，愉快地进行堆查询，执行都在一个字符串提供的查询，并创建一个严重的安全问题。</p> 
 <h2> 防止SQL注入：</h2> 
 <p> 您可以在脚本语言，如Perl和PHP巧妙地处理所有转义字符。MySQL扩展为PHP提供的函数mysql_real_escape_string()来转义特殊MySQL的输入字符。</p> 
 <div style="float:left;margin-bottom: 10px;">  
 </div>
 <div style="float:left;margin-bottom: 10px;">  
 </div>  
 <pre class="prettyprint prettyprinted" style="border-radius: 0px; font-size: 12px; overflow: auto;">
<span class="kwd" style="margin: 0px; padding: 0px; color: rgb(0, 0, 136);">if</span><span class="pln" style="margin: 0px; padding: 0px;"> </span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">(</span><span class="pln" style="margin: 0px; padding: 0px;">get_magic_quotes_gpc</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">())</span><span class="pln" style="margin: 0px; padding: 0px;"> 
</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">{</span><span class="pln" style="margin: 0px; padding: 0px;">
  $name </span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">=</span><span class="pln" style="margin: 0px; padding: 0px;"> stripslashes</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">(</span><span class="pln" style="margin: 0px; padding: 0px;">$name</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">);</span><span class="pln" style="margin: 0px; padding: 0px;">
</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">}</span><span class="pln" style="margin: 0px; padding: 0px;">
$name </span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">=</span><span class="pln" style="margin: 0px; padding: 0px;"> mysql_real_escape_string</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">(</span><span class="pln" style="margin: 0px; padding: 0px;">$name</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">);</span><span class="pln" style="margin: 0px; padding: 0px;">
mysql_query</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">(</span><span class="str" style="margin: 0px; padding: 0px; color: rgb(0, 136, 0);">"SELECT * FROM CUSTOMERS WHERE name='{$name}'"</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">);</span></pre> 
 <h2> LIKE困惑：</h2> 
 <p> 为了解决LIKE问题，一个自定义的转义机制必须将用户提供的'％'和'_'字符文字。 使用addslashes()函数，可以让你指定一个字符范围转义。</p> 
 <pre class="prettyprint prettyprinted" style="border-radius: 0px; font-size: 12px; overflow: auto;">
<span class="pln" style="margin: 0px; padding: 0px;">$sub </span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">=</span><span class="pln" style="margin: 0px; padding: 0px;"> addcslashes</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">(</span><span class="pln" style="margin: 0px; padding: 0px;">mysql_real_escape_string</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">(</span><span class="str" style="margin: 0px; padding: 0px; color: rgb(0, 136, 0);">"%str"</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">),</span><span class="pln" style="margin: 0px; padding: 0px;"> </span><span class="str" style="margin: 0px; padding: 0px; color: rgb(0, 136, 0);">"%_"</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">);</span><span class="pln" style="margin: 0px; padding: 0px;">
</span><span class="com" style="margin: 0px; padding: 0px; color: rgb(136, 0, 0);">// $sub == \%str\_</span><span class="pln" style="margin: 0px; padding: 0px;">
mysql_query</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">(</span><span class="str" style="margin: 0px; padding: 0px; color: rgb(0, 136, 0);">"SELECT * FROM messages 
             WHERE subject LIKE '{$sub}%'"</span><span class="pun" style="margin: 0px; padding: 0px; color: rgb(102, 102, 0);">);</span></pre> 
 <br>      
</div></body></html>
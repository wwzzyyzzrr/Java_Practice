<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">MongoDB自动递增序列</h1><div style="width:100%;float:left;" class="article-content">   
 <p>MongoDB中没有类似SQL数据库中那么拿来即用的自动增量功能。 默认情况下，它使用<code>_id</code>字段的<code>12</code>字节ObjectId作为唯一标识文档的主键。 但是，可能存在我们可能希望<code>_id</code>字段拥有除ObjectId之外的一些自动递增值的情况。</p> 
 <p>由于MongoDB不提供默认自动增长功能，所以我们通过使用MongoDB文档中所建议的计数器集合以编程的方式来实现此功能。</p> 
 <h2 id="h2-u4F7Fu7528u8BA1u6570u5668u96C6u5408"><a name="使用计数器集合" class="reference-link"></a><span class="header-link octicon octicon-link"></span>使用计数器集合</h2>
 <p>考虑以下<code>product</code>文档。 我们希望<code>_id</code>字段是从:<code>1</code>,<code>2</code>,<code>3</code>,<code>4</code>到<code>n</code>开始的自动递增整数序列。</p> 
 <pre><code class="lang-shell">{
  "_id":1,
  "product_name": "Huawei P9",
  "category": "mobiles"
}
</code></pre> 
 <p>为此，创建一个计数器集合，它将跟踪所有序列字段的最后一个序列值。</p> 
 <pre><code class="lang-shell">&gt;db.createCollection("counters")
</code></pre> 
 <p>现在，将把以下文档插入计数器集合中，以<code>productid</code>作为键 -</p> 
 <pre><code class="lang-shell">{
  "_id":"productid",
  "sequence_value": 0
}
</code></pre> 
 <p>字段<code>sequence_value</code>跟踪序列的最后一个值。使用以下代码将此序列文档插入计数器集合中 -</p> 
 <pre><code class="lang-shell">&gt;db.counters.insert({_id:"productid",sequence_value:0})
</code></pre> 
 <h2 id="h2--javascript-"><a name="使用Javascript函数" class="reference-link"></a><span class="header-link octicon octicon-link"></span>使用Javascript函数</h2>
 <p>现在将在创建一个新文档时使用函数<code>getNextSequenceValue</code>，并将返回的序列值分配为文档的<code>_id</code>字段的值。</p> 
 <p>使用以下代码插入两个示例文档 -</p>   
 <pre><code class="lang-shell">&gt;db.products.insert({
   "_id":getNextSequenceValue("productid"),
   "product_name":"HuaWei P9",
   "category":"mobiles"
})

&gt;db.products.insert({
   "_id":getNextSequenceValue("productid"),
   "product_name":"OPPO X6s",
   "category":"mobiles"
})
</code></pre> 
 <p>如上所示，使用<code>getNextSequenceValue</code>函数来设置<code>_id</code>字段的值。</p> 
 <pre><code class="lang-shell">&gt;db.products.find()
</code></pre> 
 <p>上述查询返回了具有自动递增的<code>_id</code>字段的值，如下文档所示 -</p> 
 <pre><code class="lang-shell">{ "_id" : 1, "product_name" : "HuaWei P9", "category" : "mobiles"}
{ "_id" : 2, "product_name" : "OPPO X6s", "category" : "mobiles" }
</code></pre>
 <br>      
</div></body></html>
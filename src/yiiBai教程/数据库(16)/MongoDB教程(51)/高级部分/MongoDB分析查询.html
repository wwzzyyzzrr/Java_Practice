<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">MongoDB分析查询</h1><div style="width:100%;float:left;" class="article-content">   
 <p>分析查询是衡量数据库和索引设计的有效性的一个非常重要的方式。在这里我们将介绍两个经常使用的<code>$explain</code>和<code>$hint</code>查询。</p> 
 <h2 id="h2--explain-"><a name="使用 $explain 操作符" class="reference-link"></a><span class="header-link octicon octicon-link"></span>使用 $explain 操作符</h2>
 <p><code>$explain</code>操作符提供有关查询的信息，查询中使用的索引和其他统计信息。它在在分析索引优化情况时非常有用。</p> 
 <p>在最后一章中，我们已经使用以下查询在<code>users</code>集合的字段：<code>gender</code> 和 <code>user_name</code> 上创建了一个索引：</p> 
 <pre><code class="lang-shell">&gt;db.users.ensureIndex({gender:1,user_name:1})
</code></pre> 
 <p>现在将在以下查询中使用<code>$explain</code>：</p> 
 <pre><code class="lang-shell">&gt;db.users.find({gender:"M"},{user_name:1,_id:0}).explain()
</code></pre> 
 <p>上述<code>explain()</code>查询返回以下分析结果 -</p> 
 <pre><code class="lang-shell">{
   "cursor" : "BtreeCursor gender_1_user_name_1",
   "isMultiKey" : false,
   "n" : 1,
   "nscannedObjects" : 0,
   "nscanned" : 1,
   "nscannedObjectsAllPlans" : 0,
   "nscannedAllPlans" : 1,
   "scanAndOrder" : false,
   "indexOnly" : true,
   "nYields" : 0,
   "nChunkSkips" : 0,
   "millis" : 0,
   "indexBounds" : {
      "gender" : [
         [
            "M",
            "M"
         ]
      ],
      "user_name" : [
         [
            {
               "$minElement" : 1
            },
            {
               "$maxElement" : 1
            }
         ]
      ]
   }
}
</code></pre> 
 <p>现在将看看这个结果集中的字段 -</p> 
 <ul> 
  <li><code>indexOnly</code>的<code>true</code>值表示此查询已使用索引。</li>
  <li><code>cursor</code>字段指定使用的游标的类型。<code>BTreeCursor</code>类型表示使用了索引，并且还给出了使用的索引的名称。 <code>BasicCursor</code>表示完全扫描，而不使用任何索引的情况。</li>
  <li><code>n</code>表示返回的文档数。</li>
  <li><code>nscannedObjects</code>表示扫描的文档总数。</li>
  <li><code>nscanned</code>表示扫描的文档或索引条目的总数。</li>
 </ul> 
 <h2 id="h2--hint"><a name="使用 $hint" class="reference-link"></a><span class="header-link octicon octicon-link"></span>使用 $hint</h2>
 <p><code>$hint</code>操作符强制查询优化器使用指定的索引来运行查询。当要测试具有不同索引的查询的性能时，这就特别有用了。 例如，以下查询指定要用于此查询的<code>gender</code>和<code>user_name</code>字段的索引 -</p>   
 <pre><code class="lang-shell">&gt; db.users.find({gender:"M"},{user_name:1,_id:0}).hint({gender:1,user_name:1})
</code></pre> 
 <p>要使用<code>$explain</code>来分析上述查询 -</p> 
 <pre><code class="lang-shell">&gt;db.users.find({gender:"M"},{user_name:1,_id:0}).hint({gender:1,user_name:1}).explain()
</code></pre>
 <br>      
</div></body></html>
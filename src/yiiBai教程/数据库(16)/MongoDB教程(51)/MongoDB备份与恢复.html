<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">MongoDB备份与恢复</h1><div style="width:100%;float:left;" class="article-content">   
 <p>本章将介绍如何在MongoDB中创建备份，以及如何恢复数据。</p> 
 <h2 id="h2--mongodb-"><a name="导出转储MongoDB数据" class="reference-link"></a><span class="header-link octicon octicon-link"></span>导出转储MongoDB数据</h2>
 <p>要在MongoDB中创建数据库备份，应该使用 <code>mongodump</code> 命令。 此命令将导出转储服务器的整个数据到转储目录。有许多选项可用于限制数据量或创建远程服务器的备份。</p> 
 <p><strong>语法</strong></p> 
 <p><code>mongodump</code>命令的基本语法如下：</p> 
 <pre><code class="lang-shell">&gt; mongodump
</code></pre> 
 <p><strong>示例</strong></p> 
 <p>启动 mongod 服务器 假设您的 mongod 服务器正在本地主机和端口 <code>27017</code> 上运行，请打开命令提示符并转到 mongodb 实例的 <code>bin</code> 目录(如示例安装路径：<code>D:\Program Files\MongoDB\Server\3.4\bin</code>)，然后键入命令：<code>mongodump</code></p> 
 <p>考虑 <code>mycol</code> 集合具有以下数据 - </p> 
 <pre><code class="lang-shell">&gt; db.mycol.find({}, {"_id":1, "title":1})
{ "_id" : 101, "title" : "MongoDB Guide" }
{ "_id" : 102, "title" : "NoSQL Database" }
{ "_id" : 104, "title" : "Python Quick Guide" }
{ "_id" : 100, "title" : "MongoDB Overview" }
&gt;
</code></pre> 
 <p>现在使用以下命令，创建备份 - </p> 
 <pre><code class="lang-shell">&gt; mongodump
</code></pre> 
 <p>该命令将连接到运行在 <code>127.0.0.1</code> 和端口 <code>27017</code> 的服务器，并将服务器的所有数据恢复到目录<code>/bin/dump/</code>。 以下是命令的输出 -</p> 
 <pre><code class="lang-shell">yiibai@ubuntu:~$ mongodump
2017-07-02T17:31:51.115-0700    writing admin.system.version to
2017-07-02T17:31:51.118-0700    done dumping admin.system.version (1 document)
2017-07-02T17:31:51.119-0700    writing test.inventory to
2017-07-02T17:31:51.119-0700    writing test.article to
2017-07-02T17:31:51.120-0700    writing test.mycol to
2017-07-02T17:31:51.121-0700    done dumping test.inventory (5 documents)
2017-07-02T17:31:51.122-0700    done dumping test.article (4 documents)
2017-07-02T17:31:51.122-0700    done dumping test.mycol (4 documents)
yiibai@ubuntu:~$
</code></pre> 
 <p>此时你可能想知道，上面导出的备份文件放到什么地方了？ 默认情况下，MongoDB 会在当前目录下创建一个 <code>dump</code> 目录，并把所有的数据库按数据库名称创建目录。在这个实例中，有两数据库 <code>admin</code> 和 <code>test</code>，那么它将创建两个目录。</p> 
 <p><strong>怎么样知道 MongoDB 文件的位置？</strong></p> 
 <p>对于大部分软件，尤其是 Linux平台上的软件，都有一个相关的配置文件，因此任何的设置选项都可以从这个文件中找到。配置文件的一般在 <code>/etc</code> 目录下，所以，mongodb 的配置文件在 <code>/etc/mongod.conf</code> ， <code>mongod.conf</code>配置的内容如下 - </p> 
 <pre><code class="lang-shell"># mongod.conf

# for documentation of all options, see:
#   http://docs.mongodb.org/manual/reference/configuration-options/

# Where and how to store data.
storage:
  dbPath: /var/lib/mongodb
  journal:
    enabled: true
#  engine:
#  mmapv1:
#  wiredTiger:

# where to write logging data.
systemLog:
  destination: file
  logAppend: true
  path: /var/log/mongodb/mongod.log

# network interfaces
net:
  port: 27017
  bindIp: 127.0.0.1

#processManagement:
#security:
#operationProfiling:
#replication:
#sharding:
## Enterprise-Only Options:
#auditLog:
#snmp:
</code></pre> 
 <p>以下是可用于 <code>mongodump</code> 命令的可用选项的列表。</p> 
 <table> 
  <thead> 
   <tr> 
    <th>语法</th> 
    <th>描述</th> 
    <th>示例</th> 
   </tr> 
  </thead> 
  <tbody> 
   <tr> 
    <td>mongodump —host HOST_NAME —port PORT_NUMBER</td> 
    <td>此命令将备份指定的 mongod 实例的所有数据库。</td> 
    <td><code>mongodump --host 127.0.0.1 --port 27017</code></td> 
   </tr> 
   <tr> 
    <td>mongodump —out BACKUP_DIRECTORY</td> 
    <td>此命令将仅在指定路径上备份数据库。</td> 
    <td><code>mongodump --out /home/yiibai/mongobak</code></td> 
   </tr> 
   <tr> 
    <td>mongodump —collection COLLECTION —db DB_NAME</td> 
    <td>此命令将仅备份指定数据库的指定集合。</td> 
    <td><code>mongodump --collection mycol --db test</code></td> 
   </tr> 
  </tbody> 
 </table> 
 <h2 id="h2-u6062u590Du6570u636E"><a name="恢复数据" class="reference-link"></a><span class="header-link octicon octicon-link"></span>恢复数据</h2>
 <p>要恢复备份数据，使用MongoDB的 <code>mongorestore</code> 命令。 此命令从备份目录中恢复所有数据。</p> 
 <p><strong>语法</strong></p> 
 <p><code>mongorestore</code>命令的基本语法是 -</p>   
 <pre><code class="lang-shell">&gt; mongorestore
</code></pre> 
 <p>在恢复数据之前，先删除当前数据库的部分数据，以演示导入恢复数据后可以查询到备份时的数据。</p> 
 <pre><code class="lang-shell">&gt; db.mycol.remove({})
WriteResult({ "nRemoved" : 4 })
&gt;
&gt; db.mycol.find({})
&gt;
&gt;
</code></pre> 
 <p>执行恢复命令后，重新查询数据 - </p> 
 <pre><code class="lang-shell">&gt; db.mycol.find({}, {"title":1})
{ "_id" : 101, "title" : "MongoDB Guide" }
{ "_id" : 102, "title" : "NoSQL Database" }
{ "_id" : 104, "title" : "Python Quick Guide" }
{ "_id" : 100, "title" : "MongoDB Overview" }
&gt;
</code></pre>
 <br>      
</div></body></html>
<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">MongoDB管理用户和角色</h1><div style="width:100%;float:left;" class="article-content">   
 <p>本教程提供了MongoDB授权模式下的用户和角色管理示例。学习如何向MongoDB添加新用户。</p> 
 <h2 id="h2-u521Bu5EFAu7528u6237u5B9Au4E49u7684u89D2u8272"><a name="创建用户定义的角色" class="reference-link"></a><span class="header-link octicon octicon-link"></span>创建用户定义的角色</h2>
 <p>角色授权用户访问MongoDB资源。 MongoDB提供了许多内置的角色，管理员可以使用它们来控制对MongoDB系统的访问。 但是，如果这些角色无法描述所需的权限集，则可以在特定数据库中创建新角色。</p> 
 <p>除了在管理数据库中创建的角色外，角色只能包含适用于其数据库的权限，并且只能继承其数据库中的其他角色。</p> 
 <p>在管理数据库中创建的角色可以包括适用于管理数据库，其他数据库或群集资源的权限，并且可以从其他数据库中的角色以及管理数据库继承。</p> 
 <p>要创建新角色，可使用<code>db.createRole()</code>方法，指定<code>permissions</code>数组中的权限和<code>roles</code>数组中的继承角色。</p> 
 <p>MongoDB使用数据库名称和角色名称的组合来唯一定义角色。 每个角色的范围限定在创建角色的数据库中，但MongoDB将所有角色信息存储在<code>admin</code>数据库的<code>admin.system.roles</code>集合中。</p> 
 <p><strong>先决条件</strong></p> 
 <p>要在数据库中创建角色，您必须具有：</p> 
 <ul> 
  <li>对该数据库资源的<code>createRole</code>操作。</li>
  <li>对该数据库的<code>grantRole</code>操作指定新角色的权限以及指定要继承的角色。</li>
 </ul> 
 <p>内置角色 <code>userAdmin</code> 和 <code>userAdminAnyDatabase</code> 在其各自的资源上提供 <code>createRole</code> 和 <code>grantRole</code> 操作。</p> 
 <h2 id="h2-u521Bu5EFAu89D2u8272u6765u7BA1u7406u5F53u524Du64CDu4F5C"><a name="创建角色来管理当前操作" class="reference-link"></a><span class="header-link octicon octicon-link"></span>创建角色来管理当前操作</h2>
 <p>以下示例创建一个名为 <code>manageOpRole</code> 的角色，该角色仅提供运行 <code>db.currentOp()</code>和<code>db.killOp()</code>的权限。</p> 
 <p><strong>第一步：使用相应的权限连接到MongoDB</strong></p> 
 <p>使用“<strong>先决条件</strong>”部分指定的权限连接到 <code>mongod</code> 或 <code>mongos</code> 。</p> 
 <p>以下过程使用在“启用认证”中创建的用户：<code>myUserAdmin</code>。</p> 
 <pre><code class="lang-shell">$ mongo --port 27017 -u "myUserAdmin" -p "abc123" --authenticationDatabase "admin"
</code></pre> 
 <p><code>myUserAdmin</code>具有在管理员以及其他数据库中创建角色的权限。</p> 
 <p><strong>第二步：创建一个新角色来管理当前操作</strong></p> 
 <p><code>manageOpRole</code>具有对多个数据库以及群集资源的权限。 因此，您必须在管理数据库中创建该角色。</p> 
 <pre><code class="lang-shell">use admin
db.createRole(
   {
     role: "manageOpRole",
     privileges: [
       { resource: { cluster: true }, actions: [ "killop", "inprog" ] },
       { resource: { db: "", collection: "" }, actions: [ "killCursors" ] }
     ],
     roles: []
   }
)
</code></pre> 
 <p>新角色授予杀死/终止任何操作的权限。</p> 
 <blockquote> 
  <p>警告: 终止运行操作非常小心。只能使用<code>db.killOp()</code>方法或<code>killOp</code>命令终止客户端发起的操作，并且不会终止内部数据库操作。</p> 
 </blockquote> 
 <h2 id="h2--mongostat"><a name="创建角色用来运行 mongostat" class="reference-link"></a><span class="header-link octicon octicon-link"></span>创建角色用来运行 mongostat</h2>
 <p>以下示例创建一个名为 <code>mongostatRole</code> 的角色，该角色仅提供运行 <code>mongostat</code> 的权限。</p> 
 <p><strong>第一步：使用相应的权限连接到MongoDB</strong></p> 
 <p>使用“<strong>先决条件</strong>”部分指定的权限连接到　<code>mongod</code>　或　<code>mongos</code>　。</p> 
 <p>以下过程使用在<a target="_blank" href="http://www.yiibai.com/mongodb/authentication.html" title="启用认证">启用认证</a>中创建的用户：<code>myUserAdmin</code>。</p> 
 <pre><code class="lang-shell">$ mongo --port 27017 -u "myUserAdmin" -p "abc123" --authenticationDatabase "admin"
</code></pre> 
 <p><code>myUserAdmin</code>具有在管理员以及其他数据库中创建角色的权限。</p> 
 <p><strong>第二步：创建一个新角色来管理当前的操作</strong></p> 
 <p><code>mongostatRole</code>具有作用于群集资源的权限。 因此，您必须在管理数据库中创建该角色。</p> 
 <pre><code class="lang-shell">use admin
db.createRole(
   {
     role: "mongostatRole",
     privileges: [
       { resource: { cluster: true }, actions: [ "serverStatus" ] }
     ],
     roles: []
   }
)
</code></pre> 
 <h2 id="h2-u4FEEu6539u73B0u6709u7528u6237u7684u8BBFu95EEu6743u9650"><a name="修改现有用户的访问权限" class="reference-link"></a><span class="header-link octicon octicon-link"></span>修改现有用户的访问权限</h2>
 <p><strong>先决条件</strong></p> 
 <ul> 
  <li>必须对数据库具有<code>grantRole</code>操作才能在该数据库上授予角色。</li>
  <li>必须在数据库上具有<code>revokeRole</code>操作以撤销该数据库上的角色。</li>
  <li>要查看角色的信息，必须明确授予该角色，或必须对该角色的数据库具有<code>viewRole</code>操作。</li>
 </ul> 
 <p><strong>执行步骤</strong></p> 
 <p><strong>第一步：使用相应的权限连接到MongoDB</strong></p> 
 <p>以具有先决条件部分中指定的权限的用户身份连接到 <code>mongod</code> 或 <code>mongos</code> 。</p> 
 <p>以下过程使用在<a target="_blank" href="http://www.yiibai.com/mongodb/authentication.html" title="启用认证">启用认证</a>中创建的用户：<code>myUserAdmin</code>。</p> 
 <pre><code class="lang-shell">$ mongo --port 27017 -u "myUserAdmin" -p "abc123" --authenticationDatabase "admin"
</code></pre> 
 <p><strong>第二步：识别用户的角色和权限</strong></p> 
 <p>要显示要修改的用户的角色和权限，请使用<code>db.getUser()</code>和<code>db.getRole()</code>方法。</p> 
 <p>例如，要查看在示例中创建的 <code>reportsUser</code> 的角色，执行以下命令：</p> 
 <pre><code class="lang-shell">use reporting
db.getUser("reportsUser")
</code></pre> 
 <p>要显示在 “<code>accounts</code>” 数据库上由 <code>readWrite</code> 角色授予用户的权限，请执行以下操作：</p> 
 <pre><code class="lang-shell">use accounts
db.getRole( "readWrite", { showPrivileges: true } )
</code></pre> 
 <p><strong>第三步：确定授予或撤销的权限</strong></p> 
 <p>如果用户需要额外的权限，则向用户授予具有所需权限集的角色或角色。 如果此类角色不存在，请使用适当的权限集创建新角色。</p> 
 <p>撤销由现有角色提供的特权子集：撤销原始角色并授予仅包含所需权限的角色。如果角色不存在，您需要创建新角色。</p> 
 <p><strong>第四步：修改用户的访问权限</strong></p> 
 <p>4.1. 撤销角色</p> 
 <p>使用<code>db.revokeRolesFromUser()</code>方法撤销角色。以下示例操作从<code>account</code>数据库上删除用户<code>reportsUser</code> 的 <code>readWrite</code> 角色：</p> 
 <pre><code class="lang-shell">use reporting
db.revokeRolesFromUser(
    "reportsUser",
    [
      { role: "readWrite", db: "accounts" }
    ]
)
</code></pre> 
 <p>4.2. 授予角色</p> 
 <p>使用<code>db.grantRolesToUser()</code>方法授予角色。 例如，以下操作授予<code>reportsUser</code>用户<code>account</code>数据库上的读取角色：</p> 
 <pre><code class="lang-shell">use reporting
db.grantRolesToUser(
    "reportsUser",
    [
      { role: "read", db: "accounts" }
    ]
)
</code></pre> 
 <p>对于分片集群，用户的更改将在命令运行的 <code>mongos</code> 上即时生效。但是，对于群集中的其他mongos 实例，用户缓存可能会等待<code>10</code>分钟才能刷新。请参阅<a target="_blank" href="http://docs.mongodb.com/manual/reference/parameters/#param.userCacheInvalidationIntervalSecs" title="userCacheInvalidationIntervalSecs">userCacheInvalidationIntervalSecs</a>。</p> 
 <h2 id="h2-u4FEEu6539u73B0u6709u7528u6237u7684u5BC6u7801"><a name="修改现有用户的密码" class="reference-link"></a><span class="header-link octicon octicon-link"></span>修改现有用户的密码</h2>
 <p><strong>先决条件</strong></p> 
 <p>要修改数据库上另一个用户的密码，您必须对该数据库具有<code>changeAnyPassword</code>操作。</p> 
 <p><strong>操作步骤：</strong></p> 
 <p><strong>第一步：使用相应的权限连接到MongoDB</strong></p> 
 <p>以具有先决条件部分中指定的权限的用户身份连接到 <code>mongod</code> 或 <code>mongos</code> 。</p> 
 <p>以下过程使用在<a target="_blank" href="http://www.yiibai.com/mongodb/authentication.html" title="启用认证">启用认证</a>中创建的用户：<code>myUserAdmin</code>。</p>   
 <pre><code class="lang-shell">$ mongo --port 27017 -u "myUserAdmin" -p "abc123" --authenticationDatabase "admin"
</code></pre> 
 <p><strong>第二步：更改密码</strong></p> 
 <p>将用户的用户名和新密码传递给<code>db.changeUserPassword()</code>方法。</p> 
 <p>以下操作将<code>reporting</code>用户的密码更改为：<code>SOh3TbYhxuLiW8ypJPxmt1oOfL</code>：</p> 
 <pre><code class="lang-shell">db.changeUserPassword("reporting", "SOh3TbYhxuLiW8ypJPxmt1oOfL")
</code></pre> 
 <h2 id="h2-u67E5u770Bu7528u6237u7684u89D2u8272"><a name="查看用户的角色" class="reference-link"></a><span class="header-link octicon octicon-link"></span>查看用户的角色</h2>
 <p><strong>先决条件</strong></p> 
 <p>要查看其他用户的信息，您必须对其他用户的数据库具有<code>viewUser</code>操作。</p> 
 <p>用户可以查看自己的信息。</p> 
 <p><strong>第一步：使用相应的权限连接到MongoDB</strong></p> 
 <p>以具有先决条件部分中指定的权限的用户身份连接到 <code>mongod</code> 或 <code>mongos</code> 。</p> 
 <p>以下过程使用在<a target="_blank" href="http://www.yiibai.com/mongodb/authentication.html" title="启用认证">启用认证</a>中创建的用户：<code>myUserAdmin</code>。</p> 
 <pre><code class="lang-shell">$ mongo --port 27017 -u "myUserAdmin" -p "abc123" --authenticationDatabase "admin"
</code></pre> 
 <p><strong>第二步：查看用户的角色</strong></p> 
 <p>使用<code>usersInfo</code>命令或<code>db.getUser()</code>方法显示用户信息。</p> 
 <p>例如，要查看在示例中创建的 <code>reportsUser</code> 的角色，请发出：</p> 
 <pre><code class="lang-shell">use reporting
db.getUser("reportsUser")
</code></pre> 
 <p>在返回的文档中，<code>roles</code>字段显示<code>reportsUser</code>的所有角色：</p> 
 <pre><code class="lang-shell">...
"roles" : [
   { "role" : "readWrite", "db" : "accounts" },
   { "role" : "read", "db" : "reporting" },
   { "role" : "read", "db" : "products" },
   { "role" : "read", "db" : "sales" }
]
</code></pre> 
 <h2 id="h2-u67E5u770Bu89D2u8272u7684u6743u9650"><a name="查看角色的权限" class="reference-link"></a><span class="header-link octicon octicon-link"></span>查看角色的权限</h2>
 <p><strong>先决条件</strong></p> 
 <p>要查看角色的信息，您必须明确授予该角色，或必须对该角色的数据库具有 <code>viewRole</code> 操作。</p> 
 <p><strong>第一步：使用相应的权限连接到MongoDB</strong></p> 
 <p>以具有先决条件部分中指定的权限的用户身份连接到 <code>mongod</code> 或 <code>mongos</code> 。</p> 
 <p>以下过程使用在<a target="_blank" href="http://www.yiibai.com/mongodb/authentication.html" title="启用认证">启用认证</a>中创建的用户：<code>myUserAdmin</code>。</p> 
 <pre><code class="lang-shell">$ mongo --port 27017 -u "myUserAdmin" -p "abc123" --authenticationDatabase "admin"
</code></pre> 
 <p><strong>第二步：查看角色授予的权限</strong></p> 
 <p>对于给定的角色，请使用<code>db.getRole()</code>方法或<code>rolesInfo</code>命令与<code>showPrivileges</code>选项一起执行：</p> 
 <p>例如，要查看在<code>product</code>数据库上由读取角色授予的权限，请使用以下操作，问题如下：</p> 
 <pre><code class="lang-shell">use products
db.getRole( "read", { showPrivileges: true } )
</code></pre> 
 <p>在返回的文档中，有两个数组：<code>privileges</code>和<code>inheritedPrivileges</code>。权限列出了角色指定的权限，并排除了从其他角色继承的权限。 <code>inheritedPrivileges</code>列出了由此角色授予的所有权限，这两个角色都是直接指定的并被继承。 如果该角色不能从其他角色继承，则两个字段是相同的。</p> 
 <pre><code class="lang-shell">...
"privileges" : [
  {
    "resource": { "db" : "products", "collection" : "" },
    "actions": [ "collStats","dbHash","dbStats","find","killCursors","planCacheRead" ]
  },
  {
    "resource" : { "db" : "products", "collection" : "system.js" },
    "actions": [ "collStats","dbHash","dbStats","find","killCursors","planCacheRead" ]
  }
],
"inheritedPrivileges" : [
  {
    "resource": { "db" : "products", "collection" : "" },
    "actions": [ "collStats","dbHash","dbStats","find","killCursors","planCacheRead" ]
  },
  {
    "resource" : { "db" : "products", "collection" : "system.js" },
    "actions": [ "collStats","dbHash","dbStats","find","killCursors","planCacheRead" ]
  }
]
</code></pre>
 <br>      
</div></body></html>
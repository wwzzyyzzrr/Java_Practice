<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">MongoDB复制</h1><div style="width:100%;float:left;" class="article-content">   
 <p>复制是跨多个服务器同步数据的过程。复制提供冗余，并通过不同数据库服务器上的多个数据副本增加数据可用性。 复制保护数据库免受单个服务器的丢失。 复制还允许从硬件故障和服务中断中恢复。 使用其他数据副本，可以将其专用于灾难恢复，报告或备份。</p> 
 <h2 id="h2--"><a name="为什么复制？" class="reference-link"></a><span class="header-link octicon octicon-link"></span>为什么复制？</h2>
 <ul> 
  <li>保持数据安全</li>
  <li>数据的高可用性(24 * 7)</li>
  <li>灾难恢复</li>
  <li>维护无停机(如备份，索引重建，压缩)</li>
  <li>读取缩放(额外的副本可读)</li>
  <li>副本集对应用程序是透明的</li>
 </ul> 
 <h2 id="h2-mongodb-"><a name="MongoDB复制的工作原理" class="reference-link"></a><span class="header-link octicon octicon-link"></span>MongoDB复制的工作原理</h2>
 <p>MongoDB通过使用副本集来实现复制。副本集是托管相同数据集的一组 mongod 实例。 在一个副本中，一个节点是接收所有写操作的主节点。所有其他实例(例如辅助节点)都应用主节点的操作，以便它们具有相同的数据集。 副本集可以只有一个主节点。</p> 
 <ul> 
  <li>副本集是一组两个或多个节点(通常最少需要<code>3</code>个节点)。</li>
  <li>在副本集中，一个节点是主节点，其余节点是次要节点。</li>
  <li>所有数据从主节点复制到辅助节点。</li>
  <li>在自动故障切换或维护时，选择为主节点建立，并选择新的主节点。</li>
  <li>恢复故障节点后，它再次加入副本集，并作为辅助节点。</li>
 </ul> 
 <p>显示了MongoDB复制的典型图，客户端应用程序始终与主节点进行交互，然后主节点将数据复制到辅助节点。</p> 
 <p><img src="http://www.yiibai.com/uploads/images/201707/0107/806150750_63835.png" alt=""></p> 
 <h2 id="h2-u526Fu672Cu96C6u529Fu80FD"><a name="副本集功能" class="reference-link"></a><span class="header-link octicon octicon-link"></span>副本集功能</h2>
 <ul> 
  <li><code>N</code>个节点的集群</li>
  <li>任何一个节点都可以是主节点</li>
  <li>所有写入操作都转到主节点操作</li>
  <li>自动故障切换</li>
  <li>自动恢复</li>
  <li>共识一般选举</li>
 </ul> 
 <h2 id="h2-u8BBEu7F6Eu526Fu672Cu96C6"><a name="设置副本集" class="reference-link"></a><span class="header-link octicon octicon-link"></span>设置副本集</h2>
 <p>在本教程中，我们将独立的 MongoDB 实例转换为副本集。要转换为副本集，以下是步骤 -</p> 
 <ul> 
  <li>关机正在运行 MongoDB 服务器。</li>
  <li>通过指定 - <code>replSet</code>选项启动 MongoDB服 务器。 以下是<code>--replSet</code>的基本语法 -</li>
 </ul> 
 <pre><code class="lang-shell">mongod --port "PORT" --dbpath "YOUR_DB_DATA_PATH" --replSet "REPLICA_SET_INSTANCE_NAME"
</code></pre> 
 <p><strong>示例</strong></p> 
 <pre><code class="lang-shell">mongod --port 27017 --dbpath "D:\set up\mongodb\data" --replSet rs0
</code></pre> 
 <ul> 
  <li>它在端口<code>27017</code>上启动名称为<code>rs0</code>的 mongod 实例。</li>
  <li>现在启动命令提示符并连接到这个 mongod 实例。</li>
  <li>在Mongo客户端中，发出命令<code>rs.initiate()</code>以启动新的副本集。</li>
  <li>要检查副本集配置，可使用命令<code>rs.conf()</code>。 要检查复制集的状态，请使用命令<code>rs.status()</code>。</li>
 </ul> 
 <h2 id="h2-u5C06u4F1Au5458u6DFBu52A0u5230u526Fu672Cu96C6"><a name="将会员添加到副本集" class="reference-link"></a><span class="header-link octicon octicon-link"></span>将会员添加到副本集</h2>
 <p>要将成员添加到副本集，请在多台计算机上启动 mongod 实例。 现在启动一个 mongo 客户端并发出一个命令<code>rs.add()</code>。</p> 
 <p><strong>语法</strong></p> 
 <p><code>rs.add()</code>命令的基本语法如下：</p>   
 <pre><code class="lang-shell">&gt;rs.add(HOST_NAME:PORT)
</code></pre> 
 <p><strong>示例</strong></p> 
 <p>假设您的 mongod 实例名称是 <code>mongod1.net</code>，它在端口 <code>27017</code> 上运行。要将此实例添加到副本集，请在 Mongo 客户端中发出命令 <code>rs.add()</code>。</p> 
 <pre><code class="lang-shell">&gt;rs.add("mongod1.net:27017")
&gt;
</code></pre> 
 <p>只能在连接到主节点时，将 mongod 实例添加到副本集。要检查是否连接到主服务器，请在 mongo 客户端中发出命令<code>db.isMaster()</code>。</p> 
 <pre><code class="lang-shell">rs0:PRIMARY&gt; db.isMaster()
{
        "hosts" : [
                "ubuntu:27017"
        ],
        "setName" : "rs0",
        "setVersion" : 1,
        "ismaster" : true,
        "secondary" : false,
        "primary" : "ubuntu:27017",
        "me" : "ubuntu:27017",
        "electionId" : ObjectId("7fffffff0000000000000001"),
        "lastWrite" : {
                "opTime" : {
                        "ts" : Timestamp(1498896581, 1),
                        "t" : NumberLong(1)
                },
                "lastWriteDate" : ISODate("2017-07-01T08:09:41Z")
        },
        "maxBsonObjectSize" : 16777216,
        "maxMessageSizeBytes" : 48000000,
        "maxWriteBatchSize" : 1000,
        "localTime" : ISODate("2017-07-01T08:09:50.365Z"),
        "maxWireVersion" : 5,
        "minWireVersion" : 0,
        "readOnly" : false,
        "ok" : 1
}
rs0:PRIMARY&gt;
</code></pre>
 <br>      
</div></body></html>
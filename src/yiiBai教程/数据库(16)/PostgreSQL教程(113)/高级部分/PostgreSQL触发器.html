<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">PostgreSQL触发器</h1><div style="width:100%;float:left;" class="article-content">   
 <p>PostgreSQL触发器是一组动作或数据库回调函数，它们在指定的表上执行指定的数据库事件(即，<code>INSERT</code>，<code>UPDATE</code>，<code>DELETE</code>或<code>TRUNCATE</code>语句)时自动运行。 触发器用于验证输入数据，执行业务规则，保持审计跟踪等。</p> 
 <h2 id="h2-u89E6u53D1u5668u7684u91CDu70B9u77E5u8BC6"><a name="触发器的重点知识" class="reference-link"></a><span class="header-link octicon octicon-link"></span>触发器的重点知识</h2>
 <ol> 
  <li><p>PostgreSQL在以下情况下执行/调用触发器：在尝试操作之前(在检查约束并尝试<code>INSERT</code>，<code>UPDATE</code>或<code>DELETE</code>之前)。或者在操作完成后(在检查约束并且<code>INSERT</code>，<code>UPDATE</code>或<code>DELETE</code>完成后)。或者不是操作(在视图中<code>INSERT</code>，<code>UPDATE</code>或<code>DELETE</code>的情况下)</p> </li>
  <li><p>对于操作修改的每一行，都会调用一个标记为<code>FOR EACH ROWS</code>的触发器。 另一方面，标记为<code>FOR EACH STATEMENT</code>的触发器只对任何给定的操作执行一次，而不管它修改多少行。</p> </li>
  <li><p>您可以为同一事件定义同一类型的多个触发器，但条件是按名称按字母顺序触发。</p> </li>
  <li>当与它们相关联的表被删除时，触发器被自动删除。</li>
 </ol> 
 <h2 id="h2-postgresql-"><a name="PostgreSQL创建触发器" class="reference-link"></a><span class="header-link octicon octicon-link"></span>PostgreSQL创建触发器</h2>
 <p><code>CREATE TRIGGER</code>语句用于在PostgreSQL表中创建一个新的触发器。 当表发生特定事件(即<code>INSERT</code>，<code>UPDATE</code>和<code>DELETE</code>)时，它被激活。</p> 
 <p><strong>语法</strong></p> 
 <pre><code class="lang-sql">CREATE  TRIGGER trigger_name [BEFORE|AFTER|INSTEAD OF] event_name  
ON table_name  
[  
 -- Trigger logic goes here....  
];
</code></pre> 
 <p>在这里，<code>event_name</code>可以是<code>INSERT</code>，<code>UPDATE</code>，<code>DELETE</code>和<code>TRUNCATE</code>数据库操作上提到的表<code>table_name</code>。 您可以选择在表名后指定<code>FOR EACH ROW</code>。</p> 
 <p>下面来看看看如何在<code>INSERT</code>操作中创建触发器的语法。</p> 
 <pre><code class="lang-sql">CREATE  TRIGGER trigger_name AFTER INSERT ON column_name  
ON table_name  
[  
 -- Trigger logic goes here....  
];
</code></pre> 
 <h2 id="h2-u89E6u53D1u5668u4F8Bu5B50"><a name="触发器例子" class="reference-link"></a><span class="header-link octicon octicon-link"></span>触发器例子</h2>
 <p>下面举个例子来演示PostgreSQL在<code>INSERT</code>语句之后创建触发器。在以下示例中，我们对每个记录插入到<code>COMPANY</code>表中进行审核(审计)。</p> 
 <p>使用以下查询创建一个名为<code>COMPANY</code>的表：</p> 
 <pre><code class="lang-sql">CREATE TABLE COMPANY(  
   ID INT PRIMARY KEY     NOT NULL,  
   NAME           TEXT    NOT NULL,  
   AGE            INT     NOT NULL,  
   ADDRESS        CHAR(50),  
   SALARY         REAL  
);
</code></pre> 
 <p>为了保存审计/审核，我们将创建一个名为<code>AUDIT</code>的新表，只要在<code>COMPANY</code>表中有一个新记录的条目，就会插入日志消息。</p> 
 <p>使用以下查询语句创建另一个表<code>Audit</code>：</p> 
 <pre><code class="lang-sql">CREATE TABLE AUDIT(  
    EMP_ID INT NOT NULL,  
    ENTRY_DATE TEXT NOT NULL  
);
</code></pre> 
 <p>在<code>COMPANY</code>表上创建触发器之前，首先创建一个名为<code>auditlogfunc()</code>的函数/过程。</p> 
 <p>执行以下查询语句来创建函数/过程：</p> 
 <pre><code class="lang-sql">CREATE OR REPLACE FUNCTION auditlogfunc() RETURNS TRIGGER AS $example_table$  
    BEGIN  
        INSERT INTO AUDIT(EMP_ID, ENTRY_DATE) VALUES (new.ID, current_timestamp);  
        RETURN NEW;   
    END;  
$example_table$ LANGUAGE plpgsql;
</code></pre> 
 <p>执行结果如下所示-</p> 
 <p><img src="http://www.yiibai.com/uploads/images/201704/1004/326160443_52826.png" alt=""></p> 
 <p>现在通过使用以下查询语句在<code>COMPANY</code>表上创建一个触发器：</p>   
 <pre><code class="lang-sql">CREATE TRIGGER example_trigger AFTER INSERT ON COMPANY  
FOR EACH ROW EXECUTE PROCEDURE auditlogfunc();
</code></pre> 
 <p>执行结果如下所示-<br><img src="http://www.yiibai.com/uploads/images/201704/1004/605160446_42975.png" alt=""></p> 
 <p>向<code>COMPANY</code>表中插入一些数据记录，以验证触发器执行情况。</p> 
 <pre><code class="lang-sql">INSERT INTO COMPANY VALUES(1, '小米科技', 8, '北京市朝阳区', 9999);
INSERT INTO COMPANY VALUES(2, '京东中科', 6, '广州市天河区', 8999);
</code></pre> 
 <p>在执行上面两条插入语句后，现我们来看<code>AUDIT</code>表是否有自动插入两条审核记录。</p> 
 <p><img src="http://www.yiibai.com/uploads/images/201704/1004/485160454_54838.png" alt=""></p> 
 <p>可以确定的是在插入数据后触发了触发器，PostgreSQL也自动向<code>AUDIT</code>表中创建/插入两个记录。 这些记录是触发的结果，这是因为我们在<code>AFTER INSERT on COMPANY</code>表上创建了这些记录。</p> 
 <h2 id="h2-postgresql-"><a name="PostgreSQL触发器的使用" class="reference-link"></a><span class="header-link octicon octicon-link"></span>PostgreSQL触发器的使用</h2>
 <p>PostgreSQL触发器可用于以下目的：</p> 
 <ul> 
  <li>验证输入数据。</li>
  <li>执行业务规则。</li>
  <li>为不同文件中新插入的行生成唯一值。</li>
  <li>写入其他文件以进行审计跟踪。</li>
  <li>从其他文件查询交叉引用目的。</li>
  <li>访问系统函数。</li>
  <li>将数据复制到不同的文件以实现数据一致性。</li>
 </ul> 
 <h2 id="h2-u4F7Fu7528u89E6u53D1u5668u7684u4F18u70B9"><a name="使用触发器的优点" class="reference-link"></a><span class="header-link octicon octicon-link"></span>使用触发器的优点</h2>
 <ul> 
  <li>它提高了应用程序的开发速度。 因为数据库存储触发器，所以您不必将触发器操作编码到每个数据库应用程序中。</li>
  <li>全局执法业务规则。定义触发器一次，然后将其重用于使用数据库的任何应用程序。</li>
  <li>更容易维护 如果业务策略发生变化，则只需更改相应的触发程序，而不是每个应用程序。</li>
  <li>提高客户/服务器环境的性能。 所有规则在结果返回之前在服务器中运行。</li>
 </ul>
 <br>      
</div></body></html>
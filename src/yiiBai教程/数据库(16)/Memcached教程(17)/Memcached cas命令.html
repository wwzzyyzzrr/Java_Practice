<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Memcached cas命令</h1><div style="width:100%;float:left;" class="article-content">   
 <p> Memcached 的 cas 命令用于设置数据，如果自上一次获取没有人更新。如果该键不在memcached中，那么它返回NOT_FOUND。</p> 
 <h2> 语法</h2> 
 <p> memcached的cas命令的基本语法如下所示：</p> 
 <pre class="prettyprint prettyprinted" style="box-sizing: border-box; Menlo, Monaco, Consolas, 'Courier New', monospace; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; width: 603.767395019531px; line-height: 16px; font-size: 12px; overflow: auto; color: rgb(49, 49, 49);">
<span class="pln" style="box-sizing: border-box; color: rgb(0, 0, 0);">set key flags exptime bytes unique_cas_key [noreply]</span>
<span class="pln" style="box-sizing: border-box; color: rgb(0, 0, 0);">value</span></pre> 
 <p> 以上关键字的含义，如下图所示：</p> 
 <ul> 
  <li> <p> <strong>key</strong>&nbsp;是通过被存储在Memcached的数据并从memcached获取键(key)的名称。</p> </li> 
  <li> <p> <strong>flags</strong>&nbsp;是32位无符号整数，该项目被检索时用的数据(由用户提供)，并沿数据返回服务器存储。</p> </li> 
  <li> <p> <strong>exptime</strong>&nbsp;以秒过期时间，0表示没有延迟，如果exptime大于30天，Memcached将使用它作为UNIX时间戳过期。</p> </li> 
  <li> <p> <strong>bytes</strong>&nbsp;是在数据块中，需要被存储的字节数。基本上，这是一个需要存储在memcached的数据的长度。</p> </li> 
  <li> <strong>unique_cas_key</strong>&nbsp;从gets命令的获得唯一键。</li> 
  <li> <p> <strong>noreply</strong> (optional)&nbsp;参数告知服务器不发送回复</p> </li> 
  <li> <p> <strong>value</strong>&nbsp;是一个需要存储的数据。数据需要将通过在新的一行后，执行命令上述选项。</p> </li> 
 </ul> 
 <h3> 输出</h3> 
 <p> 上述命令的输出如下所示：</p> 
 <pre class="result prettyprinted" style="box-sizing: border-box; Menlo, Monaco, Consolas, 'Courier New', monospace; margin-bottom: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; width: 603.767395019531px; font-size: 12px; overflow: auto; color: rgb(49, 49, 49); line-height: 22px; background-color: rgb(241, 241, 241);">
STORED</pre> 
 <ul> 
  <li> <p> <strong><em>STORED</em></strong>&nbsp;表示成功。</p> </li> 
  <li> <p> <strong><em>ERROR&nbsp;</em></strong>以表明有问题，同时保存数据或错误的语法。</p> </li> 
  <li> <p> <em><strong>EXISTS&nbsp;</strong></em>以表明自上一次获取起已有人修改了CAS数据。</p> </li> 
  <li> <p> <strong><em>EXISTS&nbsp;</em></strong>以表示该键不存在于memcached服务器。</p> </li> 
 </ul> 
 <h3> 示例</h3> 
 <p> 要运行memcached的cas命令，需要从gets命令得到memcached令牌。</p> 
 <pre class="prettyprint prettyprinted" style="box-sizing: border-box; Menlo, Monaco, Consolas, 'Courier New', monospace; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; width: 603.767395019531px; line-height: 16px; font-size: 12px; overflow: auto; color: rgb(49, 49, 49);">
cas tp 0 900 9
ERROR
cas tp 0 900 9 2
memcached
set tp 0 900 9
memcached
STORED
gets tp
VALUE tp 0 9 1
memcached
END
cas tp 0 900 5 2
redis
EXISTS
cas tp 0 900 5 1
redis
STORED
get tp
VALUE tp 0 5
redis
END</pre> 
 <h2> 使用Java应用CAS</h2> 
 <p> 若要从 memcached 服务器取cas数据，需要使用memcached的gets得到。</p> 
 <h3> 示例</h3>   
 <pre class="prettyprint prettyprinted" style="box-sizing: border-box; Menlo, Monaco, Consolas, 'Courier New', monospace; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; width: 603.767395019531px; line-height: 16px; font-size: 12px; overflow: auto; color: rgb(49, 49, 49);">
import net.spy.memcached.MemcachedClient;
public class MemcachedJava {
   public static void main(String[] args) {
      //Connecting to Memcached server on localhost
      MemcachedClient mcc = new MemcachedClient(new InetSocketAddress("127.0.0.1", 11211));
      System.out.println("Connection to server sucessfully");
      System.out.println("set status:"+mcc.set("yiibai", 900, "memcached").isDone());
      //Get cas token from cache
      long castToken = mcc.gets("yiibai").cas;
      System.out.println("Cas token:"+castToken);
      // now set new data in memcached server
      System.out.println("Now set new data:"+mcc.cas("yiibai", castToken, 900, "redis"));
      System.out.println("Get from Cache:"+mcc.get("yiibai"));
   }
}</pre> 
 <h3> 输出</h3> 
 <p> 当上述程序编译和运行，它提供了以下的输出：</p> 
 <pre class="result prettyprinted" style="box-sizing: border-box; Menlo, Monaco, Consolas, 'Courier New', monospace; margin-bottom: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; width: 603.767395019531px; font-size: 12px; overflow: auto; color: rgb(49, 49, 49); line-height: 22px; background-color: rgb(241, 241, 241);">
Connection to server successfully
set status:true
Cas token:3
Now set new data:OK
Get from Cache:redis</pre> 
 <br>      
</div></body></html>
<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">ASP.NET Web Services</h1><div style="width:100%;float:left;" class="article-content">   
 <p>Web服务是一种基于Web的功能，可以使用Web应用程序使用的Web协议进行访问。Web服务开发有三个方面：</p> 
 <ul> 
  <li>创建Web服务</li>
  <li>创建一个代理</li>
  <li>使用Web服务</li>
 </ul> 
 <h2 id="h2--web-"><a name="创建一个Web服务" class="reference-link"></a><span class="header-link octicon octicon-link"></span>创建一个Web服务</h2>
 <p>Web服务是一个Web应用程序，它基本上是由其他应用程序可以使用的方法组成的类。它也遵循一个代码隐藏的体系结构，如ASP.NET网页，尽管它没有用户界面。</p> 
 <p>为了理解这个概念，创建一个Web服务来提供股票价格信息。客户可以根据股票代码查询股票的名称和价格。 为了保持这个例子简单，股票的信息被硬编码在一个二维数组中。 这个Web服务有三种方法：</p> 
 <ul> 
  <li>默认的<code>HelloWorld</code>方法</li>
  <li><code>GetName</code>方法用于获取股票的名称</li>
  <li><code>GetPrice</code>方法用于获取股票的价格</li>
 </ul> 
 <p>按照以下步骤创建Web服务：</p> 
 <p><strong>第1步：</strong> 在Visual Studio中选择菜单：<em>文件</em> -&gt; <em>新建</em> -&gt; <em>网站</em>，然后选择<em>ASP.NET空网站</em>，输入项目名称为：<em>WebServices</em> 。</p> 
 <p><strong>第2步：</strong> 在项目上右击选择<em>“添加新建项目”</em> -&gt;<em>Web</em> -&gt; <em>Web服务</em>。在项目的<code>App_Code</code>目录中创建名为<code>Service.asmx</code>的Web服务文件及其代码，文件<code>Service.cs</code>。</p> 
 <p><strong>第3步：</strong> 将上面两个文件的名称更改为<code>StockService.asmx</code>和<code>StockService.cs</code>。</p> 
 <p><strong>第4步：</strong> <code>.asmx</code>文件只有一个<code>WebService</code>指令：</p> 
 <pre><code class="lang-aspnet">&lt;%@ WebService Language="C#" CodeBehind="~/App_Code/StockService.cs" Class="StockService" %&gt;
</code></pre> 
 <p><strong>第5步：</strong> 打开<code>StockService.cs</code>文件，其中生成的代码是基本的<code>Hello World</code>服务。 默认的Web服务代码隐藏文件如下所示：</p> 
 <pre><code class="lang-csharp">using System;
using System.Collections;
using System.ComponentModel;
using System.Data;
using System.Linq;

using System.Web;
using System.Web.Services;
using System.Web.Services.Protocols;

using System.Xml.Linq;

namespace StockService
{
   // &lt;summary&gt;
   // Summary description for Service1
   // &lt;summary&gt;

   [WebService(Namespace = "http://tempuri.org/")]
   [WebServiceBinding(ConformsTo = WsiProfiles.BasicProfile1_1)]
   [ToolboxItem(false)]

   // To allow this Web Service to be called from script, 
   // using ASP.NET AJAX, uncomment the following line. 
   // [System.Web.Script.Services.ScriptService]

   public class Service1 : System.Web.Services.WebService
   {
      [WebMethod]

      public string HelloWorld()
      {
         return "Hello World";
      }
   }
}
</code></pre> 
 <p><strong>第6步：</strong> 更改文件后面的代码，为股票代码，名称和价格添加字符串的二维数组，获取股票信息。</p> 
 <pre><code class="lang-csharp">using System;
using System.Linq;

using System.Web;
using System.Web.Services;
using System.Web.Services.Protocols;

using System.Xml.Linq;

[WebService(Namespace = "http://tempuri.org/")]
[WebServiceBinding(ConformsTo = WsiProfiles.BasicProfile1_1)]

// To allow this Web Service to be called from script, 
// using ASP.NET AJAX, uncomment the following line. 
// [System.Web.Script.Services.ScriptService]

public class StockService : System.Web.Services.WebService
{
    public StockService()
    {
        //Uncomment the following if using designed components 
        //InitializeComponent(); 
    }

    string[,] stocks =
    {
      {"RELIND", "Reliance Industries", "1060.15"},
      {"ICICI", "ICICI Bank", "911.55"},
      {"JSW", "JSW Steel", "1201.25"},
      {"WIPRO", "Wipro Limited", "1194.65"},
      {"SATYAM", "Satyam Computers", "91.10"}
   };

    [WebMethod]
    public string HelloWorld()
    {
        return "Hello World";
    }

    [WebMethod]
    public double GetPrice(string symbol)
    {
        //it takes the symbol as parameter and returns price
        for (int i = 0; i &lt; stocks.GetLength(0); i++)
        {
            if (String.Compare(symbol, stocks[i, 0], true) == 0)
                return Convert.ToDouble(stocks[i, 2]);
        }

        return 0;
    }

    [WebMethod]
    public string GetName(string symbol)
    {
        // It takes the symbol as parameter and 
        // returns name of the stock
        for (int i = 0; i &lt; stocks.GetLength(0); i++)
        {
            if (String.Compare(symbol, stocks[i, 0], true) == 0)
                return stocks[i, 1];
        }

        return "Stock Not Found";
    }
}
</code></pre> 
 <p><strong>第7步：</strong> 运行Web服务应用程序给出Web服务测试页面，其允许测试服务方法。如下图所示 - </p> 
 <p><img src="http://www.yiibai.com/uploads/images/201712/1012/466111233_88709.png" alt=""></p> 
 <p><strong>第8步：</strong> 点击方法名称，检查是否正常运行。例如，点击：<em>GetName</em> 方法 - </p> 
 <p><img src="http://www.yiibai.com/uploads/images/201712/1012/852111234_59962.png" alt=""></p> 
 <p><strong>第9步：</strong> 要测试<code>GetName</code>方法，提供一个股票代码(这里输入：<code>JSW</code>并点击<em>调用</em>)，它是硬编码的，它返回股票的名称 - </p> 
 <p><img src="http://www.yiibai.com/uploads/images/201712/1012/202111236_89834.png" alt=""></p> 
 <h2 id="h2--web-"><a name="使用Web服务" class="reference-link"></a><span class="header-link octicon octicon-link"></span>使用Web服务</h2>
 <p>要使用Web服务，请在同一解决方案下创建一个Web站点，名称为：<em>WebServiceCall</em> 。 这可以通过右键单击解决方案资源管理器中的解决方案名称来完成。 调用Web服务的网页应该有一个标签控件来显示返回的结果和一个用于调用服务的按钮。</p> 
 <p>Web应用程序(<em>Default.aspx</em>)的内容文件如下所示：</p>   
 <pre><code class="lang-aspnet">
&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;
&lt;head runat="server"&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"/&gt;
    &lt;title&gt;WebServices调用示例&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;form id="form1" runat="server"&gt;
        &lt;div&gt;

            &lt;h3&gt;使用股票Web服务的示例&lt;/h3&gt;

            &lt;br /&gt; &lt;br /&gt;

            &lt;asp:Label ID="lblmessage" runat="server"&gt;&lt;/asp:Label&gt;

            &lt;br /&gt; &lt;br /&gt;
            &lt;asp:Button ID="btnservice" runat="server" onclick="btnservice_Click"  Text="获得股票信息" style="width:99px" /&gt;

         &lt;/div&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre> 
 <p>Web应用程序的文件(<em>Default.aspx.cs</em>)的后端代码如下所示：</p> 
 <pre><code class="lang-csharp">using System;
using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;

using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;

using System.Xml.Linq;

//this is the proxy
using localhost;


public partial class _Default : System.Web.UI.Page
{

    protected void Page_Load(object sender, EventArgs e)
    {
        if (!IsPostBack)
        {
            lblmessage.Text = "第一次加载时间: " + DateTime.Now.ToLongTimeString();
         }
        else
        {
            lblmessage.Text = "回传时间: " + DateTime.Now.ToLongTimeString();
        }
    }

    protected void btnservice_Click(object sender, EventArgs e)
    {
        StockService proxy = new StockService();
        lblmessage.Text = String.Format("当前SATYAM股票的价格:{0}",
        proxy.GetPrice("SATYAM").ToString());
    }
}
</code></pre> 
 <h2 id="h2-u521Bu5EFAu4EE3u7406"><a name="创建代理" class="reference-link"></a><span class="header-link octicon octicon-link"></span>创建代理</h2>
 <p>代理是Web服务代码的替代品。在使用Web服务之前，必须创建代理。 代理向客户端应用程序注册。然后，客户端应用程序使用本地方法调用Web服务。</p> 
 <p>代理接受调用，以适当的格式包装它，并将其作为SOAP请求发送到服务器。SOAP代表简单对象访问协议。该协议用于交换Web服务数据。</p> 
 <p>当服务器将SOAP包返回给客户端时，代理解码所有内容并将其呈现给客户端应用程序。</p> 
 <p>在使用<code>btnservice_Click</code>调用Web服务之前，应该将Web引用添加到应用程序中。 这会透明地创建一个代理类，由<code>btnservice_Click</code>事件使用。</p> 
 <p>按照以下步骤创建代理：</p> 
 <p><strong>第1步：</strong> 右键单击解决方案资源管理器中的Web应用程序条目，然后单击<em>添加服务引用</em>，然后选择<em>高级</em>。</p> 
 <p><strong>第2步：</strong> 选择“此解决方案中的Web服务”。它返回<em>StockService</em> 引用。</p> 
 <p><img src="http://www.yiibai.com/uploads/images/201712/1012/126121259_65655.gif" alt=""></p> 
 <p><strong>第3步：</strong> 点击服务打开测试网页。 默认情况下，创建的代理名称为<code>localhost</code>，也可以重命名它。点击“添加引用”将代理添加到客户端应用程序。</p> 
 <p>在代码后面的代码中加入代理，方法是：</p> 
 <pre><code class="lang-shell">using localhost;
</code></pre> 
 <p>运行<em>WebServiceCall</em> 项目，得到以下结果 - </p> 
 <p><img src="http://www.yiibai.com/uploads/images/201712/1012/326121247_92824.png" alt=""></p> 
 <p>点击<em>获取股票价格</em> 按钮，得到以下结果 - </p> 
 <p><img src="http://www.yiibai.com/uploads/images/201712/1012/747121248_18184.png" alt=""></p>
 <br>      
</div></body></html>
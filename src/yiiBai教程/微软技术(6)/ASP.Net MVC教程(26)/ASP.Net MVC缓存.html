<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">ASP.Net MVC缓存</h1><div style="width:100%;float:left;" class="article-content">   
 <p>在本章中，我们将重点介绍最常用的ASP.NET技术之一：<strong>缓存</strong>，以提高应用程序的性能。 在内存中存储经常使用的内容以提供更好的性能。我们将看到如何通过利用输出缓存来显着提高ASP.NET MVC应用程序的性能。</p> 
 <p>在ASP.NET MVC中，可以应用<code>OutputCache</code>筛选器属性，这与Web表单中输出缓存的概念相同。 输出缓存使您能够缓存控制器操作返回的内容。</p> 
 <p>输出缓存基本上允许您将特定控制器的输出存储在内存中。 因此，来自该控制器中的相同动作的未来请求将从缓存结果中返回。 这样，每次调用相同的控制器操作时，都不需要生成相同的内容。</p> 
 <h2 id="h2--"><a name="为什么要缓存？" class="reference-link"></a><span class="header-link octicon octicon-link"></span>为什么要缓存？</h2>
 <p>我们需要缓存在许多不同的场景来提高应用程序的性能。 例如，一个ASP.NET MVC应用程序，它显示一个雇员名单。 现在，当每次用户调用控制器动作时，通过执行数据库查询从数据库中检索这些记录时，它将返回显示到<em>Index</em>视图中。</p> 
 <p>因此，可以利用输出缓存来避免每次调用相同的控制器操作时执行数据库查询。 在这种情况下，将从缓存中检索视图，而不是从控制器操作重新生成。</p> 
 <p>缓存使您可以避免在服务器上执行冗余工作。</p> 
 <p>下面来看看如何在项目中使用缓存的一个简单示例，为了方便演示，这里创建一个MVC Web项目：<em>MVCCaching</em> 。</p> 
 <blockquote> 
  <p>注意：创建读取数据库表记录请参考：<a target="_blank" href="http://www.yiibai.com/asp.net_mvc/asp.net_mvc_databases.html">http://www.yiibai.com/asp.net_mvc/asp.net_mvc_databases.html</a> </p> 
 </blockquote> 
 <p>参考以下代码 - </p> 
 <pre><code class="lang-csharp">
using MVCCaching.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;

namespace MVCCaching.Controllers
{
    public class EmployeeController : Controller
    {
        private EmpDBContext db = new EmpDBContext();
        // GET: Employee 使用缓存
        [OutputCache(Duration = 60)]
        public ActionResult Index()
        {
            var employees = from e in db.Employees
                            orderby e.ID
                            select e;
            return View(employees);
        }
        ... ...
    }
}
</code></pre> 
 <p>如您所见，在<code>EmployeeController</code>的<em>Index</em>动作上添加了<code>“OutputCache”</code>属性。 现在理解这个概念，在调试器模式下运行这个应用程序，并在<code>Index</code>操作方法中插入一个断点。<br><img src="http://www.yiibai.com/uploads/images/201712/1712/764121220_33563.png" alt=""></p> 
 <p>按<em>‘F5’</em>按钮继续，将看到视图中有从数据库中检索到的员工列表。<br><img src="http://www.yiibai.com/uploads/images/201712/1712/553121221_75088.png" alt=""></p> 
 <p>在<code>60</code>秒内再次刷新浏览器，会看到这个断点没有经过。 这是因为使用了输出缓存，持续时间为几秒。 所以它会把这个结果缓存<code>60</code>秒，当刷新浏览器时，它会从缓存中读取得到结果，而不会从数据库服务器加载内容。</p> 
 <p>除了持续时间参数之外，还有其他一些设置选项，可以使用输出缓存。 这些设置不仅适用于MVC框架，而且是从ASP.Net缓存继承的。</p> 
 <h2 id="h2-u6539u53D8u8F93u51FAu7F13u5B58"><a name="改变输出缓存" class="reference-link"></a><span class="header-link octicon octicon-link"></span>改变输出缓存</h2>
 <p>在某些情况下，可能需要不同的缓存版本，例如，当创建详细信息页面时，当单击详细链接时，将获得所选员工的详细信息。</p> 
 <p>但首先需要创建详细视图。 为此，请右键单击<code>EmployeeController</code>中的<code>Details</code>操作方法，然后选择<em>添加视图…</em></p> 
 <p>在默认情况下选择了详细信息名称。现在从“模板”下拉列表中选择<code>Details</code>，从“模型”下拉列表中选择<code>Employee</code> -<br><img src="http://www.yiibai.com/uploads/images/201712/1812/534161212_74367.png" alt=""></p> 
 <p>点击<em>“添加”</em>继续，会看到生成了文件：<code>Details.cshtml</code>。参考以下代码 - </p> 
 <pre><code class="lang-html">@model MVCCaching.Models.Employee

@{
    Layout = null;
}

&lt;!DOCTYPE html&gt;

&lt;html&gt;
&lt;head&gt;
    &lt;meta name="viewport" content="width=device-width" /&gt;
    &lt;title&gt;Details&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div&gt;
        &lt;h4&gt;Employee&lt;/h4&gt;
        &lt;hr /&gt;
        &lt;dl class="dl-horizontal"&gt;
            &lt;dt&gt;
                @Html.DisplayNameFor(model =&gt; model.Name)
            &lt;/dt&gt;

            &lt;dd&gt;
                @Html.DisplayFor(model =&gt; model.Name)
            &lt;/dd&gt;

            &lt;dt&gt;
                @Html.DisplayNameFor(model =&gt; model.JoiningDate)
            &lt;/dt&gt;

            &lt;dd&gt;
                @Html.DisplayFor(model =&gt; model.JoiningDate)
            &lt;/dd&gt;

            &lt;dt&gt;
                @Html.DisplayNameFor(model =&gt; model.Age)
            &lt;/dt&gt;

            &lt;dd&gt;
                @Html.DisplayFor(model =&gt; model.Age)
            &lt;/dd&gt;

        &lt;/dl&gt;
    &lt;/div&gt;
    &lt;p&gt;
        @Html.ActionLink("Edit", "Edit", new { id = Model.ID }) |
        @Html.ActionLink("Back to List", "Index")
    &lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre> 
 <p>可以利用<code>[OutputCache]</code>属性中的<code>VaryByParam</code>属性。这个属性使您能够在表单参数或查询字符串参数发生变化时创建不同的缓存版本。 以下是<code>Details</code>操作的实现。参考以下代码 - </p>   
 <pre><code class="lang-csharp">// GET: Employee/Details/5
[OutputCache(Duration = int.MaxValue, VaryByParam = "id")]

public ActionResult Details(int id){
   var employee = db.Employees.SingleOrDefault(e =&gt; e.ID == id);
   return View(employee);
}
</code></pre> 
 <p>当编译并执行上述代码时，访问指定URL：<code>http://localhost:59893/employee</code> 应该会得到以下输出。<br><img src="http://www.yiibai.com/uploads/images/201712/1712/553121221_75088.png" alt=""></p> 
 <p>点击任何一个详细信息链接，将看到该特定员工的详细信息视图。</p> 
 <p><img src="http://www.yiibai.com/uploads/images/201712/1812/746161218_57332.png" alt=""></p> 
 <p><code>Details()</code>操作包含值为<code>“Id”</code>的<code>VaryByParam</code>属性。 当<code>Id</code>参数的不同值传递给控制器操作时，会生成不同的缓存版本的<code>Details</code>视图。</p> 
 <p>理解使用<code>VaryByParam</code>属性导致更多缓存是非常重要的。 为每个不同版本的<code>Id</code>参数创建不同的缓存版本的<code>Details</code>视图。</p> 
 <h2 id="h2-u7F13u5B58u914Du7F6Eu6587u4EF6"><a name="缓存配置文件" class="reference-link"></a><span class="header-link octicon octicon-link"></span>缓存配置文件</h2>
 <p>可以在<em>web.config</em>文件中创建缓存配置文件。 可以通过修改<code>[OutputCache]</code>属性来配置输出缓存属性。 它提供了几个重要的优点，如下所示。</p> 
 <ul> 
  <li>控制控制器如何在一个中心位置缓存内容。</li>
  <li>创建一个缓存配置文件并将该配置文件应用于多个控制器或控制器操作。</li>
  <li>修改网页配置文件，而不用重新编译应用程序。</li>
  <li>为已经部署到生产环境的应用程序禁用缓存。</li>
 </ul> 
 <p>我们来看一个简单的缓存配置文件示例，在<code>web.config</code>文件中创建缓存配置文件。 <code>&lt;caching&gt;</code>部分必须出现在<code>&lt;system.web&gt;</code>部分中。如下 - </p> 
 <pre><code class="lang-xml">&lt;caching&gt;
   &lt;outputCacheSettings&gt;
      &lt;outputCacheProfiles&gt;
         &lt;add name = "Cache10Min" duration = "600" varyByParam = "none"/&gt;
      &lt;/outputCacheProfiles&gt;
   &lt;/outputCacheSettings&gt;
&lt;/caching&gt;
</code></pre> 
 <p>可以使用<code>[OutputCache]</code>属性将<code>Cache10Min</code>配置文件应用于控制器操作，如下所示。</p> 
 <pre><code class="lang-csharp">[OutputCache(CacheProfile = "Cache10Min")]

public ActionResult Index(){
   var employees = from e in db.Employees
   orderby e.ID
   select e;
   return View(employees);
}
</code></pre> 
 <p>当编译并执行上述代码时，访问指定URL：<code>http://localhost:63004/employee</code> 应该会得到以下输出。</p> 
 <p>如果调用<code>Index()</code>动作如上所示，那么同样也将是缓存<code>10</code>分钟。</p>
 <br>      
</div></body></html>
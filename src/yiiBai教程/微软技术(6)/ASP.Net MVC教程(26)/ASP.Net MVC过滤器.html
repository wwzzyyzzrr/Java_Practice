<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">ASP.Net MVC过滤器</h1><div style="width:100%;float:left;" class="article-content">   
 <p>在ASP.NET MVC中，控制器定义的操作方法通常与可能的用户交互具有一对一的关系，但有时候您希望在调用操作方法之前或者在操作方法运行之后执行逻辑。</p> 
 <p>为了支持这个功能，ASP.NET MVC提供了过滤器。 过滤器是一个自定义类，它提供了一种声明式和程序式的方法，可将操作前和操作后行为添加到控制器操作方法中。</p> 
 <h2 id="h2-u52A8u4F5Cu8FC7u6EE4u5668"><a name="动作过滤器" class="reference-link"></a><span class="header-link octicon octicon-link"></span>动作过滤器</h2>
 <p>动作过滤器是一个属性，可以将其应用于控制器动作或整个控制器，以修改执行动作的方式。 ASP.NET MVC框架包含几个操作过滤器 -</p> 
 <ul> 
  <li><em>OutputCache</em> - 将控制器操作的输出缓存指定的时间量。</li>
  <li><em>HandleError</em> - 处理执行控制器操作时引发的错误。</li>
  <li><em>Authorize</em> - 使能够限制对特定用户或角色的访问。</li>
 </ul> 
 <h2 id="h2-u8FC7u6EE4u5668u7684u7C7Bu578B"><a name="过滤器的类型" class="reference-link"></a><span class="header-link octicon octicon-link"></span>过滤器的类型</h2>
 <p>ASP.NET MVC框架支持四种不同类型的过滤器 -</p> 
 <ul> 
  <li><em>授权过滤器</em> - 实现<code>IAuthorizationFilter</code>属性。</li>
  <li><em>动作过滤器</em> - 实现<code>IActionFilter</code>属性。</li>
  <li><em>结果过滤器</em> - 实现<code>IResultFilter</code>属性。</li>
  <li><em>异常过滤器</em> - 实现<code>IExceptionFilter</code>属性。</li>
 </ul> 
 <p>过滤器按上面列出的顺序执行。例如，授权过滤器始终在每个其他类型的过滤器之后执行操作过滤器和异常过滤器之前执行。</p> 
 <p><em>授权过滤器</em> 用于实现控制器操作的身份验证和授权。 例如，授权过滤器是授权过滤器的一个例子。</p> 
 <p>下面来看一个简单的例子，创建一个新的ASP.Net MVC项目。打开Visual Studio，然后单击菜单：<em>文件</em> -&gt; <em>新建</em> -&gt; <em>项目</em> 选项。创建一个名称为：<em>MVCFiltersDemo</em> 的MVC项目。</p> 
 <blockquote> 
  <p>详细创建过程请参考：<a target="_blank" href="http://www.yiibai.com/asp.net_mvc/asp.net_mvc_getting_started.html">http://www.yiibai.com/asp.net_mvc/asp.net_mvc_getting_started.html</a> </p> 
 </blockquote> 
 <p>通过在<em>解决方案资源管理器</em> 中右键单击 <em>Controllers</em> 文件夹来添加一个控件器：<em>HomeController</em>。在弹出菜单项中选择：<em>添加</em> -&gt; <em>控制器</em> 。</p> 
 <h2 id="h2-u5E94u7528u64CDu4F5Cu7B5Bu9009u5668"><a name="应用操作筛选器" class="reference-link"></a><span class="header-link octicon octicon-link"></span>应用操作筛选器</h2>
 <p>动作过滤器可以应用于单独的控制器动作或整个控制器。 例如，操作筛选器<code>OutputCache</code>应用于名为<code>Index()</code>的操作，该操作返回字符串。 此过滤器会将该操作返回的值缓存15秒。</p> 
 <p>为了使这个实现这个例子，让我们修改控制器类通过改变称为<code>Index</code>操作方法使用下面的代码 -</p> 
 <pre><code class="lang-csharp">using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;

namespace MVCFiltersDemo.Controllers
{
    public class HomeController : Controller
    {
        // GET: Home
        // GET: Home
        [OutputCache(Duration = 15)]
        public string Index()
        {
            return "This is ASP.Net MVC Filters Tutorial";
        }
    }
}
</code></pre> 
 <p>运行此应用程序时，将看到浏览器正在显示<code>Index</code>操作方法的结果，如下所示 -<br><img src="http://www.yiibai.com/uploads/images/201712/1412/436101256_48987.png" alt=""></p> 
 <p>再添加另一个操作方法，它用于显示当前时间 - </p> 
 <pre><code class="lang-csharp">using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;

namespace MVCFiltersDemo.Controllers
{
    public class HomeController : Controller
    {
        // GET: Home
        [OutputCache(Duration = 15)]
        public string Index()
        {
            return "This is ASP.Net MVC Filters Tutorial";
        }
        // 返回当前时间
        [OutputCache(Duration = 20)]
        public string GetCurrentTime()
        {
            return DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
        }
    }
}
</code></pre> 
 <p>请求以下URL：<code>http://localhost:54713/Home/GetCurrentTime</code>，将收到以下输出 -<br><img src="http://www.yiibai.com/uploads/images/201712/1412/495111202_91010.png" alt=""></p> 
 <p>如果刷新浏览器，则会看到相同的时间，因为该操作被缓存了<code>20</code>秒。 <code>20</code>秒后刷新它将被更新。</p> 
 <h2 id="h2-u81EAu5B9Au4E49u8FC7u6EE4u5668"><a name="自定义过滤器" class="reference-link"></a><span class="header-link octicon octicon-link"></span>自定义过滤器</h2>
 <p>要创建自己的自定义过滤器，ASP.NET MVC框架提供了一个叫作<code>ActionFilterAttribute</code>的基类。 这个类实现了<code>IActionFilter</code>和<code>IResultFilter</code>接口，都是从<code>Filter</code>类派生的。</p> 
 <p>下面来看看看自定义过滤器的一个简单的例子，通过在项目中创建一个新的文件夹：<em>ActionFilters</em> 。添加一个类，右键单击<em>ActionFilters</em> 文件夹并选择：<em>添加</em> -&gt; <em>类</em> 。<br><img src="http://www.yiibai.com/uploads/images/201712/1412/913111213_88604.png" alt=""></p> 
 <p>在类名称字段中输入<em>MyLogActionFilter</em>，然后单击<em>“添加”</em> 按钮。</p> 
 <p>这个类将从<code>ActionFilterAttribute</code>派生，它是一个基类，并覆盖下面的方法。 以下是<code>MyLogActionFilter</code>的完整实现。</p>   
 <pre><code class="lang-csharp">using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;

using System.Web;
using System.Web.Mvc;
using System.Web.Routing;

namespace MVCFiltersDemo.ActionFilters
{
    public class MyLogActionFilter: ActionFilterAttribute
    {        

        public override void OnActionExecuted(ActionExecutedContext filterContext)
        {
            Log("##########OnActionExecuted", filterContext.RouteData);
        }

        public override void OnResultExecuting(ResultExecutingContext filterContext)
        {
            Log("##########OnResultExecuting", filterContext.RouteData);
        }

        public override void OnResultExecuted(ResultExecutedContext filterContext)
        {
            Log("##########OnResultExecuted", filterContext.RouteData);
        }

        private void Log(string methodName, RouteData routeData)
        {
            var controllerName = routeData.Values["controller"];
            var actionName = routeData.Values["action"];

            var message = String.Format(
               "{0} controller:{1} action:{2}", methodName, controllerName, actionName);
            System.Console.WriteLine("############################# YES ##################");
            Debug.WriteLine(message, "Action Filter Log");
        }
    }

}
</code></pre> 
 <p>现在，使用以下代码将日志过滤器应用于<code>HomeController</code>控制器。</p> 
 <pre><code class="lang-csharp">using MVCFiltersDemo.ActionFilters;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;

namespace MVCFiltersDemo.Controllers
{
    [MyLogActionFilter]
    public class HomeController : Controller
    {
        // GET: Home
        [OutputCache(Duration = 10)]
        public string Index()
        {
            return "This is ASP.Net MVC Filters Tutorial";
        }

        // 返回当前时间
        [OutputCache(Duration = 10)]
        public string GetCurrentTime()
        {
            return DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
        }
    }
}
</code></pre> 
 <p>打开项目中的<em>App_Start</em>，打开文件<em>FilterConfig.cs</em> ，添加以下代码注册过滤器：<em>MyLogActionFilter</em> - </p> 
 <pre><code class="lang-csharp">using MVCFiltersDemo.ActionFilters;
using System.Web;
using System.Web.Mvc;

namespace MVCFiltersDemo
{
    public class FilterConfig
    {
        public static void RegisterGlobalFilters(GlobalFilterCollection filters)
        {
            filters.Add(new HandleErrorAttribute());
            // 注册自定义Action过滤器：优先级最低，但是可以作用到所有的控制器和Action  
            filters.Add(new MyLogActionFilter());
        }
    }
}
</code></pre> 
 <p>运行应用程序，然后观察输出窗口。应该会看到类似(输出的最后几行)的结果 - </p> 
 <p><img src="http://www.yiibai.com/uploads/images/201712/1412/108121213_69034.png" alt=""></p> 
 <p>如上图所示，处理动作的每个阶段都有被记录到Visual Studio输出窗口中了。</p>
 <br>      
</div></body></html>
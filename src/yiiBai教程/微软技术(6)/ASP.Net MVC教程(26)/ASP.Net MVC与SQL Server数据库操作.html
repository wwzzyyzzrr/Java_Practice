<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">ASP.Net MVC与SQL Server数据库操作</h1><div style="width:100%;float:left;" class="article-content">   
 <p>在本教程之前，创建的所有ASP.NET MVC应用程序中，我们一直在将来自控制器的硬编码数据传递给视图模板。 但是，构建真正的Web应用程序，可能需要使用真实的数据库。 在本章中，我们将学习如何使用数据库引擎来存储和检索应用程序所需的数据。</p> 
 <p>要存储和检索数据，我们将使用<code>Entity</code>框架的.NET Framework数据访问技术来定义和使用模型。</p> 
 <p><code>Entity</code>框架(EF)支持Code First技术，该技术允许通过编写简单的类来创建模型对象，然后从类中随时创建数据库，从而实现非常干净和快速的开发流程。</p> 
 <p>下面来看一个简单的例子，我们将在这个例子中添加<code>Entity</code>框架的支持来访问数据库。</p> 
 <p><strong>第1步</strong> - 创建一个项目：<em>MVCDatabaseAccess</em>，如下所示 -<br><img src="http://www.yiibai.com/uploads/images/201712/1612/737171209_66063.png" alt=""></p> 
 <p>要安装<code>Entity Framework</code>框架，右键单击项目，然后选择<em>管理NuGet程序包</em> ，在弹出的界面中搜索：<em>Entity framework</em>，如下图所示 - </p> 
 <p><img src="http://www.yiibai.com/uploads/images/201712/1612/785171218_88536.png" alt=""></p> 
 <p>选择<em>Entity framework</em>，然后点击<strong>“Install”</strong>按钮。它将打开预览对话框 - </p> 
 <p><img src="http://www.yiibai.com/uploads/images/201712/1612/249171219_61413.png" alt=""></p> 
 <p>接受安装协议，如下图所示 - </p> 
 <p><img src="http://www.yiibai.com/uploads/images/201712/1612/505171220_65273.png" alt=""></p> 
 <p>当<em>Entity framework</em>框架安装成功，会看到下面的截图中所示的绿色“勾”的图标。如下图所示 - </p> 
 <p><img src="http://www.yiibai.com/uploads/images/201712/1612/669201255_99294.png" alt=""></p> 
 <h4 id="h4--dbcontext"><a name="添加DBContext" class="reference-link"></a><span class="header-link octicon octicon-link"></span>添加DBContext</h4>
 <p>我们需要向<code>Employee</code>模型添加另一个类，该类将与<em>Entity Framework</em>进行通信，以使用以下代码检索和保存数据。</p> 
 <pre><code class="lang-csharp">using System;
using System.Collections.Generic;
using System.Data.Entity;
using System.Linq;

using System.Web;
namespace MVCDatabaseAccess.Models
{
    public class Employee
    {
        public int ID { get; set; }
        public string Name { get; set; }
        public DateTime JoiningDate { get; set; }
        public int Age { get; set; }
    }

    public class EmpDBContext : DbContext
    {
        public EmpDBContext()
        { }
        public DbSet&lt;Employee&gt; Employees { get; set; }
    }
}
</code></pre> 
 <p>如上所示，<code>EmpDBContext</code>是从一个名为<code>DbContext的EF</code>类派生的。在这个类中有一个名为<code>DbSet</code>的属性它基本上表示想查询和保存的实体。</p> 
 <h4 id="h4-u8FDEu63A5u5B57u7B26u4E32"><a name="连接字符串" class="reference-link"></a><span class="header-link octicon octicon-link"></span>连接字符串</h4>
 <p>我们需要在<code>Web.config</code>文件中的<code>&lt;configuration&gt;</code>标记下为数据库指定连接字符串。</p> 
 <pre><code class="lang-xml"> &lt;connectionStrings&gt;
    &lt;add name = "EmpDBContext" connectionString = "Data Source=MY-PC;Initial Catalog=testdb;Integrated Security=True" providerName = "System.Data.SqlClient"/&gt;
  &lt;/connectionStrings&gt;
</code></pre> 
 <p>实际上不需要添加<code>EmpDBContext</code>连接字符串。如果不指定连接字符串，则<em>Entity Framework</em>将使用<code>DbContext</code>类的标准名称在用户目录中创建<code>localDB</code>数据库。 对于这个示例，我们不会添加连接字符串来简化。</p> 
 <p>现在需要更新<code>EmployeeController.cs</code>文件，以便可以从数据库中保存和检索数据，而不是使用硬编码的数据。</p> 
 <p>首先，添加创建一个私有的<code>EmpDBContext</code>类对象，然后更新<em>Index</em>，<em>Create</em>和<em>Edit</em>动作方法，如下面的代码所示。参考以下代码 - </p> 
 <pre><code class="lang-csharp">using MVCDatabaseAccess.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;

namespace MVCDatabaseAccess.Controllers
{
    public class EmployeeController : Controller
    {
        private EmpDBContext db = new EmpDBContext();

        // GET: Employee
        public ActionResult Index()
        {
            var employees = from e in db.Employees
                            orderby e.ID
                            select e;
            return View(employees);
        }

        // GET: Employee/Create
        public ActionResult Create()
        {
            return View();
        }

        // POST: Employee/Create
        [HttpPost]
        public ActionResult Create(Employee emp)
        {
            try
            {
                db.Employees.Add(emp);
                db.SaveChanges();
                return RedirectToAction("Index");
            }
            catch
            {
                return View();
            }
        }

        // GET: Employee/Edit/5
        public ActionResult Edit(int id)
        {
            var employee = db.Employees.Single(m =&gt; m.ID == id);
            return View(employee);
        }

        // POST: Employee/Edit/5
        [HttpPost]
        public ActionResult Edit(int id, FormCollection collection)
        {
            try
            {
                var employee = db.Employees.Single(m =&gt; m.ID == id);
                if (TryUpdateModel(employee))
                {
                    //To Do:- database code
                    db.SaveChanges();
                    return RedirectToAction("Index");
                }
                return View(employee);
            }
            catch
            {
                return View();
            }
        }
    }
}
</code></pre> 
 <p>然后访问以下URL：<code>http://localhost:61868/Employee</code>运行这个应用程序。将看到以下输出。<br><img src="http://www.yiibai.com/uploads/images/201712/1612/687211230_42057.png" alt=""></p> 
 <p>正如所看到的，这个视图上没有数据，但是程序已经自动创建了一个表：<em>Employee</em>，这是因为我们还没有在数据库表中添加任何记录。</p> 
 <p>进入SQL Server对象资源管理器，会看到数据库使用与我们在<code>DBContext</code>类中创建的相同的名称 - <em>Employee</em></p> 
 <p><img src="http://www.yiibai.com/uploads/images/201712/1612/722211236_33675.png" alt=""></p> 
 <p>展开这个数据库，会看到它有一个包含<code>Employee</code>模型类中的所有字段的表。<br><img src="http://www.yiibai.com/uploads/images/201712/1612/120211237_28116.png" alt=""></p> 
 <p>要查看此表中的数据，请右键单击<code>Employees</code>表并选择查看数据。应该会看到目前没有数据记录。我们直接在数据库的<code>Employee</code>表中添加一些记录，如下图所示 -<br><img src="http://www.yiibai.com/uploads/images/201712/1612/339211241_40123.png" alt=""></p> 
 <p>刷新浏览器，应该会看到数据现在已经更新到了视图中了。如下图所示 - </p> 
 <p><img src="http://www.yiibai.com/uploads/images/201712/1612/392211242_94476.png" alt=""></p> 
 <p>点击<em>“Create New”</em> 链接，从浏览器中添加一条记录，它将显示创建视图。在下面的字段中添加一些数据。</p> 
 <p><img src="http://www.yiibai.com/uploads/images/201712/1612/876211248_54958.png" alt=""></p> 
 <p>点击<em>Create</em>按钮，它会更新索引视图以及添加这个新的记录到数据库。</p> 
 <p><img src="http://www.yiibai.com/uploads/images/201712/1612/545211248_26513.png" alt=""></p> 
 <p>现在打开SQL Server对象资源管理器并刷新数据库。右键单击<code>Employees</code>表并选择查看数据菜单选项。应该就会看到该记录被添加到数据库中了。</p> 
 <p><img src="http://www.yiibai.com/uploads/images/201712/1612/581211250_61475.png" alt=""></p>
 <br>      
</div></body></html>
<html><head><meta charset="utf-8"></meta></head><body><h1 class="article-title" style="text-align:center;">Nginx反向代理</h1><div style="width:100%;float:left;" class="article-content">   
 <p>本文介绍代理服务器的基本配置。 您将学习如何通过不同协议将NGINX请求传递给代理的服务器，修改发送到代理服务器的客户端请求标头，以及配置来自代理服务器的响应缓冲。</p> 
 <p>代理服务器的基本配置目录</p> 
 <ul> 
  <li>代理服务器介绍</li>
  <li>将请求传递给代理的服务器</li>
  <li>传递请求标头</li>
  <li>配置缓冲区</li>
  <li>选择传出IP地址</li>
 </ul> 
 <h2 id="h2-1-"><a name="1. 代理服务器介绍" class="reference-link"></a><span class="header-link octicon octicon-link"></span>1. 代理服务器介绍</h2>
 <p>代理通常用于在多个服务器之间分配负载，无缝地显示来自不同网站的内容，或者通过HTTP以外的协议将请求传递给应用服务器。</p> 
 <h2 id="h2-2-"><a name="2. 将请求传递给代理的服务器" class="reference-link"></a><span class="header-link octicon octicon-link"></span>2. 将请求传递给代理的服务器</h2>
 <p>当NGINX代理请求时，它将请求发送到指定的代理服务器，获取响应，并将其发送回客户端。 可以使用指定的协议将请求代理到HTTP服务器(另一个NGINX服务器或任何其他服务器)或非HTTP服务器(可以运行使用特定框架开发的应用程序，如<a target="_blank" href="http://www.yiibai.com/php/" title="PHP">PHP</a>或<a target="_blank" href="http://www.yiibai.com/python/" title="Python">Python</a>)。 支持的协议包括FastCGI，uwsgi，SCGI和<a target="_blank" href="http://www.yiibai.com/memcached/" title="memcached">memcached</a>。</p> 
 <p>要将请求传递给HTTP代理服务器，则在一个<a target="_blank" href="http://nginx.org/en/docs/http/ngx_http_core_module.html?&amp;_ga=1.107628738.1509956953.1490042234#location" title="location">location</a>块内指定<a target="_blank" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html?&amp;_ga=1.107628738.1509956953.1490042234#proxy_pass" title="proxy_pass">proxy_pass</a>指令。 例如：</p> 
 <pre><code>location /some/path/ {
    proxy_pass http://www.example.com/link/;
}
</code></pre>
 <p>此示例配置将在此<code>location</code>处理的所有请求传递到指定地址(<code>http://www.example.com/link/</code>)处的代理服务器。该地址可以指定为域名或IP地址。 该地址还可能包括一个端口：</p> 
 <pre><code>location ~ \.php {
    proxy_pass http://127.0.0.1:8000;
}
</code></pre>
 <p>请注意，在上述第一个示例中，代理服务器的地址后面是URI为 <code>/link/</code>。 如果URI与地址一起指定，它将替换与<code>location</code>参数匹配请求URI的部分。 例如，这里使用<code>/some/path/page.html</code>的URI请求将被代理到<code>http://www.example.com/link/page.html</code>。 如果地址被指定为没有URI，或者不可能确定要替换的URI部分，则会传递完整的请求URI(可能是修改)。</p> 
 <p>要将请求传递给非HTTP代理服务器，应使用适当的<code>**_ pass</code>指令：</p> 
 <ul> 
  <li><code>fastcgi_pass</code> 将请求传递给FastCGI服务器</li>
  <li><code>uwsgi_pass</code> 将请求传递给uwsgi服务器</li>
  <li><code>scgi_pass</code> 将请求传递给SCGI服务器</li>
  <li><code>memcached_pass</code> 将请求传递给memcached服务器</li>
 </ul> 
 <blockquote> 
  <p>请注意，在这些情况下，指定地址的规则可能不同。 您可能还需要向服务器传递其他参数(有关详细信息，请参阅<a target="_blank" href="http://nginx.org/en/docs/?_ga=1.85682649.1509956953.1490042234" title="参考文档">参考文档</a>)。</p> 
 </blockquote> 
 <p><code>proxy_pass</code>指令也可以指向一组命名的服务器。 在这种情况下，根据指定的方法在组中的服务器之间分配请求。</p> 
 <h2 id="h2-3-"><a name="3. 传递请求标头" class="reference-link"></a><span class="header-link octicon octicon-link"></span>3. 传递请求标头</h2>
 <p>默认情况下，NGINX在代理请求<code>“Host”</code> 和 <code>“Connection”</code>中重新定义了两个头字段，并消除了其值为空字符串的头字段。 “Host”设置为<code>$proxy_host</code>变量，<code>“Connection”</code>设置为关闭(<code>close</code>)。</p> 
 <p>要更改这些设置，以及修改其他<code>header</code>字段，请使用<code>proxy_set_header</code>指令。 该指令可以在一个或多个位置(<code>location</code>)指定。 它也可以在特定的<code>server</code>上下文或<code>http</code>块中指定。 例如：</p> 
 <pre><code>location /some/path/ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_pass http://localhost:8000;
}
</code></pre>
 <p>在此配置中，<code>“Host”</code>字段设置为 <a target="_blank" href="http://nginx.org/en/docs/http/ngx_http_core_module.html?&amp;_ga=1.51463017.1509956953.1490042234#variables" title="$host">$host</a> 变量。<br>为了防止头域被传递给代理服务器，请将其设置为空字符串，如下所示：</p> 
 <pre><code>location /some/path/ {
    proxy_set_header Accept-Encoding "";
    proxy_pass http://localhost:8000;
}
</code></pre>
 <h2 id="h2-4-"><a name="4. 配置缓冲区" class="reference-link"></a><span class="header-link octicon octicon-link"></span>4. 配置缓冲区</h2>
 <p>默认情况下，NGINX缓存来自代理服务器的响应。 响应存储在内部缓冲区中，并且不会发送到客户端，直到收到整个响应。 缓冲有助于通过慢客户端优化性能，如果响应从NGINX同步传递到客户端，这可能会浪费代理服务器时间。 然而，当启用缓冲时，NGINX允许代理服务器快速处理响应，而NGINX存储响应时间与客户端需要下载的时间一样长。</p> 
 <p>负责启用和禁用缓冲的指令是<a target="_blank" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html?&amp;_ga=1.22701563.1509956953.1490042234#proxy_buffering" title="proxy_buffering">proxy_buffering</a>。 默认情况下，它被设置为开启且缓冲已启用。</p> 
 <p><code>proxy_buffers</code>指令控制分配给请求的缓冲区的大小和数量。 来自代理服务器的响应的第一部分存储在单独的缓冲区中，其大小由<a target="_blank" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html?&amp;_ga=1.22701563.1509956953.1490042234#proxy_buffer_size" title="proxy_buffer_size">proxy_buffer_size</a>指令设置。 这部分通常包含一个比较小的响应头，并且可以比其余的响应的缓冲区小。</p> 
 <p>在以下示例中，缓冲区的默认数量增加，并且响应的第一部分的缓冲区的大小小于默认值。</p>   
 <pre><code class="lang-shell">location /some/path/ {
    proxy_buffers 16 4k;
    proxy_buffer_size 2k;
    proxy_pass http://localhost:8000;
}
</code></pre> 
 <p>如果缓存被禁用，则在从代理服务器接收缓冲时，响应将同步发送到客户端。 对于需要尽快开始接收响应的快速交互式客户端，此行为可能是可取的。</p> 
 <p>要禁用特定位置的缓冲，请在<code>location</code>块中将<code>proxy_buffering</code>伪指令设置为<code>off</code>，如下所示：</p> 
 <pre><code>location /some/path/ {
    proxy_buffering off;
    proxy_pass http://localhost:8000;
}
</code></pre>
 <p>在这种情况下，NGINX只使用由<code>proxy_buffer_size</code>配置的缓冲区来存储响应的当前部分。</p> 
 <h2 id="h2-5-ip-"><a name="5. 选择传出IP地址" class="reference-link"></a><span class="header-link octicon octicon-link"></span>5. 选择传出IP地址</h2>
 <p>如果您的代理服务器有多个网络接口，有时您可能需要选择特定的源IP地址才能连接到代理服务器或上游。 如果NGINX后端的代理服务器只配置为接受来自特定IP网络或IP地址范围的连接，在这种情况下，这个配置选项就很有用。</p> 
 <p>指定<a target="_blank" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html?&amp;_ga=1.11034868.1509956953.1490042234#proxy_bind" title="proxy_bind">proxy_bind</a>指令和必要网络接口的IP地址：</p> 
 <pre><code>location /app1/ {
    proxy_bind 127.0.0.1;
    proxy_pass http://example.com/app1/;
}

location /app2/ {
    proxy_bind 127.0.0.2;
    proxy_pass http://example.com/app2/;
}
</code></pre>
 <p>IP地址也可以用变量指定。 例如，<a target="_blank" href="http://nginx.org/en/docs/http/ngx_http_core_module.html?&amp;_ga=1.49548390.1509956953.1490042234#var_server_addr" title="$server_addr">$server_addr</a>变量传递接受请求的网络接口的IP地址：</p> 
 <pre><code>location /app3/ {
    proxy_bind $server_addr;
    proxy_pass http://example.com/app3/;
}
</code></pre>
 <br>      
</div></body></html>